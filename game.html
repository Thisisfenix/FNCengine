<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Bounce Coins Ultimate</title>
    <style>
        :root {
            --hud-color: #4CAF50;
            --hud-bg: rgba(0, 0, 0, 0.7);
            --text-color: white;
            --button-hover: rgba(76, 175, 80, 0.7);
            --premium-color: gold;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #222;
            transition: background-color 0.5s;
        }

        canvas {
            display: block;
            background-color: #222;
            transition: background-color 0.5s;
        }

        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--text-color);
            font-size: clamp(14px, 2vw, 18px);
            text-shadow: 1px 1px 2px black;
            background-color: var(--hud-bg);
            padding: 10px;
            border-radius: 10px;
            pointer-events: auto;
            display: grid;
            grid-template-columns: repeat(3, auto);
            gap: 5px;
            align-items: center;
            transition: all 0.3s;
        }

        #stats {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--hud-bg);
            color: var(--text-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: clamp(12px, 1.5vw, 14px);
            display: none;
            pointer-events: auto;
        }

        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(90%, 400px);
            max-height: 80vh;
            background-color: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
            padding: 15px;
            border-radius: 10px;
            display: none;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            z-index: 100;
        }

        #config {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(90%, 400px);
            background-color: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
            padding: 15px;
            border-radius: 10px;
            display: none;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            z-index: 100;
        }

        #achievements {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            display: none;
            width: min(90%, 300px);
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.7);
            z-index: 100;
            animation: achievementPop 0.5s;
        }

        @keyframes achievementPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }

            80% {
                transform: translate(-50%, -50%) scale(1.1);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        button {
            background-color: var(--hud-color);
            border: none;
            color: white;
            padding: 8px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: clamp(12px, 1.5vw, 14px);
            margin: 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            pointer-events: auto;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--button-hover);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .tab {
            overflow: hidden;
            border: 1px solid #444;
            background-color: #333;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            color: white;
            border-radius: 0;
            font-size: 14px;
        }

        .tab button:hover {
            background-color: #555;
        }

        .tab button.active {
            background-color: var(--hud-color);
        }

        .tabcontent {
            display: none;
            padding: 10px 0;
            animation: fadeEffect 0.5s;
        }

        @keyframes fadeEffect {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .upgrade {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border-left: 4px solid var(--hud-color);
            position: relative;
        }

        .upgrade h3 {
            margin-top: 0;
            color: var(--hud-color);
        }

        .powerup {
            position: absolute;
            border-radius: 50%;
            animation: float 3s infinite ease-in-out;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .combo-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: gold;
            font-size: clamp(18px, 3vw, 24px);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .obstacle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        .skin-option {
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 50%;
            transition: all 0.3s;
            position: relative;
        }

        .skin-option:hover,
        .skin-option.selected {
            border-color: var(--hud-color);
            transform: scale(1.1);
        }

        .skin-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .premium-feature {
            position: relative;
        }

        .premium-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--premium-color);
            color: black;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1;
        }

        .skin-rarity {
            position: absolute;
            bottom: -15px;
            left: 0;
            width: 100%;
            font-size: 10px;
            text-align: center;
            color: var(--text-color);
        }

        .rarity-common {
            color: #a0a0a0;
        }

        .rarity-rare {
            color: #4CAF50;
        }

        .rarity-premium {
            color: var(--premium-color);
        }

        .rarity-exclusive {
            color: #ff00ff;
        }

        #premiumShop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            width: min(90%, 300px);
            text-align: center;
            display: none;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }

        #premiumShop button {
            margin-top: 15px;
            background-color: var(--premium-color);
            color: black;
            font-weight: bold;
        }

        #bossHealth {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: min(80%, 200px);
            height: 20px;
            background-color: rgba(255, 0, 0, 0.3);
            border-radius: 10px;
            display: none;
        }

        #bossHealthBar {
            height: 100%;
            width: 100%;
            background-color: red;
            border-radius: 10px;
            transition: width 0.3s;
        }

        #abilityBar {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            pointer-events: auto;
        }

        .ability-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ff9900;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .ability-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 153, 0, 0.7);
        }

        .ability-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .ability-cooldown {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            transition: height 0.1s;
        }

        #missions {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
            padding: 10px;
            border-radius: 10px;
            width: min(80%, 250px);
            max-height: 60vh;
            overflow-y: auto;
            display: none;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
        }

        .mission {
            margin-bottom: 10px;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .mission.completed {
            border-left: 3px solid var(--hud-color);
        }

        .mission-reward {
            font-size: 12px;
            color: var(--hud-color);
            margin-top: 3px;
        }

        .mission-special {
            color: var(--premium-color);
            font-weight: bold;
        }

        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-family: Arial, sans-serif;
        }

        #loadingProgress {
            width: 200px;
            height: 200px;
            position: relative;
            margin: 20px;
        }

        #loadingCircle {
            width: 100%;
            height: 100%;
            border: 10px solid #333;
            border-top-color: var(--hud-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        #loadingPercent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            font-weight: bold;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-label {
            margin-right: 10px;
        }

        /* Modo oscuro/claro */
        body.light-mode {
            background-color: #f0f0f0;
            --hud-bg: rgba(255, 255, 255, 0.9);
            --text-color: #333;
        }

        body.light-mode canvas {
            background-color: #ddd;
        }

        body.light-mode #shop,
        body.light-mode #config,
        body.light-mode #achievements,
        body.light-mode #premiumShop,
        body.light-mode #missions {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        body.light-mode .upgrade {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .mission {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #ui {
                grid-template-columns: repeat(2, auto);
            }

            #abilityBar {
                bottom: 60px;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }

            .ability-button {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            #missions {
                width: 90%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
        }

        /* Efectos de skins */
        .skin-effect {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }

        /* Notificación premium */
        #premiumNotification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            display: none;
            text-align: center;
            box-shadow: 0 0 20px var(--premium-color);
        }

        #premiumNotification button {
            margin: 10px 5px 0;
        }

        /* Añade esto en la sección de estilos */
        #saveSlots {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
            padding: 20px;
            border-radius: 10px;
            width: min(90%, 400px);
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            z-index: 100;
        }

        .save-slot {
            background: rgba(30, 30, 30, 0.8);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid var(--hud-color);
        }

        .save-slot h4 {
            margin-top: 0;
            margin-bottom: 5px;
        }

        .save-info {
            font-size: 12px;
            margin: 5px 0;
            line-height: 1.4;
        }

        .save-slot button {
            margin: 5px 2px 0 0;
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>

<div id="loadingScreen">
    <h1>Circle Bounce Coins Ultimate</h1>
    <div id="loadingProgress">
        <div id="loadingCircle"></div>
        <div id="loadingPercent">0%</div>
    </div>
    <p>Cargando recursos...</p>
</div>

<canvas id="gameCanvas"></canvas>

<div id="ui-container">
    <div id="ui">
        <div>ReboteCoins: <span id="coins">0</span> <span id="coinMultiplier"></span></div>
        <div>Rebotes: <span id="bounces">0</span></div>
        <div>Combo: <span id="combo">1x</span></div>
        <div>Nivel: <span id="level">1</span></div>
        <div>Récord: <span id="highscore">0</span></div>
        <button id="shopBtn">Tienda</button>
        <button id="configBtn">Configuración</button>
        <button id="pauseBtn">Pausa</button>
        <button id="statsBtn">Estadísticas</button>
        <button id="missionToggle">Misiones</button>
        <button id="saveBtn">Guardar</button>
    </div>

    <div id="stats">
        FPS: <span id="fpsCounter">0</span> | Partículas: <span id="particleCounter">0</span>
    </div>

    <div class="combo-display" id="comboDisplay"></div>

    <div id="bossHealth">
        <div id="bossHealthBar"></div>
    </div>

    <div id="abilityBar">
        <div class="ability-button" id="ability1" title="Invencibilidad (Q)">✨
            <div class="ability-cooldown" id="cooldown1"></div>
        </div>
        <div class="ability-button" id="ability2" title="Explosión (W)">💥
            <div class="ability-cooldown" id="cooldown2"></div>
        </div>
        <div class="ability-button" id="ability3" title="Ralentizar (E)">⌛
            <div class="ability-cooldown" id="cooldown3"></div>
        </div>
        <div class="ability-button" id="ability4" title="Iman (R)">🧲
            <div class="ability-cooldown" id="cooldown4"></div>
        </div>
    </div>
</div>

<div id="shop">
    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'upgrades')">Mejoras</button>
        <button class="tablinks" onclick="openTab(event, 'particles')">Partículas</button>
        <button class="tablinks" onclick="openTab(event, 'skins')">Skins</button>
        <button class="tablinks" onclick="openTab(event, 'premium')">Premium</button>
        <button class="tablinks" onclick="closeShop(event)">Cerrar</button>
    </div>

    <div id="upgrades" class="tabcontent" style="display: block;">
        <div class="upgrade">
            <h3>Duplicar Coins <span id="doubleLevel">(Nivel 0)</span></h3>
            <p>Aumenta el multiplicador de coins por rebote</p>
            <p>Costo: <span class="cost">200</span> coins</p>
            <button id="buyDouble" onclick="buyUpgrade('double')">Comprar</button>
        </div>
        <div class="upgrade">
            <h3>Velocidad <span id="speedLevel">(Nivel 0)</span></h3>
            <p>Aumenta la velocidad de la bola</p>
            <p>Costo: <span class="cost">300</span> coins</p>
            <button id="buySpeed" onclick="buyUpgrade('speed')">Comprar</button>
        </div>
        <div class="upgrade">
            <h3>Tamaño <span id="sizeLevel">(Nivel 0)</span></h3>
            <p>Aumenta el tamaño de la bola</p>
            <p>Costo: <span class="cost">250</span> coins</p>
            <button id="buySize" onclick="buyUpgrade('size')">Comprar</button>
        </div>
        <div class="upgrade">
            <h3>Power-ups+ <span id="powerupsLevel">(Nivel 0)</span></h3>
            <p>Aumenta la frecuencia de power-ups</p>
            <p>Costo: <span class="cost">400</span> coins</p>
            <button id="buyPowerups" onclick="buyUpgrade('powerups')">Comprar</button>
        </div>
        <div class="upgrade">
            <h3>Combo+ <span id="comboLevel">(Nivel 0)</span></h3>
            <p>Aumenta la duración del combo</p>
            <p>Costo: <span class="cost">350</span> coins</p>
            <button id="buyCombo" onclick="buyUpgrade('combo')">Comprar</button>
        </div>
        <div class="upgrade">
            <h3>Magnetismo <span id="magnetLevel">(Nivel 0)</span></h3>
            <p>Atrae power-ups hacia ti</p>
            <p>Costo: <span class="cost">500</span> coins</p>
            <button id="buyMagnet" onclick="buyUpgrade('magnet')">Comprar</button>
        </div>
        <div class="upgrade">
            <h3>Rebote Crítico <span id="criticalLevel">(Nivel 0)</span></h3>
            <p>Aumenta chance de rebote crítico (x5 coins)</p>
            <p>Costo: <span class="cost">600</span> coins</p>
            <button id="buyCritical" onclick="buyUpgrade('critical')">Comprar</button>
        </div>
        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Bolas Múltiples</h3>
            <p>Añade una bola adicional al juego</p>
            <p>Costo: <span class="cost">1000</span> coins</p>
            <button id="buyMultiBall" onclick="buyUpgrade('multiBall')" disabled>Comprar</button>
        </div>
        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Habilidades Especiales</h3>
            <p>Desbloquea habilidades especiales activables</p>
            <p>Costo: <span class="cost">1200</span> coins</p>
            <button id="buyAbility" onclick="buyUpgrade('ability')" disabled>Comprar</button>
        </div>
        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Mejora de Habilidades</h3>
            <p>Reduce el tiempo de espera de habilidades</p>
            <p>Costo: <span class="cost">1500</span> coins</p>
            <button id="buyAbilityUpgrade" onclick="buyUpgrade('abilityUpgrade')" disabled>Comprar</button>
        </div>
        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Doble Salto</h3>
            <p>Permite a la bola saltar en el aire</p>
            <p>Costo: <span class="cost">800</span> coins</p>
            <button id="buyDoubleJump" onclick="buyUpgrade('doubleJump')" disabled>Comprar</button>
        </div>

        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Gravedad</h3>
            <p>Reduce la gravedad para saltos más largos</p>
            <p>Costo: <span class="cost">800</span> coins</p>
            <button id="buyGravity" onclick="buyUpgrade('gravity')" disabled>Comprar</button>
        </div>

        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Escudo</h3>
            <p>Protege la bola de obstáculos por un tiempo</p>
            <p>Costo: <span class="cost">800</span> coins</p>
            <button id="buyShield" onclick="buyUpgrade('shield')" disabled>Comprar</button>
        </div>

        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Dilatación Temporal</h3>
            <p>Ralentiza el tiempo para combos más largos</p>
            <p>Costo: <span class="cost">800</span> coins</p>
            <button id="buyTimeWarp" onclick="buyUpgrade('timeWarp')" disabled>Comprar</button>
        </div>
    </div>

    <div id="particles" class="tabcontent">
        <div class="upgrade">
            <h3>Tipo de Partículas</h3>
            <div class="particle-option">
                <input type="radio" id="particle1" name="particle" value="circles" checked>
                <label for="particle1">Círculos simples</label>
            </div>
            <div class="particle-option">
                <input type="radio" id="particle2" name="particle" value="squares">
                <label for="particle2">Cuadrados</label>
            </div>
            <div class="particle-option">
                <input type="radio" id="particle3" name="particle" value="stars">
                <label for="particle3">Estrellas</label>
            </div>
            <div class="particle-option">
                <input type="radio" id="particle4" name="particle" value="mixed">
                <label for="particle4">Mezclado</label>
            </div>
            <div class="particle-option">
                <input type="radio" id="particle5" name="particle" value="hearts">
                <label for="particle5">Corazones</label>
            </div>
        </div>

        <div class="upgrade">
            <h3>Efectos de Partículas</h3>
            <div>
                <input type="checkbox" id="trailEffect" checked>
                <label for="trailEffect">Estela de partículas</label>
            </div>
            <div>
                <input type="checkbox" id="burstEffect" checked>
                <label for="burstEffect">Explosión al rebotar</label>
            </div>
        </div>

        <div class="upgrade premium-feature">
            <div class="premium-badge">PREMIUM</div>
            <h3>Efectos Especiales</h3>
            <div>
                <input type="checkbox" id="glowEffect" disabled>
                <label for="glowEffect">Resplandor de la bola</label>
            </div>
            <div>
                <input type="checkbox" id="screenShake" disabled>
                <label for="screenShake">Vibración en rebotes</label>
            </div>
            <div>
                <input type="checkbox" id="rainEffect" disabled>
                <label for="rainEffect">Lluvia de partículas</label>
            </div>
            <div>
                <input type="checkbox" id="trailRainbow" disabled>
                <label for="trailRainbow">Estela arcoíris</label>
            </div>
            <button onclick="showPremiumShop()">Desbloquear Premium</button>
        </div>
    </div>

    <div id="skins" class="tabcontent">
        <h3>Selecciona una Skin</h3>
        <div>
            <div class="skin-option selected" onclick="selectSkin('default')">
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #ff0000, #aa0000);">
                </div>
                <div>Predeterminado</div>
                <div class="skin-rarity rarity-common">Común</div>
            </div>
            <div class="skin-option" onclick="selectSkin('fire')">
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #ff9900, #ff3300);">
                </div>
                <div>Fuego</div>
                <div class="skin-rarity rarity-common">Común</div>
            </div>
            <div class="skin-option" onclick="selectSkin('ice')">
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #00ccff, #0066ff);">
                </div>
                <div>Hielo</div>
                <div class="skin-rarity rarity-common">Común</div>
            </div>
            <div class="skin-option" onclick="selectSkin('earth')">
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #00aa00, #006600);">
                </div>
                <div>Tierra</div>
                <div class="skin-rarity rarity-rare">Rara</div>
            </div>
            <div class="skin-option" onclick="selectSkin('galaxy')">
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #9900ff, #330066);">
                </div>
                <div>Galaxia</div>
                <div class="skin-rarity rarity-rare">Rara</div>
            </div>
            <div class="skin-option" onclick="selectSkin('sun')">
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #ffff00, #ff9900);">
                </div>
                <div>Sol</div>
                <div class="skin-rarity rarity-rare">Rara</div>
            </div>
            <div class="skin-option premium-feature" onclick="selectSkin('dragon')">
                <div class="premium-badge">PREMIUM</div>
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #ff3366, #990033);">
                </div>
                <div>Dragón</div>
                <div class="skin-rarity rarity-premium">Premium</div>
            </div>
            <div class="skin-option premium-feature" onclick="selectSkin('rainbow')">
                <div class="premium-badge">PREMIUM</div>
                <div class="skin-preview"
                    style="background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);"></div>
                <div>Arcoíris</div>
                <div class="skin-rarity rarity-premium">Premium</div>
            </div>
            <div class="skin-option premium-feature" onclick="selectSkin('nebula')">
                <div class="premium-badge">PREMIUM</div>
                <div class="skin-preview"
                    style="background: radial-gradient(circle at 30% 30%, #9b59b6, #3498db, #2ecc71);"></div>
                <div>Nebulosa</div>
                <div class="skin-rarity rarity-premium">Premium</div>
            </div>
            <div class="skin-option premium-feature" onclick="selectSkin('golden')">
                <div class="premium-badge">PREMIUM</div>
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #ffd700, #c5a000);">
                </div>
                <div>Dorada</div>
                <div class="skin-rarity rarity-premium">Premium</div>
            </div>
            <div class="skin-option premium-feature" onclick="selectSkin('phantom')">
                <div class="premium-badge">PREMIUM</div>
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #8a2be2, #4b0082);">
                </div>
                <div>Fantasma</div>
                <div class="skin-rarity rarity-exclusive">Exclusiva</div>
            </div>
            <div class="skin-option premium-feature" onclick="selectSkin('cosmic')">
                <div class="premium-badge">PREMIUM</div>
                <div class="skin-preview" style="background: radial-gradient(circle at 30% 30%, #00ffff, #00008b);">
                </div>
                <div>Cósmica</div>
                <div class="skin-rarity rarity-exclusive">Exclusiva</div>
            </div>
        </div>
    </div>

    <div id="premium" class="tabcontent">
        <div class="upgrade">
            <h3>Desbloquear Premium</h3>
            <p>Accede a todas las características premium:</p>
            <ul>
                <li>Skins exclusivas</li>
                <li>Efectos visuales avanzados</li>
                <li>Personalización de colores</li>
                <li>Estadísticas detalladas</li>
                <li>Eventos especiales</li>
                <li>Habilidades especiales</li>
                <li>Bolas múltiples</li>
                <li>Partículas premium</li>
            </ul>
            <p>Costo: <span class="cost" id="premiumCost">5000</span> coins</p>
            <button id="buyPremium" onclick="buyPremium()">Comprar Premium</button>
            <p id="premiumProgress">Progreso: 0/5000 coins</p>
        </div>

        <div class="upgrade">
            <h3>Evento Especial: Jefe Final</h3>
            <p>Desbloquea un jefe final cada 10 niveles</p>
            <p>Costo: <span class="cost">1000</span> coins</p>
            <button id="buyBossEvent" onclick="buyUpgrade('bossEvent')">Desbloquear</button>
        </div>

        <div class="upgrade">
            <h3>Misiones Diarias</h3>
            <p>Desbloquea misiones diarias con recompensas</p>
            <p>Costo: <span class="cost">800</span> coins</p>
            <button id="buyMissions" onclick="buyUpgrade('missions')">Desbloquear</button>
        </div>
    </div>
</div>

<div id="config">
    <h3>Configuración</h3>
    <div class="config-row">
        <label for="themeToggle" class="config-label">Tema:</label>
        <button id="themeToggle">Modo Claro</button>
    </div>
    <div class="config-row premium-feature">
        <div class="premium-badge">PREMIUM</div>
        <label for="ballColor" class="config-label">Color de la bola: </label>
        <input type="color" id="ballColor" value="#ff0000" disabled>
    </div>
    <div class="config-row premium-feature">
        <div class="premium-badge">PREMIUM</div>
        <label for="hudColor" class="config-label">Color del HUD: </label>
        <input type="color" id="hudColor" value="#4CAF50">
    </div>
    <div class="config-row premium-feature">
        <div class="premium-badge">PREMIUM</div>
        <label for="particleColor" class="config-label">Color de partículas: </label>
        <input type="color" id="particleColor" value="#ffffff" disabled>
    </div>
    <div class="config-row">
        <label for="difficulty" class="config-label">Dificultad: </label>
        <select id="difficulty">
            <option value="easy">Fácil</option>
            <option value="normal" selected>Normal</option>
            <option value="hard">Difícil</option>
            <option value="extreme">Extremo</option>
        </select>
    </div>
    <div class="config-row">
        <label for="soundToggle" class="config-label">Sonidos: </label>
        <input type="checkbox" id="soundToggle" checked>
    </div>
    <div class="config-row">
        <label for="performanceMode" class="config-label">Modo rendimiento: </label>
        <input type="checkbox" id="performanceMode">
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
        <button onclick="applyConfig()">Aplicar</button>
        <button onclick="resetGame()">Reiniciar Juego</button>
        <button onclick="Game.toggleConfig()">Cerrar</button>
    </div>
</div>

<div id="achievements"></div>

<div id="premiumShop">
    <h2>¡Desbloquea Premium!</h2>
    <p>Obtén acceso a todas las características premium por <span id="dynamicPremiumCost">5000</span> coins</p>
    <button onclick="buyPremium()">Comprar Ahora</button>
    <button onclick="hidePremiumShop()">Más Tarde</button>
</div>

<div id="missions">
    <h3>Misiones Diarias</h3>
    <div id="missionList"></div>
</div>

<div id="premiumNotification">
    <h3>¡Contenido Premium Bloqueado!</h3>
    <p>Esta característica requiere una suscripción Premium.</p>
    <button onclick="showPremiumShop()">Ver Premium</button>
    <button onclick="hidePremiumNotification()">Cerrar</button>
</div>



<!-- Añade este div junto a los otros paneles (#shop, #config, etc.) -->
<div id="saveSlots">
    <h3>Slots de Guardado</h3>
    <div id="saveSlotsContainer">
        <div class="save-slot">
            <h4>Slot 1</h4>
            <div class="save-info">Vacío</div>
            <button onclick="Game.loadFromSlot(0)">Cargar</button>
            <button onclick="Game.saveGame(0, true)">Guardar</button>
            <button onclick="Game.deleteSave(0)">Borrar</button>
        </div>
        <div class="save-slot">
            <h4>Slot 2</h4>
            <div class="save-info">Vacío</div>
            <button onclick="Game.loadFromSlot(1)">Cargar</button>
            <button onclick="Game.saveGame(1, true)">Guardar</button>
            <button onclick="Game.deleteSave(1)">Borrar</button>
        </div>
        <div class="save-slot">
            <h4>Slot 3</h4>
            <div class="save-info">Vacío</div>
            <button onclick="Game.loadFromSlot(2)">Cargar</button>
            <button onclick="Game.saveGame(2, true)">Guardar</button>
            <button onclick="Game.deleteSave(2)">Borrar</button>
        </div>
        <div class="save-slot">
            <h4>Slot 4</h4>
            <div class="save-info">Vacío</div>
            <button onclick="Game.loadFromSlot(3)">Cargar</button>
            <button onclick="Game.saveGame(3, true)">Guardar</button>
            <button onclick="Game.deleteSave(3)">Borrar</button>
        </div>
    </div>
    <button onclick="Game.toggleSaveSlots()" style="margin-top: 10px;">Cerrar</button>
</div>

<audio id="bounceSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
<audio id="coinSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
<audio id="powerupSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"
    preload="auto"></audio>
<audio id="bossSound" src="https://assets.mixkit.co/sfx/preview/mixkit-ominous-drums-227.mp3" preload="auto"></audio>
<audio id="criticalSound" src="https://assets.mixkit.co/sfx/preview/mixkit-extra-bonus-in-a-video-game-2065.mp3"
    preload="auto"></audio>
<audio id="abilitySound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-spell-675.mp3" preload="auto"></audio>

<script>
    // Variables del juego con encapsulación
    const Game = (() => {
        // Variables privadas
        let canvas, ctx;
        let width, height;
        let coins = 0;
        let bounces = 0;
        let highscore = 0;
        let coinsMultiplier = 1;
        let particles = [];
        let particleType = 'circles';
        let particleColor = '#ffffff';
        let difficulty = 'normal';
        let gamePaused = false;
        let lastBounceTime = 0;
        let combo = 1;
        let comboTimeout = null;
        let comboTime = 2000;
        let level = 1;
        let maxLevel = 10;
        let bouncesToNextLevel = 50;
        let powerups = [];
        let obstacles = [];
        let soundEnabled = true;
        let premiumUnlocked = false;
        let lastFrameTime = 0;
        let fps = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let bossActive = false;
        let bossHealth = 0;
        let bossMaxHealth = 0;
        let boss = null;
        let criticalChance = 0;
        let missionsUnlocked = false;
        let missions = [];
        let rainParticles = [];
        let rainInterval = null;
        let loadingProgress = 0;
        let loadingInterval = null;
        let lightMode = false;
        let performanceMode = false;
        let premiumPrice = 10000; // Precio aumentado
        let premiumProgress = 0;
        let isMobile = false;
        let saveSlots = [null, null, null, null]; // 4 slots de guardado
        let currentSaveSlot = 0;
        let lastAutoSaveTime = 0;
        let autoSaveInterval = 30000; // 30 segundos
        let randomEvents = [];
        let lastRandomEventTime = 0;
        let randomEventInterval = 120000; // 2 minutos
        let activeAbilities = [];

        // Bolas del juego
        const balls = [{
            x: 0,
            y: 0,
            radius: 20,
            dx: 5,
            dy: 5,
            color: '#ff0000',
            skin: 'default',
            trail: [],
            isInvincible: false,
            magnetRadius: 0,
            abilityActive: false
        }];

        // Habilidades
        const abilities = {
            invincibility: { cooldown: 0, maxCooldown: 300, active: false, baseCooldown: 300 },
            explosion: { cooldown: 0, maxCooldown: 450, active: false, baseCooldown: 450 },
            slow: { cooldown: 0, maxCooldown: 600, active: false, baseCooldown: 600 },
            magnet: { cooldown: 0, maxCooldown: 300, active: false, baseCooldown: 300 },
            doubleJump: { cooldown: 0, maxCooldown: 400, active: false, baseCooldown: 400 },
            gravity: { cooldown: 0, maxCooldown: 500, active: false, baseCooldown: 500 },
            shield: { cooldown: 0, maxCooldown: 600, active: false, baseCooldown: 600 },
            timeWarp: { cooldown: 0, maxCooldown: 800, active: false, baseCooldown: 800 }
        };

        // Mejoras
        const upgrades = {
            double: { level: 0, maxLevel: 10, baseCost: 200, costIncrease: 1.5 },
            speed: { level: 0, maxLevel: 10, baseCost: 300, costIncrease: 1.5 },
            size: { level: 0, maxLevel: 10, baseCost: 250, costIncrease: 1.5 },
            powerups: { level: 0, maxLevel: 5, baseCost: 400, costIncrease: 1.5 },
            combo: { level: 0, maxLevel: 5, baseCost: 350, costIncrease: 1.5 },
            magnet: { level: 0, maxLevel: 5, baseCost: 500, costIncrease: 1.5 },
            critical: { level: 0, maxLevel: 10, baseCost: 600, costIncrease: 1.5 },
            bossEvent: false,
            ability: false,
            abilityUpgrade: { level: 0, maxLevel: 10, baseCost: 1500, costIncrease: 1.5 },
            missions: false,
            multiBall: { level: 0, maxLevel: 5, baseCost: 1000, costIncrease: 2 },
            doubleJump: false,
            gravity: false,
            shield: false,
            timeWarp: false
        };

        // Logros
        const achievements = {
            firstBounce: false,
            hundredBounces: false,
            thousandBounces: false,
            firstCoin: false,
            hundredCoins: false,
            thousandCoins: false,
            firstUpgrade: false,
            allUpgrades: false,
            maxCombo: false,
            premiumUnlocked: false,
            bossDefeated: false,
            criticalHit: false,
            abilityUsed: false,
            missionCompleted: false,
            multiBallUsed: false,
            skinUnlocked: false,
            premiumSkinUsed: false,
            eventCompleted: false,
            slotSaved: false,
            maxLevelReached: false
        };

        // Elementos UI
        const uiElements = {
            coinsDisplay: document.getElementById('coins'),
            bouncesDisplay: document.getElementById('bounces'),
            comboDisplay: document.getElementById('combo'),
            comboPopup: document.getElementById('comboDisplay'),
            levelDisplay: document.getElementById('level'),
            highscoreDisplay: document.getElementById('highscore'),
            coinMultiplierDisplay: document.getElementById('coinMultiplier'),
            shopBtn: document.getElementById('shopBtn'),
            configBtn: document.getElementById('configBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            statsBtn: document.getElementById('statsBtn'),
            shop: document.getElementById('shop'),
            configPanel: document.getElementById('config'),
            ballColorInput: document.getElementById('ballColor'),
            hudColorInput: document.getElementById('hudColor'),
            particleColorInput: document.getElementById('particleColor'),
            difficultySelect: document.getElementById('difficulty'),
            soundToggle: document.getElementById('soundToggle'),
            performanceModeToggle: document.getElementById('performanceMode'),
            achievementsPopup: document.getElementById('achievements'),
            premiumShop: document.getElementById('premiumShop'),
            dynamicPremiumCost: document.getElementById('dynamicPremiumCost'),
            premiumCostDisplay: document.getElementById('premiumCost'),
            premiumProgressDisplay: document.getElementById('premiumProgress'),
            statsPanel: document.getElementById('stats'),
            fpsCounter: document.getElementById('fpsCounter'),
            particleCounter: document.getElementById('particleCounter'),
            bossHealthBar: document.getElementById('bossHealthBar'),
            bossHealthContainer: document.getElementById('bossHealth'),
            missionsPanel: document.getElementById('missions'),
            missionList: document.getElementById('missionList'),
            missionToggle: document.getElementById('missionToggle'),
            loadingScreen: document.getElementById('loadingScreen'),
            loadingPercent: document.getElementById('loadingPercent'),
            themeToggle: document.getElementById('themeToggle'),
            premiumNotification: document.getElementById('premiumNotification'),
            abilityButtons: [
                document.getElementById('ability1'),
                document.getElementById('ability2'),
                document.getElementById('ability3'),
                document.getElementById('ability4')
            ],
            cooldownElements: [
                document.getElementById('cooldown1'),
                document.getElementById('cooldown2'),
                document.getElementById('cooldown3'),
                document.getElementById('cooldown4')
            ],
            saveNotification: document.createElement('div'),
            eventNotification: document.createElement('div'),
            saveSlots: document.getElementById('saveSlots'),
            saveBtn: document.getElementById('saveBtn')
        };

        // Elementos de audio
        const sounds = {
            bounce: document.getElementById('bounceSound'),
            coin: document.getElementById('coinSound'),
            powerup: document.getElementById('powerupSound'),
            boss: document.getElementById('bossSound'),
            critical: document.getElementById('criticalSound'),
            ability: document.getElementById('abilitySound'),
            save: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3'),
            event: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3')
        };

        // Eventos aleatorios
        const randomEventsList = [
            {
                name: "Lluvia de monedas",
                description: "¡Monedas caen del cielo! Atrapa todas las que puedas.",
                duration: 10000,
                effect: () => {
                    // Crear muchas monedas
                    for (let i = 0; i < 20; i++) {
                        powerups.push({
                            x: Math.random() * width,
                            y: -20,
                            radius: 15,
                            type: 'coin',
                            life: 500,
                            color: 'gold',
                            vy: Math.random() * 3 + 2
                        });
                    }
                    return { message: "¡Lluvia de monedas!", color: "gold" };
                },
                particles: { color: "gold", count: 100 }
            },
            {
                name: "Velocidad aumentada",
                description: "¡La pelota se mueve más rápido por un tiempo!",
                duration: 8000,
                effect: () => {
                    balls.forEach(ball => {
                        ball.dx *= 1.5;
                        ball.dy *= 1.5;
                    });
                    return { message: "¡Velocidad aumentada!", color: "#ff6600" };
                },
                particles: { color: "#ff6600", count: 50 }
            },
            {
                name: "Iman supercargado",
                description: "¡Atrae power-ups desde más lejos!",
                duration: 12000,
                effect: () => {
                    const originalMagnet = balls[0].magnetRadius;
                    balls.forEach(ball => {
                        ball.magnetRadius = 500;
                    });
                    return { message: "¡Iman supercargado!", color: "#00ffff" };
                },
                particles: { color: "#00ffff", count: 80 }
            },
            {
                name: "Multiplicador de combo",
                description: "¡Tus combos valen el doble!",
                duration: 15000,
                effect: () => {
                    return { message: "¡Combo x2 activado!", color: "#00ff00" };
                },
                particles: { color: "#00ff00", count: 60 }
            },
            {
                name: "Invencibilidad temporal",
                description: "¡No puedes perder durante un tiempo!",
                duration: 10000,
                effect: () => {
                    balls.forEach(ball => {
                        ball.isInvincible = true;
                        const originalColor = ball.color;
                        ball.color = '#ffffff';
                    });
                    return { message: "¡Invencibilidad!", color: "#ffffff" };
                },
                particles: { color: "#ffffff", count: 120 }
            }
        ];

        // Métodos públicos
        return {
            init: function () {
                canvas = document.getElementById('gameCanvas');
                ctx = canvas.getContext('2d');
                this.detectMobile();
                this.setupEventListeners();
                this.setupNotifications();
                this.simulateLoading();
            },

            detectMobile: function () {
                isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            },

            setupNotifications: function () {
                // Configurar notificación de guardado
                uiElements.saveNotification.style.position = 'fixed';
                uiElements.saveNotification.style.bottom = '20px';
                uiElements.saveNotification.style.left = '50%';
                uiElements.saveNotification.style.transform = 'translateX(-50%)';
                uiElements.saveNotification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                uiElements.saveNotification.style.color = 'white';
                uiElements.saveNotification.style.padding = '10px 20px';
                uiElements.saveNotification.style.borderRadius = '5px';
                uiElements.saveNotification.style.zIndex = '1000';
                uiElements.saveNotification.style.display = 'none';
                uiElements.saveNotification.style.transition = 'all 0.3s';
                document.body.appendChild(uiElements.saveNotification);

                // Configurar notificación de evento
                uiElements.eventNotification.style.position = 'fixed';
                uiElements.eventNotification.style.top = '20px';
                uiElements.eventNotification.style.left = '50%';
                uiElements.eventNotification.style.transform = 'translateX(-50%)';
                uiElements.eventNotification.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
                uiElements.eventNotification.style.color = 'gold';
                uiElements.eventNotification.style.padding = '15px 30px';
                uiElements.eventNotification.style.borderRadius = '5px';
                uiElements.eventNotification.style.zIndex = '1000';
                uiElements.eventNotification.style.display = 'none';
                uiElements.eventNotification.style.transition = 'all 0.3s';
                uiElements.eventNotification.style.textAlign = 'center';
                uiElements.eventNotification.style.boxShadow = '0 0 15px gold';
                document.body.appendChild(uiElements.eventNotification);
            },

            simulateLoading: function () {
                loadingInterval = setInterval(() => {
                    loadingProgress += Math.random() * 10;
                    if (loadingProgress >= 100) {
                        loadingProgress = 100;
                        clearInterval(loadingInterval);
                        setTimeout(() => {
                            uiElements.loadingScreen.style.display = 'none';
                            this.loadGame();
                        }, 500);
                    }
                    uiElements.loadingPercent.textContent = Math.min(100, Math.floor(loadingProgress)) + '%';
                }, 100);
            },

            setupEventListeners: function () {
                // Event listeners UI
                uiElements.shopBtn.addEventListener('click', () => this.toggleShop());
                uiElements.configBtn.addEventListener('click', () => this.toggleConfig());
                uiElements.pauseBtn.addEventListener('click', () => this.togglePause());
                uiElements.statsBtn.addEventListener('click', () => this.toggleStats());
                uiElements.themeToggle.addEventListener('click', () => this.toggleTheme());
                uiElements.missionToggle.addEventListener('click', () => this.toggleMissions());
                uiElements.performanceModeToggle.addEventListener('change', () => this.updatePerformanceMode());
                uiElements.saveBtn.addEventListener('click', () => this.toggleSaveSlots());

                // Event listeners para habilidades
                uiElements.abilityButtons[0].addEventListener('click', () => this.activateAbility('invincibility'));
                uiElements.abilityButtons[1].addEventListener('click', () => this.activateAbility('explosion'));
                uiElements.abilityButtons[2].addEventListener('click', () => this.activateAbility('slow'));
                uiElements.abilityButtons[3].addEventListener('click', () => this.activateAbility('magnet'));

                // Event listeners para teclas de habilidad
                document.addEventListener('keydown', (e) => {
                    if (gamePaused || !upgrades.ability) return;

                    switch (e.key.toLowerCase()) {
                        case 'q': this.activateAbility('invincibility'); break;
                        case 'w': this.activateAbility('explosion'); break;
                        case 'e': this.activateAbility('slow'); break;
                        case 'r': this.activateAbility('magnet'); break;
                        case 'a': if (upgrades.doubleJump) this.activateAbility('doubleJump'); break;
                        case 's': if (upgrades.gravity) this.activateAbility('gravity'); break;
                        case 'd': if (upgrades.shield) this.activateAbility('shield'); break;
                        case 'f': if (upgrades.timeWarp) this.activateAbility('timeWarp'); break;
                    }
                });

                // Event listeners para tipos de partículas
                document.querySelectorAll('input[name="particle"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        particleType = radio.value;
                        this.saveGame();
                    });
                });

                // Event listener para redimensionamiento
                window.addEventListener('resize', () => this.resizeCanvas());

                // Event listeners táctiles para móviles
                if (isMobile) {
                    canvas.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const rect = canvas.getBoundingClientRect();
                        balls[0].x = e.touches[0].clientX - rect.left;
                        balls[0].y = e.touches[0].clientY - rect.top;
                    }, false);
                }
            },

            // Dentro del objeto Game, añade estos métodos:
            toggleSaveSlots: function () {
                if (uiElements.saveSlots.style.display === 'block') {
                    uiElements.saveSlots.style.display = 'none';
                } else {
                    uiElements.saveSlots.style.display = 'block';
                    uiElements.shop.style.display = 'none';
                    uiElements.configPanel.style.display = 'none';
                    uiElements.statsPanel.style.display = 'none';
                    uiElements.missionsPanel.style.display = 'none';
                    this.updateSaveSlotsUI();
                }
            },

            updateSaveSlotsUI: function () {
                const saveSlotsElements = document.querySelectorAll('.save-slot');

                saveSlots.forEach((slot, index) => {
                    const slotElement = saveSlotsElements[index];
                    const infoElement = slotElement.querySelector('.save-info');

                    if (slot) {
                        const date = new Date(slot.timestamp || Date.now());
                        infoElement.innerHTML = `
                Nivel: ${slot.level || 1}<br>
                Rebotes: ${slot.bounces || 0}<br>
                Monedas: ${slot.coins || 0}<br>
                Guardado: ${date.toLocaleString()}
            `;
                        slotElement.style.borderLeftColor = slot.premiumUnlocked ? 'gold' : 'var(--hud-color)';
                    } else {
                        infoElement.textContent = 'Vacío';
                        slotElement.style.borderLeftColor = 'var(--hud-color)';
                    }
                });
            },

            deleteSave: function (slotIndex) {
                if (saveSlots[slotIndex] && confirm('¿Estás seguro de que quieres borrar este guardado?')) {
                    saveSlots[slotIndex] = null;
                    localStorage.setItem('circleBounceSaveSlots', JSON.stringify(saveSlots));
                    this.updateSaveSlotsUI();
                    this.showSaveNotification('Partida borrada del slot ' + (slotIndex + 1));
                }
            },

            // Funciones de gestión del juego
            loadGame: function () {
                const savedGame = localStorage.getItem('circleBounceGame');
                const savedSlots = localStorage.getItem('circleBounceSaveSlots');

                if (savedSlots) {
                    try {
                        saveSlots = JSON.parse(savedSlots);
                    } catch (e) {
                        console.error("Error al cargar slots de guardado:", e);
                    }
                }

                if (!savedGame) {
                    this.initializeGame();
                    return;
                }

                try {
                    const gameData = JSON.parse(savedGame);

                    // Validar datos cargados
                    if (typeof gameData !== 'object') throw new Error("Datos de juego inválidos");

                    // Cargar datos básicos
                    coins = this.validateNumber(gameData.coins, 0);
                    bounces = this.validateNumber(gameData.bounces, 0);
                    highscore = this.validateNumber(gameData.highscore, 0);
                    level = this.validateNumber(gameData.level, 1);
                    maxLevel = this.validateNumber(gameData.maxLevel, 10);
                    bouncesToNextLevel = this.validateNumber(gameData.bouncesToNextLevel, 50);
                    criticalChance = this.validateNumber(gameData.criticalChance, 0);
                    premiumProgress = this.validateNumber(gameData.premiumProgress, 0);
                    currentSaveSlot = this.validateNumber(gameData.currentSaveSlot, 0);

                    // Cargar configuraciones
                    lightMode = !!gameData.lightMode;
                    performanceMode = !!gameData.performanceMode;
                    soundEnabled = gameData.soundEnabled !== false;
                    premiumUnlocked = !!gameData.premiumUnlocked;
                    missionsUnlocked = !!gameData.missionsUnlocked;

                    // Aplicar configuraciones visuales
                    if (lightMode) {
                        document.body.classList.add('light-mode');
                        uiElements.themeToggle.textContent = 'Modo Oscuro';
                    }

                    uiElements.performanceModeToggle.checked = performanceMode;
                    uiElements.soundToggle.checked = soundEnabled;

                    // Cargar mejoras con validación
                    if (gameData.upgrades) {
                        Object.keys(upgrades).forEach(key => {
                            if (gameData.upgrades[key] !== undefined) {
                                if (typeof upgrades[key] === 'object' && typeof gameData.upgrades[key] === 'object') {
                                    upgrades[key].level = this.validateNumber(gameData.upgrades[key].level, 0);
                                } else {
                                    upgrades[key] = gameData.upgrades[key];
                                }
                            }
                        });
                    }

                    // Cargar logros
                    if (gameData.achievements) {
                        Object.keys(achievements).forEach(key => {
                            if (gameData.achievements[key] !== undefined) {
                                achievements[key] = !!gameData.achievements[key];
                            }
                        });
                    }

                    // Aplicar mejoras compradas
                    if (upgrades.double.level > 0) coinsMultiplier = 1 + upgrades.double.level * 0.5;
                    if (upgrades.speed.level > 0) {
                        balls.forEach(ball => {
                            const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                            const angle = Math.atan2(ball.dy, ball.dx);
                            ball.dx = Math.cos(angle) * speed * (1 + upgrades.speed.level * 0.3);
                            ball.dy = Math.sin(angle) * speed * (1 + upgrades.speed.level * 0.3);
                        });
                    }
                    if (upgrades.size.level > 0) {
                        balls.forEach(ball => {
                            ball.radius = 20 * (1 + upgrades.size.level * 0.3);
                        });
                    }
                    if (upgrades.combo.level > 0) comboTime = 2000 + upgrades.combo.level * 500;
                    if (upgrades.magnet.level > 0) {
                        balls.forEach(ball => {
                            ball.magnetRadius = 100 + upgrades.magnet.level * 50;
                        });
                    }
                    if (upgrades.critical.level > 0) criticalChance = upgrades.critical.level * 0.05;
                    if (upgrades.ability) {
                        uiElements.abilityButtons.forEach(btn => btn.disabled = false);
                        this.checkAchievement('abilityUsed');
                    }
                    if (upgrades.missions) {
                        missionsUnlocked = true;
                        this.generateMissions();
                    }
                    if (upgrades.multiBall.level > 0) {
                        for (let i = 1; i <= upgrades.multiBall.level; i++) {
                            this.addNewBall();
                        }
                        this.checkAchievement('multiBallUsed');
                    }
                    if (upgrades.doubleJump) {
                        this.checkAchievement('abilityUsed');
                    }
                    if (upgrades.gravity) {
                        this.checkAchievement('abilityUsed');
                    }
                    if (upgrades.shield) {
                        this.checkAchievement('abilityUsed');
                    }
                    if (upgrades.timeWarp) {
                        this.checkAchievement('abilityUsed');
                    }

                    // Aplicar skin y color HUD
                    if (gameData.skin) {
                        this.applySkin(gameData.skin);
                    }
                    if (gameData.hudColor) {
                        this.applyHudColor(gameData.hudColor);
                    }

                    // Habilitar características premium
                    if (premiumUnlocked) {
                        this.enablePremiumFeatures();
                    }

                    // Inicializar juego
                    this.resizeCanvas();
                    this.updateUI();
                    this.updateShopButtons();
                    this.updatePremiumProgress();

                } catch (e) {
                    console.error("Error al cargar partida:", e);
                    localStorage.removeItem('circleBounceGame');
                    this.initializeGame();
                }
            },

            initializeGame: function () {
                this.resizeCanvas();
                balls[0].x = width / 2;
                balls[0].y = height / 2;
                this.updateUI();
                this.updateShopButtons();
            },

            closeShop: function (event, action) {
                event.preventDefault(); // Previene el comportamiento por defecto
                this.toggleShop(); // Llama a la función existente que cierra la tienda
            },

            saveGame: function (slot = null, manual = false) {
                const saveData = {
                    coins: coins,
                    bounces: bounces,
                    highscore: Math.max(highscore, bounces),
                    upgrades: upgrades,
                    level: level,
                    maxLevel: maxLevel,
                    bouncesToNextLevel: bouncesToNextLevel,
                    achievements: achievements,
                    skin: balls[0].skin,
                    premiumUnlocked: premiumUnlocked,
                    criticalChance: criticalChance,
                    missionsUnlocked: missionsUnlocked,
                    hudColor: getComputedStyle(document.documentElement).getPropertyValue('--hud-color').trim(),
                    lightMode: lightMode,
                    performanceMode: performanceMode,
                    soundEnabled: soundEnabled,
                    premiumPrice: premiumPrice,
                    premiumProgress: premiumProgress,
                    currentSaveSlot: currentSaveSlot,
                    missions: missions,
                    timestamp: Date.now(),  // Añade la marca de tiempo
                    balls: balls.map(ball => ({
                        x: ball.x,
                        y: ball.y,
                        dx: ball.dx,
                        dy: ball.dy,
                        radius: ball.radius,
                        color: ball.color,
                        skin: ball.skin
                    }))
                };


                try {
                    // Guardar juego principal
                    localStorage.setItem('circleBounceGame', JSON.stringify(saveData));

                    // Guardar en slot específico si se especifica
                    if (slot !== null) {
                        saveSlots[slot] = saveData;
                        localStorage.setItem('circleBounceSaveSlots', JSON.stringify(saveSlots));
                        currentSaveSlot = slot;
                        this.checkAchievement('slotSaved');

                        if (manual) {
                            this.showSaveNotification(`Partida guardada en slot ${slot + 1}`);
                        }
                    }
                } catch (e) {
                    console.error("Error al guardar partida:", e);
                    // Intentar con menos datos si hay error de cuota
                    const minimalData = {
                        coins: coins,
                        bounces: bounces,
                        highscore: Math.max(highscore, bounces),
                        upgrades: upgrades,
                        level: level
                    };
                    localStorage.setItem('circleBounceGame', JSON.stringify(minimalData));
                }
            },

            loadFromSlot: function (slot) {
                if (saveSlots[slot]) {
                    const gameData = saveSlots[slot];

                    // Cargar datos básicos
                    coins = this.validateNumber(gameData.coins, 0);
                    bounces = this.validateNumber(gameData.bounces, 0);
                    highscore = this.validateNumber(gameData.highscore, 0);
                    level = this.validateNumber(gameData.level, 1);
                    maxLevel = this.validateNumber(gameData.maxLevel, 10);
                    bouncesToNextLevel = this.validateNumber(gameData.bouncesToNextLevel, 50);
                    criticalChance = this.validateNumber(gameData.criticalChance, 0);
                    premiumProgress = this.validateNumber(gameData.premiumProgress, 0);
                    currentSaveSlot = slot;

                    // Cargar configuraciones
                    lightMode = !!gameData.lightMode;
                    performanceMode = !!gameData.performanceMode;
                    soundEnabled = gameData.soundEnabled !== false;
                    premiumUnlocked = !!gameData.premiumUnlocked;
                    missionsUnlocked = !!gameData.missionsUnlocked;

                    // Cargar mejoras
                    if (gameData.upgrades) {
                        Object.keys(upgrades).forEach(key => {
                            if (gameData.upgrades[key] !== undefined) {
                                if (typeof upgrades[key] === 'object' && typeof gameData.upgrades[key] === 'object') {
                                    upgrades[key].level = this.validateNumber(gameData.upgrades[key].level, 0);
                                } else {
                                    upgrades[key] = gameData.upgrades[key];
                                }
                            }
                        });
                    }

                    // Cargar logros
                    if (gameData.achievements) {
                        Object.keys(achievements).forEach(key => {
                            if (gameData.achievements[key] !== undefined) {
                                achievements[key] = !!gameData.achievements[key];
                            }
                        });
                    }

                    // Cargar misiones
                    if (gameData.missions) {
                        missions = gameData.missions;
                    } else {
                        this.generateMissions();
                    }

                    // Cargar bolas
                    if (gameData.balls && gameData.balls.length > 0) {
                        balls.length = 0;
                        gameData.balls.forEach(ballData => {
                            balls.push({
                                x: ballData.x,
                                y: ballData.y,
                                dx: ballData.dx,
                                dy: ballData.dy,
                                radius: ballData.radius,
                                color: ballData.color,
                                skin: ballData.skin,
                                trail: [],
                                isInvincible: false,
                                magnetRadius: upgrades.magnet.level > 0 ? 100 + upgrades.magnet.level * 50 : 0,
                                abilityActive: false
                            });
                        });
                    }

                    // Aplicar configuraciones visuales
                    if (lightMode) {
                        document.body.classList.add('light-mode');
                        uiElements.themeToggle.textContent = 'Modo Oscuro';
                    } else {
                        document.body.classList.remove('light-mode');
                        uiElements.themeToggle.textContent = 'Modo Claro';
                    }

                    uiElements.performanceModeToggle.checked = performanceMode;
                    uiElements.soundToggle.checked = soundEnabled;

                    // Aplicar skin y color HUD
                    if (gameData.skin) {
                        this.applySkin(gameData.skin);
                    }
                    if (gameData.hudColor) {
                        this.applyHudColor(gameData.hudColor);
                    }

                    // Habilitar características premium
                    if (premiumUnlocked) {
                        this.enablePremiumFeatures();
                    }

                    // Actualizar UI
                    this.updateUI();
                    this.updateShopButtons();
                    this.updatePremiumProgress();
                    this.updateMissionsUI();

                    this.showSaveNotification(`Partida cargada desde slot ${slot + 1}`);
                }
            },

            showSaveNotification: function (message) {
                uiElements.saveNotification.textContent = message;
                uiElements.saveNotification.style.display = 'block';
                uiElements.saveNotification.style.opacity = '1';

                if (soundEnabled) {
                    sounds.save.currentTime = 0;
                    sounds.save.play().catch(e => console.log("Error al reproducir sonido:", e));
                }

                setTimeout(() => {
                    uiElements.saveNotification.style.opacity = '0';
                    setTimeout(() => {
                        uiElements.saveNotification.style.display = 'none';
                    }, 300);
                }, 2000);
            },

            validateNumber: function (value, defaultValue) {
                const num = Number(value);
                return isNaN(num) ? defaultValue : Math.max(0, num);
            },

            // Funciones de UI
            toggleShop: function () {
                if (uiElements.shop.style.display === 'block') {
                    uiElements.shop.style.display = 'none';
                } else {
                    uiElements.shop.style.display = 'block';
                    uiElements.configPanel.style.display = 'none';
                    uiElements.statsPanel.style.display = 'none';
                    uiElements.missionsPanel.style.display = 'none';
                    this.updateShopButtons();
                    this.updatePremiumProgress();
                }
            },

            toggleConfig: function () {
                if (uiElements.configPanel.style.display === 'block') {
                    uiElements.configPanel.style.display = 'none';
                } else {
                    uiElements.configPanel.style.display = 'block';
                    uiElements.shop.style.display = 'none';
                    uiElements.statsPanel.style.display = 'none';
                    uiElements.missionsPanel.style.display = 'none';
                }
            },

            toggleStats: function () {
                if (uiElements.statsPanel.style.display === 'block') {
                    uiElements.statsPanel.style.display = 'none';
                } else {
                    uiElements.statsPanel.style.display = 'block';
                    uiElements.shop.style.display = 'none';
                    uiElements.configPanel.style.display = 'none';
                    uiElements.missionsPanel.style.display = 'none';
                }
            },

            toggleMissions: function () {
                if (!missionsUnlocked) {
                    this.showComboMessage('Desbloquea misiones en la tienda Premium', '#ff9900');
                    return;
                }

                if (uiElements.missionsPanel.style.display === 'block') {
                    uiElements.missionsPanel.style.display = 'none';
                } else {
                    uiElements.missionsPanel.style.display = 'block';
                    uiElements.shop.style.display = 'none';
                    uiElements.configPanel.style.display = 'none';
                    uiElements.statsPanel.style.display = 'none';
                    this.updateMissionsUI();
                }
            },

            togglePause: function () {
                gamePaused = !gamePaused;
                uiElements.pauseBtn.textContent = gamePaused ? 'Continuar' : 'Pausa';

                if (!gamePaused) {
                    lastBounceTime = Date.now();
                    lastFrameTime = performance.now();
                    this.gameLoop();
                }
            },

            toggleTheme: function () {
                lightMode = !lightMode;
                uiElements.themeToggle.textContent = lightMode ? 'Modo Oscuro' : 'Modo Claro';
                document.body.classList.toggle('light-mode', lightMode);
                this.saveGame();
            },

            updatePerformanceMode: function () {
                performanceMode = uiElements.performanceModeToggle.checked;
                this.saveGame();
            },

            openTab: function (evt, tabName) {
                const tabcontent = document.getElementsByClassName('tabcontent');
                for (let i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = 'none';
                }

                const tablinks = document.getElementsByClassName('tablinks');
                for (let i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(' active', '');
                }

                document.getElementById(tabName).style.display = 'block';
                evt.currentTarget.className += ' active';
            },

            updateUI: function () {
                // Actualizar récord si es necesario
                highscore = Math.max(highscore, bounces);

                uiElements.coinsDisplay.textContent = coins;
                uiElements.bouncesDisplay.textContent = bounces;
                uiElements.comboDisplay.textContent = combo + 'x';
                uiElements.levelDisplay.textContent = level;
                uiElements.highscoreDisplay.textContent = highscore;
                uiElements.coinMultiplierDisplay.textContent = upgrades.double.level > 0 ? ` (x${coinsMultiplier.toFixed(1)})` : '';

                // Verificar logros relacionados con cantidades
                if (bounces >= 1 && !achievements.firstBounce) {
                    this.checkAchievement('firstBounce');
                }
                if (bounces >= 100 && !achievements.hundredBounces) {
                    this.checkAchievement('hundredBounces');
                }
                if (bounces >= 1000 && !achievements.thousandBounces) {
                    this.checkAchievement('thousandBounces');
                }
                if (coins >= 1 && !achievements.firstCoin) {
                    this.checkAchievement('firstCoin');
                }
                if (coins >= 100 && !achievements.hundredCoins) {
                    this.checkAchievement('hundredCoins');
                }
                if (coins >= 1000 && !achievements.thousandCoins) {
                    this.checkAchievement('thousandCoins');
                }
                if (combo >= 10 && !achievements.maxCombo) {
                    this.checkAchievement('maxCombo');
                }
                if (balls.length > 1 && !achievements.multiBallUsed) {
                    this.checkAchievement('multiBallUsed');
                }
                if (level >= maxLevel && !achievements.maxLevelReached) {
                    this.checkAchievement('maxLevelReached');
                }

                this.saveGame();
            },

            updateShopButtons: function () {
                // Actualizar botones de mejoras normales
                document.getElementById('buyDouble').disabled = upgrades.double.level >= upgrades.double.maxLevel || coins < this.getUpgradeCost('double');
                document.getElementById('buySpeed').disabled = upgrades.speed.level >= upgrades.speed.maxLevel || coins < this.getUpgradeCost('speed');
                document.getElementById('buySize').disabled = upgrades.size.level >= upgrades.size.maxLevel || coins < this.getUpgradeCost('size');
                document.getElementById('buyPowerups').disabled = upgrades.powerups.level >= upgrades.powerups.maxLevel || coins < this.getUpgradeCost('powerups');
                document.getElementById('buyCombo').disabled = upgrades.combo.level >= upgrades.combo.maxLevel || coins < this.getUpgradeCost('combo');
                document.getElementById('buyMagnet').disabled = upgrades.magnet.level >= upgrades.magnet.maxLevel || coins < this.getUpgradeCost('magnet');
                document.getElementById('buyCritical').disabled = upgrades.critical.level >= upgrades.critical.maxLevel || coins < this.getUpgradeCost('critical');

                // Actualizar botones premium
                document.getElementById('buyPremium').disabled = premiumUnlocked || coins < premiumPrice;
                document.getElementById('buyBossEvent').disabled = upgrades.bossEvent || coins < 1000;
                document.getElementById('buyAbility').disabled = !premiumUnlocked || upgrades.ability || coins < 1200;
                document.getElementById('buyMissions').disabled = !premiumUnlocked || upgrades.missions || coins < 800;
                document.getElementById('buyMultiBall').disabled = !premiumUnlocked || upgrades.multiBall.level >= upgrades.multiBall.maxLevel || coins < this.getUpgradeCost('multiBall');
                document.getElementById('buyAbilityUpgrade').disabled = !premiumUnlocked || !upgrades.ability || upgrades.abilityUpgrade.level >= upgrades.abilityUpgrade.maxLevel || coins < this.getUpgradeCost('abilityUpgrade');
                document.getElementById('buyDoubleJump').disabled = !premiumUnlocked || upgrades.doubleJump || coins < 800;
                document.getElementById('buyGravity').disabled = !premiumUnlocked || upgrades.gravity || coins < 800;
                document.getElementById('buyShield').disabled = !premiumUnlocked || upgrades.shield || coins < 800;
                document.getElementById('buyTimeWarp').disabled = !premiumUnlocked || upgrades.timeWarp || coins < 800;


                // Actualizar textos de nivel y costo
                document.getElementById('doubleLevel').textContent = `(Nivel ${upgrades.double.level}/${upgrades.double.maxLevel})`;
                document.getElementById('speedLevel').textContent = `(Nivel ${upgrades.speed.level}/${upgrades.speed.maxLevel})`;
                document.getElementById('sizeLevel').textContent = `(Nivel ${upgrades.size.level}/${upgrades.size.maxLevel})`;
                document.getElementById('powerupsLevel').textContent = `(Nivel ${upgrades.powerups.level}/${upgrades.powerups.maxLevel})`;
                document.getElementById('comboLevel').textContent = `(Nivel ${upgrades.combo.level}/${upgrades.combo.maxLevel})`;
                document.getElementById('magnetLevel').textContent = `(Nivel ${upgrades.magnet.level}/${upgrades.magnet.maxLevel})`;
                document.getElementById('criticalLevel').textContent = `(Nivel ${upgrades.critical.level}/${upgrades.critical.maxLevel})`;

                // Actualizar textos de costo
                document.querySelectorAll('.cost').forEach(el => {
                    const parentId = el.parentNode.parentNode.id;
                    if (parentId) {
                        const upgradeType = parentId.replace('buy', '').toLowerCase();
                        if (upgrades[upgradeType] && typeof upgrades[upgradeType] === 'object') {
                            const cost = this.getUpgradeCost(upgradeType);
                            el.textContent = cost;
                            el.style.color = coins >= cost ? 'var(--hud-color)' : '#ff3333';
                        } else {
                            const cost = parseInt(el.textContent);
                            el.style.color = coins >= cost ? 'var(--hud-color)' : '#ff3333';
                        }
                    }
                });
            },

            getUpgradeCost: function (upgradeType) {
                if (!upgrades[upgradeType] || typeof upgrades[upgradeType] !== 'object') return 0;

                const baseCost = upgrades[upgradeType].baseCost || 0;
                const costIncrease = upgrades[upgradeType].costIncrease || 1;
                const level = upgrades[upgradeType].level || 0;

                return Math.floor(baseCost * Math.pow(costIncrease, level));
            },

            buyUpgrade: function (type) {
                let cost = 0;
                let bought = false;

                switch (type) {
                    case 'double':
                        cost = this.getUpgradeCost('double');
                        if (coins >= cost && upgrades.double.level < upgrades.double.maxLevel) {
                            coins -= cost;
                            upgrades.double.level++;
                            coinsMultiplier = 1 + upgrades.double.level * 0.5;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'speed':
                        cost = this.getUpgradeCost('speed');
                        if (coins >= cost && upgrades.speed.level < upgrades.speed.maxLevel) {
                            coins -= cost;
                            upgrades.speed.level++;
                            balls.forEach(ball => {
                                const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                                const angle = Math.atan2(ball.dy, ball.dx);
                                ball.dx = Math.cos(angle) * speed * (1 + upgrades.speed.level * 0.3);
                                ball.dy = Math.sin(angle) * speed * (1 + upgrades.speed.level * 0.3);
                            });
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'size':
                        cost = this.getUpgradeCost('size');
                        if (coins >= cost && upgrades.size.level < upgrades.size.maxLevel) {
                            coins -= cost;
                            upgrades.size.level++;
                            balls.forEach(ball => {
                                ball.radius = 20 * (1 + upgrades.size.level * 0.3);
                            });
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'powerups':
                        cost = this.getUpgradeCost('powerups');
                        if (coins >= cost && upgrades.powerups.level < upgrades.powerups.maxLevel) {
                            coins -= cost;
                            upgrades.powerups.level++;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'combo':
                        cost = this.getUpgradeCost('combo');
                        if (coins >= cost && upgrades.combo.level < upgrades.combo.maxLevel) {
                            coins -= cost;
                            upgrades.combo.level++;
                            comboTime = 2000 + upgrades.combo.level * 500;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'magnet':
                        cost = this.getUpgradeCost('magnet');
                        if (coins >= cost && upgrades.magnet.level < upgrades.magnet.maxLevel) {
                            coins -= cost;
                            upgrades.magnet.level++;
                            balls.forEach(ball => {
                                ball.magnetRadius = 100 + upgrades.magnet.level * 50;
                            });
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'critical':
                        cost = this.getUpgradeCost('critical');
                        if (coins >= cost && upgrades.critical.level < upgrades.critical.maxLevel) {
                            coins -= cost;
                            upgrades.critical.level++;
                            criticalChance = upgrades.critical.level * 0.05;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'bossEvent':
                        cost = 1000;
                        if (coins >= cost && !upgrades.bossEvent) {
                            coins -= cost;
                            upgrades.bossEvent = true;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'ability':
                        cost = 1200;
                        if (coins >= cost && !upgrades.ability && premiumUnlocked) {
                            coins -= cost;
                            upgrades.ability = true;
                            uiElements.abilityButtons.forEach(btn => btn.disabled = false);
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'abilityUpgrade':
                        cost = this.getUpgradeCost('abilityUpgrade');
                        if (coins >= cost && upgrades.abilityUpgrade.level < upgrades.abilityUpgrade.maxLevel && premiumUnlocked && upgrades.ability) {
                            coins -= cost;
                            upgrades.abilityUpgrade.level++;

                            // Reducir cooldowns de todas las habilidades
                            Object.keys(abilities).forEach(ability => {
                                abilities[ability].maxCooldown = Math.max(60, abilities[ability].baseCooldown - (upgrades.abilityUpgrade.level * 30));
                            });

                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'missions':
                        cost = 800;
                        if (coins >= cost && !upgrades.missions && premiumUnlocked) {
                            coins -= cost;
                            upgrades.missions = true;
                            missionsUnlocked = true;
                            this.generateMissions();
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'multiBall':
                        cost = this.getUpgradeCost('multiBall');
                        if (coins >= cost && upgrades.multiBall.level < upgrades.multiBall.maxLevel && premiumUnlocked) {
                            coins -= cost;
                            upgrades.multiBall.level++;
                            this.addNewBall();
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'doubleJump':
                        cost = 800;
                        if (coins >= cost && !upgrades.doubleJump && premiumUnlocked) {
                            coins -= cost;
                            upgrades.doubleJump = true;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'gravity':
                        cost = 800;
                        if (coins >= cost && !upgrades.gravity && premiumUnlocked) {
                            coins -= cost;
                            upgrades.gravity = true;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'shield':
                        cost = 800;
                        if (coins >= cost && !upgrades.shield && premiumUnlocked) {
                            coins -= cost;
                            upgrades.shield = true;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                    case 'timeWarp':
                        cost = 800;
                        if (coins >= cost && !upgrades.timeWarp && premiumUnlocked) {
                            coins -= cost;
                            upgrades.timeWarp = true;
                            bought = true;
                            this.checkAchievement('firstUpgrade');
                        }
                        break;
                }

                // Verificar si todas las mejoras están compradas
                if (Object.values(upgrades).every(val => {
                    if (typeof val === 'object') {
                        if (val.maxLevel) return val.level >= val.maxLevel;
                        return true;
                    }
                    return val === true;
                })) {
                    this.checkAchievement('allUpgrades');
                }

                if (bought) {
                    this.updateUI();
                    this.updateShopButtons();
                    this.updatePremiumProgress();
                    this.playSound(sounds.coin);
                }
            },

            applyConfig: function () {
                if (premiumUnlocked) {
                    balls.forEach(ball => {
                        ball.color = uiElements.ballColorInput.value;
                    });
                    particleColor = uiElements.particleColorInput.value;
                    this.applyHudColor(uiElements.hudColorInput.value);
                }

                difficulty = uiElements.difficultySelect.value;
                soundEnabled = uiElements.soundToggle.checked;
                performanceMode = uiElements.performanceModeToggle.checked;

                // Aplicar dificultad
                balls.forEach(ball => {
                    const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                    const angle = Math.atan2(ball.dy, ball.dx);
                    let newSpeed = currentSpeed;

                    switch (difficulty) {
                        case 'easy': newSpeed = 3; break;
                        case 'normal': newSpeed = 5; break;
                        case 'hard': newSpeed = 7; break;
                        case 'extreme': newSpeed = 10; break;
                    }

                    // Aplicar mejora de velocidad si existe
                    if (upgrades.speed.level > 0) {
                        newSpeed *= (1 + upgrades.speed.level * 0.3);
                    }

                    ball.dx = Math.cos(angle) * newSpeed;
                    ball.dy = Math.sin(angle) * newSpeed;
                });

                // Configurar efectos de partículas premium
                if (premiumUnlocked) {
                    if (document.getElementById('rainEffect').checked) {
                        this.startRainEffect();
                    } else {
                        this.stopRainEffect();
                    }
                }

                this.saveGame();
            },

            resetGame: function () {
                if (confirm("¿Estás seguro de que quieres reiniciar el juego? Perderás todo tu progreso.")) {
                    localStorage.removeItem('circleBounceGame');
                    localStorage.removeItem('circleBounceSaveSlots');
                    location.reload();
                }
            },

            // Funciones de skins y premium
            enablePremiumFeatures: function () {
                premiumUnlocked = true;
                uiElements.ballColorInput.disabled = false;
                uiElements.particleColorInput.disabled = false;
                document.getElementById('glowEffect').disabled = false;
                document.getElementById('screenShake').disabled = false;
                document.getElementById('rainEffect').disabled = false;
                document.getElementById('trailRainbow').disabled = false;

                // Mostrar skins premium
                document.querySelectorAll('.premium-feature').forEach(el => {
                    el.style.opacity = '1';
                    el.style.pointerEvents = 'auto';
                });

                // Doble monedas por rebotes
                coinsMultiplier *= 2;

                this.checkAchievement('premiumUnlocked');
                this.saveGame();
            },

            applySkin: function (skin) {
                if (skin.includes('premium') && !premiumUnlocked) {
                    this.showPremiumNotification();
                    return;
                }

                balls.forEach(ball => {
                    ball.skin = skin;
                });

                document.querySelectorAll('.skin-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                const selectedOption = document.querySelector(`.skin-option[onclick="Game.selectSkin('${skin}')"]`);
                if (selectedOption) selectedOption.classList.add('selected');

                let color = '#ff0000';
                switch (skin) {
                    case 'default': color = '#ff0000'; break;
                    case 'fire': color = '#ff6600'; break;
                    case 'ice': color = '#00ccff'; break;
                    case 'earth': color = '#00aa00'; break;
                    case 'galaxy': color = '#9900ff'; break;
                    case 'sun': color = '#ffff00'; break;
                    case 'dragon': color = '#ff3366'; break;
                    case 'rainbow': color = '#ff0000'; break;
                    case 'nebula': color = '#9b59b6'; break;
                    case 'golden': color = '#ffd700'; break;
                    case 'phantom': color = '#8a2be2'; break;
                    case 'cosmic': color = '#00ffff'; break;
                }

                balls.forEach(ball => {
                    ball.color = color;
                });

                if (skin.includes('premium') && premiumUnlocked) {
                    this.checkAchievement('premiumSkinUsed');
                }

                this.checkAchievement('skinUnlocked');
                this.saveGame();
            },

            applyHudColor: function (color) {
                document.documentElement.style.setProperty('--hud-color', color);
                document.documentElement.style.setProperty('--button-hover', `${color}70`);
                uiElements.hudColorInput.value = color;
            },

            selectSkin: function (skin) {
                this.applySkin(skin);
            },

            showPremiumNotification: function () {
                uiElements.premiumNotification.style.display = 'block';
            },

            hidePremiumNotification: function () {
                uiElements.premiumNotification.style.display = 'none';
            },

            showPremiumShop: function () {
                uiElements.premiumShop.style.display = 'block';
                this.hidePremiumNotification();
            },

            hidePremiumShop: function () {
                uiElements.premiumShop.style.display = 'none';
            },

            updatePremiumProgress: function () {
                premiumProgress = Math.min(premiumPrice, Math.max(premiumProgress, coins));
                const percentage = (premiumProgress / premiumPrice) * 100;
                uiElements.premiumProgressDisplay.textContent = `Progreso: ${premiumProgress}/${premiumPrice} coins (${Math.round(percentage)}%)`;

                // Si el jugador está cerca de desbloquear premium, aumentar el precio
                if (percentage > 80 && !premiumUnlocked) {
                    premiumPrice = Math.floor(premiumPrice * 1.2);
                    uiElements.premiumCostDisplay.textContent = premiumPrice;
                    uiElements.dynamicPremiumCost.textContent = premiumPrice;
                    this.showComboMessage('¡Estás cerca de desbloquear Premium!', 'gold');
                }
            },

            buyPremium: function () {
                if (premiumUnlocked) return;

                if (coins >= premiumPrice) {
                    coins -= premiumPrice;
                    this.enablePremiumFeatures();
                    this.updateUI();
                    this.updateShopButtons();
                    this.hidePremiumShop();
                    this.playSound(sounds.powerup);
                    this.showComboMessage('¡Premium desbloqueado!', 'gold');
                } else {
                    this.showComboMessage(`Necesitas ${premiumPrice - coins} coins más para Premium`, '#ff3333');
                    premiumProgress = coins;
                    this.updatePremiumProgress();
                }
            },

            // Funciones de juego
            addNewBall: function () {
                const lastBall = balls[balls.length - 1];
                const newBall = {
                    x: lastBall.x + (Math.random() * 40 - 20),
                    y: lastBall.y + (Math.random() * 40 - 20),
                    radius: lastBall.radius,
                    dx: lastBall.dx * (Math.random() > 0.5 ? 1 : -1),
                    dy: lastBall.dy * (Math.random() > 0.5 ? 1 : -1),
                    color: lastBall.color,
                    skin: lastBall.skin,
                    trail: [],
                    isInvincible: false,
                    magnetRadius: lastBall.magnetRadius,
                    abilityActive: false
                };
                balls.push(newBall);
                this.checkAchievement('multiBallUsed');
            },

            resizeCanvas: function () {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;

                // Asegurarse que las bolas no queden fuera
                balls.forEach(ball => {
                    if (ball.x > width) ball.x = width - ball.radius;
                    if (ball.y > height) ball.y = height - ball.radius;
                });
            },

            createParticles: function (x, y, count = 10, burst = true, color = null, type = null) {
                if (performanceMode) return;
                if (!document.getElementById('burstEffect').checked && burst) return;

                const partColor = color || particleColor;
                const partType = type || particleType;

                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 3 + 1;
                    const size = Math.random() * 5 + 2;

                    particles.push({
                        x: x,
                        y: y,
                        size: size,
                        life: 30,
                        maxLife: 30,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        type: partType === 'mixed' ?
                            ['circles', 'squares', 'stars', 'hearts'][Math.floor(Math.random() * 4)] :
                            partType,
                        color: partColor
                    });
                }
            },

            createTrailParticles: function () {
                if (performanceMode) return;
                if (!document.getElementById('trailEffect').checked) return;

                // Crear partículas de estela para cada bola
                balls.forEach(ball => {
                    ball.trail.push({ x: ball.x, y: ball.y });
                    if (ball.trail.length > 5) ball.trail.shift();

                    if (Math.random() < 0.3) {
                        this.createParticles(ball.x, ball.y, 2, false);
                    }
                });
            },

            updateParticles: function () {
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;

                    // Aplicar gravedad
                    p.vy += 0.1;

                    if (p.life <= 0) {
                        particles.splice(i, 1);
                    }
                }
            },

            drawParticles: function () {
                if (performanceMode) return;

                particles.forEach(p => {
                    const alpha = p.life / p.maxLife;
                    ctx.globalAlpha = alpha;

                    // Efecto de estela arcoíris
                    if (premiumUnlocked && document.getElementById('trailRainbow').checked) {
                        const hue = (p.life / p.maxLife) * 360;
                        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                    } else {
                        ctx.fillStyle = p.color || particleColor;
                    }

                    switch (p.type) {
                        case 'circles':
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            ctx.fill();
                            break;
                        case 'squares':
                            ctx.fillRect(p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
                            break;
                        case 'stars':
                            this.drawStar(p.x, p.y, 5, p.size, p.size / 2);
                            ctx.fill();
                            break;
                        case 'hearts':
                            this.drawHeart(p.x, p.y, p.size);
                            ctx.fill();
                            break;
                    }
                });
                ctx.globalAlpha = 1;
            },

            drawStar: function (cx, cy, spikes, outerRadius, innerRadius) {
                let rot = Math.PI / 2 * 3;
                let x = cx;
                let y = cy;
                let step = Math.PI / spikes;

                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);

                for (let i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    ctx.lineTo(x, y);
                    rot += step;

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y);
                    rot += step;
                }

                ctx.lineTo(cx, cy - outerRadius);
                ctx.closePath();
            },

            drawHeart: function (x, y, size) {
                ctx.beginPath();
                const topCurveHeight = size * 0.3;
                ctx.moveTo(x, y + topCurveHeight);
                // top left curve
                ctx.bezierCurveTo(
                    x, y,
                    x - size / 2, y,
                    x - size / 2, y + topCurveHeight
                );
                // bottom left curve
                ctx.bezierCurveTo(
                    x - size / 2, y + (size + topCurveHeight) / 2,
                    x, y + (size + topCurveHeight) / 2,
                    x, y + size
                );
                // bottom right curve
                ctx.bezierCurveTo(
                    x, y + (size + topCurveHeight) / 2,
                    x + size / 2, y + (size + topCurveHeight) / 2,
                    x + size / 2, y + topCurveHeight
                );
                // top right curve
                ctx.bezierCurveTo(
                    x + size / 2, y,
                    x, y,
                    x, y + topCurveHeight
                );
                ctx.closePath();
            },

            spawnPowerup: function () {
                if (Math.random() < 0.02 * (1 + upgrades.powerups.level * 0.5)) {
                    const types = ['coin', 'multiplier', 'slow', 'invincible', 'time', 'explosion'];
                    const type = types[Math.floor(Math.random() * types.length)];

                    const powerup = {
                        x: Math.random() * (width - 40) + 20,
                        y: Math.random() * (height - 40) + 20,
                        radius: 15,
                        type: type,
                        life: 500,
                        color: this.getPowerupColor(type)
                    };

                    powerups.push(powerup);
                }
            },

            getPowerupColor: function (type) {
                switch (type) {
                    case 'coin': return 'gold';
                    case 'multiplier': return '#00ff00';
                    case 'slow': return '#0000ff';
                    case 'invincible': return '#ff00ff';
                    case 'time': return '#ffff00';
                    case 'explosion': return '#ff6600';
                    default: return 'white';
                }
            },

            updatePowerups: function () {
                for (let i = powerups.length - 1; i >= 0; i--) {
                    // Aplicar magnetismo si está activo
                    if (upgrades.magnet.level > 0 || abilities.magnet.active) {
                        let closestBall = null;
                        let minDistance = Infinity;

                        // Encontrar la bola más cercana
                        balls.forEach(ball => {
                            const dx = ball.x - powerups[i].x;
                            const dy = ball.y - powerups[i].y;
                            const distance = Math.sqrt(dx * dx + dy * dy);

                            if (distance < minDistance) {
                                minDistance = distance;
                                closestBall = ball;
                            }
                        });

                        const magnetRadius = abilities.magnet.active ? 300 : closestBall.magnetRadius;

                        if (minDistance < magnetRadius) {
                            const angle = Math.atan2(closestBall.y - powerups[i].y, closestBall.x - powerups[i].x);
                            const pullStrength = 1 - (minDistance / magnetRadius);
                            powerups[i].x += Math.cos(angle) * 5 * pullStrength;
                            powerups[i].y += Math.sin(angle) * 5 * pullStrength;
                        }
                    }

                    powerups[i].life--;

                    if (powerups[i].life <= 0) {
                        powerups.splice(i, 1);
                    }
                }
            },

            drawPowerups: function () {
                powerups.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                    ctx.closePath();

                    // Dibujar icono según tipo
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    switch (p.type) {
                        case 'coin': ctx.fillText('$', p.x, p.y); break;
                        case 'multiplier': ctx.fillText('x2', p.x, p.y); break;
                        case 'slow': ctx.fillText('⌛', p.x, p.y); break;
                        case 'invincible': ctx.fillText('✨', p.x, p.y); break;
                        case 'time': ctx.fillText('⏱️', p.x, p.y); break;
                        case 'explosion': ctx.fillText('💥', p.x, p.y); break;
                    }
                });

                // Dibujar radio de magnetismo si está activo
                if ((upgrades.magnet.level > 0 || abilities.magnet.active) && !performanceMode) {
                    balls.forEach(ball => {
                        const magnetRadius = abilities.magnet.active ? 300 : ball.magnetRadius;
                        if (magnetRadius > 0) {
                            ctx.beginPath();
                            ctx.arc(ball.x, ball.y, magnetRadius, 0, Math.PI * 2);
                            ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                            ctx.closePath();
                        }
                    });
                }
            },

            checkPowerupCollision: function () {
                for (let i = powerups.length - 1; i >= 0; i--) {
                    const p = powerups[i];

                    // Verificar colisión con todas las bolas
                    for (let j = 0; j < balls.length; j++) {
                        const ball = balls[j];
                        const dx = ball.x - p.x;
                        const dy = ball.y - p.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < ball.radius + p.radius) {
                            this.applyPowerup(p.type);
                            powerups.splice(i, 1);
                            this.playSound(sounds.powerup);
                            break;
                        }
                    }
                }
            },

            applyPowerup: function (type) {
                let message = '';
                let color = '#ffffff';

                switch (type) {
                    case 'coin':
                        coins += 10 * coinsMultiplier;
                        message = '+10 Coins!';
                        color = 'gold';
                        break;
                    case 'multiplier':
                        coinsMultiplier *= 2;
                        setTimeout(() => {
                            coinsMultiplier /= 2;
                            this.updateUI();
                        }, 10000);
                        message = 'Multiplicador x2!';
                        color = '#00ff00';
                        break;
                    case 'slow':
                        balls.forEach(ball => {
                            const originalDx = ball.dx;
                            const originalDy = ball.dy;
                            ball.dx *= 0.5;
                            ball.dy *= 0.5;

                            setTimeout(() => {
                                ball.dx = originalDx;
                                ball.dy = originalDy;
                            }, 5000);
                        });
                        message = 'Lentitud!';
                        color = '#0000ff';
                        break;
                    case 'invincible':
                        balls.forEach(ball => {
                            ball.isInvincible = true;
                            const originalColor = ball.color;
                            ball.color = '#ffffff';
                            setTimeout(() => {
                                ball.isInvincible = false;
                                ball.color = originalColor;
                            }, 3000);
                        });
                        message = 'Invencible!';
                        color = '#ff00ff';
                        break;
                    case 'time':
                        comboTime += 1000;
                        setTimeout(() => {
                            comboTime -= 1000;
                        }, 5000);
                        message = '+1s Combo!';
                        color = '#ffff00';
                        break;
                    case 'explosion':
                        balls.forEach(ball => {
                            this.createParticles(ball.x, ball.y, 50);
                        });
                        message = '¡Explosión!';
                        color = '#ff6600';
                        break;
                }

                this.showComboMessage(message, color);
            },

            spawnObstacles: function () {
                if (level >= 3 && obstacles.length < Math.floor(level / 2)) {
                    const obstacle = {
                        x: Math.random() * (width - 100) + 50,
                        y: Math.random() * (height - 100) + 50,
                        width: Math.random() * 50 + 30,
                        height: Math.random() * 50 + 30,
                        color: `rgba(255, 255, 255, ${Math.random() * 0.3 + 0.2})`
                    };

                    // Asegurarse de que no aparezca demasiado cerca de ninguna bola
                    let tooClose = false;
                    balls.forEach(ball => {
                        const dx = ball.x - obstacle.x;
                        const dy = ball.y - obstacle.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < 150) {
                            tooClose = true;
                        }
                    });

                    if (!tooClose) {
                        obstacles.push(obstacle);
                    }
                }
            },

            drawObstacles: function () {
                obstacles.forEach(obs => {
                    ctx.fillStyle = obs.color;
                    ctx.fillRect(obs.x - obs.width / 2, obs.y - obs.height / 2, obs.width, obs.height);

                    // Dibujar borde si es premium
                    if (premiumUnlocked && !performanceMode) {
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(obs.x - obs.width / 2, obs.y - obs.height / 2, obs.width, obs.height);
                    }
                });
            },

            checkObstacleCollision: function () {
                for (let i = 0; i < obstacles.length; i++) {
                    const obs = obstacles[i];

                    // Verificar colisión con todas las bolas
                    balls.forEach(ball => {
                        if (ball.isInvincible || abilities.invincibility.active) return;

                        // Calcular el punto más cercano en el obstáculo al centro de la bola
                        const closestX = Math.max(obs.x - obs.width / 2, Math.min(ball.x, obs.x + obs.width / 2));
                        const closestY = Math.max(obs.y - obs.height / 2, Math.min(ball.y, obs.y + obs.height / 2));

                        // Calcular la distancia entre el centro de la bola y este punto más cercano
                        const distanceX = ball.x - closestX;
                        const distanceY = ball.y - closestY;
                        const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

                        // Si la distancia es menor que el radio, hay colisión
                        if (distance < ball.radius) {
                            // Determinar de qué lado ocurrió la colisión
                            if (closestY === obs.y - obs.height / 2 || closestY === obs.y + obs.height / 2) {
                                ball.dy = -ball.dy;
                            } else {
                                ball.dx = -ball.dx;
                            }

                            this.handleBounce(ball);
                            this.createParticles(closestX, closestY, 15);
                        }
                    });
                }
            },

            spawnBoss: function () {
                if (!upgrades.bossEvent || bossActive || level % 10 !== 0) return;

                bossActive = true;
                bossMaxHealth = level * 5;
                bossHealth = bossMaxHealth;
                boss = {
                    x: width / 2,
                    y: height / 4,
                    width: 150,
                    height: 80,
                    color: `rgba(255, 50, 50, 0.7)`,
                    speed: 3 + level / 10
                };

                uiElements.bossHealthContainer.style.display = 'block';
                this.updateBossHealthBar();
                this.playSound(sounds.boss);
                this.showComboMessage('¡Jefe Final Aparecido!', '#ff0000');
            },

            updateBoss: function () {
                if (!bossActive) return;

                // Mover al jefe
                boss.x += boss.speed;

                // Rebotar en los bordes
                if (boss.x + boss.width / 2 > width || boss.x - boss.width / 2 < 0) {
                    boss.speed = -boss.speed;
                }

                // Verificar colisión con todas las bolas
                balls.forEach(ball => {
                    if (ball.isInvincible || abilities.invincibility.active) return;

                    const closestX = Math.max(boss.x - boss.width / 2, Math.min(ball.x, boss.x + boss.width / 2));
                    const closestY = Math.max(boss.y - boss.height / 2, Math.min(ball.y, boss.y + boss.height / 2));
                    const distanceX = ball.x - closestX;
                    const distanceY = ball.y - closestY;
                    const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

                    if (distance < ball.radius) {
                        // Golpear al jefe
                        bossHealth--;
                        this.updateBossHealthBar();

                        // Rebotar la bola
                        if (closestY === boss.y - boss.height / 2 || closestY === boss.y + boss.height / 2) {
                            ball.dy = -ball.dy * 1.2;
                        } else {
                            ball.dx = -ball.dx * 1.2;
                        }

                        // Efecto especial
                        this.createParticles(closestX, closestY, 30);

                        // Verificar si el jefe fue derrotado
                        if (bossHealth <= 0) {
                            this.defeatBoss();
                        } else {
                            this.handleBounce(ball);
                        }
                    }
                });
            },

            updateBossHealthBar: function () {
                const percentage = (bossHealth / bossMaxHealth) * 100;
                uiElements.bossHealthBar.style.width = `${percentage}%`;
            },

            defeatBoss: function () {
                bossActive = false;
                uiElements.bossHealthContainer.style.display = 'none';
                const reward = level * 10;
                coins += reward;
                this.showComboMessage(`¡Jefe Derrotado! +${reward} Coins`, '#4CAF50');
                this.playSound(sounds.powerup);
                this.checkAchievement('bossDefeated');
                this.updateUI();
            },

            drawBoss: function () {
                if (!bossActive) return;

                ctx.fillStyle = boss.color;
                ctx.fillRect(boss.x - boss.width / 2, boss.y - boss.height / 2, boss.width, boss.height);

                // Dibujar detalles del jefe
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.beginPath();
                ctx.arc(boss.x - boss.width / 4, boss.y, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(boss.x + boss.width / 4, boss.y, 15, 0, Math.PI * 2);
                ctx.fill();

                // Boca
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.beginPath();
                ctx.ellipse(boss.x, boss.y + 20, 30, 15, 0, 0, Math.PI);
                ctx.fill();
            },

            updateCombo: function () {
                const now = Date.now();
                if (now - lastBounceTime > comboTime) {
                    if (combo > 1) {
                        this.showComboMessage(`Combo x${combo} terminado!`, 'gold');
                    }
                    combo = 1;
                    uiElements.comboDisplay.style.color = 'white';
                }
            },

            showComboMessage: function (message, color) {
                uiElements.comboPopup.textContent = message;
                uiElements.comboPopup.style.color = color;
                uiElements.comboPopup.style.opacity = '1';

                setTimeout(() => {
                    uiElements.comboPopup.style.opacity = '0';
                }, 1000);
            },

            playSound: function (sound) {
                if (soundEnabled) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log("Error al reproducir sonido:", e));
                }
            },

            updateLevel: function () {
                if (bounces >= bouncesToNextLevel) {
                    level++;

                    // Verificar si se ha alcanzado el nivel máximo
                    if (level >= maxLevel) {
                        // Aumentar el nivel máximo cada 15 niveles
                        if (level % 15 === 0) {
                            maxLevel += 10;
                            this.showComboMessage(`¡Nuevo límite desbloqueado! Ahora puedes llegar a nivel ${maxLevel}`, '#4CAF50');
                            this.checkAchievement('maxLevelReached');
                        }
                    }

                    bouncesToNextLevel += level * 50;
                    this.showComboMessage(`Nivel ${level} alcanzado!`, '#4CAF50');
                    this.playSound(sounds.powerup);

                    // Aumentar dificultad
                    balls.forEach(ball => {
                        const speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                        const angle = Math.atan2(ball.dy, ball.dx);
                        ball.dx = Math.cos(angle) * speed * 1.05;
                        ball.dy = Math.sin(angle) * speed * 1.05;
                    });

                    this.updateUI();
                    this.spawnObstacles();
                    this.spawnBoss();

                    // Actualizar misiones
                    this.checkMissions('level', level);
                }
            },

            updateFPS: function () {
                const now = performance.now();
                frameCount++;

                if (now - lastFpsUpdate >= 1000) {
                    fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
                    uiElements.fpsCounter.textContent = fps;
                    uiElements.particleCounter.textContent = particles.length;
                    frameCount = 0;
                    lastFpsUpdate = now;
                }
            },

            // Funciones de habilidades
            activateAbility: function (type) {
                if (!upgrades.ability || abilities[type].cooldown > 0) return;

                abilities[type].cooldown = abilities[type].maxCooldown;
                abilities[type].active = true;

                // Efectos específicos de cada habilidad
                switch (type) {
                    case 'invincibility':
                        balls.forEach(ball => {
                            ball.isInvincible = true;
                            const originalColor = ball.color;
                            ball.color = '#ffffff';

                            setTimeout(() => {
                                ball.isInvincible = false;
                                ball.color = originalColor;
                                abilities[type].active = false;
                            }, 3000);
                        });
                        this.showComboMessage('Invencibilidad activada!', '#ff00ff');
                        break;

                    case 'explosion':
                        balls.forEach(ball => {
                            this.createParticles(ball.x, ball.y, 50);

                            // Empujar power-ups lejos
                            powerups.forEach(p => {
                                const angle = Math.atan2(p.y - ball.y, p.x - ball.x);
                                p.x += Math.cos(angle) * 20;
                                p.y += Math.sin(angle) * 20;
                            });
                        });
                        this.showComboMessage('¡Explosión!', '#ff6600');
                        abilities[type].active = false;
                        break;

                    case 'slow':
                        balls.forEach(ball => {
                            const originalDx = ball.dx;
                            const originalDy = ball.dy;
                            ball.dx *= 0.3;
                            ball.dy *= 0.3;

                            setTimeout(() => {
                                ball.dx = originalDx;
                                ball.dy = originalDy;
                                abilities[type].active = false;
                            }, 5000);
                        });
                        this.showComboMessage('Tiempo ralentizado!', '#0000ff');
                        break;

                    case 'magnet':
                        this.showComboMessage('Magnetismo potenciado!', '#00ffff');
                        setTimeout(() => {
                            abilities[type].active = false;
                        }, 5000);
                        break;

                    case 'doubleJump':
                        balls.forEach(ball => {
                            ball.dy = -Math.abs(ball.dy) * 1.5;
                        });
                        this.showComboMessage('¡Doble salto!', '#ff9900');
                        abilities[type].active = false;
                        break;

                    case 'gravity':
                        balls.forEach(ball => {
                            ball.dy *= 0.5;
                        });
                        this.showComboMessage('Gravedad reducida!', '#00ccff');
                        setTimeout(() => {
                            abilities[type].active = false;
                        }, 4000);
                        break;

                    case 'shield':
                        balls.forEach(ball => {
                            ball.isInvincible = true;
                            const originalColor = ball.color;
                            ball.color = '#00ff00';

                            setTimeout(() => {
                                ball.isInvincible = false;
                                ball.color = originalColor;
                                abilities[type].active = false;
                            }, 4000);
                        });
                        this.showComboMessage('Escudo activado!', '#00ff00');
                        break;

                    case 'timeWarp':
                        comboTime += 2000;
                        this.showComboMessage('Dilatación temporal!', '#9900ff');
                        setTimeout(() => {
                            comboTime -= 2000;
                            abilities[type].active = false;
                        }, 5000);
                        break;
                }

                this.playSound(sounds.ability);
                this.checkAchievement('abilityUsed');
            },

            updateAbilityCooldowns: function () {
                Object.keys(abilities).forEach((ability, index) => {
                    if (abilities[ability].cooldown > 0) {
                        abilities[ability].cooldown--;

                        // Actualizar visualización del cooldown
                        const percentage = (abilities[ability].cooldown / abilities[ability].maxCooldown) * 100;
                        uiElements.cooldownElements[index].style.height = `${percentage}%`;

                        if (abilities[ability].cooldown <= 0) {
                            uiElements.abilityButtons[index].disabled = false;
                        } else {
                            uiElements.abilityButtons[index].disabled = true;
                        }
                    }
                });
            },

            // Funciones de misiones
            generateMissions: function () {
                if (!missionsUnlocked) return;

                const missionTypes = [
                    { type: 'bounces', target: 50, reward: 50, description: 'Realiza 50 rebotes', special: false },
                    { type: 'coins', target: 100, reward: 75, description: 'Consigue 100 coins', special: false },
                    { type: 'level', target: 5, reward: 100, description: 'Alcanza el nivel 5', special: false },
                    { type: 'combo', target: 5, reward: 60, description: 'Consigue un combo de 5x', special: false },
                    { type: 'bounces', target: 200, reward: 150, description: 'Realiza 200 rebotes', special: true },
                    { type: 'coins', target: 500, reward: 250, description: 'Consigue 500 coins', special: true },
                    { type: 'level', target: 10, reward: 200, description: 'Alcanza el nivel 10', special: true },
                    { type: 'combo', target: 10, reward: 150, description: 'Consigue un combo de 10x', special: true },
                    { type: 'boss', target: 1, reward: 300, description: 'Derrota a un jefe', special: true },
                    { type: 'event', target: 1, reward: 200, description: 'Completa un evento aleatorio', special: true }
                ];

                missions = [];
                for (let i = 0; i < 5; i++) {
                    const randomType = Math.floor(Math.random() * missionTypes.length);
                    const mission = { ...missionTypes[randomType] };

                    // Asegurarse de que no haya misiones duplicadas
                    if (!missions.some(m => m.description === mission.description)) {
                        missions.push({
                            ...mission,
                            progress: 0,
                            completed: false
                        });
                    } else {
                        i--; // Intentar de nuevo
                    }
                }

                this.updateMissionsUI();
            },

            checkMissions: function (type, amount) {
                if (!missionsUnlocked) return;

                let anyCompleted = false;

                missions.forEach(mission => {
                    if (!mission.completed && mission.type === type) {
                        mission.progress = Math.max(mission.progress, amount);

                        if (mission.progress >= mission.target) {
                            mission.completed = true;
                            coins += mission.reward;
                            anyCompleted = true;
                            this.checkAchievement('missionCompleted');

                            if (mission.special) {
                                this.showComboMessage(`Misión especial completada! +${mission.reward}`, '#4CAF50');
                            } else {
                                this.showComboMessage(`Misión completada! +${mission.reward}`, '#4CAF50');
                            }
                        }
                    }
                });

                if (anyCompleted) {
                    this.updateUI();
                    this.updateMissionsUI();
                    this.playSound(sounds.coin);

                    // Verificar si todas las misiones están completadas
                    if (missions.every(m => m.completed)) {
                        setTimeout(() => {
                            this.generateMissions();
                            this.showComboMessage('Nuevas misiones disponibles!', '#4CAF50');
                        }, 2000);
                    }
                }
            },

            updateMissionsUI: function () {
                if (!missionsUnlocked) return;

                uiElements.missionList.innerHTML = '';

                missions.forEach((mission, index) => {
                    const missionElement = document.createElement('div');
                    missionElement.className = `mission ${mission.completed ? 'completed' : ''}`;

                    const progress = mission.completed ? mission.target : mission.progress;
                    const percent = Math.min(100, (progress / mission.target) * 100);

                    missionElement.innerHTML = `
                    <h4>${mission.description}</h4>
                    <div>Progreso: ${progress}/${mission.target}</div>
                    <div class="progress-bar" style="width: 100%; height: 5px; background: #333;">
                        <div style="width: ${percent}%; height: 100%; background: var(--hud-color);"></div>
                    </div>
                    <div class="mission-reward ${mission.special ? 'mission-special' : ''}">Recompensa: ${mission.reward} coins</div>
                    ${mission.completed ? '<div class="completed-text">¡Completada!</div>' : ''}
                `;

                    uiElements.missionList.appendChild(missionElement);
                });
            },

            // Funciones de efectos de lluvia
            startRainEffect: function () {
                if (rainInterval) return;

                rainInterval = setInterval(() => {
                    if (gamePaused) return;

                    // Crear partículas de lluvia en la parte superior
                    for (let i = 0; i < 3; i++) {
                        rainParticles.push({
                            x: Math.random() * width,
                            y: -10,
                            size: Math.random() * 4 + 2,
                            speed: Math.random() * 5 + 5,
                            life: 100,
                            alpha: Math.random() * 0.5 + 0.3
                        });
                    }
                }, 100);
            },

            stopRainEffect: function () {
                if (rainInterval) {
                    clearInterval(rainInterval);
                    rainInterval = null;
                }
            },

            updateRainParticles: function () {
                for (let i = rainParticles.length - 1; i >= 0; i--) {
                    const p = rainParticles[i];
                    p.y += p.speed;
                    p.life--;

                    if (p.y > height || p.life <= 0) {
                        rainParticles.splice(i, 1);
                    }
                }
            },

            drawRainParticles: function () {
                if (performanceMode) return;

                rainParticles.forEach(p => {
                    ctx.fillStyle = `rgba(200, 200, 255, ${p.alpha})`;
                    ctx.fillRect(p.x, p.y, p.size / 2, p.size * 2);
                });
            },

            // Funciones de eventos aleatorios
            checkRandomEvents: function () {
                const now = Date.now();
                if (now - lastRandomEventTime > randomEventInterval) {
                    lastRandomEventTime = now;
                    this.triggerRandomEvent();
                }
            },

            triggerRandomEvent: function () {
                if (randomEventsList.length === 0) return;

                const randomIndex = Math.floor(Math.random() * randomEventsList.length);
                const event = randomEventsList[randomIndex];

                // Mostrar notificación del evento
                this.showEventNotification(event);

                // Aplicar efecto del evento
                const eventResult = event.effect();
                this.showComboMessage(eventResult.message, eventResult.color);

                // Crear partículas especiales para el evento
                for (let i = 0; i < event.particles.count; i++) {
                    this.createParticles(
                        Math.random() * width,
                        Math.random() * height,
                        1,
                        true,
                        event.particles.color,
                        'stars'
                    );
                }

                // Verificar misiones relacionadas con eventos
                this.checkMissions('event', 1);
                this.checkAchievement('eventCompleted');

                // Reproducir sonido del evento
                this.playSound(sounds.event);
            },

            showEventNotification: function (event) {
                uiElements.eventNotification.innerHTML = `
                <h3>${event.name}</h3>
                <p>${event.description}</p>
                <p>Duración: ${event.duration / 1000} segundos</p>
            `;

                uiElements.eventNotification.style.display = 'block';
                uiElements.eventNotification.style.opacity = '1';

                setTimeout(() => {
                    uiElements.eventNotification.style.opacity = '0';
                    setTimeout(() => {
                        uiElements.eventNotification.style.display = 'none';
                    }, 300);
                }, 3000);
            },

            // Funciones de logros
            checkAchievement: function (achievement) {
                if (!achievements[achievement]) {
                    achievements[achievement] = true;
                    this.showAchievement(achievement);
                    this.saveGame();
                }
            },

            showAchievement: function (achievement) {
                let title = '';
                let description = '';
                let reward = 10;

                switch (achievement) {
                    case 'firstBounce':
                        title = 'Primer Rebote!';
                        description = 'Has rebotado por primera vez';
                        break;
                    case 'hundredBounces':
                        title = '100 Rebotes!';
                        description = 'Has alcanzado 100 rebotes';
                        reward = 20;
                        break;
                    case 'thousandBounces':
                        title = '1000 Rebotes!';
                        description = 'Wow, 1000 rebotes!';
                        reward = 50;
                        break;
                    case 'firstCoin':
                        title = 'Primera Moneda!';
                        description = 'Has ganado tu primera moneda';
                        break;
                    case 'hundredCoins':
                        title = '100 Monedas!';
                        description = 'Has acumulado 100 monedas';
                        reward = 20;
                        break;
                    case 'thousandCoins':
                        title = '1000 Monedas!';
                        description = 'Eres rico! 1000 monedas';
                        reward = 50;
                        break;
                    case 'firstUpgrade':
                        title = 'Primera Mejora!';
                        description = 'Has comprado tu primera mejora';
                        break;
                    case 'allUpgrades':
                        title = 'Mejoras Completas!';
                        description = 'Has comprado todas las mejoras';
                        reward = 100;
                        break;
                    case 'maxCombo':
                        title = 'Combo Máximo!';
                        description = 'Alcanzaste un combo de 10x';
                        reward = 30;
                        break;
                    case 'premiumUnlocked':
                        title = 'Premium Desbloqueado!';
                        description = 'Ahora tienes acceso a características exclusivas';
                        reward = 50;
                        break;
                    case 'bossDefeated':
                        title = 'Jefe Derrotado!';
                        description = 'Has vencido a un jefe final';
                        reward = 100;
                        break;
                    case 'criticalHit':
                        title = 'Golpe Crítico!';
                        description = 'Has conseguido un rebote crítico';
                        reward = 15;
                        break;
                    case 'abilityUsed':
                        title = 'Habilidad Usada!';
                        description = 'Has utilizado tu primera habilidad especial';
                        reward = 20;
                        break;
                    case 'missionCompleted':
                        title = 'Misión Completada!';
                        description = 'Has completado tu primera misión';
                        reward = 25;
                        break;
                    case 'multiBallUsed':
                        title = 'Bolas Múltiples!';
                        description = 'Has usado bolas múltiples por primera vez';
                        reward = 30;
                        break;
                    case 'skinUnlocked':
                        title = 'Skin Desbloqueada!';
                        description = 'Has cambiado de skin por primera vez';
                        reward = 15;
                        break;
                    case 'premiumSkinUsed':
                        title = 'Skin Premium Usada!';
                        description = 'Has equipado una skin premium';
                        reward = 25;
                        break;
                    case 'eventCompleted':
                        title = 'Evento Completado!';
                        description = 'Has participado en un evento especial';
                        reward = 30;
                        break;
                    case 'slotSaved':
                        title = 'Partida Guardada!';
                        description = 'Has guardado tu progreso en un slot';
                        reward = 15;
                        break;
                    case 'maxLevelReached':
                        title = 'Nivel Máximo!';
                        description = 'Has alcanzado el nivel máximo actual';
                        reward = 50;
                        break;
                }

                uiElements.achievementsPopup.innerHTML = `
                <h2>${title}</h2>
                <p>${description}</p>
                <p>+${reward} Coins de recompensa!</p>
            `;
                uiElements.achievementsPopup.style.display = 'block';
                coins += reward;
                this.updateUI();
                this.playSound(sounds.powerup);

                setTimeout(() => {
                    uiElements.achievementsPopup.style.display = 'none';
                }, 3000);
            },

            // Funciones de dibujo y bucle del juego
            handleBounce: function (ball) {
                const now = Date.now();

                // Comprobar si es un rebote rápido (combo)
                if (now - lastBounceTime < comboTime) {
                    combo++;
                    uiElements.comboDisplay.style.color = combo >= 5 ? 'gold' : 'var(--hud-color)';

                    if (combo >= 10) {
                        this.checkAchievement('maxCombo');
                    }
                }

                lastBounceTime = now;
                bounces++;

                // Verificar si es un rebote crítico
                let isCritical = false;
                if (upgrades.critical.level > 0 && Math.random() < criticalChance) {
                    isCritical = true;
                    this.playSound(sounds.critical);
                    this.checkAchievement('criticalHit');
                }

                const coinsEarned = 1 * coinsMultiplier * combo * (isCritical ? 5 : 1);
                coins += coinsEarned;

                if (isCritical) {
                    this.showComboMessage(`CRÍTICO! +${coinsEarned}`, '#ff0000');
                    this.createParticles(ball.x, ball.y, 30, true, '#ff0000', 'stars');
                }

                this.updateUI();
                this.createParticles(ball.x, ball.y);
                this.playSound(sounds.bounce);

                // Efecto de vibración de pantalla si está activado
                if (premiumUnlocked && document.getElementById('screenShake').checked && !performanceMode) {
                    canvas.style.transform = 'translate(5px, 5px)';
                    setTimeout(() => {
                        canvas.style.transform = 'translate(0, 0)';
                    }, 100);
                }
            },

            drawBall: function (ball) {
                // Dibujar la bola con estilo según skin
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);

                // Efectos especiales según skin
                switch (ball.skin) {
                    case 'fire':
                        const fireGradient = ctx.createRadialGradient(
                            ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                            ball.x, ball.y, ball.radius
                        );
                        fireGradient.addColorStop(0, '#ffff00');
                        fireGradient.addColorStop(0.5, '#ff6600');
                        fireGradient.addColorStop(1, '#aa0000');
                        ctx.fillStyle = fireGradient;
                        break;
                    case 'ice':
                        const iceGradient = ctx.createRadialGradient(
                            ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                            ball.x, ball.y, ball.radius
                        );
                        iceGradient.addColorStop(0, '#ffffff');
                        iceGradient.addColorStop(0.7, '#00ccff');
                        iceGradient.addColorStop(1, '#0066ff');
                        ctx.fillStyle = iceGradient;
                        break;
                    case 'galaxy':
                        const galaxyGradient = ctx.createRadialGradient(
                            ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                            ball.x, ball.y, ball.radius
                        );
                        galaxyGradient.addColorStop(0, '#ffffff');
                        galaxyGradient.addColorStop(0.3, '#cc99ff');
                        galaxyGradient.addColorStop(1, '#330066');
                        ctx.fillStyle = galaxyGradient;

                        // Estrellas en la bola galaxia
                        ctx.fill();
                        ctx.fillStyle = 'white';
                        for (let i = 0; i < 10; i++) {
                            const angle = Math.random() * Math.PI * 2;
                            const dist = Math.random() * ball.radius * 0.8;
                            const starX = ball.x + Math.cos(angle) * dist;
                            const starY = ball.y + Math.sin(angle) * dist;
                            const size = Math.random() * 2 + 1;
                            ctx.fillRect(starX - size / 2, starY - size / 2, size, size);
                        }
                        break;
                    case 'rainbow':
                        if (premiumUnlocked) {
                            const rainbowGradient = ctx.createConicGradient(0, ball.x, ball.y);
                            rainbowGradient.addColorStop(0, 'red');
                            rainbowGradient.addColorStop(0.16, 'orange');
                            rainbowGradient.addColorStop(0.33, 'yellow');
                            rainbowGradient.addColorStop(0.5, 'green');
                            rainbowGradient.addColorStop(0.66, 'blue');
                            rainbowGradient.addColorStop(0.83, 'indigo');
                            rainbowGradient.addColorStop(1, 'violet');
                            ctx.fillStyle = rainbowGradient;
                        } else {
                            ctx.fillStyle = ball.color;
                        }
                        break;
                    case 'dragon':
                        if (premiumUnlocked) {
                            const dragonGradient = ctx.createRadialGradient(
                                ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                                ball.x, ball.y, ball.radius
                            );
                            dragonGradient.addColorStop(0, '#ff9999');
                            dragonGradient.addColorStop(0.5, '#ff3366');
                            dragonGradient.addColorStop(1, '#990033');
                            ctx.fillStyle = dragonGradient;

                            // Escamas de dragón
                            ctx.fill();
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                            ctx.lineWidth = 1;
                            for (let i = 0; i < 20; i++) {
                                const angle = Math.random() * Math.PI * 2;
                                const dist = Math.random() * ball.radius * 0.8;
                                const scaleX = ball.x + Math.cos(angle) * dist;
                                const scaleY = ball.y + Math.sin(angle) * dist;
                                const size = Math.random() * 5 + 3;
                                ctx.beginPath();
                                ctx.ellipse(scaleX, scaleY, size, size / 2, angle, 0, Math.PI * 2);
                                ctx.stroke();
                            }
                        } else {
                            ctx.fillStyle = ball.color;
                        }
                        break;
                    case 'nebula':
                        if (premiumUnlocked) {
                            const nebulaGradient = ctx.createRadialGradient(
                                ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                                ball.x, ball.y, ball.radius
                            );
                            nebulaGradient.addColorStop(0, '#9b59b6');
                            nebulaGradient.addColorStop(0.5, '#3498db');
                            nebulaGradient.addColorStop(1, '#2ecc71');
                            ctx.fillStyle = nebulaGradient;

                            // Efecto nebulosa
                            ctx.fill();
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                            for (let i = 0; i < 15; i++) {
                                const angle = Math.random() * Math.PI * 2;
                                const dist = Math.random() * ball.radius * 0.7;
                                const cloudX = ball.x + Math.cos(angle) * dist;
                                const cloudY = ball.y + Math.sin(angle) * dist;
                                const size = Math.random() * 8 + 4;
                                ctx.beginPath();
                                ctx.arc(cloudX, cloudY, size, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        } else {
                            ctx.fillStyle = ball.color;
                        }
                        break;
                    case 'golden':
                        if (premiumUnlocked) {
                            const goldenGradient = ctx.createRadialGradient(
                                ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                                ball.x, ball.y, ball.radius
                            );
                            goldenGradient.addColorStop(0, '#ffd700');
                            goldenGradient.addColorStop(0.7, '#c5a000');
                            goldenGradient.addColorStop(1, '#8b7500');
                            ctx.fillStyle = goldenGradient;

                            // Efecto de joya
                            ctx.fill();
                            ctx.strokeStyle = 'rgba(255, 215, 0, 0.7)';
                            ctx.lineWidth = 2;
                            for (let i = 0; i < 8; i++) {
                                const angle = (i * Math.PI * 2) / 8;
                                const dist = ball.radius * 0.8;
                                const jewelX = ball.x + Math.cos(angle) * dist;
                                const jewelY = ball.y + Math.sin(angle) * dist;
                                ctx.beginPath();
                                ctx.moveTo(ball.x, ball.y);
                                ctx.lineTo(jewelX, jewelY);
                                ctx.stroke();
                            }
                        } else {
                            ctx.fillStyle = ball.color;
                        }
                        break;
                    case 'phantom':
                        if (premiumUnlocked) {
                            const phantomGradient = ctx.createRadialGradient(
                                ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                                ball.x, ball.y, ball.radius
                            );
                            phantomGradient.addColorStop(0, '#e6e6fa');
                            phantomGradient.addColorStop(0.5, '#8a2be2');
                            phantomGradient.addColorStop(1, '#4b0082');
                            ctx.fillStyle = phantomGradient;

                            // Efecto fantasma
                            ctx.fill();
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                            for (let i = 0; i < 5; i++) {
                                const angle = Math.random() * Math.PI * 2;
                                const dist = Math.random() * ball.radius * 0.6;
                                const ghostX = ball.x + Math.cos(angle) * dist;
                                const ghostY = ball.y + Math.sin(angle) * dist;
                                const size = Math.random() * 10 + 5;
                                ctx.beginPath();
                                ctx.arc(ghostX, ghostY, size, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        } else {
                            ctx.fillStyle = ball.color;
                        }
                        break;
                    case 'cosmic':
                        if (premiumUnlocked) {
                            const cosmicGradient = ctx.createRadialGradient(
                                ball.x - ball.radius / 3, ball.y - ball.radius / 3, 0,
                                ball.x, ball.y, ball.radius
                            );
                            cosmicGradient.addColorStop(0, '#00ffff');
                            cosmicGradient.addColorStop(0.5, '#0000ff');
                            cosmicGradient.addColorStop(1, '#00008b');
                            ctx.fillStyle = cosmicGradient;

                            // Efecto cósmico
                            ctx.fill();
                            ctx.fillStyle = 'white';
                            for (let i = 0; i < 20; i++) {
                                const angle = Math.random() * Math.PI * 2;
                                const dist = Math.random() * ball.radius * 0.9;
                                const starX = ball.x + Math.cos(angle) * dist;
                                const starY = ball.y + Math.sin(angle) * dist;
                                const size = Math.random() * 1.5 + 0.5;
                                ctx.fillRect(starX - size / 2, starY - size / 2, size, size);
                            }
                        } else {
                            ctx.fillStyle = ball.color;
                        }
                        break;
                    default:
                        ctx.fillStyle = ball.color;
                }

                ctx.fill();
                ctx.closePath();

                // Efecto de resplandor si está activado
                if (premiumUnlocked && document.getElementById('glowEffect').checked && !performanceMode) {
                    ctx.shadowColor = ball.color;
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.closePath();
                    ctx.shadowBlur = 0;
                }

                // Dibujar trail
                if (document.getElementById('trailEffect').checked && !performanceMode) {
                    ctx.strokeStyle = ball.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(ball.trail[0]?.x || ball.x, ball.trail[0]?.y || ball.y);
                    for (let i = 1; i < ball.trail.length; i++) {
                        ctx.lineTo(ball.trail[i].x, ball.trail[i].y);
                    }
                    ctx.stroke();
                }
            },

            draw: function () {
                // Limpiar el canvas
                ctx.fillStyle = lightMode ? '#ddd' : '#222';
                ctx.fillRect(0, 0, width, height);

                // Dibujar partículas de lluvia si está activo
                if (premiumUnlocked && document.getElementById('rainEffect').checked) {
                    this.drawRainParticles();
                }

                // Dibujar obstáculos
                this.drawObstacles();

                // Dibujar jefe si existe
                this.drawBoss();

                // Dibujar power-ups
                this.drawPowerups();

                // Dibujar partículas
                this.drawParticles();

                // Dibujar todas las bolas
                balls.forEach(ball => {
                    this.drawBall(ball);
                });
            },

            update: function () {
                if (gamePaused) return;

                // Auto-guardado cada cierto tiempo
                const now = Date.now();
                if (now - lastAutoSaveTime > autoSaveInterval) {
                    lastAutoSaveTime = now;
                    this.saveGame();
                }

                // Verificar eventos aleatorios
                this.checkRandomEvents();

                // Mover todas las bolas
                balls.forEach(ball => {
                    ball.x += ball.dx;
                    ball.y += ball.dy;
                });

                // Crear estela de partículas
                this.createTrailParticles();

                // Detectar colisiones con los bordes para todas las bolas
                balls.forEach(ball => {
                    if (ball.x + ball.radius > width || ball.x - ball.radius < 0) {
                        ball.dx = -ball.dx;
                        if (ball.x + ball.radius > width) ball.x = width - ball.radius;
                        if (ball.x - ball.radius < 0) ball.x = ball.radius;
                        this.handleBounce(ball);
                    }

                    if (ball.y + ball.radius > height || ball.y - ball.radius < 0) {
                        ball.dy = -ball.dy;
                        if (ball.y + ball.radius > height) ball.y = height - ball.radius;
                        if (ball.y - ball.radius < 0) ball.y = ball.radius;
                        this.handleBounce(ball);
                    }
                });

                // Verificar colisión con obstáculos
                this.checkObstacleCollision();

                // Actualizar combo
                this.updateCombo();

                // Generar power-ups aleatorios
                this.spawnPowerup();

                // Verificar colisión con power-ups
                this.checkPowerupCollision();

                // Actualizar jefe si existe
                if (bossActive) {
                    this.updateBoss();
                }

                // Actualizar nivel
                this.updateLevel();

                // Actualizar FPS y contadores
                this.updateFPS();

                // Actualizar cooldowns de habilidades
                this.updateAbilityCooldowns();

                // Actualizar partículas de lluvia
                if (premiumUnlocked && document.getElementById('rainEffect').checked) {
                    this.updateRainParticles();
                }

                // Verificar misiones
                this.checkMissions('bounces', bounces);
                this.checkMissions('coins', coins);
                this.checkMissions('combo', combo);
                if (bossHealth <= 0) {
                    this.checkMissions('boss', 1);
                }
            },

            gameLoop: function (timestamp) {
                if (!gamePaused) {
                    this.update();
                    this.updateParticles();
                    this.updatePowerups();
                    this.draw();

                    // Optimización: Limitar partículas si hay demasiadas
                    if (particles.length > 500) {
                        particles = particles.slice(particles.length - 500);
                    }

                    requestAnimationFrame((t) => this.gameLoop(t));
                }
            }
        };
    })();

    // Inicializar el juego cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
        Game.init();

        // Iniciar el bucle del juego
        Game.gameLoop();
    });

    // Hacer accesibles las funciones necesarias desde HTML
    window.openTab = Game.openTab;
    window.buyUpgrade = Game.buyUpgrade.bind(Game);
    window.selectSkin = Game.selectSkin.bind(Game);
    window.showPremiumShop = Game.showPremiumShop.bind(Game);
    window.hidePremiumShop = Game.hidePremiumShop.bind(Game);
    window.buyPremium = Game.buyPremium.bind(Game);
    window.hidePremiumNotification = Game.hidePremiumNotification.bind(Game);
    window.applyConfig = Game.applyConfig.bind(Game);
    window.resetGame = Game.resetGame.bind(Game);
    window.closeShop = Game.closeShop.bind(Game);
</script>
</body>

</html>