<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Bounce Coins Ultimate - Enhanced Edition</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4facfe;
            --warning: #f6d365;
            --danger: #ff6b6b;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.5s ease;
        }

        canvas {
            display: block;
            background: radial-gradient(circle at center, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.3) 100%);
            backdrop-filter: blur(10px);
            transition: all 0.5s ease;
        }

        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: clamp(10px, 1.2vw, 12px);
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 12px;
            border-radius: 20px;
            pointer-events: auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            min-width: 280px;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            pointer-events: auto;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        #controls.hidden {
            transform: translateX(-50%) translateY(100%);
            opacity: 0.3;
        }
        
        #toggleControls {
            position: fixed;
            bottom: 5px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            z-index: 101;
            font-size: 12px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 11px;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .stat-icon {
            font-size: 14px;
        }

        #currency-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 15px;
            border-radius: 20px;
            font-size: clamp(11px, 1.5vw, 14px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
        }

        .diamond-text {
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
            font-weight: 600;
        }

        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(95%, 600px);
            max-height: 90vh;
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 25px;
            border-radius: 25px;
            display: none;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
            z-index: 100;
        }

        .tab {
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }

        .tab button {
            background: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 16px;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 500;
            flex: 1;
            min-width: 90px;
            border-radius: 12px;
            margin: 3px;
        }

        .tab button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-2px);
        }

        .tab button.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tabcontent {
            display: none;
            padding: 10px 0;
            animation: fadeEffect 0.3s;
        }

        @keyframes fadeEffect {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .upgrade {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            position: relative;
            font-size: 13px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .upgrade::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .upgrade:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .upgrade h4 {
            margin: 0 0 8px 0;
            color: var(--success);
            font-size: 15px;
            font-weight: 600;
        }

        .upgrade p {
            margin: 3px 0;
            font-size: 11px;
            line-height: 1.3;
        }

        .legendary-upgrade::before {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
        }

        .legendary-upgrade {
            background: rgba(255, 107, 53, 0.08);
        }

        .legendary-upgrade h4 {
            color: #ff6b35;
        }

        .mythic-upgrade::before {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .mythic-upgrade {
            background: rgba(155, 89, 182, 0.08);
        }

        .mythic-upgrade h4 {
            color: #9b59b6;
        }

        button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            display: inline-block;
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.5;
        }

        .premium-feature {
            position: relative;
        }

        .premium-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, var(--warning), #ffa726);
            color: #333;
            font-size: 9px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(246, 211, 101, 0.4);
        }

        .diamond-badge {
            background: linear-gradient(135deg, var(--accent), #a8edea);
            color: #333;
        }

        .legendary-badge {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
        }

        .mythic-badge {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        #importExport,
        #config,
        #stats,
        #missions,
        #premiumShop,
        #dailyChallenges,
        #achievements {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 20px;
            border-radius: 15px;
            width: min(90%, 600px);
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
        }
        
        #dailyChallenges {
            max-height: 80vh;
            overflow-y: auto;
        }

        #saveData {
            width: 100%;
            height: 150px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        .prestige-section {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        /* Sistema de Notificaciones Móvil */
        .notification-center {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 2000;
            pointer-events: none;
        }
        
        .notification-item {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideInNotif 0.3s ease-out;
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .notification-item:hover {
            background: rgba(0, 0, 0, 0.95);
            transform: translateX(-5px);
        }
        
        .notification-item.removing {
            animation: slideOutNotif 0.3s ease-in forwards;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 11px;
            opacity: 0.7;
        }
        

        
        .notification-text {
            font-weight: 500;
        }
        
        @keyframes slideInNotif {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutNotif {
            to {
                transform: translateX(100%);
                opacity: 0;
                height: 0;
                margin-bottom: 0;
                padding: 0;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
            40% { transform: translateX(-50%) translateY(-10px); }
            60% { transform: translateX(-50%) translateY(-5px); }
        }
        
        @media (max-width: 768px) {
            #ui {
                grid-template-columns: repeat(2, 1fr);
                font-size: 9px;
                left: 5px;
                top: 5px;
                min-width: calc(50vw - 20px);
                max-width: calc(50vw - 20px);
                padding: 8px;
            }
            
            .stat-item {
                font-size: 9px;
                padding: 2px 4px;
            }
            
            #controls {
                bottom: 5px;
                left: 5px;
                right: 5px;
                transform: none;
                width: calc(100vw - 30px);
                padding: 5px;
            }
            
            #controls.hidden {
                transform: translateY(100%);
            }
            
            #controls button {
                flex: 1;
                min-width: 60px;
                font-size: 10px;
                padding: 6px 4px;
            }
            
            #controlsArrow {
                bottom: 70px;
                font-size: 16px;
            }

            .tab {
                flex-direction: column;
            }

            .tab button {
                flex: none;
                width: 100%;
            }
            
            #currency-display {
                right: 5px;
                top: 5px;
                font-size: 9px;
                padding: 8px;
                min-width: calc(45vw - 20px);
                max-width: calc(45vw - 20px);
            }
            
            #toggleControls {
                right: 10px;
                bottom: 2px;
                padding: 6px 8px;
                font-size: 10px;
            }
            
            .notification-center {
                width: calc(100vw - 20px);
                right: 10px;
                top: 10px;
                max-height: 200px;
            }
            
            .notification-item {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 480px) {
            #ui {
                grid-template-columns: 1fr;
                font-size: 8px;
                min-width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
            }
            
            #currency-display {
                position: relative;
                top: auto;
                right: auto;
                margin: 5px;
                min-width: calc(100vw - 30px);
                max-width: calc(100vw - 30px);
            }
        }
    </style>
</head>

<body>
    <div id="loadingScreen"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; color: white;">
        <h1>Circle Bounce Coins Ultimate - Enhanced</h1>
        <div style="width: 200px; height: 200px; position: relative; margin: 20px;">
            <div
                style="width: 100%; height: 100%; border: 10px solid #333; border-top-color: var(--hud-color); border-radius: 50%; animation: spin 1s linear infinite;">
            </div>
            <div
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; font-weight: bold;">
                100%</div>
        </div>
        <p>Cargando recursos avanzados...</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div id="ui">
            <div class="stat-item"><span class="stat-icon">⚡</span><span class="stat-label">Rebotes:</span> <span id="bounces">0</span></div>
            <div class="stat-item"><span class="stat-icon">🔥</span><span class="stat-label">Combo:</span> <span id="combo">1x</span></div>
            <div class="stat-item"><span class="stat-icon">📊</span><span class="stat-label">Nivel:</span> <span id="level">1</span></div>
            <div class="stat-item"><span class="stat-icon">👑</span><span class="stat-label">Prestigio:</span> <span id="prestige">0</span></div>
            <div class="stat-item"><span class="stat-icon">🔮</span><span class="stat-label">Orbes:</span> <span id="orbCount">0</span></div>
            <div class="stat-item"><span class="stat-icon">⏰</span><span class="stat-label">AFK:</span> <span id="afkTimer">0s</span></div>
        </div>
        
        <div id="controls">
            <button id="shopBtn" title="Abrir tienda de mejoras">🛒 Tienda</button>
            <button id="achievementsBtn" title="Ver logros y eventos activos">🏆 Logros & Eventos</button>
            <button id="dailyChallengesBtn" title="Desafíos diarios disponibles">🎯 Desafíos</button>
            <button id="missionsBtn" title="Misiones del juego">📋 Misiones</button>
            <button id="statsBtn" title="Estadísticas del juego">📈 Stats</button>
            <button id="configBtn" title="Configuración del juego">⚙️ Config</button>
            <button id="pauseBtn" title="Pausar/Reanudar juego">⏸️ Pausa</button>
            <button id="importExportBtn" title="Guardar/Cargar datos">📁 Datos</button>
            <button id="prestigeBtn" title="Reiniciar con bonificadores">✨ Prestigio</button>
        </div>
        
        <div id="controlsArrow" style="position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); color: white; font-size: 20px; animation: bounce 2s infinite; pointer-events: none; z-index: 99;">▼</div>
        
        <button id="toggleControls" onclick="toggleControlsVisibility()">▲</button>
        </div>

        <div id="currency-display">
            <div>💰 Coins: <span id="coins">0</span></div>
            <div class="diamond-text">💎 Diamantes: <span id="diamonds">0</span></div>
            <div>⭐ Experiencia: <span id="experience">0</span></div>
            <div style="color: #ff6b35;">🔥 Ascensión: <span id="ascensionPoints">0</span></div>
            <div style="color: #ffd700;">🏆 Logros: <span id="achievementCount">0</span></div>
            <div style="color: #00ff00;">🃏 Cartas: <span id="cardCount">0</span></div>
            <div style="color: #ff69b4;">🎪 Evento: <span id="eventStatus">Ninguno</span></div>
            <div id="activeOrbEffectsDisplay" style="color: #00ffff; font-size: 10px; margin-top: 5px;"></div>
        </div>
        
        <!-- Centro de Notificaciones Móvil -->
        <div id="notificationCenter" class="notification-center"></div>
    </div>

    <!-- Config Panel -->
    <div id="config">
        <h3>Configuración</h3>
        <div style="margin: 10px 0;">
            <label>Tema: </label>
            <button id="themeToggle" onclick="toggleTheme()">Modo Claro</button>
        </div>
        <div style="margin: 10px 0;">
            <label>Sonidos: </label>
            <input type="checkbox" id="soundToggle" checked>
        </div>
        <div style="margin: 10px 0;">
            <label>Modo rendimiento: </label>
            <input type="checkbox" id="performanceMode">
        </div>
        <div style="margin: 10px 0;">
            <label>Velocidad de juego: </label>
            <input type="range" id="gameSpeed" min="0.5" max="2" step="0.1" value="1">
            <span id="speedValue">1x</span>
        </div>
        <div style="margin: 10px 0;">
            <label>Partículas: </label>
            <input type="range" id="particleCount" min="5" max="50" value="10">
            <span id="particleValue">10</span>
        </div>
        <div class="premium-feature" style="margin: 10px 0; opacity: 0.5;">
            <div class="premium-badge">PREMIUM</div>
            <label>Color de la bola: </label>
            <input type="color" id="ballColor" value="#ff0000" disabled>
        </div>
        <div style="margin: 10px 0;">
            <label>Slot de guardado: </label>
            <select id="saveSlot">
                <option value="1">Slot 1</option>
                <option value="2">Slot 2</option>
                <option value="3">Slot 3</option>
            </select>
        </div>
        <div style="margin-top: 15px;">
            <button onclick="applyConfig()">Aplicar</button>
            <button onclick="saveToSlot()">Guardar Slot</button>
            <button onclick="loadFromSlot()">Cargar Slot</button>
            <button onclick="resetGame()">Reset Total</button>
            <button onclick="closeConfig()">Cerrar</button>
        </div>
    </div>

    <!-- Stats Panel -->
    <div id="stats">
        <h3>Estadísticas</h3>
        <div>FPS: <span id="fpsCounter">60</span></div>
        <div>Partículas: <span id="particleCounter">0</span></div>
        <div>Total rebotes: <span id="totalBounces">0</span></div>
        <div>Total coins: <span id="totalCoins">0</span></div>
        <div>Tiempo jugado: <span id="playTime">0m</span></div>
        <div>Mejor combo: <span id="bestCombo">1x</span></div>
        <button onclick="closeStats()">Cerrar</button>
    </div>

    <!-- Missions Panel -->
    <div id="missions" style="max-height: 80vh; overflow-y: auto;">
        <h3>Misiones Diarias</h3>
        <div>Set de Misiones: <span id="missionSetNumber">1</span></div>
        <div id="missionList"></div>
        <button onclick="closeMissions()">Cerrar</button>
    </div>

    <!-- Unified Achievements & Events Panel -->
    <div id="achievements">
        <div class="tab">
            <button class="tablinks active" onclick="openAchievementTab(event, 'achievementsList')">🏆 Logros</button>
            <button class="tablinks" onclick="openAchievementTab(event, 'eventsList')">🎪 Eventos</button>
        </div>
        
        <div id="achievementsList" class="tabcontent" style="display: block;">
            <h3>🏆 Sistema de Logros</h3>
            <div id="achievementsContainer">
                <div class="upgrade"><h4>Primer Centenar</h4><p>Alcanza 100 rebotes - Recompensa: 500 coins</p><div id="achievement-first100">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Mil Rebotes</h4><p>Alcanza 1000 rebotes - Recompensa: 2000 coins</p><div id="achievement-first1000">❌ Bloqueado</div></div>
                <div class="upgrade legendary-upgrade"><h4>Maestro Rebotador</h4><p>Alcanza 10K rebotes - Recompensa: 10K coins</p><div id="achievement-first10k">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Millonario</h4><p>Consigue 1M coins - Recompensa: 1000 coins</p><div id="achievement-millionaire">❌ Bloqueado</div></div>
                <div class="upgrade legendary-upgrade"><h4>Billonario</h4><p>Consigue 1B coins - Recompensa: 50K coins</p><div id="achievement-billionaire">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Coleccionista</h4><p>Obtén 10 diamantes - Recompensa: 5 diamantes</p><div id="achievement-diamond10">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Cazador de Gemas</h4><p>Obtén 100 diamantes - Recompensa: 25 diamantes</p><div id="achievement-diamond100">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Renacimiento</h4><p>Haz tu primer prestigio - Recompensa: 2000 coins</p><div id="achievement-prestige1">❌ Bloqueado</div></div>
                <div class="upgrade legendary-upgrade"><h4>Veterano</h4><p>Haz 10 prestigios - Recompensa: 20K coins</p><div id="achievement-prestige10">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Medio Siglo</h4><p>Alcanza nivel 50 - Recompensa: 5K coins</p><div id="achievement-level50">❌ Bloqueado</div></div>
                <div class="upgrade legendary-upgrade"><h4>Centurión</h4><p>Alcanza nivel 100 - Recompensa: 15K coins</p><div id="achievement-level100">❌ Bloqueado</div></div>
                <div class="upgrade mythic-upgrade"><h4>Combo Master</h4><p>Alcanza combo 20x - Recompensa: 8K coins</p><div id="achievement-combo20">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Velocista</h4><p>Alcanza velocidad 15+ - Recompensa: 3K coins</p><div id="achievement-speed15">❌ Bloqueado</div></div>
                <div class="upgrade"><h4>Gigante</h4><p>Tamaño de bola 40+ - Recompensa: 4K coins</p><div id="achievement-size40">❌ Bloqueado</div></div>
                <div class="upgrade legendary-upgrade"><h4>Ascendido</h4><p>Haz tu primera ascensión - Recompensa: 100K coins</p><div id="achievement-ascension1">❌ Bloqueado</div></div>
            </div>
        </div>
        
        <div id="eventsList" class="tabcontent">
            <h3>🎪 Eventos Temporales</h3>
            <div id="currentEventDisplay">
                <div class="upgrade"><h4 id="eventName">Sin evento activo</h4><p id="eventDesc">Los eventos aparecen aleatoriamente cada ~100 segundos</p><div id="eventTimer"></div></div>
            </div>
            <h3>📅 Eventos Especiales</h3>
            <div id="specialEventsContainer">
                <div class="upgrade"><h4>🌟 Fin de Semana Dorado</h4><p>x2 coins los fines de semana</p><div id="weekend-event">⏰ Próximo evento</div></div>
                <div class="upgrade"><h4>🎃 Evento de Halloween</h4><p>Orbes especiales y bonificaciones</p><div id="halloween-event">🗓️ Octubre</div></div>
                <div class="upgrade"><h4>🎄 Navidad Especial</h4><p>Regalos diarios y multiplicadores</p><div id="christmas-event">🗓️ Diciembre</div></div>
                <div class="upgrade"><h4>🎆 Año Nuevo</h4><p>Reset de desafíos y bonos</p><div id="newyear-event">🗓️ Enero</div></div>
            </div>
        </div>
        

        
        <button onclick="closeAchievements()">Cerrar</button>
    </div>

    <!-- Daily Challenges Panel -->
    <div id="dailyChallenges">
        <h3>🎯 Desafíos Diarios</h3>
        <div>Próximo reset: <span id="resetTimer">--:--:--</span></div>
        <div id="dailyChallengesContainer"></div>
        <button onclick="selectRandomDailyChallenge()">🎲 Nuevo Desafío Aleatorio</button>
        <button id="resetDailyChallengesBtn" onclick="resetDailyChallenges()" style="display:none;">🔄 Reset Desafíos (24h)</button>
        <button onclick="claimAfkRewards()">💤 Reclamar Recompensas AFK</button>
        <button onclick="closeDailyChallenges()">Cerrar</button>
    </div>

    <!-- Premium Shop -->
    <div id="premiumShop" style="text-align: center;">
        <h2 style="color: gold;">🌟 Premium Unlock 🌟</h2>
        <p>Desbloquea características exclusivas:</p>
        <ul style="text-align: left; margin: 15px 0;">
            <li>🎨 Skins premium exclusivas</li>
            <li>✨ Efectos visuales avanzados</li>
            <li>🎯 Personalización completa</li>
            <li>📊 Estadísticas detalladas</li>
            <li>🚀 Multiplicadores especiales</li>
            <li>🎪 Eventos únicos</li>
        </ul>
        <div
            style="background: linear-gradient(45deg, gold, orange); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h3 style="margin: 0; color: black;">Solo 5000 coins</h3>
            <p style="margin: 5px 0; color: black;">¡Oferta limitada!</p>
        </div>
        <button onclick="buyPremium()"
            style="background: gold; color: black; font-weight: bold; padding: 10px 20px; font-size: 14px;">Comprar
            Premium</button>
        <button onclick="closePremiumShop()">Más tarde</button>
    </div>
    </div>
    </div>

    <div id="shop">
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'basic')">Básico</button>
            <button class="tablinks" onclick="openTab(event, 'advanced')">Avanzado</button>
            <button class="tablinks" onclick="openTab(event, 'legendary')">Legendario</button>
            <button class="tablinks" onclick="openTab(event, 'mythic')">Mítico</button>
            <button class="tablinks" onclick="openTab(event, 'prestige')">Prestigio</button>
            <button class="tablinks" onclick="openTab(event, 'ascension')">Ascensión</button>
            <button class="tablinks" onclick="openTab(event, 'collection')">Colección</button>
            <button class="tablinks" onclick="openTab(event, 'research')">Investigación</button>
            <button class="tablinks" onclick="openTab(event, 'particles')">Partículas</button>
            <button class="tablinks" onclick="openTab(event, 'skins')">Skins</button>
            <button class="tablinks" onclick="openTab(event, 'premium')">Premium</button>
            <button class="tablinks" onclick="openTab(event, 'generators')">Generadores</button>
            <button class="tablinks" onclick="closeShop()">Cerrar</button>
        </div>

        <div id="basic" class="tabcontent" style="display: block;">
            <div class="upgrade">
                <h4>Multiplicador de Coins <span id="coinMultLevel">(Nivel 0)</span></h4>
                <p>Aumenta coins por rebote</p>
                <p>Costo: <span id="coinMultCost">100</span> coins</p>
                <button onclick="buyUpgrade('coinMult')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Velocidad <span id="speedLevel">(Nivel 0)</span></h4>
                <p>Aumenta velocidad de la bola</p>
                <p>Costo: <span id="speedCost">150</span> coins</p>
                <button onclick="buyUpgrade('speed')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Tamaño <span id="sizeLevel">(Nivel 0)</span></h4>
                <p>Aumenta tamaño de la bola</p>
                <p>Costo: <span id="sizeCost">200</span> coins</p>
                <button onclick="buyUpgrade('size')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Combo Duración <span id="comboLevel">(Nivel 0)</span></h4>
                <p>Aumenta duración del combo</p>
                <p>Costo: <span id="comboCost">250</span> coins</p>
                <button onclick="buyUpgrade('combo')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Crítico <span id="critLevel">(Nivel 0)</span></h4>
                <p>Aumenta chance de rebote crítico</p>
                <p>Costo: <span id="criticalCost">300</span> coins</p>
                <button onclick="buyUpgrade('critical')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Generador de Diamantes <span id="diamondGenLevel">(Nivel 0)</span></h4>
                <p>Genera diamantes automáticamente</p>
                <p>Costo: <span id="diamondGenCost">500</span> coins</p>
                <button onclick="buyUpgrade('diamondGen')">Comprar</button>
            </div>
        </div>

        <div id="advanced" class="tabcontent">
            <div class="upgrade premium-feature">
                <div class="diamond-badge">DIAMANTE</div>
                <h4>Multiplicador de Experiencia <span id="expMultLevel">(Nivel 0)</span></h4>
                <p>Aumenta ganancia de experiencia</p>
                <p>Costo: <span id="expMultCost">10</span> 💎</p>
                <button onclick="buyUpgrade('expMult')">Comprar</button>
            </div>
            <div class="upgrade premium-feature">
                <div class="diamond-badge">DIAMANTE</div>
                <h4>Auto-Rebote <span id="autoLevel">(Nivel 0)</span></h4>
                <p>La bola rebota automáticamente</p>
                <p>Costo: <span id="autoCost">25</span> 💎</p>
                <button onclick="buyUpgrade('auto')">Comprar</button>
            </div>
        </div>

        <div id="legendary" class="tabcontent">
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">LEGENDARIO</div>
                <h4>Ascensión Temporal <span id="timeAscLevel">(Nivel 0)</span></h4>
                <p>Ralentiza el tiempo globalmente</p>
                <p>Costo: <span id="timeAscCost">100</span> 💎</p>
                <button onclick="buyUpgrade('timeAsc')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">LEGENDARIO</div>
                <h4>Dimensión Paralela <span id="dimensionLevel">(Nivel 0)</span></h4>
                <p>Duplica todas las ganancias</p>
                <p>Costo: <span id="dimensionCost">200</span> 💎</p>
                <button onclick="buyUpgrade('dimension')">Comprar</button>
            </div>
        </div>

        <div id="mythic" class="tabcontent">
            <div class="upgrade mythic-upgrade">
                <div class="mythic-badge">MÍTICO</div>
                <h4>Omnipotencia <span id="omniLevel">(Nivel 0)</span></h4>
                <p>Multiplica TODAS las ganancias x10</p>
                <p>Costo: <span id="omnipotenceCost">1000</span> 💎</p>
                <button onclick="buyUpgrade('omnipotence')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <div class="mythic-badge">MÍTICO</div>
                <h4>Infinito <span id="infiniteLevel">(Nivel 0)</span></h4>
                <p>Rompe los límites del juego</p>
                <p>Costo: <span id="infiniteCost">5000</span> 💎</p>
                <button onclick="buyUpgrade('infinite')">Comprar</button>
            </div>
        </div>

        <div id="prestige" class="tabcontent">
            <div class="prestige-section">
                <h3>Sistema de Prestigio</h3>
                <p>Reinicia tu progreso pero ganas bonificadores permanentes</p>
                <p>Puntos de Prestigio: <span id="prestigePoints">0</span></p>
                <p>Requiere nivel 25+ y 500K+ coins</p>
                <button onclick="doPrestige()">Prestigiar</button>
            </div>
            <div class="upgrade">
                <h4>Multiplicador Permanente</h4>
                <p>+10% coins por punto de prestigio</p>
                <p>Costo: 1 Punto de Prestigio</p>
                <button onclick="buyPrestigeUpgrade('coinBonus')">Comprar</button>
            </div>
        </div>

        <div id="ascension" class="tabcontent">
            <div class="prestige-section" style="background: linear-gradient(45deg, #ff6b35, #ff9500);">
                <h3>🔥 Sistema de Ascensión 🔥</h3>
                <p>Reinicia TODO incluyendo prestigio, pero desbloquea poder supremo</p>
                <p>Puntos de Ascensión: <span id="ascensionPointsDisplay">0</span></p>
                <p>Requiere 10+ Prestigios y 1B+ coins</p>
                <button onclick="doAscension()">Ascender</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">ASCENSIÓN</div>
                <h4>Multiplicador Cósmico</h4>
                <p>x2 a TODAS las ganancias por punto de ascensión</p>
                <p>Costo: 1 Punto de Ascensión</p>
                <button onclick="buyAscensionUpgrade('cosmicMult')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">ASCENSIÓN</div>
                <h4>Generador de Prestigio</h4>
                <p>Genera puntos de prestigio automáticamente</p>
                <p>Costo: 2 Puntos de Ascensión</p>
                <button onclick="buyAscensionUpgrade('prestigeGen')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">ASCENSIÓN</div>
                <h4>Acelerador Temporal</h4>
                <p>El juego funciona 2x más rápido permanentemente</p>
                <p>Costo: 3 Puntos de Ascensión</p>
                <button onclick="buyAscensionUpgrade('timeAccel')">Comprar</button>
            </div>
        </div>

        <div id="research" class="tabcontent">
            <h3>Árbol de Investigación</h3>
            <p>Usa experiencia para desbloquear tecnologías</p>
            <div class="upgrade">
                <h4>Eficiencia I</h4>
                <p>+25% coins por rebote</p>
                <p>Costo: 1000 ⭐</p>
                <button onclick="buyResearch('efficiency1')">Investigar</button>
            </div>
            <div class="upgrade">
                <h4>Eficiencia II</h4>
                <p>+50% coins por rebote</p>
                <p>Costo: 5000 ⭐</p>
                <button onclick="buyResearch('efficiency2')">Investigar</button>
            </div>
            <div class="upgrade">
                <h4>Automatización I</h4>
                <p>Genera recursos pasivamente</p>
                <p>Costo: 2500 ⭐</p>
                <button onclick="buyResearch('automation1')">Investigar</button>
            </div>
            <div class="upgrade">
                <h4>Automatización II</h4>
                <p>x2 generación pasiva</p>
                <p>Costo: 10000 ⭐</p>
                <button onclick="buyResearch('automation2')">Investigar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Multiplicación Cósmica</h4>
                <p>x5 a todas las ganancias</p>
                <p>Costo: 50000 ⭐</p>
                <button onclick="buyResearch('cosmic')">Investigar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Trascendencia</h4>
                <p>Desbloquea la siguiente dimensión</p>
                <p>Costo: 1000000 ⭐</p>
                <button onclick="buyResearch('transcend')">Investigar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Mecánica Cuántica</h4>
                <p>+500% a todas las ganancias</p>
                <p>Costo: 5000000 ⭐</p>
                <button onclick="buyResearch('quantum')">Investigar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Infinito</h4>
                <p>Remueve todos los límites</p>
                <p>Costo: 50000000 ⭐</p>
                <button onclick="buyResearch('infinity')">Investigar</button>
            </div>
        </div>

        <div id="particles" class="tabcontent">
            <h3>Efectos de Partículas</h3>
            <div class="upgrade">
                <h4>Tipo de Partículas</h4>
                <div style="margin: 5px 0;">
                    <input type="radio" id="particle1" name="particle" value="circles" checked>
                    <label for="particle1">Círculos</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="radio" id="particle2" name="particle" value="squares">
                    <label for="particle2">Cuadrados</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="radio" id="particle3" name="particle" value="stars">
                    <label for="particle3">Estrellas</label>
                </div>
            </div>
            <div class="upgrade">
                <h4>Efectos Básicos</h4>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="trailEffect" checked>
                    <label for="trailEffect">Estela de partículas</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="burstEffect" checked>
                    <label for="burstEffect">Explosión al rebotar</label>
                </div>
            </div>
            <div class="upgrade premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <h4>Efectos Premium</h4>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="glowEffect" disabled>
                    <label for="glowEffect">Resplandor de la bola</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="rainbowTrail" disabled>
                    <label for="rainbowTrail">Estela arcoíris</label>
                </div>
                <button onclick="showPremiumShop()">Desbloquear Premium</button>
            </div>
        </div>

        <div id="skins" class="tabcontent">
            <h3>Selecciona una Skin</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px;">
                <div class="skin-option selected" onclick="selectSkin('default')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid var(--hud-color); border-radius: 10px;">
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #ff0000, #aa0000); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Predeterminado</div>
                    <div style="font-size: 8px; color: #aaa;">Común</div>
                </div>
                <div class="skin-option" onclick="selectSkin('fire')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px;">
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #ff9900, #ff3300); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Fuego</div>
                    <div style="font-size: 8px; color: #aaa;">Común</div>
                </div>
                <div class="skin-option" onclick="selectSkin('ice')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px;">
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #00ccff, #0066ff); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Hielo</div>
                    <div style="font-size: 8px; color: var(--hud-color);">Rara</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('rainbow')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Arcoíris</div>
                    <div style="font-size: 8px; color: gold;">Premium</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('galaxy')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #9900ff, #330066); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Galaxia</div>
                    <div style="font-size: 8px; color: gold;">Premium</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('cosmic')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #00ffff, #00008b); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Cósmica</div>
                    <div style="font-size: 8px; color: #ff00ff;">Exclusiva</div>
                </div>
            </div>
        </div>

        <div id="premium" class="tabcontent">
            <div class="upgrade">
                <h4>🌟 Desbloquear Premium 🌟</h4>
                <p>Accede a todas las características premium:</p>
                <ul style="font-size: 11px; margin: 10px 0;">
                    <li>🎨 Skins exclusivas y efectos especiales</li>
                    <li>✨ Partículas premium y resplandores</li>
                    <li>🎯 Personalización completa de colores</li>
                    <li>📊 Estadísticas detalladas y avanzadas</li>
                    <li>🚀 Multiplicadores y bonificadores únicos</li>
                    <li>🎪 Eventos especiales y contenido exclusivo</li>
                </ul>
                <div
                    style="background: linear-gradient(45deg, gold, orange); padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">
                    <div style="color: black; font-weight: bold;">Precio: 5000 coins</div>
                    <div style="color: black; font-size: 10px;">Progreso: <span id="premiumProgress">0</span>/<span id="premiumCost">5000</span></div>
                </div>
                <button id="buyPremiumBtn" onclick="buyPremium()"
                    style="background: gold; color: black; font-weight: bold;">Comprar Premium</button>
            </div>
        </div>

        <div id="generators" class="tabcontent">
            <h3>🏭 Generadores Automáticos</h3>
            <div class="upgrade">
                <h4>Generador de Coins Nivel 1</h4>
                <p>Genera 10 coins/seg</p>
                <p>Costo: 1000 coins</p>
                <button onclick="buyGenerator('coin1')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Generador de Coins Nivel 2</h4>
                <p>Genera 100 coins/seg</p>
                <p>Costo: 25000 coins</p>
                <button onclick="buyGenerator('coin2')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Generador de Diamantes</h4>
                <p>Genera 1 diamante/min</p>
                <p>Costo: 100000 coins</p>
                <button onclick="buyGenerator('diamond1')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Generador de Experiencia</h4>
                <p>Genera 50 exp/seg</p>
                <p>Costo: 50 💎</p>
                <button onclick="buyGenerator('exp1')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Generador Universal</h4>
                <p>Genera TODO automáticamente</p>
                <p>Costo: 500 💎</p>
                <button onclick="buyGenerator('universal')">Comprar</button>
            </div>
            <div class="upgrade premium-feature legendary-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Generador Cuántico</h4>
                <p>Genera recursos basado en experiencia</p>
                <p>Costo: 1000 💎</p>
                <button onclick="buyGenerator('quantum')">Comprar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Reactor de Fusión</h4>
                <p>Convierte experiencia en diamantes</p>
                <p>Costo: 2000 💎</p>
                <button onclick="buyGenerator('fusion')">Comprar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Acelerador Temporal</h4>
                <p>Acelera el juego basado en experiencia</p>
                <p>Costo: 5000 💎</p>
                <button onclick="buyGenerator('temporal')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Multiplicador de Rebotes</h4>
                <p>Cada rebote cuenta como múltiples</p>
                <p>Costo: 10000 coins</p>
                <button onclick="buyGenerator('bounceMulti')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Generador de Niveles</h4>
                <p>Sube de nivel automáticamente</p>
                <p>Costo: 1500 💎</p>
                <button onclick="buyGenerator('levelGen')">Comprar</button>
            </div>
            <div class="upgrade premium-feature legendary-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Recolector de Orbes</h4>
                <p>Recoge orbes automáticamente</p>
                <p>Costo: 3000 💎</p>
                <button onclick="buyGenerator('orbCollector')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Auto-Clicker Nivel 1</h4>
                <p>Clicks automáticos cada 5 segundos</p>
                <p>Costo: 100 💎</p>
                <button onclick="buyAutoClicker(1)">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Auto-Clicker Nivel 2</h4>
                <p>Clicks automáticos cada 2 segundos</p>
                <p>Costo: 300 💎</p>
                <button onclick="buyAutoClicker(2)">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Auto-Clicker Supremo</h4>
                <p>Clicks automáticos cada segundo</p>
                <p>Costo: 1000 💎</p>
                <button onclick="buyAutoClicker(3)">Comprar</button>
            </div>
        </div>

        <div id="collection" class="tabcontent">
            <h3>🃏 Cartas Coleccionables</h3>
            <div id="cardsList">
                <div class="upgrade"><h4>Carta de Velocidad</h4><p>+10% velocidad - Común</p><button onclick="buyCard('speed')">25 💎</button></div>
                <div class="upgrade"><h4>Carta de Fortuna</h4><p>+25% coins - Rara</p><button onclick="buyCard('coins')">25 💎</button></div>
                <div class="upgrade"><h4>Carta Crítica</h4><p>+5% crítico - Épica</p><button onclick="buyCard('critical')">50 💎</button></div>
                <div class="upgrade"><h4>Carta de Sabiduría</h4><p>+30% experiencia - Rara</p><button onclick="buyCard('experience')">35 💎</button></div>
                <div class="upgrade"><h4>Carta de Combo</h4><p>+2 duración combo - Épica</p><button onclick="buyCard('combo')">60 💎</button></div>
                <div class="upgrade legendary-upgrade"><h4>Carta de Gemas</h4><p>+15% diamantes - Legendaria</p><button onclick="buyCard('diamond')">100 💎</button></div>
                <div class="upgrade legendary-upgrade"><h4>Carta de Poder</h4><p>+50% puntos prestigio - Legendaria</p><button onclick="buyCard('prestige')">150 💎</button></div>
                <div class="upgrade mythic-upgrade"><h4>Carta Suprema</h4><p>x2 a TODO - Mítica</p><button onclick="buyCard('ultimate')">500 💎</button></div>
            </div>
            <h3>🐾 Mascotas</h3>
            <div id="petsList">
                <div class="upgrade"><h4>Gato Cósmico</h4><p>+15% experiencia</p><button onclick="buyPet('cat')">50 💎</button></div>
                <div class="upgrade"><h4>Dragón Dorado</h4><p>+30% coins</p><button onclick="buyPet('dragon')">200 💎</button></div>
                <div class="upgrade"><h4>Fénix de Fuego</h4><p>+20% velocidad</p><button onclick="buyPet('phoenix')">150 💎</button></div>
                <div class="upgrade legendary-upgrade"><h4>Unicornio Mágico</h4><p>+25% diamantes</p><button onclick="buyPet('unicorn')">300 💎</button></div>
                <div class="upgrade legendary-upgrade"><h4>Kraken Abismal</h4><p>+40% combo</p><button onclick="buyPet('kraken')">400 💎</button></div>
                <div class="upgrade mythic-upgrade"><h4>Ser Celestial</h4><p>+100% todo por 1min cada hora</p><button onclick="buyPet('celestial')">1000 💎</button></div>
            <div class="upgrade premium-feature legendary-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Robot Recolector</h4><p>Recoge orbes automáticamente</p><button onclick="buyPet('robot')">2000 💎</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Dragón Ancestral</h4><p>x5 a todas las ganancias</p><button onclick="buyPet('ancientDragon')">5000 💎</button>
            </div>
            </div>
            <h3>⚡ Artefactos</h3>
            <div id="artifactsList">
                <div class="upgrade"><h4>Orbe del Tiempo</h4><p>Ralentiza el tiempo 10%</p><button onclick="buyArtifact('orb')">100 💎</button></div>
                <div class="upgrade"><h4>Anillo de Poder</h4><p>x3 puntos de prestigio</p><button onclick="buyArtifact('ring')">250 💎</button></div>
                <div class="upgrade"><h4>Amuleto de la Suerte</h4><p>+50% críticos</p><button onclick="buyArtifact('amulet')">300 💎</button></div>
                <div class="upgrade legendary-upgrade"><h4>Corona Infinita</h4><p>Niveles infinitos</p><button onclick="buyArtifact('crown')">500 💎</button></div>
                <div class="upgrade legendary-upgrade"><h4>Bastón Arcano</h4><p>Auto-prestigio cada 10min</p><button onclick="buyArtifact('staff')">800 💎</button></div>
                <div class="upgrade mythic-upgrade"><h4>Reliquia Ancestral</h4><p>Genera recursos offline</p><button onclick="buyArtifact('relic')">1200 💎</button></div>
            </div>
        </div>
    </div>

    <div id="importExport">
        <h3>Importar/Exportar Datos</h3>
        <p>Copia tu código de guardado:</p>
        <textarea id="saveData" placeholder="Pega aquí tu código de guardado..."></textarea>
        <div style="margin-top: 10px;">
            <button onclick="exportSave()">Exportar</button>
            <button onclick="importSave()">Importar</button>
            <button onclick="downloadSave()">Descargar</button>
            <button onclick="toggleImportExport()">Cerrar</button>
        </div>
    </div>

    <script>
        // Variables del juego
        let gameData = {
            coins: 0,
            diamonds: 0,
            experience: 0,
            bounces: 0,
            level: 1,
            prestige: 0,
            prestigePoints: 0,
            ascension: 0,
            ascensionPoints: 0,
            achievements: [],
            cards: [],
            pets: [],
            artifacts: [],
            events: { current: null, timeLeft: 0 },
            dailyChallenges: [],
            leaderboard: { rank: 0, score: 0 },
            season: 1,
            infiniteLevels: false,
            lastSave: Date.now(),
            lastDailyReset: Date.now(),
            saveCount: 0,
            upgrades: {
                coinMult: { level: 0, baseCost: 100, multiplier: 1.5, maxLevel: 1000 },
                speed: { level: 0, baseCost: 150, multiplier: 1.6, maxLevel: 500 },
                size: { level: 0, baseCost: 200, multiplier: 1.7, maxLevel: 200 },
                combo: { level: 0, baseCost: 250, multiplier: 1.8, maxLevel: 100 },
                critical: { level: 0, baseCost: 300, multiplier: 1.9, maxLevel: 50 },
                diamondGen: { level: 0, baseCost: 500, multiplier: 2.0, maxLevel: 25 },
                expMult: { level: 0, baseCost: 10, multiplier: 2.5, currency: 'diamonds', maxLevel: 100 },
                auto: { level: 0, baseCost: 25, multiplier: 3.0, currency: 'diamonds', maxLevel: 10 },
                timeAsc: { level: 0, baseCost: 100, multiplier: 5.0, currency: 'diamonds', maxLevel: 5 },
                dimension: { level: 0, baseCost: 200, multiplier: 10.0, currency: 'diamonds', maxLevel: 3 },
                omnipotence: { level: 0, baseCost: 1000, multiplier: 50.0, currency: 'diamonds', maxLevel: 2 },
                infinite: { level: 0, baseCost: 5000, multiplier: 100.0, currency: 'diamonds', maxLevel: 1 }
            },
            research: {
                unlocked: [],
                available: ['efficiency1', 'automation1']
            }
        };

        let canvas, ctx, width, height;
        let coins = 0, diamonds = 0, experience = 0, bounces = 0, level = 1;
        let combo = 1, gamePaused = false;
        let ball = { x: 0, y: 0, radius: 20, dx: 5, dy: 5, color: '#ff0000' };
        let particles = [];
        let orbs = [];
        let orbTypes = [
            { id: 'speed', name: 'Orbe de Velocidad', color: '#00ff00', effect: 'speed', power: 1.5, duration: 5000, rarity: 'común' },
            { id: 'coins', name: 'Orbe de Fortuna', color: '#ffd700', effect: 'coins', power: 2, duration: 8000, rarity: 'común' },
            { id: 'diamonds', name: 'Orbe de Gemas', color: '#ff69b4', effect: 'diamonds', power: 3, duration: 6000, rarity: 'raro' },
            { id: 'combo', name: 'Orbe de Combo', color: '#ff4500', effect: 'combo', power: 1.8, duration: 10000, rarity: 'raro' },
            { id: 'critical', name: 'Orbe Crítico', color: '#dc143c', effect: 'critical', power: 2.5, duration: 7000, rarity: 'épico' },
            { id: 'experience', name: 'Orbe de Sabiduría', color: '#9370db', effect: 'experience', power: 3, duration: 9000, rarity: 'épico' },
            { id: 'time', name: 'Orbe Temporal', color: '#00ffff', effect: 'time', power: 0.7, duration: 12000, rarity: 'legendario' },
            { id: 'rainbow', name: 'Orbe Arcoíris', color: '#ffffff', effect: 'rainbow', power: 5, duration: 15000, rarity: 'mítico' }
        ];
        let activeOrbEffects = [];

        // Inicialización
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            resize();
            window.addEventListener('resize', resize);

            ball.x = width / 2;
            ball.y = height / 2;
            
            // Asegurar velocidad inicial correcta
            ball.dx = 5;
            ball.dy = 5;

            loadGame();
            setupEventListeners();
            
            // Aplicar efectos de velocidad después de cargar
            if (gameData.upgrades.speed.level > 0) {
                applyUpgradeEffects('speed');
            }

            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                gameLoop();
            }, 2000);
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        function setupEventListeners() {
            document.getElementById('shopBtn').onclick = () => togglePanel('shop');
            document.getElementById('pauseBtn').onclick = togglePause;
            document.getElementById('importExportBtn').onclick = () => togglePanel('importExport');
            document.getElementById('prestigeBtn').onclick = doPrestige;
            document.getElementById('configBtn').onclick = () => togglePanel('config');
            document.getElementById('statsBtn').onclick = () => { togglePanel('stats'); updateStats(); };
            document.getElementById('missionsBtn').onclick = () => { togglePanel('missions'); updateMissions(); };
            document.getElementById('achievementsBtn').onclick = () => { 
                togglePanel('achievements'); 
                updateAchievementsDisplay(); 
                updateEventsDisplay(); 
            };
            document.getElementById('dailyChallengesBtn').onclick = () => { togglePanel('dailyChallenges'); updateDailyChallengesDisplay(); updateResetTimer(); };
            
            // Detectar actividad del usuario para sistema anti-AFK
            document.addEventListener('mousemove', resetAfkTimer);
            document.addEventListener('keypress', resetAfkTimer);
            document.addEventListener('click', resetAfkTimer);
            document.addEventListener('scroll', resetAfkTimer);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('touchstart', resetAfkTimer);
            document.addEventListener('touchmove', resetAfkTimer);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('focus', handleWindowFocus);
        }

        function gameLoop() {
            if (!gamePaused) {
                update();
                render();
            }
            requestAnimationFrame(gameLoop);
        }

        function update() {
            ball.x += ball.dx * gameSpeed;
            ball.y += ball.dy * gameSpeed;

            // Evitar que la pelota se quede atascada
            if (ball.x <= ball.radius) {
                ball.x = ball.radius + 1;
                ball.dx = Math.abs(ball.dx);
                handleBounce();
            }
            if (ball.x >= width - ball.radius) {
                ball.x = width - ball.radius - 1;
                ball.dx = -Math.abs(ball.dx);
                handleBounce();
            }
            if (ball.y <= ball.radius) {
                ball.y = ball.radius + 1;
                ball.dy = Math.abs(ball.dy);
                handleBounce();
            }
            if (ball.y >= height - ball.radius) {
                ball.y = height - ball.radius - 1;
                ball.dy = -Math.abs(ball.dy);
                handleBounce();
            }

            updateParticles();
            updateOrbs();
            checkOrbCollisions();
            updateOrbEffects();
            updateAfkSystem();
            updateDailyChallenges();
        }

        function render() {
            ctx.fillStyle = '#222';
            ctx.fillRect(0, 0, width, height);

            // Dibujar orbes
            orbs.forEach(orb => {
                ctx.globalAlpha = orb.alpha;
                ctx.beginPath();
                ctx.arc(orb.x, orb.y, orb.radius, 0, Math.PI * 2);
                
                // Efecto de resplandor según rareza
                const glowSize = orb.type.rarity === 'mítico' ? 30 : orb.type.rarity === 'legendario' ? 20 : 15;
                const gradient = ctx.createRadialGradient(orb.x, orb.y, 0, orb.x, orb.y, glowSize);
                gradient.addColorStop(0, orb.type.color);
                gradient.addColorStop(0.7, orb.type.color + '80');
                gradient.addColorStop(1, orb.type.color + '00');
                
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Núcleo del orbe
                ctx.beginPath();
                ctx.arc(orb.x, orb.y, orb.radius * 0.6, 0, Math.PI * 2);
                ctx.fillStyle = orb.type.color;
                ctx.fill();
                
                // Texto del tipo de orbe
                ctx.fillStyle = 'white';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(orb.type.name.split(' ')[1] || orb.type.id, orb.x, orb.y - orb.radius - 5);
            });
            ctx.globalAlpha = 1;

            // Dibujar bola
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
            
            // Efecto de aura si hay efectos activos
            if (activeOrbEffects.length > 0) {
                const auraGradient = ctx.createRadialGradient(ball.x, ball.y, ball.radius, ball.x, ball.y, ball.radius * 2);
                auraGradient.addColorStop(0, activeOrbEffects[0].color + '40');
                auraGradient.addColorStop(1, activeOrbEffects[0].color + '00');
                ctx.fillStyle = auraGradient;
                ctx.fill();
            }

            // Dibujar partículas
            particles.forEach(p => {
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
            });
            ctx.globalAlpha = 1;
        }

        function handleBounce() {
            bounces++;
            gameData.bounces = bounces;

            // Calcular coins ganadas MEJORADAS PARA EL JUGADOR
            let baseCoins = 2 + Math.floor(level / 10); // Más coins base
            let coinMultiplier = Math.pow(1.15, gameData.upgrades.coinMult.level); // Mejor multiplicador
            let comboMultiplier = Math.min(combo * (1 + gameData.upgrades.combo.level * 0.08), 30); // Combo más efectivo
            let prestigeMultiplier = (1 + gameData.prestige * 0.1); // Mejor bonus prestigio

            // Crítico mejorado
            let criticalMultiplier = 1;
            if (Math.random() < Math.min(gameData.upgrades.critical.level * 0.02, 0.25)) { // Más chance crítico
                criticalMultiplier = 3; // Críticos más poderosos
                // Actualizar progreso de críticos
                if (currentDailyChallenge && currentDailyChallenge.id === 'critical') {
                    if (!currentDailyChallenge.criticalHits) currentDailyChallenge.criticalHits = 0;
                    currentDailyChallenge.criticalHits++;
                }
            }

            let coinsGained = Math.floor(baseCoins * coinMultiplier * comboMultiplier * prestigeMultiplier * criticalMultiplier * 0.8); // Más coins

            // Aplicar efectos de colección
            const effects = applyCollectionEffects();
            coinsGained = Math.floor(coinsGained * effects.coinMultiplier);
            
            // Aplicar eventos temporales
            if (currentEvent && currentEvent.effect === 'coins') {
                coinsGained *= 3;
            }

            // Aplicar investigaciones
            if (gameData.research.unlocked.includes('efficiency1')) coinsGained = Math.floor(coinsGained * 1.25);
            if (gameData.research.unlocked.includes('efficiency2')) coinsGained = Math.floor(coinsGained * 1.5);
            if (gameData.research.unlocked.includes('cosmic')) coinsGained = Math.floor(coinsGained * 5);
            
            // Aplicar eventos especiales
            if (currentEvent) {
                switch(currentEvent.effect) {
                    case 'coins': coinsGained *= 3; break;
                    case 'speed': ball.dx *= 1.5; ball.dy *= 1.5; break;
                    case 'critical': criticalMultiplier = 2; break;
                    case 'magic': diamonds += 10; break;
                    case 'cosmic': coinsGained *= 10; expGained *= 10; break;
                }
            }

            // Mejoras legendarias y míticas
            if (gameData.upgrades.dimension.level > 0) coinsGained *= Math.pow(2, gameData.upgrades.dimension.level);
            if (gameData.upgrades.omnipotence.level > 0) coinsGained *= Math.pow(10, gameData.upgrades.omnipotence.level);
            if (gameData.upgrades.infinite.level > 0) coinsGained *= Math.pow(100, gameData.upgrades.infinite.level);

            coins += coinsGained;
            gameData.coins = coins;

            // Experiencia mejorada
            let expGained = Math.floor(coinsGained / 5); // Más experiencia base
            if (gameData.upgrades.expMult.level > 0) expGained *= Math.pow(2.5, gameData.upgrades.expMult.level); // Mejor multiplicador
            expGained = Math.floor(expGained * effects.expMultiplier);
            experience += expGained;
            gameData.experience = experience;

            // Generación de diamantes MEJORADA
            let diamondChance = 0.015 + gameData.upgrades.diamondGen.level * 0.005; // Más chance
            if (currentEvent && currentEvent.effect === 'diamonds') diamondChance *= 2;
            
            if (Math.random() < diamondChance) {
                let diamondsGained = Math.floor(Math.random() * 3) + 1; // Más diamantes
                if (currentEvent && currentEvent.effect === 'diamonds') diamondsGained = Math.floor(diamondsGained * 2);
                diamonds += diamondsGained;
                gameData.diamonds = diamonds;
            }

            // Subir de nivel (más rápido)
            if (bounces >= level * 75) {
                level++;
                gameData.level = level;
                // Solo notificar niveles importantes
                if (level % 5 === 0 || level <= 10) {
                    showNotification(`¡Nivel ${level} alcanzado!`);
                }
            }

            // Combo mejorado para el jugador
            let comboDecay = 0.01 - (gameData.upgrades.combo.level * 0.008); // Menos decay
            if (currentEvent && currentEvent.effect === 'combo') comboDecay = 0;
            combo = Math.max(1, combo - comboDecay);
            combo = Math.min(combo + 0.15, 15 + gameData.upgrades.combo.level); // Más combo y límite más alto

            createParticles(ball.x, ball.y);
            updateUI();
        }

        function createParticles(x, y) {
            const count = document.getElementById('particleCount') ? parseInt(document.getElementById('particleCount').value) : 10;
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    dx: (Math.random() - 0.5) * 10,
                    dy: (Math.random() - 0.5) * 10,
                    life: 1000,
                    maxLife: 1000,
                    alpha: 1,
                    color: '#4CAF50'
                });
            }
            
            // Actualizar progreso de partículas
            if (currentDailyChallenge && currentDailyChallenge.id === 'particles') {
                if (!currentDailyChallenge.particlesGenerated) currentDailyChallenge.particlesGenerated = 0;
                currentDailyChallenge.particlesGenerated += count;
            }
        }

        function updateParticles() {
            particles = particles.filter(particle => {
                particle.x += particle.dx;
                particle.y += particle.dy;
                particle.life -= 16;
                particle.alpha = particle.life / particle.maxLife;
                return particle.life > 0;
            });
        }

        function updateUI() {
            document.getElementById('coins').textContent = formatNumber(coins);
            document.getElementById('diamonds').textContent = formatNumber(diamonds);
            document.getElementById('experience').textContent = formatNumber(experience);
            document.getElementById('bounces').textContent = formatNumber(bounces);
            document.getElementById('level').textContent = gameData.infiniteLevels ? level + '∞' : level;
            document.getElementById('prestige').textContent = gameData.prestige;
            document.getElementById('combo').textContent = combo.toFixed(1) + 'x';
            document.getElementById('prestigePoints').textContent = gameData.prestigePoints;
            if (document.getElementById('ascensionPoints')) document.getElementById('ascensionPoints').textContent = gameData.ascensionPoints;
            if (document.getElementById('ascensionPointsDisplay')) document.getElementById('ascensionPointsDisplay').textContent = gameData.ascensionPoints;
            if (document.getElementById('achievementCount')) document.getElementById('achievementCount').textContent = (gameData.achievements || []).length;
            if (document.getElementById('cardCount')) document.getElementById('cardCount').textContent = (gameData.cards || []).length;
            
            // Actualizar contador de orbes
            if (document.getElementById('orbCount')) {
                document.getElementById('orbCount').textContent = orbs.length;
            }
            
            // Actualizar efectos de orbes activos
            const orbEffectsDisplay = document.getElementById('activeOrbEffectsDisplay');
            if (orbEffectsDisplay) {
                if (activeOrbEffects.length > 0) {
                    const effectsText = activeOrbEffects.map(effect => 
                        `🔮 ${effect.name.split(' ')[1] || effect.type}: ${Math.ceil(effect.timeLeft/1000)}s`
                    ).join('<br>');
                    orbEffectsDisplay.innerHTML = effectsText;
                } else {
                    orbEffectsDisplay.innerHTML = '';
                }
            }
            
            // Actualizar displays del HUD
            if (document.getElementById('eventStatus')) {
                document.getElementById('eventStatus').textContent = currentEvent ? currentEvent.name : 'Ninguno';
            }

            if (document.getElementById('afkTimer')) {
                const afkMinutes = Math.floor(afkTime / 60);
                const afkSeconds = afkTime % 60;
                document.getElementById('afkTimer').textContent = afkMinutes > 0 ? `${afkMinutes}m${afkSeconds}s` : `${afkSeconds}s`;
            }
            
            updateShopUI();
            checkAchievements();
        }

        function updateShopUI() {
            Object.keys(gameData.upgrades).forEach(upgradeId => {
                const upgrade = gameData.upgrades[upgradeId];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.multiplier, upgrade.level));

                const levelElement = document.getElementById(upgradeId + 'Level');
                const costElement = document.getElementById(upgradeId + 'Cost');

                if (levelElement) levelElement.textContent = `(Nivel ${upgrade.level})`;
                if (costElement) {
                    costElement.textContent = formatNumber(cost);
                    const currency = upgrade.currency || 'coins';
                    const currentAmount = currency === 'coins' ? coins : (currency === 'diamonds' ? diamonds : experience);
                    costElement.style.color = currentAmount >= cost ? '#4CAF50' : '#ff4444';
                }
            });
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return Math.floor(num).toString();
        }

        function buyUpgrade(upgradeId) {
            const upgrade = gameData.upgrades[upgradeId];
            if (!upgrade || upgrade.level >= upgrade.maxLevel) return;

            const currency = upgrade.currency || 'coins';
            const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.multiplier, upgrade.level));

            let currentAmount = currency === 'coins' ? coins : (currency === 'diamonds' ? diamonds : experience);

            if (currentAmount >= cost && cost > 0) {
                if (currency === 'coins') {
                    coins = Math.max(0, coins - cost);
                    gameData.coins = coins;
                } else if (currency === 'diamonds') {
                    diamonds = Math.max(0, diamonds - cost);
                    gameData.diamonds = diamonds;
                } else {
                    experience = Math.max(0, experience - cost);
                    gameData.experience = experience;
                }
                upgrade.level = Math.min(upgrade.level + 1, upgrade.maxLevel);
                if (missions.upgrades) missions.upgrades.progress++;

                applyUpgradeEffects(upgradeId);
                updateUI();
            }
        }

        function applyUpgradeEffects(upgradeId) {
            switch (upgradeId) {
                case 'speed':
                    // Aplicar velocidad base más incremento por nivel
                    const baseSpeed = 5;
                    const speedIncrease = gameData.upgrades.speed.level * 0.5;
                    const newSpeed = baseSpeed + speedIncrease;
                    
                    // Mantener la dirección actual
                    const directionX = ball.dx > 0 ? 1 : -1;
                    const directionY = ball.dy > 0 ? 1 : -1;
                    
                    ball.dx = newSpeed * directionX;
                    ball.dy = newSpeed * directionY;
                    break;
                case 'size':
                    ball.radius = 20 + gameData.upgrades.size.level * 2;
                    break;
                case 'auto':
                    if (gameData.upgrades.auto.level === 1) {
                        setInterval(() => {
                            if (!gamePaused) {
                                handleBounce();
                            }
                        }, 2000 - (gameData.upgrades.auto.level * 200));
                    }
                    break;
                case 'timeAsc':
                    if (gameData.upgrades.timeAsc.level > 0) {
                        ball.dx *= 0.9;
                        ball.dy *= 0.9;
                    }
                    break;
            }
        }

        function doPrestige() {
            if (level >= 25 && coins >= 500000) {
                let prestigePointsGained = Math.floor(Math.log10(coins / 500000) + 2); // Más puntos de prestigio

                coins = 0;
                bounces = 0;
                level = 1;
                experience = 0;
                combo = 1;
                totalBounces = 0;
                totalCoins = 0;
                missionSet = 1;
                completedMissions = 0;

                gameData.coins = 0;
                gameData.bounces = 0;
                gameData.level = 1;
                gameData.experience = 0;

                ['coinMult', 'speed', 'size', 'combo', 'critical', 'diamondGen'].forEach(key => {
                    gameData.upgrades[key].level = 0;
                });

                gameData.prestigePoints += prestigePointsGained;
                gameData.prestige++;

                // Resetear pelota a valores iniciales
                ball.radius = 20;
                ball.dx = 5;
                ball.dy = 5;
                ball.color = '#ff0000';

                generateMissions();
                updateUI();
                showNotification(`¡Prestigio completado! +${prestigePointsGained} puntos`);
            } else {
                showNotification('Necesitas nivel 25+ y 500K+ coins para prestigiar');
            }
        }

        function buyPrestigeUpgrade(upgradeId) {
            if (upgradeId === 'coinBonus' && gameData.prestigePoints >= 1) {
                gameData.prestigePoints -= 1;
                gameData.prestige += 0.1;
                updateUI();
                showNotification('¡Multiplicador permanente comprado! +10% coins');
            }
        }

        function buyResearch(researchId) {
            const costs = {
                efficiency1: 1000, efficiency2: 5000,
                automation1: 2500, automation2: 10000,
                cosmic: 50000, transcend: 1000000,
                quantum: 5000000, infinity: 50000000
            };

            if (experience >= costs[researchId] && !gameData.research.unlocked.includes(researchId)) {
                experience -= costs[researchId];
                gameData.experience = experience;
                gameData.research.unlocked.push(researchId);
                
                // Aplicar efectos de investigación
                if (researchId === 'quantum') {
                    showNotification('¡Mecánica Cuántica desbloqueada! +500% a todo');
                } else if (researchId === 'infinity') {
                    showNotification('¡Infinito desbloqueado! Límites removidos');
                }
                
                updateUI();
                showNotification(`¡Investigación ${researchId} completada!`);
            }
        }
        
        function buyGenerator(genId) {
            const generators = {
                coin1: { cost: 1000, currency: 'coins' },
                coin2: { cost: 25000, currency: 'coins' },
                diamond1: { cost: 100000, currency: 'coins' },
                exp1: { cost: 50, currency: 'diamonds' },
                universal: { cost: 500, currency: 'diamonds' },
                quantum: { cost: 1000, currency: 'diamonds', premium: true },
                fusion: { cost: 2000, currency: 'diamonds', premium: true },
                temporal: { cost: 5000, currency: 'diamonds', premium: true },
                bounceMulti: { cost: 10000, currency: 'coins' },
                levelGen: { cost: 1500, currency: 'diamonds' },
                orbCollector: { cost: 3000, currency: 'diamonds', premium: true }
            };
            
            const gen = generators[genId];
            if (!gen) return;
            
            if (gen.premium && !premiumUnlocked) {
                showPremiumShop();
                return;
            }
            
            const currentAmount = gen.currency === 'coins' ? coins : diamonds;
            if (currentAmount >= gen.cost && !gameData.generators?.includes(genId)) {
                if (gen.currency === 'coins') {
                    coins -= gen.cost;
                    gameData.coins = coins;
                } else {
                    diamonds -= gen.cost;
                    gameData.diamonds = diamonds;
                }
                
                if (!gameData.generators) gameData.generators = [];
                gameData.generators.push(genId);
                updateUI();
                showNotification(`🏭 Generador ${genId} comprado!`);
            }
        }

        function generateResources() {
            if (gameData.upgrades.diamondGen.level > 0) {
                diamonds += gameData.upgrades.diamondGen.level * 0.2; // Doble generación
                gameData.diamonds = diamonds;
            }

            if (gameData.prestigePoints > 0) {
                diamonds += gameData.prestigePoints * 0.02; // Doble generación pasiva
                coins += gameData.prestigePoints * 25; // Más coins pasivas
                gameData.diamonds = diamonds;
                gameData.coins = coins;
            }

            if (gameData.upgrades.auto.level > 0 && !gamePaused) {
                if (Math.random() < 0.05 * gameData.upgrades.auto.level) {
                    handleBounce();
                }
            }

            // Generadores automáticos
            if (gameData.generators) {
                if (gameData.generators.includes('coin1')) coins += 10;
                if (gameData.generators.includes('coin2')) coins += 100;
                if (gameData.generators.includes('exp1')) experience += 50;
                if (gameData.generators.includes('universal')) {
                    coins += 50; diamonds += 1; experience += 25;
                }
                if (gameData.generators.includes('quantum')) {
                    const expBonus = Math.floor(experience / 1000);
                    coins += expBonus; diamonds += Math.floor(expBonus / 100);
                }
                if (gameData.generators.includes('fusion')) {
                    if (experience >= 10000) {
                        experience -= 1000;
                        diamonds += 10;
                    }
                }
                if (gameData.generators.includes('temporal')) {
                    gameSpeed = 1 + (experience / 100000);
                }
                if (gameData.generators.includes('bounceMulti')) {
                    if (Math.random() < 0.1) handleBounce();
                }
                if (gameData.generators.includes('levelGen')) {
                    if (Math.random() < 0.01) {
                        level++;
                        gameData.level = level;
                    }
                }
                if (gameData.generators.includes('orbCollector')) {
                    orbs.forEach((orb, index) => {
                        if (Math.random() < 0.05) {
                            collectOrb(orb);
                            orbs.splice(index, 1);
                        }
                    });
                }
                gameData.coins = coins;
                gameData.experience = experience;
                gameData.diamonds = diamonds;
            }
            
            // Investigaciones pasivas mejoradas
            if (gameData.research.unlocked.includes('automation1')) {
                coins += Math.floor(level * 3); // Triple generación
                gameData.coins = coins;
            }
            if (gameData.research.unlocked.includes('automation2')) {
                coins += Math.floor(level * 6); // Triple generación
                diamonds += Math.floor(level / 5); // Doble generación de diamantes
                gameData.coins = coins;
                gameData.diamonds = diamonds;
            }

            updateUI();
        }

        function autoSave() {
            gameData.lastSave = Date.now();
            gameData.saveCount++;
            
            const saveData = {
                coins, diamonds, experience, bounces, level,
                prestige: gameData.prestige, prestigePoints: gameData.prestigePoints,
                ascension: gameData.ascension, ascensionPoints: gameData.ascensionPoints,
                achievements: gameData.achievements, cards: gameData.cards, pets: gameData.pets,
                artifacts: gameData.artifacts, events: gameData.events, season: gameData.season,
                infiniteLevels: gameData.infiniteLevels, lastSave: gameData.lastSave,
                lastDailyReset: gameData.lastDailyReset, saveCount: gameData.saveCount,
                premiumUnlocked, selectedSkin, missionSet, completedMissions,
                totalBounces, totalCoins, bestCombo, missions,
                dailyChallenges, currentDailyChallenge, advancedMissions,
                upgrades: gameData.upgrades, research: gameData.research,
                timestamp: gameData.lastSave
            };
            localStorage.setItem('circleBounceUltimate', JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem('circleBounceUltimate');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Validaciones anti-exploit
                    coins = Math.max(0, Math.min(data.coins || 0, 1e15));
                    diamonds = Math.max(0, Math.min(data.diamonds || 0, 1e10));
                    experience = Math.max(0, Math.min(data.experience || 0, 1e12));
                    bounces = Math.max(0, Math.min(data.bounces || 0, 1e12));
                    level = Math.max(1, Math.min(data.level || 1, 10000));
                    
                    gameData.prestige = Math.max(0, Math.min(data.prestige || 0, 1000));
                    gameData.prestigePoints = Math.max(0, Math.min(data.prestigePoints || 0, 10000));
                    gameData.ascension = Math.max(0, Math.min(data.ascension || 0, 100));
                    gameData.ascensionPoints = Math.max(0, Math.min(data.ascensionPoints || 0, 1000));
                    gameData.achievements = Array.isArray(data.achievements) ? data.achievements.slice(0, 50) : [];
                    gameData.cards = Array.isArray(data.cards) ? data.cards.slice(0, 20) : [];
                    gameData.pets = Array.isArray(data.pets) ? data.pets.slice(0, 20) : [];
                    gameData.artifacts = Array.isArray(data.artifacts) ? data.artifacts.slice(0, 20) : [];
                    gameData.events = data.events || { current: null, timeLeft: 0 };
                    gameData.season = Math.max(1, Math.min(data.season || 1, 100));
                    gameData.infiniteLevels = Boolean(data.infiniteLevels);
                    gameData.lastSave = data.lastSave || Date.now();
                    gameData.lastDailyReset = data.lastDailyReset || Date.now();
                    gameData.saveCount = Math.max(0, data.saveCount || 0);
                    
                    premiumUnlocked = Boolean(data.premiumUnlocked);
                    selectedSkin = data.selectedSkin || 'default';
                    missionSet = Math.max(1, Math.min(data.missionSet || 1, 1000));
                    completedMissions = Math.max(0, Math.min(data.completedMissions || 0, 1000));
                    totalBounces = Math.max(0, Math.min(data.totalBounces || 0, 1e12));
                    totalCoins = Math.max(0, Math.min(data.totalCoins || 0, 1e15));
                    bestCombo = Math.max(1, Math.min(data.bestCombo || 1, 1000));
                    
                    if (data.missions && typeof data.missions === 'object') missions = data.missions;
                    if (data.dailyChallenges && Array.isArray(data.dailyChallenges)) dailyChallenges = data.dailyChallenges;
                    if (data.currentDailyChallenge && typeof data.currentDailyChallenge === 'object') currentDailyChallenge = data.currentDailyChallenge;
                    if (data.advancedMissions && Array.isArray(data.advancedMissions)) advancedMissions = data.advancedMissions;
                    if (data.upgrades && typeof data.upgrades === 'object') gameData.upgrades = data.upgrades;
                    if (data.research && typeof data.research === 'object') gameData.research = data.research;
                    
                    if (gameData.events.current) {
                        currentEvent = gameData.events.current;
                        eventTimeLeft = Math.max(0, gameData.events.timeLeft || 0);
                    }
                    
                    syncCollectionData();
                    updateUI();
                    renderMissions();
                } catch (error) {
                    console.log('Error cargando datos');
                    showNotification('Error al cargar - datos corruptos');
                }
            }
        }

        function exportSave() {
            gameData.coins = coins;
            gameData.diamonds = diamonds;
            gameData.experience = experience;
            gameData.bounces = bounces;
            gameData.level = level;
            const saveString = btoa(JSON.stringify(gameData));
            document.getElementById('saveData').value = saveString;
        }

        function importSave() {
            try {
                const saveString = document.getElementById('saveData').value;
                const importedData = JSON.parse(atob(saveString));
                if (importedData.coins !== undefined) {
                    gameData = { ...gameData, ...importedData };
                    coins = gameData.coins || 0;
                    diamonds = gameData.diamonds || 0;
                    experience = gameData.experience || 0;
                    bounces = gameData.bounces || 0;
                    level = gameData.level || 1;
                    updateUI();
                    showNotification('¡Datos importados correctamente!');
                }
            } catch (error) {
                showNotification('Error al importar datos');
            }
        }

        function downloadSave() {
            exportSave();
            const saveString = document.getElementById('saveData').value;
            const blob = new Blob([saveString], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `circle_bounce_save_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();

            URL.revokeObjectURL(url);
        }



        function togglePause() {
            gamePaused = !gamePaused;
            document.getElementById('pauseBtn').textContent = gamePaused ? '▶️ Reanudar' : '⏸️ Pausa';
        }



        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName('tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }

            const tablinks = document.getElementsByClassName('tablinks');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active');
            }

            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }



        // Variables adicionales
        let premiumUnlocked = false;
        let soundEnabled = true;
        let performanceMode = false;
        let selectedSkin = 'default';
        let totalBounces = 0;
        let totalCoins = 0;
        let bestCombo = 1;
        let playTimeStart = Date.now();
        let missions = {
            bounces: { target: 50, progress: 0, reward: 100, completed: false },
            coins: { target: 500, progress: 0, reward: 200, completed: false },
            diamonds: { target: 3, progress: 0, reward: 5, completed: false },
            level: { target: 5, progress: 0, reward: 500, completed: false },
            combo: { target: 5, progress: 0, reward: 300, completed: false },
            upgrades: { target: 3, progress: 0, reward: 1000, completed: false }
        };
        let missionSet = 1;
        let completedMissions = 0;
        let gameSpeed = 1;
        let lightMode = false;
        let achievements = [
            { id: 'first100', name: 'Primer Centenar', desc: 'Alcanza 100 rebotes', target: 100, type: 'bounces', unlocked: false, reward: 500 },
            { id: 'first1000', name: 'Mil Rebotes', desc: 'Alcanza 1000 rebotes', target: 1000, type: 'bounces', unlocked: false, reward: 2000 },
            { id: 'first10k', name: 'Maestro Rebotador', desc: 'Alcanza 10K rebotes', target: 10000, type: 'bounces', unlocked: false, reward: 10000 },
            { id: 'millionaire', name: 'Millonario', desc: 'Consigue 1M coins', target: 1000000, type: 'coins', unlocked: false, reward: 1000 },
            { id: 'billionaire', name: 'Billonario', desc: 'Consigue 1B coins', target: 1000000000, type: 'coins', unlocked: false, reward: 50000 },
            { id: 'diamond10', name: 'Coleccionista', desc: 'Obtén 10 diamantes', target: 10, type: 'diamonds', unlocked: false, reward: 5 },
            { id: 'diamond100', name: 'Cazador de Gemas', desc: 'Obtén 100 diamantes', target: 100, type: 'diamonds', unlocked: false, reward: 25 },
            { id: 'prestige1', name: 'Renacimiento', desc: 'Haz tu primer prestigio', target: 1, type: 'prestige', unlocked: false, reward: 2000 },
            { id: 'prestige10', name: 'Veterano', desc: 'Haz 10 prestigios', target: 10, type: 'prestige', unlocked: false, reward: 20000 },
            { id: 'level50', name: 'Medio Siglo', desc: 'Alcanza nivel 50', target: 50, type: 'level', unlocked: false, reward: 5000 },
            { id: 'level100', name: 'Centurión', desc: 'Alcanza nivel 100', target: 100, type: 'level', unlocked: false, reward: 15000 },
            { id: 'combo20', name: 'Combo Master', desc: 'Alcanza combo 20x', target: 20, type: 'combo', unlocked: false, reward: 8000 },
            { id: 'speed15', name: 'Velocista', desc: 'Alcanza velocidad 15+', target: 15, type: 'speed', unlocked: false, reward: 3000 },
            { id: 'size40', name: 'Gigante', desc: 'Tamaño de bola 40+', target: 40, type: 'size', unlocked: false, reward: 4000 },
            { id: 'ascension1', name: 'Ascendido', desc: 'Haz tu primera ascensión', target: 1, type: 'ascension', unlocked: false, reward: 100000 }
        ];
        let cards = [
            { id: 'speed', name: 'Carta de Velocidad', effect: '+10% velocidad', rarity: 'común', cost: 25, owned: false },
            { id: 'coins', name: 'Carta de Fortuna', effect: '+25% coins', rarity: 'rara', cost: 25, owned: false },
            { id: 'critical', name: 'Carta Crítica', effect: '+5% crítico', rarity: 'épica', cost: 50, owned: false },
            { id: 'experience', name: 'Carta de Sabiduría', effect: '+30% experiencia', rarity: 'rara', cost: 35, owned: false },
            { id: 'combo', name: 'Carta de Combo', effect: '+2 duración combo', rarity: 'épica', cost: 60, owned: false },
            { id: 'diamond', name: 'Carta de Gemas', effect: '+15% diamantes', rarity: 'legendaria', cost: 100, owned: false },
            { id: 'prestige', name: 'Carta de Poder', effect: '+50% puntos prestigio', rarity: 'legendaria', cost: 150, owned: false },
            { id: 'ultimate', name: 'Carta Suprema', effect: 'x2 a TODO', rarity: 'mítica', cost: 500, owned: false }
        ];
        let pets = [
            { id: 'cat', name: 'Gato Cósmico', effect: '+15% experiencia', cost: 50, owned: false },
            { id: 'dragon', name: 'Dragón Dorado', effect: '+30% coins', cost: 200, owned: false },
            { id: 'phoenix', name: 'Fénix de Fuego', effect: '+20% velocidad', cost: 150, owned: false },
            { id: 'unicorn', name: 'Unicornio Mágico', effect: '+25% diamantes', cost: 300, owned: false },
            { id: 'kraken', name: 'Kraken Abismal', effect: '+40% combo', cost: 400, owned: false },
            { id: 'celestial', name: 'Ser Celestial', effect: '+100% todo por 1min cada hora', cost: 1000, owned: false },
            { id: 'robot', name: 'Robot Recolector', effect: 'Recoge orbes automáticamente', cost: 2000, owned: false, premium: true },
            { id: 'ancientDragon', name: 'Dragón Ancestral', effect: 'x5 a todas las ganancias', cost: 5000, owned: false, premium: true }
        ];
        let artifacts = [
            { id: 'orb', name: 'Orbe del Tiempo', effect: 'Ralentiza el tiempo 10%', cost: 100, owned: false },
            { id: 'crown', name: 'Corona Infinita', effect: 'Niveles infinitos', cost: 500, owned: false },
            { id: 'ring', name: 'Anillo de Poder', effect: 'x3 puntos de prestigio', cost: 250, owned: false },
            { id: 'amulet', name: 'Amuleto de la Suerte', effect: '+50% críticos', cost: 300, owned: false },
            { id: 'staff', name: 'Bastón Arcano', effect: 'Auto-prestigio cada 10min', cost: 800, owned: false },
            { id: 'relic', name: 'Reliquia Ancestral', effect: 'Genera recursos offline', cost: 1200, owned: false }
        ];
        let currentEvent = null;
        let eventTimeLeft = 0;
        let dailyChallenges = [
            { id: 'bounces', name: 'Rebotador Experto', desc: 'Haz 200 rebotes', target: 200, progress: 0, reward: 1500, type: 'coins', completed: false },
            { id: 'coins', name: 'Coleccionista Diario', desc: 'Gana 5K coins', target: 5000, progress: 0, reward: 5, type: 'diamonds', completed: false },
            { id: 'diamonds', name: 'Cazador de Gemas', desc: 'Consigue 5 diamantes', target: 5, progress: 0, reward: 3000, type: 'coins', completed: false },
            { id: 'combo', name: 'Combo Diario', desc: 'Alcanza combo 8x', target: 8, progress: 0, reward: 3, type: 'diamonds', completed: false },
            { id: 'levels', name: 'Subir de Nivel', desc: 'Sube 2 niveles', target: 2, progress: 0, reward: 2000, type: 'coins', completed: false },
            { id: 'speed', name: 'Velocidad Extrema', desc: 'Alcanza velocidad 15+', target: 15, progress: 0, reward: 4, type: 'diamonds', completed: false },
            { id: 'upgrades', name: 'Mejorador', desc: 'Compra 3 mejoras', target: 3, progress: 0, reward: 2500, type: 'coins', completed: false },
            { id: 'orbs', name: 'Recolector de Orbes', desc: 'Recoge 5 orbes', target: 5, progress: 0, reward: 6, type: 'diamonds', completed: false },
            { id: 'prestige', name: 'Prestigio Rápido', desc: 'Haz 1 prestigio', target: 1, progress: 0, reward: 15, type: 'diamonds', completed: false },
            { id: 'experience', name: 'Sabio', desc: 'Gana 20K experiencia', target: 20000, progress: 0, reward: 4000, type: 'coins', completed: false },
            { id: 'critical', name: 'Crítico Maestro', desc: 'Haz 50 críticos', target: 50, progress: 0, reward: 8, type: 'diamonds', completed: false },
            { id: 'particles', name: 'Lluvia de Partículas', desc: 'Genera 500 partículas', target: 500, progress: 0, reward: 3500, type: 'coins', completed: false }
        ];
        
        let advancedMissions = [
            { id: 'marathon', name: 'Maratón de Rebotes', desc: 'Haz 10K rebotes sin parar', target: 10000, progress: 0, reward: 25000, type: 'coins', completed: false, difficulty: 'hard' },
            { id: 'collector', name: 'Gran Coleccionista', desc: 'Obtén 500 diamantes', target: 500, progress: 0, reward: 100, type: 'diamonds', completed: false, difficulty: 'extreme' },
            { id: 'master', name: 'Maestro del Combo', desc: 'Mantén combo 50x por 1 minuto', target: 60, progress: 0, reward: 50000, type: 'coins', completed: false, difficulty: 'legendary' },
            { id: 'ascender', name: 'Camino a la Ascensión', desc: 'Alcanza 5 prestigios', target: 5, progress: 0, reward: 200, type: 'diamonds', completed: false, difficulty: 'mythic' },
            { id: 'speedster', name: 'Velocista Supremo', desc: 'Velocidad 50+ por 5 minutos', target: 300, progress: 0, reward: 75000, type: 'coins', completed: false, difficulty: 'extreme' },
            { id: 'giant', name: 'Bola Gigante', desc: 'Tamaño 100+ por 10 minutos', target: 600, progress: 0, reward: 150, type: 'diamonds', completed: false, difficulty: 'legendary' }
        ];
        let currentDailyChallenge = null;
        let afkTime = 0;
        let lastActivity = Date.now();
        let afkRewards = { coins: 0, diamonds: 0, experience: 0 };
        let leaderboardData = [];
        let playerRank = 0;
        let season = 1;
        let nightMode = false;
        let autoClicker = { active: false, level: 0 };
        let idleBonus = 1;

        // Funciones UI
        // Sistema unificado de paneles
        function togglePanel(panelId) {
            console.log('togglePanel called with:', panelId);
            const panel = document.getElementById(panelId);
            if (!panel) {
                console.error('Panel not found:', panelId);
                return;
            }
            
            const isVisible = panel.style.display === 'block';
            console.log('Panel visibility:', isVisible);
            
            // Cerrar todos los paneles
            ['shop', 'config', 'stats', 'missions', 'achievements', 'dailyChallenges', 'importExport', 'premiumShop'].forEach(id => {
                const p = document.getElementById(id);
                if (p) p.style.display = 'none';
            });
            
            // Abrir el panel solicitado si no estaba visible
            if (!isVisible) {
                panel.style.display = 'block';
                console.log('Panel opened:', panelId);
            }
        }
        
        // Funciones de cierre individuales
        function closeConfig() { document.getElementById('config').style.display = 'none'; }
        function closeStats() { document.getElementById('stats').style.display = 'none'; }
        function closeMissions() { document.getElementById('missions').style.display = 'none'; }
        function closeAchievements() { document.getElementById('achievements').style.display = 'none'; }
        function closeDailyChallenges() { document.getElementById('dailyChallenges').style.display = 'none'; }
        function closeShop() { document.getElementById('shop').style.display = 'none'; }
        function closePremiumShop() { document.getElementById('premiumShop').style.display = 'none'; }
        
        // Función para tabs del panel unificado
        function openAchievementTab(evt, tabName) {
            const tabcontent = document.querySelectorAll('#achievements .tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }
            
            const tablinks = document.querySelectorAll('#achievements .tablinks');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active');
            }
            
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }
        
        function updateResetTimer() {
            const now = Date.now();
            const timeSinceReset = now - gameData.lastDailyReset;
            const timeLeft = 86400000 - timeSinceReset;
            
            const resetBtn = document.getElementById('resetDailyChallengesBtn');
            const newChallengeBtn = document.getElementById('newChallengeBtn');
            
            if (timeLeft > 0) {
                const hours = Math.floor(timeLeft / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                
                const timerEl = document.getElementById('resetTimer');
                if (timerEl) {
                    timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                if (resetBtn) resetBtn.style.display = 'none';
                if (newChallengeBtn) {
                    newChallengeBtn.disabled = true;
                    newChallengeBtn.style.opacity = '0.5';
                }
            } else {
                const timerEl = document.getElementById('resetTimer');
                if (timerEl) timerEl.textContent = '00:00:00';
                if (resetBtn) resetBtn.style.display = 'inline-block';
                if (newChallengeBtn) {
                    newChallengeBtn.disabled = false;
                    newChallengeBtn.style.opacity = '1';
                }
            }
        }
        
        function resetDailyChallenges() {
            gameData.lastDailyReset = Date.now();
            dailyChallenges.forEach(challenge => {
                challenge.completed = false;
                challenge.progress = 0;
                challenge.claimed = false;
            });
            currentDailyChallenge = null;
            updateDailyChallengesDisplay();
            showNotification('🔄 ¡Desafíos diarios reseteados!');
            document.getElementById('resetDailyChallengesBtn').style.display = 'none';
        }
        
        let controlsVisible = true;
        function toggleControlsVisibility() {
            const controls = document.getElementById('controls');
            const toggleBtn = document.getElementById('toggleControls');
            
            controlsVisible = !controlsVisible;
            
            if (controlsVisible) {
                controls.classList.remove('hidden');
                toggleBtn.textContent = '▲';
            } else {
                controls.classList.add('hidden');
                toggleBtn.textContent = '▼';
            }
        }
        

        function showPremiumShop() { togglePanel('premiumShop'); }

        function toggleTheme() {
            lightMode = !lightMode;
            const root = document.documentElement;
            if (lightMode) {
                root.style.setProperty('--glass', 'rgba(0, 0, 0, 0.1)');
                root.style.setProperty('--glass-border', 'rgba(0, 0, 0, 0.2)');
                document.body.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
                document.getElementById('themeToggle').textContent = 'Modo Oscuro';
            } else {
                root.style.setProperty('--glass', 'rgba(255, 255, 255, 0.1)');
                root.style.setProperty('--glass-border', 'rgba(255, 255, 255, 0.2)');
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('themeToggle').textContent = 'Modo Claro';
            }
        }

        function applyConfig() {
            soundEnabled = document.getElementById('soundToggle').checked;
            performanceMode = document.getElementById('performanceMode').checked;
            gameSpeed = parseFloat(document.getElementById('gameSpeed').value);
            document.getElementById('speedValue').textContent = gameSpeed + 'x';
            document.getElementById('particleValue').textContent = document.getElementById('particleCount').value;
            if (premiumUnlocked) ball.color = document.getElementById('ballColor').value;
            saveGame();
        }

        function resetGame() {
            if (confirm('¿REINICIAR TODO EL PROGRESO? Esto borrará ABSOLUTAMENTE TODO: coins, diamantes, estrellas, mejoras, prestigio, misiones, etc.')) {
                // Limpiar localStorage completamente
                localStorage.removeItem('circleBounceUltimate');
                localStorage.removeItem('circleBounceUltimate_slot1');
                localStorage.removeItem('circleBounceUltimate_slot2');
                localStorage.removeItem('circleBounceUltimate_slot3');
                
                // Resetear todas las variables del juego
                coins = 0;
                diamonds = 0;
                experience = 0;
                bounces = 0;
                level = 1;
                combo = 1;
                totalBounces = 0;
                totalCoins = 0;
                bestCombo = 1;
                missionSet = 1;
                completedMissions = 0;
                premiumUnlocked = false;
                selectedSkin = 'default';
                
                // Resetear gameData completamente
                gameData = {
                    coins: 0,
                    diamonds: 0,
                    experience: 0,
                    bounces: 0,
                    level: 1,
                    prestige: 0,
                    prestigePoints: 0,
                    ascension: 0,
                    ascensionPoints: 0,
                    upgrades: {
                        coinMult: { level: 0, baseCost: 100, multiplier: 1.5, maxLevel: 1000 },
                        speed: { level: 0, baseCost: 150, multiplier: 1.6, maxLevel: 500 },
                        size: { level: 0, baseCost: 200, multiplier: 1.7, maxLevel: 200 },
                        combo: { level: 0, baseCost: 250, multiplier: 1.8, maxLevel: 100 },
                        critical: { level: 0, baseCost: 300, multiplier: 1.9, maxLevel: 50 },
                        diamondGen: { level: 0, baseCost: 500, multiplier: 2.0, maxLevel: 25 },
                        expMult: { level: 0, baseCost: 10, multiplier: 2.5, currency: 'diamonds', maxLevel: 100 },
                        auto: { level: 0, baseCost: 25, multiplier: 3.0, currency: 'diamonds', maxLevel: 10 },
                        timeAsc: { level: 0, baseCost: 100, multiplier: 5.0, currency: 'diamonds', maxLevel: 5 },
                        dimension: { level: 0, baseCost: 200, multiplier: 10.0, currency: 'diamonds', maxLevel: 3 },
                        omnipotence: { level: 0, baseCost: 1000, multiplier: 50.0, currency: 'diamonds', maxLevel: 2 },
                        infinite: { level: 0, baseCost: 5000, multiplier: 100.0, currency: 'diamonds', maxLevel: 1 }
                    },
                    research: {
                        unlocked: [],
                        available: ['efficiency1', 'automation1']
                    }
                };
                
                // Resetear misiones
                missions = {
                    bounces: { target: 50, progress: 0, reward: 200, completed: false },
                    coins: { target: 500, progress: 0, reward: 300, completed: false },
                    diamonds: { target: 3, progress: 0, reward: 5, completed: false },
                    level: { target: 5, progress: 0, reward: 1000, completed: false },
                    combo: { target: 5, progress: 0, reward: 500, completed: false },
                    upgrades: { target: 3, progress: 0, reward: 1500, completed: false }
                };
                
                // Resetear bola completamente
                ball.radius = 20;
                ball.dx = 5;
                ball.dy = 5;
                ball.color = '#ff0000';
                ball.x = width / 2;
                ball.y = height / 2;
                
                // Regenerar misiones y actualizar UI
                generateMissions();
                updateUI();
                showNotification('¡RESET COMPLETO! Todo ha sido reiniciado.');
            }
        }

        function selectSkin(skin) {
            if (skin.includes('premium') && !premiumUnlocked) {
                showPremiumShop();
                return;
            }
            selectedSkin = skin;
            document.querySelectorAll('.skin-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.skin-option').classList.add('selected');
            const colors = { default: '#ff0000', fire: '#ff6600', ice: '#00ccff', rainbow: '#ff0000', galaxy: '#9900ff', cosmic: '#00ffff' };
            ball.color = colors[skin] || '#ff0000';
            saveGame();
        }

        function buyPremium() {
            const premiumCost = 5000 + (gameData.prestige * 2000) + (gameData.ascension * 10000);
            if (coins >= premiumCost && !premiumUnlocked) {
                coins -= premiumCost;
                premiumUnlocked = true;
                document.querySelectorAll('.premium-feature').forEach(el => {
                    el.style.opacity = '1';
                    el.style.pointerEvents = 'auto';
                });
                document.querySelectorAll('.premium-feature input').forEach(el => el.disabled = false);
                updateUI();
                saveGame();
                closePremiumShop();
                showNotification('¡Premium desbloqueado!');
            }
        }

        function updateStats() {
            const playTime = Math.floor((Date.now() - playTimeStart) / 60000);
            document.getElementById('totalBounces').textContent = totalBounces;
            document.getElementById('totalCoins').textContent = totalCoins;
            document.getElementById('playTime').textContent = playTime + 'm';
            document.getElementById('bestCombo').textContent = bestCombo + 'x';
        }

        function generateMissions() {
            const missionTypes = [
                { type: 'bounces', name: 'Realiza {target} rebotes', reward: 'coins', base: 200, scale: 1.8 },
                { type: 'coins', name: 'Consigue {target} coins', reward: 'coins', base: 5000, scale: 2.2 },
                { type: 'diamonds', name: 'Obtén {target} diamantes', reward: 'diamonds', base: 50, scale: 1.5 },
                { type: 'level', name: 'Alcanza nivel {target}', reward: 'coins', base: 10, scale: 1.3 },
                { type: 'combo', name: 'Combo de {target}x', reward: 'coins', base: 8, scale: 1.4 },
                { type: 'upgrades', name: 'Compra {target} mejoras', reward: 'coins', base: 15, scale: 1.6 }
            ];

            Object.keys(missions).forEach(key => {
                const mission = missions[key];
                const type = missionTypes.find(t => t.type === key);
                if (type && !mission.completed) {
                    mission.target = Math.floor(type.base * Math.pow(type.scale, missionSet - 1));
                    mission.reward = Math.floor(mission.target * (type.base / 10) * missionSet);
                    if (!mission.progress) mission.progress = 0;
                    if (!mission.completed) mission.completed = false;
                    if (!mission.claimed) mission.claimed = false;
                    mission.name = type.name.replace('{target}', mission.target);
                    mission.rewardType = type.reward;
                }
            });

            renderMissions();
        }

        function renderMissions() {
            const list = document.getElementById('missionList');
            list.innerHTML = '';
            Object.keys(missions).forEach(key => {
                const mission = missions[key];
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px; background: rgba(255,255,255,0.1); margin: 5px 0; border-radius: 5px;';
                div.innerHTML = `
                    <h4>${mission.name}</h4>
                    <div>Progreso: <span id="${key}Progress">${mission.progress}</span>/${mission.target}</div>
                    <div style="background: #333; height: 5px; border-radius: 3px; margin: 5px 0;">
                        <div id="${key}Bar" style="background: var(--success); height: 100%; width: ${(mission.progress / mission.target) * 100}%; border-radius: 3px;"></div>
                    </div>
                    <div style="color: var(--success); font-size: 12px;">Recompensa: ${mission.reward} ${mission.rewardType}</div>
                `;
                list.appendChild(div);
            });
            document.getElementById('missionSetNumber').textContent = missionSet;
        }

        function updateMissions() {
            if (!missions.bounces.completed) missions.bounces.progress = Math.min(bounces, missions.bounces.target);
            if (!missions.coins.completed) missions.coins.progress = Math.min(coins, missions.coins.target);
            if (!missions.diamonds.completed) missions.diamonds.progress = Math.min(diamonds, missions.diamonds.target);
            if (!missions.level.completed) missions.level.progress = Math.min(level, missions.level.target);
            if (!missions.combo.completed) missions.combo.progress = Math.min(Math.floor(combo), missions.combo.target);

            Object.keys(missions).forEach(key => {
                const mission = missions[key];
                const progressEl = document.getElementById(key + 'Progress');
                const barEl = document.getElementById(key + 'Bar');
                if (progressEl) progressEl.textContent = mission.progress;
                if (barEl) barEl.style.width = (mission.progress / mission.target) * 100 + '%';

                if (mission.progress >= mission.target && !mission.completed && !mission.claimed) {
                    mission.completed = true;
                    mission.claimed = true;
                    completedMissions++;
                    if (mission.rewardType === 'coins') {
                        coins += mission.reward;
                    } else if (mission.rewardType === 'diamonds') {
                        diamonds += mission.reward;
                    }
                    showNotification(`¡Misión completada! +${mission.reward} ${mission.rewardType}`);

                    if (completedMissions >= 2) {
                        completedMissions = 0;
                        missionSet++;
                        generateMissions();
                        showNotification('¡Nuevas misiones disponibles!');
                    }
                }
            });
        }

        // Funciones del sistema AFK
        function resetAfkTimer() {
            lastActivity = Date.now();
            afkTime = 0;
        }
        
        function handleVisibilityChange() {
            if (document.hidden) {
                lastActivity = Date.now() - 60000; // Marca como inactivo hace 1 minuto
            } else {
                resetAfkTimer();
            }
        }
        
        function handleWindowBlur() {
            lastActivity = Date.now() - 30000; // Marca como inactivo hace 30s
        }
        
        function handleWindowFocus() {
            resetAfkTimer();
        }
        
        function checkGitHubPages() {
            // Sistema antipiracy eliminado
        }
        
        function updateAfkSystem() {
            const now = Date.now();
            const timeSinceActivity = Math.floor((now - lastActivity) / 1000);
            
            if (timeSinceActivity > 30) {
                afkTime = timeSinceActivity - 30;
                
                if (afkTime > 0 && afkTime % 10 === 0) {
                    const afkMultiplier = Math.min(afkTime / 3600, 2);
                    afkRewards.coins += Math.floor(level * afkMultiplier * 0.1);
                    afkRewards.diamonds += Math.floor(afkMultiplier * 0.01);
                    afkRewards.experience += Math.floor(level * afkMultiplier * 0.05);
                }
                
                idleBonus = 1 + (afkTime / 7200);
            } else {
                afkTime = 0;
                idleBonus = 1;
            }
        }
        
        function claimAfkRewards() {
            if (afkRewards.coins > 0 || afkRewards.diamonds > 0 || afkRewards.experience > 0) {
                coins += Math.floor(afkRewards.coins);
                diamonds += Math.floor(afkRewards.diamonds);
                experience += Math.floor(afkRewards.experience);
                
                showNotification(`💤 Recompensas AFK: +${Math.floor(afkRewards.coins)} coins, +${Math.floor(afkRewards.diamonds)} diamantes, +${Math.floor(afkRewards.experience)} exp`);
                
                afkRewards = { coins: 0, diamonds: 0, experience: 0 };
                updateUI();
            } else {
                showNotification('No hay recompensas AFK disponibles');
            }
        }
        
        function updateDailyChallenges() {
            if (currentDailyChallenge && !currentDailyChallenge.completed) {
                let newProgress = 0;
                switch(currentDailyChallenge.id) {
                    case 'bounces':
                        newProgress = Math.min(bounces, currentDailyChallenge.target);
                        break;
                    case 'coins':
                        newProgress = Math.min(coins, currentDailyChallenge.target);
                        break;
                    case 'diamonds':
                        newProgress = Math.min(diamonds, currentDailyChallenge.target);
                        break;
                    case 'combo':
                        newProgress = Math.min(Math.floor(combo), currentDailyChallenge.target);
                        break;
                    case 'levels':
                        newProgress = Math.min(level, currentDailyChallenge.target);
                        break;
                    case 'speed':
                        newProgress = Math.min(Math.abs(ball.dx) + Math.abs(ball.dy), currentDailyChallenge.target);
                        break;
                    case 'upgrades':
                        newProgress = Math.min(Object.values(gameData.upgrades).reduce((sum, u) => sum + u.level, 0), currentDailyChallenge.target);
                        break;
                    case 'orbs':
                        if (!currentDailyChallenge.orbsCollected) currentDailyChallenge.orbsCollected = 0;
                        newProgress = currentDailyChallenge.orbsCollected;
                        break;
                    case 'prestige':
                        newProgress = Math.min(gameData.prestige, currentDailyChallenge.target);
                        break;
                    case 'experience':
                        newProgress = Math.min(experience, currentDailyChallenge.target);
                        break;
                    case 'critical':
                        if (!currentDailyChallenge.criticalHits) currentDailyChallenge.criticalHits = 0;
                        newProgress = currentDailyChallenge.criticalHits;
                        break;
                    case 'particles':
                        if (!currentDailyChallenge.particlesGenerated) currentDailyChallenge.particlesGenerated = 0;
                        newProgress = currentDailyChallenge.particlesGenerated;
                        break;
                }
                
                currentDailyChallenge.progress = Math.max(currentDailyChallenge.progress, newProgress);
                
                if (currentDailyChallenge.progress >= currentDailyChallenge.target && !currentDailyChallenge.claimed) {
                    currentDailyChallenge.completed = true;
                    currentDailyChallenge.claimed = true;
                    if (currentDailyChallenge.type === 'coins') {
                        coins += currentDailyChallenge.reward;
                        gameData.coins = coins;
                    } else {
                        diamonds += currentDailyChallenge.reward;
                        gameData.diamonds = diamonds;
                    }
                    showNotification(`🎯 Desafío completado: ${currentDailyChallenge.name}! +${currentDailyChallenge.reward} ${currentDailyChallenge.type}`);
                    currentDailyChallenge = null;
                }
            }
            
            // Actualizar misiones avanzadas
            advancedMissions.forEach(mission => {
                if (!mission.completed) {
                    let newProgress = 0;
                    switch(mission.id) {
                        case 'marathon':
                            newProgress = Math.min(bounces, mission.target);
                            break;
                        case 'collector':
                            newProgress = Math.min(diamonds, mission.target);
                            break;
                        case 'master':
                            if (Math.floor(combo) >= 50) {
                                if (!mission.comboStartTime) mission.comboStartTime = Date.now();
                                newProgress = Math.min(Math.floor((Date.now() - mission.comboStartTime) / 1000), mission.target);
                            } else {
                                mission.comboStartTime = null;
                                newProgress = 0;
                            }
                            break;
                        case 'ascender':
                            newProgress = Math.min(gameData.prestige, mission.target);
                            break;
                        case 'speedster':
                            if (Math.abs(ball.dx) + Math.abs(ball.dy) >= 50) {
                                if (!mission.speedStartTime) mission.speedStartTime = Date.now();
                                newProgress = Math.min(Math.floor((Date.now() - mission.speedStartTime) / 1000), mission.target);
                            } else {
                                mission.speedStartTime = null;
                                newProgress = 0;
                            }
                            break;
                        case 'giant':
                            if (ball.radius >= 100) {
                                if (!mission.sizeStartTime) mission.sizeStartTime = Date.now();
                                newProgress = Math.min(Math.floor((Date.now() - mission.sizeStartTime) / 1000), mission.target);
                            } else {
                                mission.sizeStartTime = null;
                                newProgress = 0;
                            }
                            break;
                    }
                    
                    mission.progress = Math.max(mission.progress, newProgress);
                    
                    if (mission.progress >= mission.target && !mission.claimed) {
                        mission.completed = true;
                        mission.claimed = true;
                        if (mission.rewardType === 'coins') {
                            coins += mission.reward;
                            gameData.coins = coins;
                        } else {
                            diamonds += mission.reward;
                            gameData.diamonds = diamonds;
                        }
                        showNotification(`📋 Misión completada: ${mission.name}! +${mission.reward} ${mission.rewardType}`);
                    }
                }
            });
        }
        
        function selectRandomDailyChallenge() {
            const now = Date.now();
            const timeSinceReset = now - gameData.lastDailyReset;
            const timeLeft = 86400000 - timeSinceReset;
            
            if (timeLeft > 0) {
                const hoursLeft = Math.ceil(timeLeft / 3600000);
                showNotification(`⏰ Desafíos se resetean en ${hoursLeft}h`);
                return;
            }
            
            if (!currentDailyChallenge || currentDailyChallenge.completed) {
                const availableChallenges = dailyChallenges.filter(c => !c.completed);
                if (availableChallenges.length > 0) {
                    currentDailyChallenge = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
                    currentDailyChallenge.progress = 0;
                    currentDailyChallenge.completed = false;
                    showNotification(`🎯 Nuevo desafío: ${currentDailyChallenge.name}`);
                    updateDailyChallengesDisplay();
                } else {
                    showNotification('¡Todos los desafíos completados!');
                }
            } else {
                showNotification('Ya tienes un desafío activo');
            }
        }
        
        function updateDailyChallengesDisplay() {
            const container = document.getElementById('dailyChallengesContainer');
            if (container) {
                container.innerHTML = '';
                
                if (currentDailyChallenge) {
                    const div = document.createElement('div');
                    div.className = 'upgrade';
                    div.innerHTML = `
                        <h4>🎯 ${currentDailyChallenge.name}</h4>
                        <p>${currentDailyChallenge.desc}</p>
                        <p>Progreso: ${currentDailyChallenge.progress}/${currentDailyChallenge.target}</p>
                        <div style="background: #333; height: 8px; border-radius: 4px; margin: 5px 0;">
                            <div style="background: var(--success); height: 100%; width: ${(currentDailyChallenge.progress / currentDailyChallenge.target) * 100}%; border-radius: 4px;"></div>
                        </div>
                        <p style="color: var(--success);">Recompensa: ${currentDailyChallenge.reward} ${currentDailyChallenge.type}</p>
                        <div style="color: ${currentDailyChallenge.completed ? '#4CAF50' : '#ff4444'};">Estado: ${currentDailyChallenge.completed ? '✅ Completado' : '⏳ En progreso'}</div>
                    `;
                    container.appendChild(div);
                } else {
                    container.innerHTML = '<div class="upgrade"><h4>Sin desafío activo</h4><p>Selecciona un nuevo desafío aleatorio</p></div>';
                }
            }
        }
        
        function buyAutoClicker(level) {
            const costs = { 1: 100, 2: 300, 3: 1000 };
            const cost = costs[level];
            
            if (diamonds >= cost && autoClicker.level < level) {
                diamonds -= cost;
                autoClicker.level = level;
                autoClicker.active = true;
                
                // Configurar intervalo según el nivel
                const intervals = { 1: 5000, 2: 2000, 3: 1000 };
                if (autoClicker.interval) clearInterval(autoClicker.interval);
                
                autoClicker.interval = setInterval(() => {
                    if (!gamePaused && autoClicker.active) {
                        handleBounce();
                    }
                }, intervals[level]);
                
                showNotification(`🤖 Auto-Clicker Nivel ${level} activado!`);
                updateUI();
            }
        }

        // Modificar handleBounce
        const originalHandleBounce = handleBounce;
        handleBounce = function () {
            originalHandleBounce();
            totalBounces++;
            totalCoins = coins;
            if (combo > bestCombo) bestCombo = combo;
            updateMissions();
        };

        // Auto-guardado y generación de recursos
        setInterval(() => {
            autoSave();
            generateResources();
            generateEvent();
            if (eventTimeLeft > 0) {
                eventTimeLeft--;
                if (!gameData.events) gameData.events = { current: null, timeLeft: 0 };
                gameData.events.timeLeft = eventTimeLeft;
                updateEventsDisplay();
                if (eventTimeLeft <= 0) {
                    currentEvent = null;
                    if (!gameData.events) gameData.events = { current: null, timeLeft: 0 };
                    gameData.events.current = null;
                    showNotification('🎪 Evento terminado');
                    updateEventsDisplay();
                }
            }
            
            // Contenido adicional para jugadores 24/7
            if (Math.random() < 0.001) { // 0.1% chance cada segundo
                const bonusEvents = [
                    { name: 'Lluvia de Coins', reward: Math.floor(level * 10), type: 'coins' },
                    { name: 'Gema Misteriosa', reward: Math.floor(level / 20) + 1, type: 'diamonds' },
                    { name: 'Experiencia Súbita', reward: Math.floor(level * 5), type: 'experience' },
                    { name: 'Combo Boost', effect: 'combo' },
                    { name: 'Velocidad Temporal', effect: 'speed' }
                ];
                
                const bonus = bonusEvents[Math.floor(Math.random() * bonusEvents.length)];
                if (bonus.type) {
                    if (bonus.type === 'coins') coins += bonus.reward;
                    else if (bonus.type === 'diamonds') diamonds += bonus.reward;
                    else if (bonus.type === 'experience') experience += bonus.reward;
                    showNotification(`🎁 ${bonus.name}: +${bonus.reward} ${bonus.type}`);
                } else if (bonus.effect === 'combo') {
                    combo += 1;
                    showNotification(`🎁 ${bonus.name}: +1 combo`);
                } else if (bonus.effect === 'speed') {
                    ball.dx *= 1.2;
                    ball.dy *= 1.2;
                    showNotification(`🎁 ${bonus.name}: Velocidad aumentada`);
                    setTimeout(() => {
                        ball.dx /= 1.2;
                        ball.dy /= 1.2;
                    }, 5000);
                }
                updateUI();
            }
            
            // Reset diario de desafíos (cada 24 horas)
            const now = Date.now();
            if (now - gameData.lastDailyReset >= 86400000) {
                gameData.lastDailyReset = now;
                dailyChallenges.forEach(challenge => {
                    challenge.completed = false;
                    challenge.progress = 0;
                });
                currentDailyChallenge = null;
                showNotification('🌅 ¡Nuevos desafíos diarios disponibles!');
                updateDailyChallengesDisplay();
            }
            
            const premiumCost = 5000 + (gameData.prestige * 2000) + (gameData.ascension * 10000);
            document.getElementById('premiumProgress').textContent = coins;
            if (document.getElementById('premiumCost')) {
                document.getElementById('premiumCost').textContent = premiumCost;
            }
        }, 1000);

        // CSS adicional
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .skin-option:hover {
                border-color: var(--hud-color) !important;
                transform: scale(1.05);
            }
            .skin-option.selected {
                border-color: var(--hud-color) !important;
            }
        `;
        document.head.appendChild(style);



        function saveGame() {
            const saveData = {
                coins, diamonds, experience, bounces, level,
                prestige: gameData.prestige, prestigePoints: gameData.prestigePoints,
                ascension: gameData.ascension, ascensionPoints: gameData.ascensionPoints,
                achievements: gameData.achievements, cards: gameData.cards, pets: gameData.pets,
                artifacts: gameData.artifacts, events: gameData.events, season: gameData.season,
                infiniteLevels: gameData.infiniteLevels,
                premiumUnlocked, selectedSkin, missionSet, completedMissions,
                totalBounces, totalCoins, bestCombo, missions,
                upgrades: gameData.upgrades, research: gameData.research
            };
            localStorage.setItem('circleBounceUltimate', JSON.stringify(saveData));
        }

        function saveToSlot() {
            const now = Date.now();
            if (now - gameData.lastSave < 30000) {
                showNotification('Debes esperar 30 segundos entre guardados');
                return;
            }
            
            const slot = document.getElementById('saveSlot').value;
            gameData.lastSave = now;
            gameData.saveCount++;
            
            const saveData = {
                coins, diamonds, experience, bounces, level,
                prestige: gameData.prestige, prestigePoints: gameData.prestigePoints,
                ascension: gameData.ascension, ascensionPoints: gameData.ascensionPoints,
                achievements: gameData.achievements, cards: gameData.cards, pets: gameData.pets,
                artifacts: gameData.artifacts, events: gameData.events, season: gameData.season,
                infiniteLevels: gameData.infiniteLevels, lastSave: gameData.lastSave,
                lastDailyReset: gameData.lastDailyReset, saveCount: gameData.saveCount,
                premiumUnlocked, selectedSkin, missionSet, completedMissions,
                totalBounces, totalCoins, bestCombo, missions,
                dailyChallenges, currentDailyChallenge,
                upgrades: gameData.upgrades, research: gameData.research,
                timestamp: now, checksum: btoa(JSON.stringify({coins, diamonds, level}))
            };
            localStorage.setItem(`circleBounceUltimate_slot${slot}`, JSON.stringify(saveData));
            showNotification(`Guardado en Slot ${slot}`);
        }

        function loadFromSlot() {
            const slot = document.getElementById('saveSlot').value;
            const saved = localStorage.getItem(`circleBounceUltimate_slot${slot}`);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Validar checksum anti-exploit
                    const expectedChecksum = btoa(JSON.stringify({coins: data.coins, diamonds: data.diamonds, level: data.level}));
                    if (data.checksum !== expectedChecksum) {
                        showNotification('Datos corruptos o modificados');
                        return;
                    }
                    
                    // Validar timestamp
                    if (!data.timestamp || Date.now() - data.timestamp > 86400000 * 30) {
                        showNotification('Guardado demasiado antiguo');
                        return;
                    }
                    
                    coins = Math.max(0, data.coins || 0);
                    diamonds = Math.max(0, data.diamonds || 0);
                    experience = Math.max(0, data.experience || 0);
                    bounces = Math.max(0, data.bounces || 0);
                    level = Math.max(1, data.level || 1);
                    gameData.prestige = Math.max(0, data.prestige || 0);
                    gameData.prestigePoints = Math.max(0, data.prestigePoints || 0);
                    gameData.ascension = Math.max(0, data.ascension || 0);
                    gameData.ascensionPoints = Math.max(0, data.ascensionPoints || 0);
                    gameData.achievements = data.achievements || [];
                    gameData.cards = data.cards || [];
                    gameData.pets = data.pets || [];
                    gameData.artifacts = data.artifacts || [];
                    gameData.events = data.events || { current: null, timeLeft: 0 };
                    gameData.season = Math.max(1, data.season || 1);
                    gameData.infiniteLevels = data.infiniteLevels || false;
                    gameData.lastSave = data.lastSave || Date.now();
                    gameData.lastDailyReset = data.lastDailyReset || Date.now();
                    gameData.saveCount = data.saveCount || 0;
                    missionSet = Math.max(1, data.missionSet || 1);
                    completedMissions = Math.max(0, data.completedMissions || 0);
                    missions = data.missions || missions;
                    if (data.dailyChallenges && Array.isArray(data.dailyChallenges)) dailyChallenges = data.dailyChallenges;
                    if (data.currentDailyChallenge && typeof data.currentDailyChallenge === 'object') currentDailyChallenge = data.currentDailyChallenge;
                    gameData.upgrades = data.upgrades || gameData.upgrades;
                    gameData.research = data.research || gameData.research;
                    
                    syncCollectionData();
                    updateUI();
                    renderMissions();
                    showNotification(`Cargado desde Slot ${slot}`);
                } catch (e) {
                    showNotification('Error al cargar slot');
                }
            } else {
                showNotification('Slot vacío');
            }
        }



        function doAscension() {
            if (gameData.prestige >= 10 && coins >= 1e9) {
                let ascensionPointsGained = Math.floor(Math.log10(coins / 1e9) + gameData.prestige / 5);
                
                coins = 0;
                diamonds = 0;
                experience = 0;
                bounces = 0;
                level = 1;
                combo = 1;
                totalBounces = 0;
                totalCoins = 0;
                missionSet = 1;
                completedMissions = 0;
                
                gameData.coins = 0;
                gameData.diamonds = 0;
                gameData.experience = 0;
                gameData.bounces = 0;
                gameData.level = 1;
                gameData.prestige = 0;
                gameData.prestigePoints = 0;
                
                Object.keys(gameData.upgrades).forEach(key => {
                    gameData.upgrades[key].level = 0;
                });
                
                gameData.ascensionPoints += ascensionPointsGained;
                gameData.ascension++;
                
                // Resetear pelota a valores iniciales
                ball.radius = 20;
                ball.dx = 5;
                ball.dy = 5;
                ball.color = '#ff0000';
                
                generateMissions();
                updateUI();
                showNotification(`¡Ascensión completada! +${ascensionPointsGained} puntos cósmicos`);
            } else {
                showNotification('Necesitas 10+ prestigios y 1B+ coins para ascender');
            }
        }
        
        function buyAscensionUpgrade(upgradeId) {
            if (upgradeId === 'cosmicMult' && gameData.ascensionPoints >= 1) {
                gameData.ascensionPoints -= 1;
                updateUI();
                showNotification('¡Multiplicador cósmico comprado! x2 a todas las ganancias');
            } else if (upgradeId === 'prestigeGen' && gameData.ascensionPoints >= 2) {
                gameData.ascensionPoints -= 2;
                updateUI();
                showNotification('¡Generador de prestigio activado!');
            } else if (upgradeId === 'timeAccel' && gameData.ascensionPoints >= 3) {
                gameData.ascensionPoints -= 3;
                updateUI();
                showNotification('¡Acelerador temporal activado! Juego 2x más rápido');
            }
        }
        
        function checkAchievements() {
            if (!gameData.achievements) gameData.achievements = [];
            
            achievements.forEach(achievement => {
                if (!achievement.unlocked) {
                    let progress = 0;
                    switch(achievement.type) {
                        case 'bounces': progress = bounces; break;
                        case 'coins': progress = coins; break;
                        case 'diamonds': progress = diamonds; break;
                        case 'prestige': progress = gameData.prestige; break;
                        case 'level': progress = level; break;
                        case 'combo': progress = Math.floor(combo); break;
                        case 'speed': progress = Math.abs(ball.dx) + Math.abs(ball.dy); break;
                        case 'size': progress = ball.radius; break;
                        case 'ascension': progress = gameData.ascension; break;
                    }
                    if (progress >= achievement.target) {
                        achievement.unlocked = true;
                        gameData.achievements.push(achievement.id);
                        coins += achievement.reward;
                        gameData.coins = coins;
                        showNotification(`🏆 Logro desbloqueado: ${achievement.name}! +${achievement.reward} coins`);
                        updateAchievementsDisplay();
                    }
                }
            });
        }
        
        function generateAdvancedMissions() {
            const missionTypes = [
                { type: 'marathon', name: 'Maratón de {target} rebotes', reward: 'coins', base: 5000, scale: 2.0, difficulty: 'hard' },
                { type: 'collector', name: 'Colecciona {target} diamantes', reward: 'diamonds', base: 100, scale: 1.8, difficulty: 'extreme' },
                { type: 'speedrun', name: 'Alcanza nivel {target} rápido', reward: 'coins', base: 25, scale: 1.5, difficulty: 'medium' },
                { type: 'combo_master', name: 'Mantén combo {target}x', reward: 'diamonds', base: 30, scale: 1.6, difficulty: 'legendary' },
                { type: 'upgrader', name: 'Compra {target} mejoras', reward: 'coins', base: 20, scale: 1.4, difficulty: 'easy' },
                { type: 'prestige_rush', name: 'Haz {target} prestigios', reward: 'diamonds', base: 3, scale: 1.3, difficulty: 'mythic' }
            ];
            
            advancedMissions.forEach((mission, index) => {
                if (!mission.completed) {
                    const type = missionTypes[index % missionTypes.length];
                    mission.target = Math.floor(type.base * Math.pow(type.scale, missionSet - 1));
                    mission.reward = Math.floor(mission.target * (type.base / 10) * missionSet);
                    mission.name = type.name.replace('{target}', mission.target);
                    mission.rewardType = type.reward;
                    mission.difficulty = type.difficulty;
                    mission.progress = 0;
                }
            });
            
            updateAdvancedMissions();
        }
        
        function updateAdvancedMissions() {
            const container = document.getElementById('advancedMissionList');
            if (!container) return;
            
            container.innerHTML = '';
            advancedMissions.forEach((mission, index) => {
                const difficultyColors = {
                    'easy': '#4CAF50',
                    'medium': '#FF9800',
                    'hard': '#F44336',
                    'extreme': '#9C27B0',
                    'legendary': '#FF6B35',
                    'mythic': '#E91E63'
                };
                
                const div = document.createElement('div');
                div.className = `upgrade ${mission.difficulty === 'legendary' ? 'legendary-upgrade' : mission.difficulty === 'mythic' ? 'mythic-upgrade' : ''}`;
                div.innerHTML = `
                    <h4>${mission.name} <span style="color: ${difficultyColors[mission.difficulty]}">[${mission.difficulty.toUpperCase()}]</span></h4>
                    <p>Progreso: ${mission.progress}/${mission.target}</p>
                    <div style="background: #333; height: 8px; border-radius: 4px; margin: 5px 0;">
                        <div style="background: ${difficultyColors[mission.difficulty]}; height: 100%; width: ${(mission.progress / mission.target) * 100}%; border-radius: 4px;"></div>
                    </div>
                    <p style="color: var(--success);">Recompensa: ${mission.reward} ${mission.rewardType}</p>
                    <div style="color: ${mission.completed ? '#4CAF50' : '#ff4444'};">Estado: ${mission.completed ? '✅ Completado' : '⏳ En progreso'}</div>
                `;
                container.appendChild(div);
            });
        }
        
        function updateExpandedChallenges() {
            const container = document.getElementById('expandedChallengesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Mostrar desafío actual
            if (currentDailyChallenge) {
                const div = document.createElement('div');
                div.className = 'upgrade';
                div.innerHTML = `
                    <h4>🎯 ${currentDailyChallenge.name} (ACTIVO)</h4>
                    <p>${currentDailyChallenge.desc}</p>
                    <p>Progreso: ${currentDailyChallenge.progress}/${currentDailyChallenge.target}</p>
                    <div style="background: #333; height: 8px; border-radius: 4px; margin: 5px 0;">
                        <div style="background: var(--success); height: 100%; width: ${(currentDailyChallenge.progress / currentDailyChallenge.target) * 100}%; border-radius: 4px;"></div>
                    </div>
                    <p style="color: var(--success);">Recompensa: ${currentDailyChallenge.reward} ${currentDailyChallenge.type}</p>
                `;
                container.appendChild(div);
            }
            
            // Mostrar todos los desafíos disponibles
            dailyChallenges.forEach(challenge => {
                if (challenge !== currentDailyChallenge) {
                    const div = document.createElement('div');
                    div.className = 'upgrade';
                    div.style.opacity = challenge.completed ? '0.6' : '1';
                    div.innerHTML = `
                        <h4>${challenge.name} ${challenge.completed ? '✅' : ''}</h4>
                        <p>${challenge.desc}</p>
                        <p>Recompensa: ${challenge.reward} ${challenge.type}</p>
                        <div style="color: ${challenge.completed ? '#4CAF50' : '#888'};">Estado: ${challenge.completed ? 'Completado' : 'Disponible'}</div>
                    `;
                    container.appendChild(div);
                }
            });
        }
        
        function updateAchievementsDisplay() {
            achievements.forEach(achievement => {
                const element = document.getElementById(`achievement-${achievement.id}`);
                if (element) {
                    element.textContent = achievement.unlocked ? '✅ Completado' : '❌ Bloqueado';
                    element.style.color = achievement.unlocked ? '#4CAF50' : '#ff4444';
                }
            });
        }
        
        function updateEventsDisplay() {
            const nameEl = document.getElementById('eventName');
            const descEl = document.getElementById('eventDesc');
            const timerEl = document.getElementById('eventTimer');
            
            if (currentEvent) {
                nameEl.textContent = `🎪 ${currentEvent.name}`;
                descEl.textContent = currentEvent.desc;
                const minutes = Math.floor(eventTimeLeft / 60);
                const seconds = eventTimeLeft % 60;
                timerEl.textContent = `Tiempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                timerEl.style.color = '#4CAF50';
            } else {
                nameEl.textContent = 'Sin evento activo';
                descEl.textContent = 'Los eventos aparecen aleatoriamente cada ~100 segundos';
                timerEl.textContent = '';
            }
        }
        
        function generateEvent() {
            const events = [
                { name: 'Lluvia de Diamantes', desc: 'x2 diamantes por 1 hora', duration: 3600, effect: 'diamonds' },
                { name: 'Fiebre del Oro', desc: 'x3 coins por 30 min', duration: 1800, effect: 'coins' },
                { name: 'Combo Infinito', desc: 'Combo no decae por 45 min', duration: 2700, effect: 'combo' },
                { name: 'Velocidad Extrema', desc: 'x5 velocidad por 20 min', duration: 1200, effect: 'speed' },
                { name: 'Críticos Salvajes', desc: '100% críticos por 15 min', duration: 900, effect: 'critical' },
                { name: 'Experiencia Doble', desc: 'x4 experiencia por 40 min', duration: 2400, effect: 'experience' },
                { name: 'Rebote Mágico', desc: 'Cada rebote da +10 diamantes por 10 min', duration: 600, effect: 'magic' },
                { name: 'Tormenta Cósmica', desc: 'x10 a TODO por 5 min', duration: 300, effect: 'cosmic' }
            ];
            if (!currentEvent && Math.random() < 0.008) {
                currentEvent = events[Math.floor(Math.random() * events.length)];
                eventTimeLeft = currentEvent.duration;
                if (!gameData.events) gameData.events = { current: null, timeLeft: 0 };
                gameData.events.current = currentEvent;
                gameData.events.timeLeft = eventTimeLeft;
                showNotification(`🎪 Evento iniciado: ${currentEvent.name}`);
            }
        }
        
        function buyCard(cardId) {
            const card = cards.find(c => c.id === cardId);
            if (card && !card.owned && diamonds >= card.cost) {
                diamonds -= card.cost;
                card.owned = true;
                gameData.cards.push(cardId);
                showNotification(`🃏 Carta obtenida: ${card.name}`);
                updateUI();
            }
        }
        
        function buyPet(petId) {
            const pet = pets.find(p => p.id === petId);
            if (!pet) return;
            
            if (pet.premium && !premiumUnlocked) {
                showPremiumShop();
                return;
            }
            
            if (pet && !pet.owned && diamonds >= pet.cost) {
                diamonds -= pet.cost;
                pet.owned = true;
                gameData.pets.push(petId);
                gameData.diamonds = diamonds;
                showNotification(`🐾 Mascota obtenida: ${pet.name}`);
                updateUI();
            }
        }
        
        function buyArtifact(artifactId) {
            const artifact = artifacts.find(a => a.id === artifactId);
            if (artifact && !artifact.owned && diamonds >= artifact.cost) {
                diamonds -= artifact.cost;
                artifact.owned = true;
                gameData.artifacts.push(artifactId);
                if (artifactId === 'crown') gameData.infiniteLevels = true;
                showNotification(`⚡ Artefacto obtenido: ${artifact.name}`);
                updateUI();
            }
        }
        
        function syncCollectionData() {
            // Inicializar arrays si no existen
            if (!gameData.achievements) gameData.achievements = [];
            if (!gameData.cards) gameData.cards = [];
            if (!gameData.pets) gameData.pets = [];
            if (!gameData.artifacts) gameData.artifacts = [];
            
            // Sincronizar logros
            achievements.forEach(achievement => {
                if (gameData.achievements.includes(achievement.id)) {
                    achievement.unlocked = true;
                }
            });
            
            // Sincronizar cartas
            cards.forEach(card => {
                if (gameData.cards.includes(card.id)) {
                    card.owned = true;
                }
            });
            
            // Sincronizar mascotas
            pets.forEach(pet => {
                if (gameData.pets.includes(pet.id)) {
                    pet.owned = true;
                }
            });
            
            // Sincronizar artefactos
            artifacts.forEach(artifact => {
                if (gameData.artifacts.includes(artifact.id)) {
                    artifact.owned = true;
                }
            });
        }
        
        function applyCollectionEffects() {
            let coinMultiplier = 1;
            let expMultiplier = 1;
            let speedMultiplier = 1;
            
            // Asegurar que los arrays existen
            const cards = gameData.cards || [];
            const pets = gameData.pets || [];
            
            // Efectos de cartas
            if (cards.includes('coins')) coinMultiplier *= 1.25;
            if (cards.includes('speed')) speedMultiplier *= 1.1;
            if (cards.includes('experience')) expMultiplier *= 1.3;
            if (cards.includes('ultimate')) { coinMultiplier *= 2; expMultiplier *= 2; speedMultiplier *= 2; }
            
            // Efectos de mascotas
            if (pets.includes('cat')) expMultiplier *= 1.15;
            if (pets.includes('dragon')) coinMultiplier *= 1.3;
            if (pets.includes('phoenix')) speedMultiplier *= 1.2;
            if (pets.includes('unicorn')) coinMultiplier *= 1.25;
            if (pets.includes('kraken')) coinMultiplier *= 1.4;
            if (pets.includes('robot')) {
                // Robot recolector automático
                orbs.forEach((orb, index) => {
                    if (Math.random() < 0.02) {
                        collectOrb(orb);
                        orbs.splice(index, 1);
                    }
                });
            }
            if (pets.includes('ancientDragon')) {
                coinMultiplier *= 5;
                expMultiplier *= 5;
                speedMultiplier *= 2;
            }
            
            // Efectos de ascensión
            if (gameData.ascensionPoints > 0) {
                coinMultiplier *= Math.pow(2, gameData.ascensionPoints);
            }
            
            return { coinMultiplier, expMultiplier, speedMultiplier };
        }

        // Sistema de notificaciones móvil
        let notificationId = 0;
        
        function showNotification(message) {
            const notificationCenter = document.getElementById('notificationCenter');
            if (!notificationCenter) return;
            
            const notification = document.createElement('div');
            notification.className = 'notification-item';
            notification.id = `notification-${++notificationId}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            notification.innerHTML = `
                <div class="notification-header">
                    <span class="notification-time">${timeString}</span>
                </div>
                <div class="notification-text">${message}</div>
            `;
            
            // Hacer toda la notificación clickeable para cerrar
            notification.onclick = () => removeNotification(notification.id);
            
            // Agregar al inicio de la lista
            notificationCenter.insertBefore(notification, notificationCenter.firstChild);
            
            // Limitar a 10 notificaciones máximo
            const notifications = notificationCenter.children;
            if (notifications.length > 10) {
                notifications[notifications.length - 1].remove();
            }
            
            // Auto-remover después de 10 segundos
            setTimeout(() => {
                removeNotification(notification.id);
            }, 10000);
        }
        
        function removeNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.classList.add('removing');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }

        // Funciones de orbes
        function spawnOrb() {
            if (orbs.length < 8 && Math.random() < 0.008) { // 0.8% chance cada frame
                const orbType = getRandomOrbType();
                const orb = {
                    x: Math.random() * (width - 100) + 50,
                    y: Math.random() * (height - 100) + 50,
                    radius: 15 + (orbType.rarity === 'mítico' ? 10 : orbType.rarity === 'legendario' ? 5 : 0),
                    type: orbType,
                    alpha: 1,
                    life: 15000 + (orbType.rarity === 'mítico' ? 10000 : 0), // Vida más larga para raros
                    maxLife: 15000 + (orbType.rarity === 'mítico' ? 10000 : 0),
                    pulsePhase: 0
                };
                orbs.push(orb);
                // Solo notificar orbes raros o mejores
                if (orb.type.rarity !== 'común') {
                    showNotification(`✨ ${orb.type.name} apareció!`);
                }
            }
        }
        
        function getRandomOrbType() {
            const rarityWeights = {
                'común': 50,
                'raro': 25,
                'épico': 15,
                'legendario': 8,
                'mítico': 2
            };
            
            const totalWeight = Object.values(rarityWeights).reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            
            for (const [rarity, weight] of Object.entries(rarityWeights)) {
                random -= weight;
                if (random <= 0) {
                    const orbsOfRarity = orbTypes.filter(orb => orb.rarity === rarity);
                    return orbsOfRarity[Math.floor(Math.random() * orbsOfRarity.length)];
                }
            }
            
            return orbTypes[0]; // Fallback
        }
        
        function updateOrbs() {
            spawnOrb();
            
            orbs.forEach((orb, index) => {
                orb.life -= 16; // Reducir vida
                orb.alpha = orb.life / orb.maxLife;
                orb.pulsePhase += 0.1;
                orb.radius = (15 + (orb.type.rarity === 'mítico' ? 10 : orb.type.rarity === 'legendario' ? 5 : 0)) + Math.sin(orb.pulsePhase) * 3;
                
                if (orb.life <= 0) {
                    orbs.splice(index, 1);
                }
            });
        }
        
        function checkOrbCollisions() {
            orbs.forEach((orb, index) => {
                const distance = Math.sqrt((ball.x - orb.x) ** 2 + (ball.y - orb.y) ** 2);
                if (distance < ball.radius + orb.radius) {
                    collectOrb(orb);
                    orbs.splice(index, 1);
                }
            });
        }
        
        function collectOrb(orb) {
            const effect = {
                type: orb.type.effect,
                power: orb.type.power,
                duration: orb.type.duration,
                timeLeft: orb.type.duration,
                color: orb.type.color,
                name: orb.type.name
            };
            
            activeOrbEffects.push(effect);
            
            // Actualizar progreso de desafío de orbes
            if (currentDailyChallenge && currentDailyChallenge.id === 'orbs') {
                if (!currentDailyChallenge.orbsCollected) currentDailyChallenge.orbsCollected = 0;
                currentDailyChallenge.orbsCollected++;
            }
            
            // Crear partículas especiales al recoger orbe
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: orb.x,
                    y: orb.y,
                    dx: (Math.random() - 0.5) * 15,
                    dy: (Math.random() - 0.5) * 15,
                    life: 2000,
                    maxLife: 2000,
                    alpha: 1,
                    color: orb.type.color
                });
            }
            
            // Actualizar progreso de partículas
            if (currentDailyChallenge && currentDailyChallenge.id === 'particles') {
                if (!currentDailyChallenge.particlesGenerated) currentDailyChallenge.particlesGenerated = 0;
                currentDailyChallenge.particlesGenerated += 15;
            }
            
            // Aplicar efecto inmediato balanceado
            switch (orb.type.effect) {
                case 'speed':
                    ball.dx *= orb.type.power;
                    ball.dy *= orb.type.power;
                    break;
                case 'coins':
                    const coinsGained = Math.floor(level * orb.type.power * 5);
                    coins += coinsGained;
                    gameData.coins = coins;
                    break;
                case 'diamonds':
                    const diamondsGained = Math.floor(orb.type.power);
                    diamonds += diamondsGained;
                    gameData.diamonds = diamonds;
                    break;
                case 'combo':
                    combo += orb.type.power;
                    break;
                case 'experience':
                    const expGained = Math.floor(level * orb.type.power * 3);
                    experience += expGained;
                    gameData.experience = experience;
                    break;
                case 'rainbow':
                    // Efecto especial balanceado: todos los recursos
                    const rainbowCoins = Math.floor(level * orb.type.power * 8);
                    const rainbowDiamonds = Math.floor(orb.type.power);
                    const rainbowExp = Math.floor(level * orb.type.power * 4);
                    coins += rainbowCoins;
                    diamonds += rainbowDiamonds;
                    experience += rainbowExp;
                    combo += orb.type.power * 0.5;
                    gameData.coins = coins;
                    gameData.diamonds = diamonds;
                    gameData.experience = experience;
                    break;
            }
            
            const rarityEmoji = {
                'común': '⚪',
                'raro': '🔵', 
                'épico': '🟣',
                'legendario': '🟡',
                'mítico': '🌈'
            };
            
            // Solo notificar recolección de orbes épicos o mejores
            if (orb.type.rarity === 'épico' || orb.type.rarity === 'legendario' || orb.type.rarity === 'mítico') {
                showNotification(`${rarityEmoji[orb.type.rarity]} ${orb.type.name} recogido!`);
            }
            updateUI();
        }
        
        function updateOrbEffects() {
            activeOrbEffects.forEach((effect, index) => {
                effect.timeLeft -= 16;
                
                // Efectos continuos balanceados
                if (effect.type === 'critical' && Math.random() < 0.05) {
                    const criticalCoins = Math.floor(level * effect.power * 0.5);
                    coins += criticalCoins;
                    gameData.coins = coins;
                } else if (effect.type === 'time') {
                    // Ralentizar el juego ligeramente
                    gameSpeed = Math.max(0.5, 1 * effect.power);
                } else if (effect.type === 'combo' && Math.random() < 0.02) {
                    // Mantener combo alto
                    combo = Math.min(combo + 0.1, 20);
                }
                
                if (effect.timeLeft <= 0) {
                    // Revertir efectos al terminar
                    if (effect.type === 'speed') {
                        ball.dx /= effect.power;
                        ball.dy /= effect.power;
                    } else if (effect.type === 'time') {
                        gameSpeed = 1;
                    }
                    
                    activeOrbEffects.splice(index, 1);
                }
            });
        }
        
        function toggleControlsVisibility() {
            const controls = document.getElementById('controls');
            const toggleBtn = document.getElementById('toggleControls');
            const arrow = document.getElementById('controlsArrow');
            
            controlsVisible = !controlsVisible;
            
            if (controlsVisible) {
                controls.classList.remove('hidden');
                toggleBtn.textContent = '▲';
                if (arrow) arrow.style.display = 'block';
            } else {
                controls.classList.add('hidden');
                toggleBtn.textContent = '▼';
                if (arrow) arrow.style.display = 'none';
            }
        }

        // Inicializar el juego
        window.addEventListener('load', () => {
            init();
            generateMissions();
            generateAdvancedMissions();
            syncCollectionData();
            updateDailyChallengesDisplay();
            selectRandomDailyChallenge();
            setInterval(updateResetTimer, 1000);
            
            // Ocultar flecha después de 15 segundos o al hacer clic en cualquier botón
            setTimeout(() => {
                const arrow = document.getElementById('controlsArrow');
                if (arrow) arrow.style.display = 'none';
            }, 15000);
            
            // Ocultar flecha al interactuar con controles
            document.getElementById('controls').addEventListener('click', () => {
                const arrow = document.getElementById('controlsArrow');
                if (arrow) arrow.style.display = 'none';
            });
        });
    </script>
</body>

</html>