<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef's Kitchen Frenzy - Cooking Challenge</title>
    <style>
        :root {
            --primary: #ff6b35;
            --secondary: #f7931e;
            --accent: #ffd700;
            --success: #27ae60;
            --warning: #e74c3c;
            --danger: #c0392b;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --ui-scale: 1;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            transition: all 0.5s ease;
        }

        canvas {
            display: block;
            background: radial-gradient(circle at center, rgba(255, 107, 53, 0.1) 0%, rgba(247, 147, 30, 0.3) 100%);
            backdrop-filter: blur(10px);
            transition: all 0.5s ease;
            transform-origin: center;
        }

        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff6b35;
            padding: 15px;
            border-radius: 8px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            font-weight: bold;
            transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff6b35;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            pointer-events: auto;
            z-index: 100;
            transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #controls.hidden {
            transform: translateX(-50%) translateY(100%);
            opacity: 0.3;
        }

        #toggleControls {
            position: fixed;
            bottom: 5px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            z-index: 101;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
            font-size: 13px;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .stat-icon {
            font-size: 14px;
        }

        #currency-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff6b35;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: auto;
            min-width: 200px;
            font-weight: bold;
            transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .gold-text {
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
            font-weight: 600;
        }

        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(95%, 600px);
            max-height: 90vh;
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 25px;
            border-radius: 25px;
            display: none;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
            z-index: 100;
        }

        .tab {
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }

        .tab button {
            background: transparent;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 12px 16px;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 500;
            flex: 1;
            min-width: 90px;
            border-radius: 12px;
            margin: 3px;
        }

        .tab button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-2px);
        }

        .tab button.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .tabcontent {
            display: none;
            padding: 10px 0;
            animation: fadeEffect 0.3s;
        }

        @keyframes fadeEffect {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .upgrade {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            position: relative;
            font-size: 13px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .upgrade::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .upgrade:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .upgrade h4 {
            margin: 0 0 8px 0;
            color: var(--success);
            font-size: 15px;
            font-weight: 600;
        }

        .upgrade p {
            margin: 3px 0;
            font-size: 11px;
            line-height: 1.3;
        }

        .legendary-upgrade::before {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
        }

        .legendary-upgrade {
            background: rgba(255, 107, 53, 0.08);
        }

        .legendary-upgrade h4 {
            color: #ff6b35;
        }

        .mythic-upgrade::before {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .mythic-upgrade {
            background: rgba(155, 89, 182, 0.08);
        }

        .mythic-upgrade h4 {
            color: #9b59b6;
        }

        button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            display: inline-block;
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.5;
        }

        .premium-feature {
            position: relative;
        }

        .premium-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, var(--warning), #ffa726);
            color: #333;
            font-size: 9px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(246, 211, 101, 0.4);
        }

        .diamond-badge {
            background: linear-gradient(135deg, var(--accent), #a8edea);
            color: #333;
        }

        .legendary-badge {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
        }

        .mythic-badge {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        #importExport,
        #config,
        #stats,
        #missions,
        #premiumShop,
        #dailyChallenges,
        #achievements,
        #codes,
        #feedback,
        #musicPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 20px;
            border-radius: 15px;
            width: min(90%, 600px);
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            pointer-events: auto;
        }

        #dailyChallenges {
            max-height: 80vh;
            overflow-y: auto;
        }

        #saveData {
            width: 100%;
            height: 150px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }

        .prestige-section {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }



        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            40% {
                transform: translateX(-50%) translateY(-10px);
            }

            60% {
                transform: translateX(-50%) translateY(-5px);
            }
        }

        @media (max-width: 768px) {
            #ui {
                grid-template-columns: repeat(2, 1fr);
                font-size: 9px;
                left: 5px;
                top: 5px;
                min-width: calc(50vw - 20px);
                max-width: calc(50vw - 20px);
                padding: 8px;
            }

            .stat-item {
                font-size: 9px;
                padding: 2px 4px;
            }

            #controls {
                bottom: 5px;
                left: 5px;
                right: 5px;
                transform: none;
                width: calc(100vw - 30px);
                padding: 5px;
            }

            #controls.hidden {
                transform: translateY(100%);
            }

            #controls button {
                flex: 1;
                min-width: 60px;
                font-size: 10px;
                padding: 6px 4px;
            }

            #controlsArrow {
                bottom: 70px;
                font-size: 16px;
            }

            .tab {
                flex-direction: column;
            }

            .tab button {
                flex: none;
                width: 100%;
            }

            #currency-display {
                right: 5px;
                top: 5px;
                font-size: 9px;
                padding: 8px;
                min-width: calc(45vw - 20px);
                max-width: calc(45vw - 20px);
            }

            #toggleControls {
                right: 10px;
                bottom: 2px;
                padding: 6px 8px;
                font-size: 10px;
            }

            .notification-center {
                width: calc(100vw - 20px);
                right: 10px;
                top: 10px;
                max-height: 200px;
            }

            .notification-item {
                font-size: 12px;
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {
            #ui {
                grid-template-columns: 1fr;
                font-size: 8px;
                min-width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
            }

            #currency-display {
                position: relative;
                top: auto;
                right: auto;
                margin: 5px;
                min-width: calc(100vw - 30px);
                max-width: calc(100vw - 30px);
            }
        }

        .config-section {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            backdrop-filter: blur(5px);
        }

        .config-section h4 {
            margin: 0 0 10px 0;
            color: #fff;
            font-size: 16px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            font-weight: bold;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .config-item label {
            flex: 1;
            margin-right: 15px;
            color: #fff;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .config-item select,
        .config-item input[type="range"],
        .config-item input[type="number"],
        .config-item input[type="checkbox"] {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            padding: 8px 12px;
            min-width: 120px;
            font-size: 14px;
            font-weight: bold;
        }

        .config-item select option {
            background: #1a1a1a;
            color: #fff;
            padding: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .config-item select:focus,
        .config-item input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
        }

        .config-item input[type="checkbox"] {
            min-width: auto;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .config-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .config-buttons button {
            flex: 1;
            font-size: 12px;
            padding: 8px 12px;
            font-weight: bold;
        }

        .config-main-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .config-main-buttons button {
            flex: 1;
            min-width: 100px;
            font-size: 13px;
            padding: 10px 15px;
            font-weight: bold;
        }

        .premium-tab {
            transition: all 0.3s ease;
        }

        .premium-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .premium-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .premium-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Optimizaciones móviles */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px;
                touch-action: manipulation;
            }

            input,
            select {
                min-height: 40px;
                font-size: 16px;
                touch-action: manipulation;
            }

            canvas {
                touch-action: none;
            }

            #ui,
            #currency-display,
            #controls {
                -webkit-user-select: none;
                user-select: none;
            }
        }
    </style>
</head>

<body>
    <div id="loadingScreen"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; color: white;">
        <h1>Chef's Kitchen Frenzy - Cooking Challenge</h1>
        <div style="width: 200px; height: 200px; position: relative; margin: 20px;">
            <div
                style="width: 100%; height: 100%; border: 10px solid #333; border-top-color: var(--hud-color); border-radius: 50%; animation: spin 1s linear infinite;">
            </div>
            <div
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; font-weight: bold;">
                100%</div>
        </div>
        <p>Preparando la cocina...</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div id="ui">
            <div class="stat-item"><span class="stat-icon">🍳</span><span class="stat-label">Platos:</span> <span
                    id="bounces">0</span></div>
            <div class="stat-item"><span class="stat-icon">🔥</span><span class="stat-label">Combo:</span> <span
                    id="combo">1x</span></div>
            <div class="stat-item"><span class="stat-icon">👨🍳</span><span class="stat-label">Chef Lv:</span> <span
                    id="level">1</span></div>
            <div class="stat-item"><span class="stat-icon">⭐</span><span class="stat-label">Michelin:</span> <span
                    id="prestige">0</span></div>
            <div class="stat-item"><span class="stat-icon">🥘</span><span class="stat-label">Recetas:</span> <span
                    id="orbCount">0</span></div>
            <div class="stat-item"><span class="stat-icon">⏰</span><span class="stat-label">AFK:</span> <span
                    id="afkTimer">0s</span></div>
            <div class="stat-item"><span class="stat-icon">⚡</span><span class="stat-label">Racha:</span> <span
                    id="streakDisplay">0x</span></div>
        </div>

        <div id="controls">

            <button id="shopBtn" title="Abrir tienda de mejoras">🛒 Mercado</button>
            <button id="achievementsBtn" title="Ver logros y eventos activos">🏆 Logros & Eventos</button>
            <button id="dailyChallengesBtn" title="Retos culinarios diarios">🎯 Retos</button>
            <button id="missionsBtn" title="Misiones del juego">📋 Órdenes</button>
            <button id="statsBtn" title="Estadísticas del juego">📈 Stats</button>
            <button id="configBtn" title="Configuración del juego">⚙️ Config</button>
            <button id="pauseBtn" title="Pausar/Reanudar juego">⏸️ Pausa</button>
            <button id="importExportBtn" title="Guardar/Cargar datos">📁 Datos</button>
            <button id="codesBtn" title="Canjear códigos especiales">🎁 Códigos</button>
            <button id="feedbackBtn" title="Enviar feedback de beta">📝 Feedback</button>
            <button id="musicBtn" title="Panel de música">🎵 Música</button>
            <button id="prestigeBtn" title="Reiniciar con bonificadores">⭐ Estrella</button>
        </div>

        <div id="controlsArrow"
            style="position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); color: white; font-size: 20px; animation: bounce 2s infinite; pointer-events: none; z-index: 99;">
            ▼</div>

        <button id="toggleControls" onclick="toggleControlsVisibility()">▲</button>

        <button id="toggleUI" onclick="toggleUIVisibility()"
            style="position: fixed; top: 5px; right: 20px; background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); color: white; padding: 8px 12px; border-radius: 15px; cursor: pointer; z-index: 101; font-size: 12px;">◀</button>

        <div id="versionIndicator"
            style="position: fixed; bottom: 5px; left: 5px; background: rgba(0, 0, 0, 0.6); color: white; padding: 3px 6px; border-radius: 4px; font-size: 9px; z-index: 1000; pointer-events: none;">
            v1.0
        </div>
    </div>

    <div id="currency-display">
        <div>🥕 Ingredientes: <span id="coins">0</span></div>
        <div class="diamond-text">🧂 Especias: <span id="diamonds">0</span></div>
        <div>👨🍳 Experiencia: <span id="experience">0</span></div>
        <div style="color: #ff6b35;">🔥 Maestría: <span id="ascensionPoints">0</span></div>
        <div style="color: #ffd700;">🏆 Logros: <span id="achievementCount">0</span></div>
        <div style="color: #00ff00;">📜 Recetas: <span id="cardCount">0</span></div>
        <div style="color: #ff69b4;">🎪 Evento: <span id="eventStatus">Ninguno</span></div>
        <div style="color: #ffd700;">🏬 Reputación: <span id="reputation">0</span></div>
        <div style="color: #87ceeb;">👥 Clientes: <span id="customerCount">0</span></div>
        <div id="activeOrbEffectsDisplay" style="color: #00ffff; font-size: 10px; margin-top: 5px;"></div>
    </div>


    </div>

    <!-- Config Panel -->
    <div id="config">
        <h3>⚙️ Configuración</h3>

        <!-- Apartado: Apariencia -->
        <div class="config-section">
            <h4>🎨 Apariencia</h4>
            <div class="config-item">
                <label>Tema:</label>
                <button id="themeToggle" onclick="toggleTheme()">Modo Claro</button>
            </div>
            <div class="config-item">
                <label>Tamaño de UI:</label>
                <input type="range" id="uiScale" min="0.8" max="1.5" step="0.1" value="1" oninput="updateUIScale()">
                <span id="uiScaleValue">100%</span>
            </div>
            <div class="config-item premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <label>Color de la bola:</label>
                <input type="color" id="ballColor" value="#ff0000" disabled>
            </div>
            <div class="config-item premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <label>Efectos de aura:</label>
                <input type="checkbox" id="auraEffects" disabled>
            </div>
            <div class="config-item premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <label>Celebraciones épicas:</label>
                <input type="checkbox" id="epicCelebrations" disabled>
            </div>
            <div class="config-item">
                <label>Fondo del juego:</label>
                <select id="backgroundType"
                    style="background: var(--glass); color: white; border: 1px solid var(--glass-border); padding: 5px;">
                    <option value="gradient">Degradado</option>
                    <option value="solid">Sólido</option>
                    <option value="stars">Estrellas</option>
                    <option value="minimal">Minimalista</option>
                </select>
            </div>
        </div>

        <!-- Apartado: Rendimiento -->
        <div class="config-section">
            <h4>⚡ Rendimiento</h4>
            <div class="config-item">
                <label>Calidad gráfica:</label>
                <select id="graphicsQuality"
                    style="background: var(--glass); color: white; border: 1px solid var(--glass-border); padding: 5px;">
                    <option value="low">Baja (móvil)</option>
                    <option value="medium" selected>Media</option>
                    <option value="high">Alta (PC)</option>
                    <option value="ultra">Ultra (PC potente)</option>
                </select>
            </div>
            <div class="config-item">
                <label>FPS objetivo:</label>
                <select id="targetFPS"
                    style="background: var(--glass); color: white; border: 1px solid var(--glass-border); padding: 5px;">
                    <option value="30">30 FPS (móvil)</option>
                    <option value="60" selected>60 FPS</option>
                    <option value="120">120 FPS (PC)</option>
                    <option value="144">144 FPS (PC gaming)</option>
                </select>
            </div>
            <div class="config-item">
                <label>Partículas:</label>
                <input type="range" id="particleCountSlider" min="0" max="100" value="10"
                    oninput="updateParticleValue()">
                <span id="particleValue">10</span>
            </div>
            <div class="config-item">
                <label>Modo rendimiento:</label>
                <input type="checkbox" id="performanceMode">
            </div>
            <div class="config-item">
                <label>Ahorro de batería:</label>
                <input type="checkbox" id="batterySaver">
            </div>
            <div class="config-item">
                <label>Reducir animaciones:</label>
                <input type="checkbox" id="reduceAnimations">
            </div>
        </div>

        <!-- Apartado: Juego -->
        <div class="config-section">
            <h4>🎮 Juego</h4>
            <div class="config-item">
                <label>Velocidad de juego:</label>
                <input type="range" id="gameSpeedSlider" min="0.5" max="3" step="0.1" value="1"
                    oninput="updateSpeedValue()">
                <span id="speedValue">1.0x</span>
            </div>
            <div class="config-item">
                <label>Auto-pausa en segundo plano:</label>
                <input type="checkbox" id="pauseBackground" checked>
            </div>
            <div class="config-item">
                <label>Auto-guardado:</label>
                <select id="autoSaveInterval"
                    style="background: var(--glass); color: white; border: 1px solid var(--glass-border); padding: 5px;">
                    <option value="5">Cada 5 segundos</option>
                    <option value="10" selected>Cada 10 segundos</option>
                    <option value="30">Cada 30 segundos</option>
                    <option value="60">Cada minuto</option>
                </select>
            </div>
            <div class="config-item">
                <label>Confirmación de prestigio:</label>
                <input type="checkbox" id="confirmPrestige" checked>
            </div>
        </div>

        <!-- Apartado: Audio y Notificaciones -->
        <div class="config-section">
            <h4>🔊 Audio & Notificaciones</h4>
            <div class="config-item">
                <label>Sonidos:</label>
                <input type="checkbox" id="soundToggle" checked>
            </div>
            <div class="config-item">
                <label>Volumen:</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="updateVolumeValue()">
                <span id="volumeValue">50%</span>
            </div>
            <div class="config-item">
                <label>Notificaciones:</label>
                <input type="checkbox" id="notificationsToggle" checked>
            </div>
            <div class="config-item">
                <label>Vibración (móvil):</label>
                <input type="checkbox" id="vibrationToggle" checked>
            </div>
            <div class="config-item">
                <label>Sonidos de logros:</label>
                <input type="checkbox" id="achievementSounds" checked>
            </div>

            <div class="config-item premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <label>🎵 Temas musicales extra:</label>
                <select id="premiumMusicThemes" disabled>
                    <option>Synthwave</option>
                    <option>Dubstep</option>
                    <option>Jazz</option>
                    <option>Classical</option>
                </select>
            </div>
        </div>

        <!-- Apartado: Guardado -->
        <div class="config-section">
            <h4>💾 Guardado</h4>
            <div class="config-item">
                <label>Slot de guardado:</label>
                <select id="saveSlot"
                    style="background: var(--glass); color: white; border: 1px solid var(--glass-border); padding: 5px;">
                    <option value="1">Slot 1</option>
                    <option value="2">Slot 2</option>
                    <option value="3">Slot 3</option>
                </select>
            </div>
            <div class="config-buttons">
                <button onclick="saveToSlot()">💾 Guardar Slot</button>
                <button onclick="loadFromSlot()">📁 Cargar Slot</button>
            </div>
            <div class="config-item premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <label>☁️ Guardado en la nube:</label>
                <button onclick="showPremiumRequired('Guardado en la nube')" disabled>Sincronizar</button>
            </div>
            <div class="config-item premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <label>🔄 Auto-backup:</label>
                <input type="checkbox" id="autoBackup" disabled>
            </div>
        </div>

        <!-- Apartado: Avanzado -->
        <div class="config-section">
            <h4>🔧 Avanzado</h4>
            <div class="config-item">
                <label>Modo desarrollador:</label>
                <input type="checkbox" id="devMode">
            </div>
            <div class="config-item">
                <label>Mostrar FPS:</label>
                <input type="checkbox" id="showFPS">
            </div>
            <div class="config-item">
                <label>Debug de colisiones:</label>
                <input type="checkbox" id="debugCollisions">
            </div>
            <div class="config-buttons">
                <button onclick="exportSettings()">📤 Exportar Config</button>
                <button onclick="importSettings()">📥 Importar Config</button>
            </div>
        </div>

        <!-- Botones principales -->
        <div class="config-main-buttons">
            <button onclick="applyConfig()" style="background: var(--success);">✓ Aplicar Todo</button>
            <button onclick="resetSettings()" style="background: var(--warning); color: black;">🔄 Restaurar</button>
            <button onclick="resetGame()" style="background: var(--danger);">⚠️ Reset Total</button>
            <button onclick="closeConfig()">❌ Cerrar</button>
        </div>
    </div>

    <!-- Stats Panel -->
    <div id="stats">
        <h3>Estadísticas</h3>
        <div>FPS: <span id="fpsCounter">60</span></div>
        <div>Partículas: <span id="particleCounter">0</span></div>
        <div>Total rebotes: <span id="totalBounces">0</span></div>
        <div>Total coins: <span id="totalCoins">0</span></div>
        <div>Tiempo jugado: <span id="playTime">0m</span></div>
        <div>Mejor combo: <span id="bestCombo">1x</span></div>
        <div style="border-top: 1px solid #555; margin: 15px 0; padding-top: 15px;">
            <h4>Estadísticas Beta 2</h4>
            <div>Sesión actual: <span id="sessionTime">0m</span></div>
            <div>Orbes recogidos: <span id="totalOrbs">0</span></div>
            <div>Códigos canjeados: <span id="codesRedeemed">0</span></div>
            <div>Eventos activados: <span id="eventsTriggered">0</span></div>
            <div>Crashes detectados: <span id="crashCount">0</span></div>
        </div>

        <div class="premium-feature"
            style="opacity: 0.5; border-top: 1px solid #555; margin-top: 15px; padding-top: 15px;">
            <div class="premium-badge">PREMIUM</div>
            <h4>📊 Estadísticas Avanzadas</h4>
            <button onclick="showPremiumRequired('Estadísticas avanzadas')" disabled>📈 Gráficos Detallados</button>
            <button onclick="showPremiumRequired('Exportar datos')" disabled>📄 Exportar PDF</button>
            <button onclick="showPremiumRequired('Predictor de metas')" disabled>🎯 Predictor IA</button>
        </div>

        <button onclick="closeStats()">Cerrar</button>
    </div>

    <!-- Missions Panel -->
    <div id="missions" style="max-height: 80vh; overflow-y: auto;">
        <h3>Misiones Diarias</h3>
        <div>Set de Misiones: <span id="missionSetNumber">1</span></div>
        <div id="missionList"></div>
        <button onclick="closeMissions()">Cerrar</button>
    </div>

    <!-- Unified Achievements & Events Panel -->
    <div id="achievements">
        <div class="tab">
            <button class="tablinks active" onclick="openAchievementTab(event, 'achievementsList')">🏆 Logros</button>
            <button class="tablinks" onclick="openAchievementTab(event, 'eventsList')">🎪 Eventos</button>
        </div>

        <div id="achievementsList" class="tabcontent" style="display: block;">
            <h3>🏆 Sistema de Logros</h3>
            <div id="achievementsContainer">
                <div class="upgrade">
                    <h4>Primer Centenar</h4>
                    <p>Alcanza 100 rebotes - Recompensa: 500 coins</p>
                    <div id="achievement-first100">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Mil Rebotes</h4>
                    <p>Alcanza 1000 rebotes - Recompensa: 2000 coins</p>
                    <div id="achievement-first1000">❌ Bloqueado</div>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Maestro Rebotador</h4>
                    <p>Alcanza 10K rebotes - Recompensa: 10K coins</p>
                    <div id="achievement-first10k">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Millonario</h4>
                    <p>Consigue 1M coins - Recompensa: 1000 coins</p>
                    <div id="achievement-millionaire">❌ Bloqueado</div>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Billonario</h4>
                    <p>Consigue 1B coins - Recompensa: 50K coins</p>
                    <div id="achievement-billionaire">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Coleccionista</h4>
                    <p>Obtén 10 diamantes - Recompensa: 5 diamantes</p>
                    <div id="achievement-diamond10">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Cazador de Gemas</h4>
                    <p>Obtén 100 diamantes - Recompensa: 25 diamantes</p>
                    <div id="achievement-diamond100">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Renacimiento</h4>
                    <p>Haz tu primer prestigio - Recompensa: 2000 coins</p>
                    <div id="achievement-prestige1">❌ Bloqueado</div>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Veterano</h4>
                    <p>Haz 10 prestigios - Recompensa: 20K coins</p>
                    <div id="achievement-prestige10">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Medio Siglo</h4>
                    <p>Alcanza nivel 50 - Recompensa: 5K coins</p>
                    <div id="achievement-level50">❌ Bloqueado</div>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Centurión</h4>
                    <p>Alcanza nivel 100 - Recompensa: 15K coins</p>
                    <div id="achievement-level100">❌ Bloqueado</div>
                </div>
                <div class="upgrade mythic-upgrade">
                    <h4>Combo Master</h4>
                    <p>Alcanza combo 20x - Recompensa: 8K coins</p>
                    <div id="achievement-combo20">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Velocista</h4>
                    <p>Alcanza velocidad 15+ - Recompensa: 3K coins</p>
                    <div id="achievement-speed15">❌ Bloqueado</div>
                </div>
                <div class="upgrade">
                    <h4>Gigante</h4>
                    <p>Tamaño de bola 40+ - Recompensa: 4K coins</p>
                    <div id="achievement-size40">❌ Bloqueado</div>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Ascendido</h4>
                    <p>Haz tu primera ascensión - Recompensa: 100K coins</p>
                    <div id="achievement-ascension1">❌ Bloqueado</div>
                </div>
            </div>
        </div>

        <div id="eventsList" class="tabcontent">
            <h3>🎪 Eventos Temporales</h3>
            <div id="currentEventDisplay">
                <div class="upgrade">
                    <h4 id="eventName">Sin evento activo</h4>
                    <p id="eventDesc">Los eventos aparecen aleatoriamente cada ~100 segundos</p>
                    <div id="eventTimer"></div>
                </div>
            </div>
            <h3>📅 Eventos Especiales</h3>
            <div id="specialEventsContainer">
                <div class="upgrade">
                    <h4>🌟 Fin de Semana Dorado</h4>
                    <p>x2 coins los fines de semana</p>
                    <div id="weekend-event">⏰ Próximo evento</div>
                </div>
                <div class="upgrade">
                    <h4>🎃 Evento de Halloween</h4>
                    <p>Orbes especiales y bonificaciones</p>
                    <div id="halloween-event">🗓️ Octubre</div>
                </div>
                <div class="upgrade">
                    <h4>🎄 Navidad Especial</h4>
                    <p>Regalos diarios y multiplicadores</p>
                    <div id="christmas-event">🗓️ Diciembre</div>
                </div>
                <div class="upgrade">
                    <h4>🎆 Año Nuevo</h4>
                    <p>Reset de desafíos y bonos</p>
                    <div id="newyear-event">🗓️ Enero</div>
                </div>
            </div>
        </div>



        <button onclick="closeAchievements()">Cerrar</button>
    </div>

    <!-- Daily Challenges Panel -->
    <div id="dailyChallenges">
        <h3>🎯 Desafíos Diarios</h3>
        <div>Próximo reset: <span id="resetTimer">--:--:--</span></div>
        <div id="dailyChallengesContainer"></div>
        <button onclick="selectRandomDailyChallenge()">🎲 Nuevo Desafío Aleatorio</button>
        <button id="resetDailyChallengesBtn" onclick="resetDailyChallenges()" style="display:none;">🔄 Reset Desafíos
            (24h)</button>
        <button onclick="claimAfkRewards()">💤 Reclamar Recompensas AFK</button>
        <button onclick="closeDailyChallenges()">Cerrar</button>
    </div>

    <!-- Premium Shop -->
    <div id="premiumShop" style="text-align: center;">
        <h2 style="color: gold;">🌟 Premium Unlock 🌟</h2>
        <p>Desbloquea características exclusivas:</p>
        <ul style="text-align: left; margin: 15px 0;">
            <li>🎨 Skins premium exclusivas</li>
            <li>✨ Efectos visuales avanzados</li>
            <li>🎯 Personalización completa</li>
            <li>📊 Estadísticas detalladas</li>
            <li>🚀 Multiplicadores especiales</li>
            <li>🎪 Eventos únicos</li>
        </ul>
        <div
            style="background: linear-gradient(45deg, gold, orange); padding: 15px; border-radius: 10px; margin: 15px 0;">
            <h3 style="margin: 0; color: black;">Solo 5000 coins</h3>
            <p style="margin: 5px 0; color: black;">¡Oferta limitada!</p>
        </div>
        <button onclick="buyPremium()"
            style="background: gold; color: black; font-weight: bold; padding: 10px 20px; font-size: 14px;">Comprar
            Premium</button>
        <button onclick="closePremiumShop()">Más tarde</button>
    </div>
    </div>
    </div>

    <div id="shop">
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'basic')">Básico</button>
            <button class="tablinks" onclick="openTab(event, 'advanced')">Avanzado</button>
            <button class="tablinks" onclick="openTab(event, 'legendary')">Legendario</button>
            <button class="tablinks" onclick="openTab(event, 'mythic')">Mítico</button>
            <button class="tablinks" onclick="openTab(event, 'prestige')">Prestigio</button>
            <button class="tablinks" onclick="openTab(event, 'ascension')">Ascensión</button>
            <button class="tablinks" onclick="openTab(event, 'collection')">Colección</button>
            <button class="tablinks" onclick="openTab(event, 'research')">Investigación</button>
            <button class="tablinks" onclick="openTab(event, 'particles')">Partículas</button>
            <button class="tablinks" onclick="openTab(event, 'skins')">Skins</button>
            <button class="tablinks" onclick="openTab(event, 'premium')">Premium</button>
            <button class="tablinks" onclick="openTab(event, 'generators')">Generadores</button>
            <button class="tablinks" onclick="closeShop()">Cerrar</button>
        </div>

        <div id="basic" class="tabcontent" style="display: block;">
            <div class="upgrade">
                <h4>Multiplicador de Ingredientes <span id="coinMultLevel">(Nivel 0)</span></h4>
                <p>Aumenta ingredientes por plato</p>
                <p>Costo: <span id="coinMultCost">100</span> ingredientes</p>
                <button onclick="buyUpgrade('coinMult')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Velocidad de Cocina <span id="speedLevel">(Nivel 0)</span></h4>
                <p>Aumenta velocidad de preparación</p>
                <p>Costo: <span id="speedCost">150</span> ingredientes</p>
                <button onclick="buyUpgrade('speed')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Tamaño de Sartén <span id="sizeLevel">(Nivel 0)</span></h4>
                <p>Aumenta tamaño de la sartén</p>
                <p>Costo: <span id="sizeCost">200</span> ingredientes</p>
                <button onclick="buyUpgrade('size')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Combo Culinario <span id="comboLevel">(Nivel 0)</span></h4>
                <p>Aumenta duración del combo de sabores</p>
                <p>Costo: <span id="comboCost">250</span> ingredientes</p>
                <button onclick="buyUpgrade('combo')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Plato Perfecto <span id="critLevel">(Nivel 0)</span></h4>
                <p>Aumenta chance de plato perfecto</p>
                <p>Costo: <span id="criticalCost">300</span> ingredientes</p>
                <button onclick="buyUpgrade('critical')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Generador de Especias <span id="diamondGenLevel">(Nivel 0)</span></h4>
                <p>Genera especias automáticamente</p>
                <p>Costo: <span id="diamondGenCost">500</span> ingredientes</p>
                <button onclick="buyUpgrade('diamondGen')">Comprar</button>
            </div>
        </div>

        <div id="advanced" class="tabcontent">
            <div class="upgrade premium-feature">
                <div class="diamond-badge">DIAMANTE</div>
                <h4>Multiplicador de Experiencia Culinaria <span id="expMultLevel">(Nivel 0)</span></h4>
                <p>Aumenta ganancia de experiencia culinaria</p>
                <p>Costo: <span id="expMultCost">10</span> 🧂</p>
                <button onclick="buyUpgrade('expMult')">Comprar</button>
            </div>
            <div class="upgrade premium-feature">
                <div class="diamond-badge">DIAMANTE</div>
                <h4>Auto-Cocina <span id="autoLevel">(Nivel 0)</span></h4>
                <p>Cocina platos automáticamente</p>
                <p>Costo: <span id="autoCost">25</span> 🧂</p>
                <button onclick="buyUpgrade('auto')">Comprar</button>
            </div>
        </div>

        <div id="legendary" class="tabcontent">
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">LEGENDARIO</div>
                <h4>Cocción Lenta <span id="timeAscLevel">(Nivel 0)</span></h4>
                <p>Ralentiza el tiempo de cocción</p>
                <p>Costo: <span id="timeAscCost">100</span> 🧂</p>
                <button onclick="buyUpgrade('timeAsc')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">LEGENDARIO</div>
                <h4>Cocina Paralela <span id="dimensionLevel">(Nivel 0)</span></h4>
                <p>Duplica todas las ganancias culinarias</p>
                <p>Costo: <span id="dimensionCost">200</span> 🧂</p>
                <button onclick="buyUpgrade('dimension')">Comprar</button>
            </div>
        </div>

        <div id="mythic" class="tabcontent">
            <div class="upgrade mythic-upgrade">
                <div class="mythic-badge">MÍTICO</div>
                <h4>Chef Supremo <span id="omniLevel">(Nivel 0)</span></h4>
                <p>Multiplica TODAS las ganancias x10</p>
                <p>Costo: <span id="omnipotenceCost">1000</span> 🧂</p>
                <button onclick="buyUpgrade('omnipotence')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <div class="mythic-badge">MÍTICO</div>
                <h4>Maestro Infinito <span id="infiniteLevel">(Nivel 0)</span></h4>
                <p>Rompe los límites culinarios</p>
                <p>Costo: <span id="infiniteCost">5000</span> 🧂</p>
                <button onclick="buyUpgrade('infinite')">Comprar</button>
            </div>
        </div>

        <div id="prestige" class="tabcontent">
            <div class="prestige-section">
                <h3>⭐ Sistema de Estrellas Michelin ⭐</h3>
                <p>Reinicia tu progreso pero ganas bonificadores permanentes</p>
                <p>Estrellas Michelin: <span id="prestigePoints">0</span> | Prestigios: <span id="prestigeCount">0</span></p>
                <p>Requiere nivel chef 25+ y 500K+ ingredientes</p>
                <p>Bonus actual: +<span id="prestigeBonus">0</span>% coins por prestigio</p>
                <button onclick="doPrestige()">⭐ Obtener Estrella Michelin</button>
            </div>
            <div class="upgrade">
                <h4>Multiplicador de Ingredientes</h4>
                <p>+10% ingredientes permanentemente</p>
                <p>Costo: 1 Estrella Michelin</p>
                <button onclick="buyPrestigeUpgrade('coinBonus')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Multiplicador de Experiencia</h4>
                <p>+15% experiencia permanentemente</p>
                <p>Costo: 2 Estrellas Michelin</p>
                <button onclick="buyPrestigeUpgrade('expBonus')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Multiplicador de Especias</h4>
                <p>+20% especias permanentemente</p>
                <p>Costo: 3 Estrellas Michelin</p>
                <button onclick="buyPrestigeUpgrade('diamondBonus')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Chef Experimentado</h4>
                <p>Empezar con 1000 ingredientes y nivel 5</p>
                <p>Costo: 5 Estrellas Michelin</p>
                <button onclick="buyPrestigeUpgrade('startBonus')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Recolector Automático</h4>
                <p>Auto-recolectar ingredientes especiales cada 10s</p>
                <p>Costo: 8 Estrellas Michelin</p>
                <button onclick="buyPrestigeUpgrade('autoCollect')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Maestro Supremo</h4>
                <p>x2 a TODAS las ganancias permanentemente</p>
                <p>Costo: 15 Estrellas Michelin</p>
                <button onclick="buyPrestigeUpgrade('megaBonus')">Comprar</button>
            </div>
        </div>

        <div id="ascension" class="tabcontent">
            <div class="prestige-section" style="background: linear-gradient(45deg, #ff6b35, #ff9500);">
                <h3>🔥 Sistema de Maestría Culinaria 🔥</h3>
                <p>Reinicia TODO incluyendo estrellas, pero desbloquea poder supremo</p>
                <p>Puntos de Maestría: <span id="ascensionPointsDisplay">0</span></p>
                <p>Requiere 10+ Estrellas y 1B+ ingredientes</p>
                <button onclick="doAscension()">Alcanzar Maestría</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">ASCENSIÓN</div>
                <h4>Multiplicador de Maestro</h4>
                <p>x2 a TODAS las ganancias por punto de maestría</p>
                <p>Costo: 1 Punto de Maestría</p>
                <button onclick="buyAscensionUpgrade('cosmicMult')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">ASCENSIÓN</div>
                <h4>Generador de Estrellas</h4>
                <p>Genera estrellas Michelin automáticamente</p>
                <p>Costo: 2 Puntos de Maestría</p>
                <button onclick="buyAscensionUpgrade('prestigeGen')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <div class="legendary-badge">ASCENSIÓN</div>
                <h4>Acelerador Culinario</h4>
                <p>La cocina funciona 2x más rápido permanentemente</p>
                <p>Costo: 3 Puntos de Maestría</p>
                <button onclick="buyAscensionUpgrade('timeAccel')">Comprar</button>
            </div>
        </div>

        <div id="research" class="tabcontent">
            <h3>Árbol de Investigación</h3>
            <p>Usa experiencia para desbloquear tecnologías</p>
            <div class="upgrade">
                <h4>Eficiencia I</h4>
                <p>+25% coins por rebote</p>
                <p>Costo: 1000 ⭐</p>
                <button onclick="buyResearch('efficiency1')">Investigar</button>
            </div>
            <div class="upgrade">
                <h4>Eficiencia II</h4>
                <p>+50% coins por rebote</p>
                <p>Costo: 5000 ⭐</p>
                <button onclick="buyResearch('efficiency2')">Investigar</button>
            </div>
            <div class="upgrade">
                <h4>Automatización I</h4>
                <p>Genera recursos pasivamente</p>
                <p>Costo: 2500 ⭐</p>
                <button onclick="buyResearch('automation1')">Investigar</button>
            </div>
            <div class="upgrade">
                <h4>Automatización II</h4>
                <p>x2 generación pasiva</p>
                <p>Costo: 10000 ⭐</p>
                <button onclick="buyResearch('automation2')">Investigar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Multiplicación Cósmica</h4>
                <p>x5 a todas las ganancias</p>
                <p>Costo: 50000 ⭐</p>
                <button onclick="buyResearch('cosmic')">Investigar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Trascendencia</h4>
                <p>Desbloquea la siguiente dimensión</p>
                <p>Costo: 1000000 ⭐</p>
                <button onclick="buyResearch('transcend')">Investigar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Mecánica Cuántica</h4>
                <p>+500% a todas las ganancias</p>
                <p>Costo: 5000000 ⭐</p>
                <button onclick="buyResearch('quantum')">Investigar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Infinito</h4>
                <p>Remueve todos los límites</p>
                <p>Costo: 50000000 ⭐</p>
                <button onclick="buyResearch('infinity')">Investigar</button>
            </div>
        </div>

        <div id="particles" class="tabcontent">
            <h3>Efectos de Partículas</h3>
            <div class="upgrade">
                <h4>Tipo de Partículas</h4>
                <div style="margin: 5px 0;">
                    <input type="radio" id="particle1" name="particle" value="circles" checked>
                    <label for="particle1">Círculos</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="radio" id="particle2" name="particle" value="squares">
                    <label for="particle2">Cuadrados</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="radio" id="particle3" name="particle" value="stars">
                    <label for="particle3">Estrellas</label>
                </div>
            </div>
            <div class="upgrade">
                <h4>Efectos Básicos</h4>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="trailEffect" checked>
                    <label for="trailEffect">Estela de partículas</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="burstEffect" checked>
                    <label for="burstEffect">Explosión al rebotar</label>
                </div>
            </div>
            <div class="upgrade premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <h4>Efectos Premium</h4>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="glowEffect" disabled>
                    <label for="glowEffect">Resplandor de la bola</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="rainbowTrail" disabled>
                    <label for="rainbowTrail">Estela arcoíris</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="epicBurst" disabled>
                    <label for="epicBurst">Explosiones épicas</label>
                </div>
                <div style="margin: 5px 0;">
                    <input type="checkbox" id="customShapes" disabled>
                    <label for="customShapes">Formas personalizadas</label>
                </div>
                <button onclick="showPremiumShop()">Desbloquear Premium</button>
            </div>
        </div>

        <div id="skins" class="tabcontent">
            <h3>Selecciona Apariencia de Sartén</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px;">
                <div class="skin-option selected" onclick="selectSkin('default')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid var(--hud-color); border-radius: 10px;">
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #ff0000, #aa0000); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Clásica</div>
                    <div style="font-size: 8px; color: #aaa;">Común</div>
                </div>
                <div class="skin-option" onclick="selectSkin('fire')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px;">
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #ff9900, #ff3300); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Flambeada</div>
                    <div style="font-size: 8px; color: #aaa;">Común</div>
                </div>
                <div class="skin-option" onclick="selectSkin('ice')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px;">
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #00ccff, #0066ff); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Congelada</div>
                    <div style="font-size: 8px; color: var(--hud-color);">Rara</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('rainbow')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Arcoíris</div>
                    <div style="font-size: 8px; color: gold;">Premium</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('galaxy')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #9900ff, #330066); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Galaxia</div>
                    <div style="font-size: 8px; color: gold;">Premium</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('cosmic')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: radial-gradient(circle, #00ffff, #00008b); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Cósmica</div>
                    <div style="font-size: 8px; color: #ff00ff;">Exclusiva</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('neon')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: linear-gradient(45deg, #ff0080, #00ff80); border-radius: 50%; margin: 0 auto 5px;">
                    </div>
                    <div style="font-size: 10px;">Neón</div>
                    <div style="font-size: 8px; color: gold;">Premium</div>
                </div>
                <div class="skin-option premium-feature" onclick="selectSkin('diamond')"
                    style="text-align: center; cursor: pointer; padding: 10px; border: 2px solid transparent; border-radius: 10px; opacity: 0.5; position: relative;">
                    <div class="premium-badge">PREMIUM</div>
                    <div
                        style="width: 40px; height: 40px; background: linear-gradient(45deg, #b9f2ff, #0099cc); border-radius: 50%; margin: 0 auto 5px; box-shadow: 0 0 10px rgba(185, 242, 255, 0.8);">
                    </div>
                    <div style="font-size: 10px;">Diamante</div>
                    <div style="font-size: 8px; color: gold;">Premium</div>
                </div>
            </div>
        </div>

        <div id="premium" class="tabcontent">
            <div class="upgrade premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <h4>🎮 Editor de Skins Personalizado</h4>
                <p>Crea tus propias skins con herramientas avanzadas</p>
                <button onclick="showPremiumRequired('Editor de skins')" disabled>🎨 Abrir Editor</button>
            </div>
            <div class="upgrade premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <h4>🎬 Grabador de Replays</h4>
                <p>Graba y comparte tus mejores jugadas</p>
                <button onclick="showPremiumRequired('Grabador de replays')" disabled>📹 Iniciar Grabación</button>
            </div>
            <div class="upgrade premium-feature" style="opacity: 0.5;">
                <div class="premium-badge">PREMIUM</div>
                <h4>🏆 Títulos y Badges</h4>
                <p>Desbloquea títulos exclusivos y badges únicos</p>
                <button onclick="showPremiumRequired('Títulos y badges')" disabled>🎖️ Ver Colección</button>
            </div>
            <div class="upgrade">
                <h4>🌟 Desbloquear Premium 🌟</h4>
                <p>Accede a todas las características premium:</p>
                <ul style="font-size: 11px; margin: 10px 0;">
                    <li>🎨 Skins exclusivas y efectos especiales</li>
                    <li>✨ Partículas premium y resplandores</li>
                    <li>🎯 Personalización completa de colores</li>
                    <li>📊 Estadísticas detalladas y avanzadas</li>
                    <li>🚀 Multiplicadores y bonificadores únicos</li>
                    <li>🎪 Eventos especiales y contenido exclusivo</li>
                </ul>
                <div
                    style="background: linear-gradient(45deg, gold, orange); padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">
                    <div style="color: black; font-weight: bold;">Precio: 5000 coins</div>
                    <div style="color: black; font-size: 10px;">Progreso: <span id="premiumProgress">0</span>/<span
                            id="premiumCost">5000</span></div>
                </div>
                <button id="buyPremiumBtn" onclick="buyPremium()"
                    style="background: gold; color: black; font-weight: bold;">Comprar Premium</button>
            </div>
        </div>

        <div id="generators" class="tabcontent">
            <h3>🏭 Generadores Automáticos</h3>
            <div class="upgrade">
                <h4>Generador de Coins Nivel 1</h4>
                <p>Genera 10 coins/seg</p>
                <p>Costo: 1000 coins</p>
                <button onclick="buyGenerator('coin1')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Generador de Coins Nivel 2</h4>
                <p>Genera 100 coins/seg</p>
                <p>Costo: 25000 coins</p>
                <button onclick="buyGenerator('coin2')">Comprar</button>
            </div>
            <div class="upgrade">
                <h4>Generador de Diamantes</h4>
                <p>Genera 1 diamante/min</p>
                <p>Costo: 100000 coins</p>
                <button onclick="buyGenerator('diamond1')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Generador de Experiencia</h4>
                <p>Genera 50 exp/seg</p>
                <p>Costo: 50 💎</p>
                <button onclick="buyGenerator('exp1')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Generador Universal</h4>
                <p>Genera TODO automáticamente</p>
                <p>Costo: 500 💎</p>
                <button onclick="buyGenerator('universal')">Comprar</button>
            </div>
            <div class="upgrade premium-feature legendary-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Generador Cuántico</h4>
                <p>Genera recursos basado en experiencia</p>
                <p>Costo: 1000 💎</p>
                <button onclick="buyGenerator('quantum')">Comprar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Reactor de Fusión</h4>
                <p>Convierte experiencia en diamantes</p>
                <p>Costo: 2000 💎</p>
                <button onclick="buyGenerator('fusion')">Comprar</button>
            </div>
            <div class="upgrade premium-feature mythic-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Acelerador Temporal</h4>
                <p>Acelera el juego basado en experiencia</p>
                <p>Costo: 5000 💎</p>
                <button onclick="buyGenerator('temporal')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Multiplicador de Rebotes</h4>
                <p>Cada rebote cuenta como múltiples</p>
                <p>Costo: 10000 coins</p>
                <button onclick="buyGenerator('bounceMulti')">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Generador de Niveles</h4>
                <p>Sube de nivel automáticamente</p>
                <p>Costo: 1500 💎</p>
                <button onclick="buyGenerator('levelGen')">Comprar</button>
            </div>
            <div class="upgrade premium-feature legendary-upgrade">
                <div class="premium-badge">PREMIUM</div>
                <h4>Recolector de Orbes</h4>
                <p>Recoge orbes automáticamente</p>
                <p>Costo: 3000 💎</p>
                <button onclick="buyGenerator('orbCollector')">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Auto-Clicker Nivel 1</h4>
                <p>Clicks automáticos cada 5 segundos</p>
                <p>Costo: 100 💎</p>
                <button onclick="buyAutoClicker(1)">Comprar</button>
            </div>
            <div class="upgrade legendary-upgrade">
                <h4>Auto-Clicker Nivel 2</h4>
                <p>Clicks automáticos cada 2 segundos</p>
                <p>Costo: 300 💎</p>
                <button onclick="buyAutoClicker(2)">Comprar</button>
            </div>
            <div class="upgrade mythic-upgrade">
                <h4>Auto-Clicker Supremo</h4>
                <p>Clicks automáticos cada segundo</p>
                <p>Costo: 1000 💎</p>
                <button onclick="buyAutoClicker(3)">Comprar</button>
            </div>
        </div>

        <div id="collection" class="tabcontent">
            <h3>🃏 Cartas Coleccionables</h3>
            <div id="cardsList">
                <div class="upgrade">
                    <h4>Carta de Velocidad</h4>
                    <p>+10% velocidad - Común</p><button onclick="buyCard('speed')">25 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Carta de Fortuna</h4>
                    <p>+25% coins - Rara</p><button onclick="buyCard('coins')">25 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Carta Crítica</h4>
                    <p>+5% crítico - Épica</p><button onclick="buyCard('critical')">50 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Carta de Sabiduría</h4>
                    <p>+30% experiencia - Rara</p><button onclick="buyCard('experience')">35 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Carta de Combo</h4>
                    <p>+2 duración combo - Épica</p><button onclick="buyCard('combo')">60 💎</button>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Carta de Gemas</h4>
                    <p>+15% diamantes - Legendaria</p><button onclick="buyCard('diamond')">100 💎</button>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Carta de Poder</h4>
                    <p>+50% puntos prestigio - Legendaria</p><button onclick="buyCard('prestige')">150 💎</button>
                </div>
                <div class="upgrade mythic-upgrade">
                    <h4>Carta Suprema</h4>
                    <p>x2 a TODO - Mítica</p><button onclick="buyCard('ultimate')">500 💎</button>
                </div>
            </div>
            <h3>🐾 Mascotas</h3>
            <div id="petsList">
                <div class="upgrade">
                    <h4>Gato Cósmico</h4>
                    <p>+15% experiencia</p><button onclick="buyPet('cat')">50 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Dragón Dorado</h4>
                    <p>+30% coins</p><button onclick="buyPet('dragon')">200 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Fénix de Fuego</h4>
                    <p>+20% velocidad</p><button onclick="buyPet('phoenix')">150 💎</button>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Unicornio Mágico</h4>
                    <p>+25% diamantes</p><button onclick="buyPet('unicorn')">300 💎</button>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Kraken Abismal</h4>
                    <p>+40% combo</p><button onclick="buyPet('kraken')">400 💎</button>
                </div>
                <div class="upgrade mythic-upgrade">
                    <h4>Ser Celestial</h4>
                    <p>+100% todo por 1min cada hora</p><button onclick="buyPet('celestial')">1000 💎</button>
                </div>
                <div class="upgrade premium-feature legendary-upgrade">
                    <div class="premium-badge">PREMIUM</div>
                    <h4>Robot Recolector</h4>
                    <p>Recoge orbes automáticamente</p><button onclick="buyPet('robot')">2000 💎</button>
                </div>
                <div class="upgrade premium-feature mythic-upgrade">
                    <div class="premium-badge">PREMIUM</div>
                    <h4>Dragón Ancestral</h4>
                    <p>x5 a todas las ganancias</p><button onclick="buyPet('ancientDragon')">5000 💎</button>
                </div>
            </div>
            <h3>⚡ Artefactos</h3>
            <div id="artifactsList">
                <div class="upgrade">
                    <h4>Orbe del Tiempo</h4>
                    <p>Ralentiza el tiempo 10%</p><button onclick="buyArtifact('orb')">100 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Anillo de Poder</h4>
                    <p>x3 puntos de prestigio</p><button onclick="buyArtifact('ring')">250 💎</button>
                </div>
                <div class="upgrade">
                    <h4>Amuleto de la Suerte</h4>
                    <p>+50% críticos</p><button onclick="buyArtifact('amulet')">300 💎</button>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Corona Infinita</h4>
                    <p>Niveles infinitos</p><button onclick="buyArtifact('crown')">500 💎</button>
                </div>
                <div class="upgrade legendary-upgrade">
                    <h4>Bastón Arcano</h4>
                    <p>Auto-prestigio cada 10min</p><button onclick="buyArtifact('staff')">800 💎</button>
                </div>
                <div class="upgrade mythic-upgrade">
                    <h4>Reliquia Ancestral</h4>
                    <p>Genera recursos offline</p><button onclick="buyArtifact('relic')">1200 💎</button>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback">
        <h3>📝 Feedback Beta 2</h3>
        <p>Ayuda a mejorar el juego reportando bugs o sugerencias:</p>
        <div style="margin: 10px 0;">
            <label>Tipo de feedback:</label>
            <select id="feedbackType"
                style="width: 100%; padding: 5px; margin: 5px 0; background: #333; color: white; border: 1px solid #555;">
                <option value="bug">Bug/Error</option>
                <option value="balance">Balance del juego</option>
                <option value="feature">Nueva característica</option>
                <option value="ui">Interfaz/Diseño</option>
                <option value="mobile">Problema móvil</option>
                <option value="other">Otro</option>
            </select>
        </div>
        <textarea id="feedbackText" placeholder="Describe tu feedback aquí..."
            style="width: 100%; height: 100px; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #555; background: #333; color: white; resize: vertical;"></textarea>
        <div style="margin: 10px 0;">
            <button onclick="submitFeedback()">🚀 Enviar Feedback</button>
            <button onclick="closeFeedback()">Cerrar</button>
        </div>
        <div style="font-size: 11px; opacity: 0.7; margin-top: 10px;">
            <p>🚀 <strong>Cómo funciona:</strong></p>
            <p>1. Escribe tu feedback y haz clic en "Enviar"</p>
            <p>2. Elige: GitHub Issue (recomendado) o copiar al portapapeles</p>
            <p>3. Si eliges portapapeles, envíamelo por Discord/email</p>
            <p>Versión: 1.0 | Build: <span id="buildNumber">2024.12</span></p>
        </div>
    </div>

    <!-- Music Panel -->
    <div id="musicPanel">
        <h3>🎵 Panel de Música</h3>

        <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="musicMode" onchange="toggleMusicMode()">
                <span>Activar Efectos Reactivos</span>
            </label>
        </div>

        <div style="padding: 15px; background: rgba(0,0,0,0.8); border-radius: 10px; border: 1px solid #4CAF50;">
            <input type="file" id="musicFile" accept="audio/*" style="width: 100%; margin-bottom: 10px; padding: 5px;">

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="playPauseBtn">▶️ Play</button>
                <button id="stopBtn">⏹️ Stop</button>
            </div>

            <div style="margin-bottom: 10px;">
                <label style="color: #aaa; font-size: 12px;">Sensibilidad:</label>
                <input type="range" id="musicSensitivity" min="0.5" max="2" step="0.1" value="1" style="width: 100%;">
            </div>

            <div style="margin-bottom: 10px;">
                <label style="color: #aaa; font-size: 12px;">Tema Visual:</label>
                <select id="musicTheme"
                    style="width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #555;">
                    <option value="disco">🕺 Disco</option>
                    <option value="rock">🎸 Rock</option>
                    <option value="electronic">🎛️ Electronic</option>
                    <option value="chill">😌 Chill</option>
                </select>
            </div>

            <div style="margin-bottom: 10px;">
                <label style="color: #aaa; font-size: 12px;">Modo BPM:</label>
                <select id="bpmMode" onchange="toggleBpmMode()"
                    style="width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #555;">
                    <option value="auto">🤖 Automático</option>
                    <option value="manual">✋ Manual</option>
                </select>
            </div>

            <div style="margin-bottom: 10px;">
                <label style="color: #aaa; font-size: 12px;">BPM Manual:</label>
                <input type="number" id="manualBpm" min="60" max="200" value="120" disabled
                    style="width: 100%; padding: 5px; background: #333; color: white; border: 1px solid #555;">
            </div>

            <div style="margin-bottom: 10px;">
                <div id="musicProgress" style="width: 100%; height: 4px; background: #333; border-radius: 2px; position: relative;">
                    <div id="musicProgressBar" style="height: 100%; background: #4CAF50; border-radius: 2px; width: 0%; transition: width 0.1s;"></div>
                </div>
                <div id="musicTime" style="color: #4CAF50; font-size: 10px; text-align: center; margin-top: 5px;">0:00 / 0:00</div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 9px;">
                <span style="color: #4CAF50;">🎵 <span id="musicBPM">-- BPM</span></span>
                <span style="color: #FF6B35;">🔊 <span id="musicIntensity">--</span>%</span>
                <span style="color: #FFD700;">🎯 <span id="musicBeatMultiplier">x1.0</span></span>
            </div>
            
            <div id="musicInfo" style="font-size: 10px; color: #666; text-align: center;">
                Carga un archivo de audio para comenzar
            </div>
        </div>

        <button onclick="closeMusicPanel()" style="margin-top: 15px;">Cerrar</button>
    </div>

    <div id="codes">
        <h3>🎁 Códigos Especiales</h3>
        <p>Ingresa códigos para obtener recompensas:</p>
        <input type="text" id="codeInput" placeholder="Ingresa tu código aquí..."
            style="width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #555; background: #333; color: white;">
        <div style="margin: 10px 0;">
            <button onclick="redeemCode()">Canjear Código</button>
            <button onclick="closeCodes()">Cerrar</button>
        </div>
        <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
            <h4>Códigos Activos:</h4>
            <p>• WELCOME2 - Pack de bienvenida beta</p>
            <p>• BETA2024 - 1K coins + 5 diamantes</p>
            <p>• FENIX2024 - 500 coins + 3 diamantes</p>
            <p>• BETATEST2 - 2K coins + 10 diamantes</p>
            <p>• FEEDBACK - Orbe mítico + 1K coins</p>
            <p>• GITHUB - 5 diamantes + boost combo</p>
            <p>• ORBES - 300 coins + orbe raro</p>
            <p>• SPEED - Velocidad x1.5 por 1 min</p>
            <p>• COMBO - Combo x2 por 30 seg</p>
        </div>
    </div>

    <div id="importExport">
        <h3>Importar/Exportar Datos</h3>
        <p>Copia tu código de guardado:</p>
        <textarea id="saveData" placeholder="Pega aquí tu código de guardado..."></textarea>
        <div style="margin-top: 10px;">
            <button onclick="exportSave()">Exportar</button>
            <button onclick="importSave()">Importar</button>
            <button onclick="downloadSave()">Descargar</button>
            <button onclick="togglePanel('importExport')">Cerrar</button>
        </div>
    </div>

    <script>
        function showNotification(message) {
            // Sistema de notificaciones deshabilitado
        }

        let gameData = {
            coins: 0,
            diamonds: 0,
            experience: 0,
            bounces: 0,
            level: 1,
            prestige: 0,
            prestigePoints: 0,
            ascension: 0,
            ascensionPoints: 0,
            achievements: [],
            cards: [],
            pets: [],
            artifacts: [],
            events: { current: null, timeLeft: 0 },
            dailyChallenges: [],
            leaderboard: { rank: 0, score: 0 },
            season: 1,
            infiniteLevels: false,
            lastSave: Date.now(),
            lastDailyReset: Date.now(),
            saveCount: 0,
            upgrades: {
                coinMult: { level: 0, baseCost: 100, multiplier: 1.3, maxLevel: 200 },
                speed: { level: 0, baseCost: 150, multiplier: 1.35, maxLevel: 150 },
                size: { level: 0, baseCost: 200, multiplier: 1.4, maxLevel: 100 },
                combo: { level: 0, baseCost: 250, multiplier: 1.45, maxLevel: 75 },
                critical: { level: 0, baseCost: 300, multiplier: 1.5, maxLevel: 50 },
                diamondGen: { level: 0, baseCost: 500, multiplier: 1.6, maxLevel: 30 },
                expMult: { level: 0, baseCost: 10, multiplier: 2.5, currency: 'diamonds', maxLevel: 100 },
                auto: { level: 0, baseCost: 25, multiplier: 3.0, currency: 'diamonds', maxLevel: 10 },
                timeAsc: { level: 0, baseCost: 100, multiplier: 5.0, currency: 'diamonds', maxLevel: 5 },
                dimension: { level: 0, baseCost: 200, multiplier: 10.0, currency: 'diamonds', maxLevel: 3 },
                omnipotence: { level: 0, baseCost: 1000, multiplier: 50.0, currency: 'diamonds', maxLevel: 2 },
                infinite: { level: 0, baseCost: 5000, multiplier: 100.0, currency: 'diamonds', maxLevel: 1 }
            },
            research: {
                unlocked: [],
                available: ['efficiency1', 'automation1']
            }
        };

        let canvas, ctx, width, height;
        let coins = 0, diamonds = 0, experience = 0, bounces = 0, level = 1; // coins=ingredientes, diamonds=especias, bounces=platos
        let combo = 1, gamePaused = false;
        let streak = 0, streakMultiplier = 1, lastBounceTime = 0;
        let ball = { x: 0, y: 0, radius: 20, dx: 5, dy: 5, color: '#ff6b35', baseSpeed: 5, sizzleEffect: false, maxSpeed: 25 }; // ball=sartén
        let particles = [];
        let orbs = [];
        let orbTypes = [
            { id: 'speed', name: 'Ingrediente Rápido', color: '#00ff00', effect: 'speed', power: 1.3, duration: 4000, rarity: 'común' },
            { id: 'coins', name: 'Ingrediente Dorado', color: '#ffd700', effect: 'coins', power: 1.5, duration: 6000, rarity: 'común' },
            { id: 'diamonds', name: 'Especia Rara', color: '#ff69b4', effect: 'diamonds', power: 2, duration: 5000, rarity: 'raro' },
            { id: 'combo', name: 'Ingrediente Combo', color: '#ff4500', effect: 'combo', power: 1.5, duration: 8000, rarity: 'raro' },
            { id: 'critical', name: 'Ingrediente Perfecto', color: '#dc143c', effect: 'critical', power: 2.5, duration: 7000, rarity: 'épico' },
            { id: 'experience', name: 'Ingrediente Sabio', color: '#9370db', effect: 'experience', power: 3, duration: 9000, rarity: 'épico' },
            { id: 'time', name: 'Ingrediente Temporal', color: '#00ffff', effect: 'time', power: 0.7, duration: 12000, rarity: 'legendario' },
            { id: 'rainbow', name: 'Ingrediente Arcoíris', color: '#ffffff', effect: 'rainbow', power: 5, duration: 15000, rarity: 'mítico' },
            { id: 'truffle', name: 'Trufa Negra', color: '#2c1810', effect: 'truffle', power: 10, duration: 20000, rarity: 'legendario' },
            { id: 'saffron', name: 'Azafrán Dorado', color: '#f4c430', effect: 'saffron', power: 3, duration: 12000, rarity: 'épico' },
            { id: 'wasabi', name: 'Wasabi Picante', color: '#7cb342', effect: 'wasabi', power: 2, duration: 8000, rarity: 'raro' }
        ];
        let activeOrbEffects = [];

        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            resize();
            window.addEventListener('resize', resize);

            ball.x = width / 2;
            ball.y = height / 2;

            ball.dx = ball.baseSpeed;
            ball.dy = ball.baseSpeed;

            loadGame();
            setupEventListeners();
            setupMusicEventListeners(); // Añadir listeners de música
            applyDeviceOptimizations();

            if (gameData.upgrades.speed && gameData.upgrades.speed.level > 0) {
                applyUpgradeEffects('speed');
            }
            
            // Aplicar bonificadores de prestigio
            applyPrestigeBonuses();

            lastFrameTime = performance.now();
            lastFPSUpdate = performance.now();

            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                initPremiumSystem();
                gameLoop();
            }, 2000);
        }

        function applyDeviceOptimizations() {
            if (isMobile || isLowEndDevice) {
                // Optimizaciones móvil/dispositivos lentos
                targetFPS = 30;
                fpsInterval = 1000 / targetFPS;
                document.getElementById('particleCountSlider').value = 5;
                document.getElementById('targetFPS').value = '30';
                document.getElementById('graphicsQuality').value = 'low';
                performanceMode = true;
                batterySaverMode = true;

                // Reducir efectos visuales
                if (document.getElementById('performanceMode')) {
                    document.getElementById('performanceMode').checked = true;
                }
                if (document.getElementById('batterySaver')) {
                    document.getElementById('batterySaver').checked = true;
                }

                console.log('Optimizaciones móvil aplicadas');
            } else {
                // Optimizaciones PC
                targetFPS = 60;
                fpsInterval = 1000 / targetFPS;
                document.getElementById('particleCountSlider').value = 20;
                document.getElementById('targetFPS').value = '60';
                document.getElementById('graphicsQuality').value = 'medium';

                console.log('Optimizaciones PC aplicadas');
            }
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        function setupEventListeners() {
            document.getElementById('shopBtn').onclick = () => togglePanel('shop');
            document.getElementById('pauseBtn').onclick = togglePause;
            document.getElementById('importExportBtn').onclick = () => togglePanel('importExport');
            document.getElementById('prestigeBtn').onclick = doPrestige;
            document.getElementById('configBtn').onclick = () => togglePanel('config');
            document.getElementById('statsBtn').onclick = () => { togglePanel('stats'); updateStats(); };
            document.getElementById('missionsBtn').onclick = () => { togglePanel('missions'); updateMissions(); };
            document.getElementById('achievementsBtn').onclick = () => {
                togglePanel('achievements');
                // updateAchievementsDisplay(); // Fixed: function will be added
                // updateEventsDisplay(); // Fixed: function will be added 
            };
            document.getElementById('dailyChallengesBtn').onclick = () => { togglePanel('dailyChallenges'); updateDailyChallengesDisplay(); updateResetTimer(); };
            document.getElementById('codesBtn').onclick = () => togglePanel('codes');
            document.getElementById('feedbackBtn').onclick = () => togglePanel('feedback');
            document.getElementById('musicBtn').onclick = () => togglePanel('musicPanel');

            // Detectar actividad del usuario para sistema anti-AFK
            document.addEventListener('mousemove', resetAfkTimer);
            document.addEventListener('keypress', resetAfkTimer);
            document.addEventListener('click', resetAfkTimer);
            document.addEventListener('scroll', resetAfkTimer);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            document.addEventListener('touchstart', resetAfkTimer);
            document.addEventListener('touchmove', resetAfkTimer);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('focus', handleWindowFocus);
        }

        let targetFPS = 60;
        let fpsInterval = 1000 / targetFPS;
        let then = performance.now();

        function gameLoop() {
            try {
                requestAnimationFrame(gameLoop);

                const now = performance.now();
                const elapsed = now - then;

                // Control de FPS real
                if (elapsed > fpsInterval) {
                    then = now - (elapsed % fpsInterval);

                    // Calcular FPS real
                    frameCount++;
                    if (now - lastFPSUpdate >= 1000) {
                        currentFPS = Math.round(frameCount * 1000 / (now - lastFPSUpdate));
                        frameCount = 0;
                        lastFPSUpdate = now;

                        // Actualizar display de FPS
                        const fpsDisplay = document.getElementById('fpsDisplay');
                        if (fpsDisplay) {
                            fpsDisplay.textContent = `FPS: ${currentFPS} / ${targetFPS}`;
                        }

                        // Actualizar stats panel
                        const fpsCounter = document.getElementById('fpsCounter');
                        if (fpsCounter) {
                            fpsCounter.textContent = currentFPS;
                        }
                    }

                    // Optimización automática
                    if (elapsed > 33 && !batterySaverMode && particles.length > 20) {
                        particles.splice(0, Math.floor(particles.length * 0.3));
                    }

                    if (!gamePaused) {
                        update();
                        updateMusicEffects();
                        render();
                    }
                }
            } catch (error) {
                console.error('Error in game loop:', error);
                // Continue game loop even if there's an error
                requestAnimationFrame(gameLoop);
            }
        }

        function updateFPSTarget() {
            const newTargetFPS = parseInt(document.getElementById('targetFPS')?.value || 60);
            if (newTargetFPS !== targetFPS) {
                targetFPS = newTargetFPS;
                fpsInterval = 1000 / targetFPS;
                console.log(`FPS objetivo cambiado a: ${targetFPS}`);
            }
        }

        function update() {
            try {
                // Resource management - limit objects
                if (orbs.length > GAME_CONFIG.MAX_ORBS) {
                    const removed = orbs.splice(0, orbs.length - GAME_CONFIG.MAX_ORBS);
                    removed.forEach(returnOrbToPool);
                }
                if (particles.length > GAME_CONFIG.MAX_PARTICLES) {
                    const removed = particles.splice(0, particles.length - GAME_CONFIG.MAX_PARTICLES);
                    removed.forEach(returnParticleToPool);
                }

                // Aplicar límite de velocidad
                const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                if (currentSpeed > ball.maxSpeed) {
                    const ratio = ball.maxSpeed / currentSpeed;
                    ball.dx *= ratio;
                    ball.dy *= ratio;
                }

                ball.x += ball.dx * gameSpeed;
                ball.y += ball.dy * gameSpeed;

            if (ball.x <= ball.radius) {
                ball.x = ball.radius + 1;
                ball.dx = Math.abs(ball.dx);
                handleBounce();
            }
            if (ball.x >= width - ball.radius) {
                ball.x = width - ball.radius - 1;
                ball.dx = -Math.abs(ball.dx);
                handleBounce();
            }
            if (ball.y <= ball.radius) {
                ball.y = ball.radius + 1;
                ball.dy = Math.abs(ball.dy);
                handleBounce();
            }
            if (ball.y >= height - ball.radius) {
                ball.y = height - ball.radius - 1;
                ball.dy = -Math.abs(ball.dy);
                handleBounce();
            }

            updateParticles();
            updateOrbs();
            checkOrbCollisions();
            updateOrbEffects();
            updateAfkSystem();
            updateDailyChallenges();
            } catch (error) {
                console.error('Error in update function:', error);
            }
        }

        function render() {
            // Optimizar clear según dispositivo
            if (isMobile || performanceMode) {
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = 'rgba(34, 34, 34, 0.1)';
                ctx.fillRect(0, 0, width, height);
            } else {
                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, width, height);
            }

            // Dibujar ondas de fondo musicales
            if (musicMode && backgroundWaves.length > 0) {
                backgroundWaves.forEach(wave => {
                    ctx.globalAlpha = wave.life / 1000;
                    ctx.strokeStyle = wave.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(wave.x, wave.y, wave.radius, 0, Math.PI * 2);
                    ctx.stroke();
                });
                ctx.globalAlpha = 1;
            }

            // Dibujar estela musical
            if (musicMode && musicTrail.length > 0) {
                musicTrail.forEach(trail => {
                    ctx.globalAlpha = trail.life / trail.maxLife * 0.6;
                    ctx.fillStyle = trail.color;
                    ctx.beginPath();
                    ctx.arc(trail.x, trail.y, trail.size * (trail.life / trail.maxLife), 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;
            }

            // Dibujar orbes (mejorado para orbes musicales)
            orbs.forEach(orb => {
                ctx.globalAlpha = orb.alpha;

                // Efecto especial para orbes musicales
                if (orb.musical) {
                    const pulseSize = orb.radius + Math.sin(orb.pulsePhase * 3) * 5;
                    ctx.beginPath();
                    ctx.arc(orb.x, orb.y, pulseSize, 0, Math.PI * 2);

                    const gradient = ctx.createRadialGradient(orb.x, orb.y, 0, orb.x, orb.y, pulseSize);
                    gradient.addColorStop(0, orb.type.color);
                    gradient.addColorStop(0.5, orb.type.color + (orb.type.color.startsWith('#') ? '80' : ''));
                    gradient.addColorStop(1, orb.type.color + (orb.type.color.startsWith('#') ? '00' : ''));

                    ctx.fillStyle = gradient;
                    ctx.fill();
                } else {
                    // Orbes normales
                    ctx.beginPath();
                    ctx.arc(orb.x, orb.y, orb.radius, 0, Math.PI * 2);

                    const glowSize = orb.type.rarity === 'mítico' ? 30 : orb.type.rarity === 'legendario' ? 20 : 15;
                    const gradient = ctx.createRadialGradient(orb.x, orb.y, 0, orb.x, orb.y, glowSize);
                    gradient.addColorStop(0, orb.type.color);
                    gradient.addColorStop(0.7, orb.type.color.startsWith('#') ? orb.type.color + '80' : 'rgba(255,255,255,0.5)');
                    gradient.addColorStop(1, orb.type.color.startsWith('#') ? orb.type.color + '00' : 'rgba(255,255,255,0)');

                    ctx.fillStyle = gradient;
                    ctx.fill();
                }

                // Núcleo del orbe
                ctx.beginPath();
                ctx.arc(orb.x, orb.y, orb.radius * 0.6, 0, Math.PI * 2);
                ctx.fillStyle = orb.type.color;
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Dibujar bola con efectos musicales
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);

            // Gradiente musical si está activo
            if (musicMode && audioSource && !audioSource.paused) {
                const ballGradient = ctx.createRadialGradient(ball.x, ball.y, 0, ball.x, ball.y, ball.radius);
                ballGradient.addColorStop(0, ball.color);
                if (ball.color.startsWith('#')) {
                    ballGradient.addColorStop(0.7, ball.color + 'CC');
                    ballGradient.addColorStop(1, ball.color + '66');
                } else if (ball.color.startsWith('hsl')) {
                    ballGradient.addColorStop(0.7, ball.color.replace(')', ', 0.8)').replace('hsl', 'hsla'));
                    ballGradient.addColorStop(1, ball.color.replace(')', ', 0.4)').replace('hsl', 'hsla'));
                } else {
                    ballGradient.addColorStop(0.7, 'rgba(255,107,53,0.8)');
                    ballGradient.addColorStop(1, 'rgba(255,107,53,0.4)');
                }
                ctx.fillStyle = ballGradient;
            } else {
                ctx.fillStyle = ball.color;
            }
            ctx.fill();

            // Aura de efectos activos
            if (activeOrbEffects.length > 0) {
                const auraGradient = ctx.createRadialGradient(ball.x, ball.y, ball.radius, ball.x, ball.y, ball.radius * 2);
                const effectColor = activeOrbEffects[0].color;
                if (effectColor.startsWith('#')) {
                    auraGradient.addColorStop(0, effectColor + '40');
                    auraGradient.addColorStop(1, effectColor + '00');
                } else {
                    auraGradient.addColorStop(0, 'rgba(255,107,53,0.25)');
                    auraGradient.addColorStop(1, 'rgba(255,107,53,0)');
                }
                ctx.fillStyle = auraGradient;
                ctx.fill();
            }

            // Dibujar partículas optimizado
            if (particles.length > 0) {
                const step = isMobile ? 2 : 1;
                for (let i = 0; i < particles.length; i += step) {
                    const p = particles[i];
                    if (!p || p.x < -10 || p.x > width + 10 || p.y < -10 || p.y > height + 10) continue;

                    ctx.globalAlpha = p.alpha;
                    ctx.fillStyle = p.color;

                    if (p.musical && !isMobile) {
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size || 3, 0, Math.PI * 2);
                        ctx.fill();
                        if (!performanceMode) {
                            ctx.shadowColor = p.color;
                            ctx.shadowBlur = 10;
                            ctx.fill();
                            ctx.shadowBlur = 0;
                        }
                    } else {
                        ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
                    }
                }
                ctx.globalAlpha = 1;
            }
        }

        function handleBounce() {
            bounces++;
            gameData.bounces = bounces;

            let baseCoins = 1 + Math.floor(level / 5);
            let coinMultiplier = Math.pow(1.08, gameData.upgrades.coinMult.level);
            let comboMultiplier = Math.min(combo * (1 + gameData.upgrades.combo.level * 0.05), 15);
            let prestigeMultiplier = (1 + gameData.prestige * 0.05);

            let criticalMultiplier = 1;
            if (Math.random() < Math.min(gameData.upgrades.critical.level * 0.02, 0.25)) {
                criticalMultiplier = 3;
                if (currentDailyChallenge && currentDailyChallenge.id === 'critical') {
                    if (!currentDailyChallenge.criticalHits) currentDailyChallenge.criticalHits = 0;
                    currentDailyChallenge.criticalHits++;
                }
            }

            let coinsGained = Math.floor(baseCoins * coinMultiplier * comboMultiplier * prestigeMultiplier * criticalMultiplier * 0.8);
            const effects = applyCollectionEffects();
            coinsGained = Math.floor(coinsGained * effects.coinMultiplier * streakMultiplier);
            
            // Aplicar bonificadores de prestigio
            if (gameData.prestigeBonuses?.coins) {
                coinsGained = Math.floor(coinsGained * gameData.prestigeBonuses.coins);
            }
            if (gameData.prestigeBonuses?.megaMultiplier) {
                coinsGained = Math.floor(coinsGained * gameData.prestigeBonuses.megaMultiplier);
            }


            if (currentEvent && currentEvent.effect === 'coins') {
                coinsGained *= 3;
            }


            if (gameData.research.unlocked.includes('efficiency1')) coinsGained = Math.floor(coinsGained * 1.25);
            if (gameData.research.unlocked.includes('efficiency2')) coinsGained = Math.floor(coinsGained * 1.5);
            if (gameData.research.unlocked.includes('cosmic')) coinsGained = Math.floor(coinsGained * 5);

            let expGained = Math.floor(coinsGained / 5);

            // Aplicar eventos especiales
            if (currentEvent) {
                switch (currentEvent.effect) {
                    case 'coins': coinsGained *= 3; break;
                    case 'speed': ball.dx *= 1.5; ball.dy *= 1.5; break;
                    case 'critical': criticalMultiplier = 2; break;
                    case 'magic': diamonds += 10; break;
                    case 'cosmic': coinsGained *= 10; expGained *= 10; break;
                }
            }

            // Aplicar eventos por fecha
            if (dateEvent) {
                switch (dateEvent.type) {
                    case 'coins': coinsGained *= dateEvent.multiplier; break;
                    case 'all': coinsGained *= dateEvent.multiplier; expGained *= dateEvent.multiplier; break;
                    case 'experience': expGained *= dateEvent.multiplier; break;
                    case 'combo': combo = Math.min(combo + 0.1, 20); break;
                }
            }

            // Mejoras legendarias y míticas
            if (gameData.upgrades.dimension && gameData.upgrades.dimension.level > 0) coinsGained *= Math.pow(2, gameData.upgrades.dimension.level);
            if (gameData.upgrades.omnipotence && gameData.upgrades.omnipotence.level > 0) coinsGained *= Math.pow(10, gameData.upgrades.omnipotence.level);
            if (gameData.upgrades.infinite && gameData.upgrades.infinite.level > 0) coinsGained *= Math.pow(100, gameData.upgrades.infinite.level);

            // Aplicar multiplicador musical
            if (musicMode && musicBeatMultiplier > 1) {
                coinsGained = Math.floor(coinsGained * musicBeatMultiplier);

                // Bonus por combo musical
                if (musicComboStreak > 10) {
                    coinsGained = Math.floor(coinsGained * (1 + musicComboStreak * 0.01));
                    showNotification(`🎵 Combo Musical x${musicComboStreak}!`);
                }
            }

            coins += coinsGained;
            gameData.coins = coins;
            if (gameData.upgrades.expMult && gameData.upgrades.expMult.level > 0) expGained *= Math.pow(2.5, gameData.upgrades.expMult.level);
            expGained = Math.floor(expGained * effects.expMultiplier);
            experience += expGained;
            gameData.experience = experience;

            let diamondChance = 0.008 + gameData.upgrades.diamondGen.level * 0.003;
            if (currentEvent && currentEvent.effect === 'diamonds') diamondChance *= 2;
            if (dateEvent && dateEvent.type === 'diamonds') diamondChance *= dateEvent.multiplier;

            if (Math.random() < diamondChance) {
                let diamondsGained = Math.floor(Math.random() * 3) + 1;
                if (currentEvent && currentEvent.effect === 'diamonds') diamondsGained = Math.floor(diamondsGained * 2);
                diamonds += diamondsGained;
                gameData.diamonds = diamonds;
            }


            if (bounces >= level * 100 + Math.pow(level, 1.2) * 25) {
                level++;
                gameData.level = level;
                saveGame(); // Guardar al subir de nivel

                if (level % 10 === 0 && Date.now() - notificationCooldown.level > 5000) {
                    showNotification(`👨‍🍳 ¡Chef Nivel ${level}!`);
                    notificationCooldown.level = Date.now();
                }
            }

            let comboDecay = 0.01 - (gameData.upgrades.combo.level * 0.008);
            if (currentEvent && currentEvent.effect === 'combo') comboDecay = 0;
            // Sistema de rachas
            const now = Date.now();
            if (now - lastBounceTime < 500) {
                streak++;
                streakMultiplier = 1 + (streak * 0.02);
            } else {
                streak = 0;
                streakMultiplier = 1;
            }
            lastBounceTime = now;

            combo = Math.max(1, combo - comboDecay);
            combo = Math.min(combo + 0.15, 15 + gameData.upgrades.combo.level);

            createParticles(ball.x, ball.y);
            // Efectos visuales mejorados
            ball.sizzleEffect = true;
            setTimeout(() => ball.sizzleEffect = false, 200);

            // Vibración en móvil
            if (navigator.vibrate && streak > 5) {
                navigator.vibrate(50);
            }

            // Efecto de pantalla al hacer combo alto
            if (combo > 10) {
                document.body.style.filter = `hue-rotate(${combo * 10}deg)`;
                setTimeout(() => document.body.style.filter = '', 100);
            }
            updateUI();
        }

        function createParticles(x, y) {
            let count = document.getElementById('particleCountSlider') ? parseInt(document.getElementById('particleCountSlider').value) : 10;

            // Reducir partículas en dispositivos lentos
            if (isMobile || isLowEndDevice || batterySaverMode) {
                count = Math.min(count, 5);
            }

            // Skip si hay demasiadas partículas
            if (particles.length > GAME_CONFIG.MAX_PARTICLES) return;

            for (let i = 0; i < count; i++) {
                let particle = getPooledParticle();
                
                Object.assign(particle, {
                    x: x, y: y,
                    dx: (Math.random() - 0.5) * 10,
                    dy: (Math.random() - 0.5) * 10,
                    life: isMobile ? 500 : GAME_CONFIG.PARTICLE_LIFETIME,
                    maxLife: isMobile ? 500 : GAME_CONFIG.PARTICLE_LIFETIME,
                    alpha: 1, color: '#4CAF50'
                });

                particles.push(particle);
            }

            if (currentDailyChallenge && currentDailyChallenge.id === 'particles') {
                if (!currentDailyChallenge.particlesGenerated) currentDailyChallenge.particlesGenerated = 0;
                currentDailyChallenge.particlesGenerated += count;
            }
        }

        function updateParticles() {
            const maxParticles = isMobile ? 15 : (batterySaverMode ? 20 : (performanceMode ? 50 : GAME_CONFIG.MAX_PARTICLES));
            if (particles.length > maxParticles) {
                const removed = particles.splice(0, particles.length - maxParticles);
                removed.forEach(returnParticleToPool);
            }

            const step = isMobile ? 2 : 1; // Skip frames en móvil
            for (let i = particles.length - 1; i >= 0; i -= step) {
                const particle = particles[i];
                if (!particle) continue;

                particle.x += particle.dx;
                particle.y += particle.dy;
                particle.life -= 16;
                particle.alpha = particle.life / particle.maxLife;

                if (particle.life <= 0) {
                    returnParticleToPool(particles.splice(i, 1)[0]);
                }
            }
        }

        function updateUI() {
            document.getElementById('coins').textContent = formatNumber(coins);
            document.getElementById('diamonds').textContent = formatNumber(diamonds);
            document.getElementById('experience').textContent = formatNumber(experience);
            document.getElementById('bounces').textContent = formatNumber(bounces);
            document.getElementById('level').textContent = gameData.infiniteLevels ? level + '∞' : level;
            document.getElementById('prestige').textContent = gameData.prestige;
            document.getElementById('combo').textContent = combo.toFixed(1) + 'x';
            document.getElementById('prestigePoints').textContent = gameData.prestigePoints;
            
            // Actualizar displays de prestigio
            const prestigeCountEl = document.getElementById('prestigeCount');
            const prestigeBonusEl = document.getElementById('prestigeBonus');
            if (prestigeCountEl) prestigeCountEl.textContent = gameData.prestige;
            if (prestigeBonusEl) prestigeBonusEl.textContent = (gameData.prestige * 10).toFixed(1);
            if (document.getElementById('ascensionPoints')) document.getElementById('ascensionPoints').textContent = gameData.ascensionPoints;
            if (document.getElementById('ascensionPointsDisplay')) document.getElementById('ascensionPointsDisplay').textContent = gameData.ascensionPoints;
            if (document.getElementById('achievementCount')) document.getElementById('achievementCount').textContent = (gameData.achievements || []).length;
            if (document.getElementById('cardCount')) document.getElementById('cardCount').textContent = (gameData.cards || []).length;
            if (document.getElementById('reputation')) document.getElementById('reputation').textContent = restaurantData.reputation;
            if (document.getElementById('customerCount')) document.getElementById('customerCount').textContent = restaurantData.customers.length;

            // Actualizar contador de orbes
            if (document.getElementById('orbCount')) {
                document.getElementById('orbCount').textContent = orbs.length;
            }

            // Actualizar efectos de orbes activos
            const orbEffectsDisplay = document.getElementById('activeOrbEffectsDisplay');
            if (orbEffectsDisplay) {
                if (activeOrbEffects.length > 0) {
                    const effectsText = activeOrbEffects.map(effect =>
                        `🔮 ${effect.name.split(' ')[1] || effect.type}: ${Math.ceil(effect.timeLeft / 1000)}s`
                    ).join('<br>');
                    orbEffectsDisplay.innerHTML = effectsText;
                } else {
                    orbEffectsDisplay.innerHTML = '';
                }
            }

            // Actualizar displays del HUD
            if (document.getElementById('eventStatus')) {
                const eventText = dateEvent ? dateEvent.name : (currentEvent ? currentEvent.name : 'Ninguno');
                document.getElementById('eventStatus').textContent = eventText;
            }

            if (document.getElementById('afkTimer')) {
                const afkMinutes = Math.floor(afkTime / 60);
                const afkSeconds = afkTime % 60;
                document.getElementById('afkTimer').textContent = afkMinutes > 0 ? `${afkMinutes}m${afkSeconds}s` : `${afkSeconds}s`;
            }

            if (document.getElementById('streakDisplay')) {
                document.getElementById('streakDisplay').textContent = streak > 0 ? `${streak}x` : '0x';
            }

            updateShopUI();
            checkAchievements();
        }

        function updateShopUI() {
            Object.keys(gameData.upgrades).forEach(upgradeId => {
                const upgrade = gameData.upgrades[upgradeId];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.multiplier, upgrade.level));

                const levelElement = document.getElementById(upgradeId + 'Level');
                const costElement = document.getElementById(upgradeId + 'Cost');

                if (levelElement) levelElement.textContent = `(Nivel ${upgrade.level})`;
                if (costElement) {
                    costElement.textContent = formatNumber(cost);
                    const currency = upgrade.currency || 'coins';
                    const currentAmount = currency === 'coins' ? coins : (currency === 'diamonds' ? diamonds : experience);
                    costElement.style.color = currentAmount >= cost ? '#4CAF50' : '#ff4444';
                }
            });
            
            // Actualizar botones de prestigio
            const prestigeButtons = {
                coinBonus: { cost: 1, owned: gameData.prestigeUpgrades?.includes('coinBonus') },
                expBonus: { cost: 2, owned: gameData.prestigeUpgrades?.includes('expBonus') },
                diamondBonus: { cost: 3, owned: gameData.prestigeUpgrades?.includes('diamondBonus') },
                startBonus: { cost: 5, owned: gameData.prestigeUpgrades?.includes('startBonus') },
                autoCollect: { cost: 8, owned: gameData.prestigeUpgrades?.includes('autoCollect') },
                megaBonus: { cost: 15, owned: gameData.prestigeUpgrades?.includes('megaBonus') }
            };
            
            Object.entries(prestigeButtons).forEach(([id, data]) => {
                const button = document.querySelector(`button[onclick="buyPrestigeUpgrade('${id}')"]`);
                if (button) {
                    if (data.owned) {
                        button.textContent = '✅ Comprado';
                        button.disabled = true;
                        button.style.opacity = '0.6';
                    } else {
                        button.textContent = 'Comprar';
                        button.disabled = gameData.prestigePoints < data.cost;
                        button.style.opacity = gameData.prestigePoints >= data.cost ? '1' : '0.6';
                    }
                }
            });
        }

        function formatNumber(num) {
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return Math.floor(num).toString();
        }

        function buyUpgrade(upgradeId) {
            const upgrade = gameData.upgrades[upgradeId];
            if (!upgrade || upgrade.level >= upgrade.maxLevel) return;

            const currency = upgrade.currency || 'coins';
            const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.multiplier, upgrade.level));

            let currentAmount = currency === 'coins' ? coins : (currency === 'diamonds' ? diamonds : experience);

            if (currentAmount >= cost && cost > 0) {
                if (currency === 'coins') {
                    coins = Math.max(0, coins - cost);
                    gameData.coins = coins;
                } else if (currency === 'diamonds') {
                    diamonds = Math.max(0, diamonds - cost);
                    gameData.diamonds = diamonds;
                } else {
                    experience = Math.max(0, experience - cost);
                    gameData.experience = experience;
                }
                upgrade.level = Math.min(upgrade.level + 1, upgrade.maxLevel);
                if (missions.upgrades) missions.upgrades.progress++;

                applyUpgradeEffects(upgradeId);
                updateUI();
                saveGame(); // Guardar inmediatamente después de comprar mejora
            }
        }

        function applyUpgradeEffects(upgradeId) {
            switch (upgradeId) {
                case 'speed':
                    // Recalcular velocidad base con mejoras
                    const speedIncrease = gameData.upgrades.speed.level * 0.5;
                    const newSpeed = Math.min(ball.baseSpeed + speedIncrease, ball.maxSpeed);

                    // Mantener la dirección actual
                    const directionX = ball.dx > 0 ? 1 : -1;
                    const directionY = ball.dy > 0 ? 1 : -1;

                    ball.dx = newSpeed * directionX;
                    ball.dy = newSpeed * directionY;
                    break;
                case 'size':
                    ball.radius = 20 + gameData.upgrades.size.level * 2;
                    break;
                case 'auto':
                    if (gameData.upgrades.auto.level === 1) {
                        setInterval(() => {
                            if (!gamePaused) {
                                handleBounce();
                            }
                        }, 2000 - (gameData.upgrades.auto.level * 200));
                    }
                    break;
                case 'timeAsc':
                    if (gameData.upgrades.timeAsc.level > 0) {
                        ball.dx *= 0.9;
                        ball.dy *= 0.9;
                    }
                    break;
            }
        }

        function doPrestige() {
            const confirmPrestige = document.getElementById('confirmPrestige')?.checked ?? true;

            if (level >= 25 && coins >= 500000) {
                if (confirmPrestige && !confirm('¿Estás seguro de que quieres prestigiar? Perderás todo tu progreso actual pero ganarás bonificadores permanentes.')) {
                    return;
                }

                let prestigePointsGained = Math.floor(Math.log10(coins / 100000) + Math.sqrt(level / 10) + 3);
                
                // Bonificadores por logros
                if (gameData.achievements && gameData.achievements.includes('prestige1')) prestigePointsGained += 2;
                if (gameData.achievements && gameData.achievements.includes('level100')) prestigePointsGained += 3;
                if (combo > 10) prestigePointsGained += Math.floor(combo / 5);

                // Resetear progreso básico
                coins = 0;
                bounces = 0;
                level = 1;
                experience = 0;
                combo = 1;
                orbs = [];
                activeOrbEffects = [];
                particles = [];

                gameData.coins = 0;
                gameData.bounces = 0;
                gameData.level = 1;
                gameData.experience = 0;

                // Resetear mejoras básicas
                ['coinMult', 'speed', 'size', 'combo', 'critical', 'diamondGen'].forEach(key => {
                    gameData.upgrades[key].level = 0;
                });

                // Mantener diamantes (50% se conservan)
                diamonds = Math.floor(diamonds * 0.5);
                gameData.diamonds = diamonds;

                // Aplicar prestigio
                gameData.prestigePoints += prestigePointsGained;
                gameData.prestige++;

                // Resetear pelota
                ball.radius = 20;
                ball.dx = ball.baseSpeed;
                ball.dy = ball.baseSpeed;
                ball.color = '#ff6b35';

                // Bonificadores de prestigio inmediatos
                const prestigeBonus = gameData.prestige * 0.1;
                showNotification(`⭐ ¡Prestigio ${gameData.prestige}! +${prestigePointsGained} puntos | Bonus: +${(prestigeBonus * 100).toFixed(1)}% coins`);
                
                // Generar nuevas misiones
                if (typeof generateMissions === 'function') generateMissions();
                
                updateUI();
                saveGame();
            } else {
                const missing = [];
                if (level < 25) missing.push(`Nivel ${25 - level} más`);
                if (coins < 500000) missing.push(`${formatNumber(500000 - coins)} coins más`);
                showNotification(`⚠️ Necesitas: ${missing.join(' y ')}`);
            }
        }

        function buyPrestigeUpgrade(upgradeId) {
            const upgrades = {
                coinBonus: { cost: 1, effect: 'Multiplicador permanente +10% coins' },
                expBonus: { cost: 2, effect: 'Multiplicador permanente +15% experiencia' },
                diamondBonus: { cost: 3, effect: 'Multiplicador permanente +20% diamantes' },
                startBonus: { cost: 5, effect: 'Empezar con 1000 coins y nivel 5' },
                autoCollect: { cost: 8, effect: 'Auto-recolectar orbes cada 10 segundos' },
                megaBonus: { cost: 15, effect: 'x2 a TODAS las ganancias permanentemente' }
            };
            
            const upgrade = upgrades[upgradeId];
            if (!upgrade) return;
            
            if (gameData.prestigePoints >= upgrade.cost) {
                gameData.prestigePoints -= upgrade.cost;
                
                // Aplicar mejora
                if (!gameData.prestigeUpgrades) gameData.prestigeUpgrades = [];
                if (!gameData.prestigeUpgrades.includes(upgradeId)) {
                    gameData.prestigeUpgrades.push(upgradeId);
                    
                    switch (upgradeId) {
                        case 'coinBonus':
                            gameData.prestigeBonuses = gameData.prestigeBonuses || {};
                            gameData.prestigeBonuses.coins = (gameData.prestigeBonuses.coins || 1) * 1.1;
                            break;
                        case 'expBonus':
                            gameData.prestigeBonuses = gameData.prestigeBonuses || {};
                            gameData.prestigeBonuses.experience = (gameData.prestigeBonuses.experience || 1) * 1.15;
                            break;
                        case 'diamondBonus':
                            gameData.prestigeBonuses = gameData.prestigeBonuses || {};
                            gameData.prestigeBonuses.diamonds = (gameData.prestigeBonuses.diamonds || 1) * 1.2;
                            break;
                        case 'startBonus':
                            gameData.prestigeBonuses = gameData.prestigeBonuses || {};
                            gameData.prestigeBonuses.startCoins = 1000;
                            gameData.prestigeBonuses.startLevel = 5;
                            break;
                        case 'autoCollect':
                            gameData.prestigeBonuses = gameData.prestigeBonuses || {};
                            gameData.prestigeBonuses.autoCollect = true;
                            startAutoCollect();
                            break;
                        case 'megaBonus':
                            gameData.prestigeBonuses = gameData.prestigeBonuses || {};
                            gameData.prestigeBonuses.megaMultiplier = 2;
                            break;
                    }
                    
                    showNotification(`⭐ ${upgrade.effect} comprado!`);
                } else {
                    showNotification('⚠️ Ya tienes esta mejora');
                    gameData.prestigePoints += upgrade.cost; // Devolver puntos
                }
                
                updateUI();
                saveGame();
            } else {
                showNotification(`⚠️ Necesitas ${upgrade.cost - gameData.prestigePoints} puntos más`);
            }
        }
        
        function startAutoCollect() {
            if (gameData.prestigeBonuses?.autoCollect) {
                setInterval(() => {
                    orbs.forEach((orb, index) => {
                        if (Math.random() < 0.1) {
                            collectOrb(orb);
                            orbs.splice(index, 1);
                        }
                    });
                }, 10000);
            }
        }
        
        function applyPrestigeBonuses() {
            if (!gameData.prestigeBonuses) return;
            
            // Aplicar bonificadores de inicio
            if (gameData.prestigeBonuses.startCoins && coins === 0 && level === 1) {
                coins = gameData.prestigeBonuses.startCoins;
                gameData.coins = coins;
            }
            if (gameData.prestigeBonuses.startLevel && level === 1) {
                level = gameData.prestigeBonuses.startLevel;
                gameData.level = level;
            }
            
            // Auto-collect si está activo
            if (gameData.prestigeBonuses.autoCollect && !window.autoCollectActive) {
                window.autoCollectActive = true;
                startAutoCollect();
            }
        }

        function buyResearch(researchId) {
            const costs = {
                efficiency1: 1000, efficiency2: 5000,
                automation1: 2500, automation2: 10000,
                cosmic: 50000, transcend: 1000000,
                quantum: 5000000, infinity: 50000000
            };

            if (experience >= costs[researchId] && !gameData.research.unlocked.includes(researchId)) {
                experience -= costs[researchId];
                gameData.experience = experience;
                gameData.research.unlocked.push(researchId);

                // Aplicar efectos de investigación
                if (researchId === 'quantum') {
                    showNotification('¡Mecánica Cuántica desbloqueada! +500% a todo');
                } else if (researchId === 'infinity') {
                    showNotification('¡Infinito desbloqueado! Límites removidos');
                }

                updateUI();
                saveGame(); // Guardar después de investigación
                showNotification(`¡Investigación ${researchId} completada!`);
            }
        }

        function buyGenerator(genId) {
            const generators = {
                coin1: { cost: 1000, currency: 'coins' },
                coin2: { cost: 25000, currency: 'coins' },
                diamond1: { cost: 100000, currency: 'coins' },
                exp1: { cost: 50, currency: 'diamonds' },
                universal: { cost: 500, currency: 'diamonds' },
                quantum: { cost: 1000, currency: 'diamonds', premium: true },
                fusion: { cost: 2000, currency: 'diamonds', premium: true },
                temporal: { cost: 5000, currency: 'diamonds', premium: true },
                bounceMulti: { cost: 10000, currency: 'coins' },
                levelGen: { cost: 1500, currency: 'diamonds' },
                orbCollector: { cost: 3000, currency: 'diamonds', premium: true }
            };

            const gen = generators[genId];
            if (!gen) return;

            if (gen.premium && !premiumUnlocked) {
                showPremiumShop();
                return;
            }

            const currentAmount = gen.currency === 'coins' ? coins : diamonds;
            if (currentAmount >= gen.cost && !gameData.generators?.includes(genId)) {
                if (gen.currency === 'coins') {
                    coins -= gen.cost;
                    gameData.coins = coins;
                } else {
                    diamonds -= gen.cost;
                    gameData.diamonds = diamonds;
                }

                if (!gameData.generators) gameData.generators = [];
                gameData.generators.push(genId);
                updateUI();
                showNotification(`🏭 Generador ${genId} comprado!`);
            }
        }

        function generateResources() {
            if (gameData.upgrades.diamondGen && gameData.upgrades.diamondGen.level > 0) {
                diamonds += gameData.upgrades.diamondGen.level * 0.1;
                gameData.diamonds = diamonds;
            }

            if (gameData.prestigePoints > 0) {
                diamonds += gameData.prestigePoints * 0.01;
                coins += gameData.prestigePoints * 10;
                gameData.diamonds = diamonds;
                gameData.coins = coins;
            }

            if (gameData.upgrades.auto && gameData.upgrades.auto.level > 0 && !gamePaused) {
                if (Math.random() < 0.05 * gameData.upgrades.auto.level) {
                    handleBounce();
                }
            }

            // Generadores automáticos
            if (gameData.generators) {
                if (gameData.generators.includes('coin1')) coins += 10;
                if (gameData.generators.includes('coin2')) coins += 100;
                if (gameData.generators.includes('exp1')) experience += 50;
                if (gameData.generators.includes('universal')) {
                    coins += 50; diamonds += 1; experience += 25;
                }
                if (gameData.generators.includes('quantum')) {
                    const expBonus = Math.floor(experience / 1000);
                    coins += expBonus; diamonds += Math.floor(expBonus / 100);
                }
                if (gameData.generators.includes('fusion')) {
                    if (experience >= 10000) {
                        experience -= 1000;
                        diamonds += 10;
                    }
                }
                if (gameData.generators.includes('temporal')) {
                    gameSpeed = 1 + (experience / 100000);
                }
                if (gameData.generators.includes('bounceMulti')) {
                    if (Math.random() < 0.1) handleBounce();
                }
                if (gameData.generators.includes('levelGen')) {
                    if (Math.random() < 0.01) {
                        level++;
                        gameData.level = level;
                    }
                }
                if (gameData.generators.includes('orbCollector')) {
                    orbs.forEach((orb, index) => {
                        if (Math.random() < 0.05) {
                            collectOrb(orb);
                            orbs.splice(index, 1);
                        }
                    });
                }
                gameData.coins = coins;
                gameData.experience = experience;
                gameData.diamonds = diamonds;
            }

            // Investigaciones pasivas mejoradas
            if (gameData.research.unlocked.includes('automation1')) {
                coins += Math.floor(level * 3); // Triple generación
                gameData.coins = coins;
            }
            if (gameData.research.unlocked.includes('automation2')) {
                coins += Math.floor(level * 6); // Triple generación
                diamonds += Math.floor(level / 5); // Doble generación de diamantes
                gameData.coins = coins;
                gameData.diamonds = diamonds;
            }

            updateUI();
        }

        function autoSave() {
            saveGame();
        }

        function saveGame() {
            gameData.coins = coins;
            gameData.diamonds = diamonds;
            gameData.experience = experience;
            gameData.bounces = bounces;
            gameData.level = level;
            gameData.lastSave = Date.now();
            gameData.saveCount = (gameData.saveCount || 0) + 1;

            const saveData = {
                coins, diamonds, experience, bounces, level,
                prestige: gameData.prestige, prestigePoints: gameData.prestigePoints,
                ascension: gameData.ascension, ascensionPoints: gameData.ascensionPoints,
                achievements: gameData.achievements, cards: gameData.cards, pets: gameData.pets,
                artifacts: gameData.artifacts, events: gameData.events, season: gameData.season,
                infiniteLevels: gameData.infiniteLevels, lastSave: gameData.lastSave,
                lastDailyReset: gameData.lastDailyReset, saveCount: gameData.saveCount,
                premiumUnlocked, selectedSkin, missionSet, completedMissions,
                totalBounces, totalCoins, bestCombo, missions,
                dailyChallenges, currentDailyChallenge, advancedMissions,
                upgrades: gameData.upgrades, research: gameData.research,
                timestamp: gameData.lastSave
            };
            localStorage.setItem('circleBounceUltimate', JSON.stringify(saveData));
            console.log('Juego guardado automáticamente');
        }

        function loadGame() {
            const saved = localStorage.getItem('circleBounceUltimate');
            if (saved) {
                try {
                    const data = JSON.parse(saved);

                    // Validaciones anti-exploit
                    coins = Math.max(0, Math.min(data.coins || 0, 1e15));
                    diamonds = Math.max(0, Math.min(data.diamonds || 0, 1e10));
                    experience = Math.max(0, Math.min(data.experience || 0, 1e12));
                    bounces = Math.max(0, Math.min(data.bounces || 0, 1e12));
                    level = Math.max(1, Math.min(data.level || 1, 10000));

                    gameData.prestige = Math.max(0, Math.min(data.prestige || 0, 1000));
                    gameData.prestigePoints = Math.max(0, Math.min(data.prestigePoints || 0, 10000));
                    gameData.ascension = Math.max(0, Math.min(data.ascension || 0, 100));
                    gameData.ascensionPoints = Math.max(0, Math.min(data.ascensionPoints || 0, 1000));
                    gameData.achievements = Array.isArray(data.achievements) ? data.achievements.slice(0, 50) : [];
                    gameData.cards = Array.isArray(data.cards) ? data.cards.slice(0, 20) : [];
                    gameData.pets = Array.isArray(data.pets) ? data.pets.slice(0, 20) : [];
                    gameData.artifacts = Array.isArray(data.artifacts) ? data.artifacts.slice(0, 20) : [];
                    gameData.events = data.events || { current: null, timeLeft: 0 };
                    gameData.season = Math.max(1, Math.min(data.season || 1, 100));
                    gameData.infiniteLevels = Boolean(data.infiniteLevels);
                    gameData.lastSave = data.lastSave || Date.now();
                    gameData.lastDailyReset = data.lastDailyReset || Date.now();
                    gameData.saveCount = Math.max(0, data.saveCount || 0);

                    premiumUnlocked = Boolean(data.premiumUnlocked);
                    gameData.premiumUnlocked = premiumUnlocked;
                    selectedSkin = data.selectedSkin || 'default';

                    // Aplicar skin guardada
                    if (selectedSkin) {
                        const colors = {
                            default: '#ff6b35',
                            fire: '#ff6600',
                            ice: '#00ccff',
                            rainbow: '#ff0000',
                            galaxy: '#9900ff',
                            cosmic: '#00ffff',
                            neon: '#ff0080',
                            diamond: '#b9f2ff'
                        };
                        ball.color = colors[selectedSkin] || '#ff6b35';
                    }

                    if (premiumUnlocked) {
                        setTimeout(() => {
                            document.querySelectorAll('.premium-feature').forEach(el => {
                                el.style.opacity = '1';
                                el.style.pointerEvents = 'auto';
                            });
                            document.querySelectorAll('.premium-feature input, .premium-feature select, .premium-feature button').forEach(el => el.disabled = false);
                        }, 100);
                    }
                    missionSet = Math.max(1, Math.min(data.missionSet || 1, 1000));
                    completedMissions = Math.max(0, Math.min(data.completedMissions || 0, 1000));
                    totalBounces = Math.max(0, Math.min(data.totalBounces || 0, 1e12));
                    totalCoins = Math.max(0, Math.min(data.totalCoins || 0, 1e15));
                    bestCombo = Math.max(1, Math.min(data.bestCombo || 1, 1000));

                    if (data.missions && typeof data.missions === 'object') missions = data.missions;
                    if (data.dailyChallenges && Array.isArray(data.dailyChallenges)) dailyChallenges = data.dailyChallenges;
                    if (data.currentDailyChallenge && typeof data.currentDailyChallenge === 'object') currentDailyChallenge = data.currentDailyChallenge;
                    if (data.advancedMissions && Array.isArray(data.advancedMissions)) advancedMissions = data.advancedMissions;
                    if (data.upgrades && typeof data.upgrades === 'object') gameData.upgrades = data.upgrades;
                    if (data.research && typeof data.research === 'object') gameData.research = data.research;

                    if (gameData.events.current) {
                        currentEvent = gameData.events.current;
                        eventTimeLeft = Math.max(0, gameData.events.timeLeft || 0);
                    }

                    // syncCollectionData(); // Fixed: function will be added
                    updateUI();
                    renderMissions();
                } catch (error) {
                    console.log('Error cargando datos');
                    showNotification('Error al cargar - datos corruptos');
                }
            }
        }

        function exportSave() {
            gameData.coins = coins;
            gameData.diamonds = diamonds;
            gameData.experience = experience;
            gameData.bounces = bounces;
            gameData.level = level;
            const saveString = btoa(JSON.stringify(gameData));
            document.getElementById('saveData').value = saveString;
        }

        function importSave() {
            try {
                const saveString = document.getElementById('saveData').value;
                const importedData = JSON.parse(atob(saveString));
                if (importedData.coins !== undefined) {
                    gameData = { ...gameData, ...importedData };
                    coins = gameData.coins || 0;
                    diamonds = gameData.diamonds || 0;
                    experience = gameData.experience || 0;
                    bounces = gameData.bounces || 0;
                    level = gameData.level || 1;
                    updateUI();
                    showNotification('¡Datos importados correctamente!');
                }
            } catch (error) {
                showNotification('Error al importar datos');
            }
        }

        function downloadSave() {
            exportSave();
            const saveString = document.getElementById('saveData').value;
            const blob = new Blob([saveString], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `circle_bounce_save_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();

            URL.revokeObjectURL(url);
        }



        function togglePause() {
            gamePaused = !gamePaused;
            document.getElementById('pauseBtn').textContent = gamePaused ? '▶️ Reanudar' : '⏸️ Pausa';
        }



        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName('tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }

            const tablinks = document.getElementsByClassName('tablinks');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active');
            }

            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }



        // Variables adicionales
        let premiumUnlocked = false;
        let soundEnabled = true;
        let performanceMode = false;
        let selectedSkin = 'default';
        let totalBounces = 0;
        let totalCoins = 0;
        let bestCombo = 1;
        let playTimeStart = Date.now();
        let missions = {
            bounces: { target: 100, progress: 0, reward: 150, completed: false },
            coins: { target: 1000, progress: 0, reward: 250, completed: false },
            diamonds: { target: 5, progress: 0, reward: 3, completed: false },
            level: { target: 8, progress: 0, reward: 400, completed: false },
            combo: { target: 8, progress: 0, reward: 200, completed: false },
            upgrades: { target: 5, progress: 0, reward: 600, completed: false }
        };
        let missionSet = 1;
        let completedMissions = 0;
        let gameSpeed = 1;
        let lightMode = false;
        let redeemedCodes = [];
        let achievements = [
            { id: 'first100', name: 'Primer Centenar', desc: 'Alcanza 100 rebotes', target: 100, type: 'bounces', unlocked: false, reward: 200 },
            { id: 'first1000', name: 'Mil Rebotes', desc: 'Alcanza 1000 rebotes', target: 1000, type: 'bounces', unlocked: false, reward: 800 },
            { id: 'first10k', name: 'Maestro Rebotador', desc: 'Alcanza 10K rebotes', target: 10000, type: 'bounces', unlocked: false, reward: 3000 },
            { id: 'millionaire', name: 'Millonario', desc: 'Consigue 1M coins', target: 1000000, type: 'coins', unlocked: false, reward: 500 },
            { id: 'billionaire', name: 'Billonario', desc: 'Consigue 1B coins', target: 1000000000, type: 'coins', unlocked: false, reward: 50000 },
            { id: 'diamond10', name: 'Coleccionista', desc: 'Obtén 10 diamantes', target: 10, type: 'diamonds', unlocked: false, reward: 2 },
            { id: 'diamond100', name: 'Cazador de Gemas', desc: 'Obtén 100 diamantes', target: 100, type: 'diamonds', unlocked: false, reward: 8 },
            { id: 'prestige1', name: 'Renacimiento', desc: 'Haz tu primer prestigio', target: 1, type: 'prestige', unlocked: false, reward: 2000 },
            { id: 'prestige10', name: 'Veterano', desc: 'Haz 10 prestigios', target: 10, type: 'prestige', unlocked: false, reward: 20000 },
            { id: 'level50', name: 'Medio Siglo', desc: 'Alcanza nivel 50', target: 50, type: 'level', unlocked: false, reward: 1500 },
            { id: 'level100', name: 'Centurión', desc: 'Alcanza nivel 100', target: 100, type: 'level', unlocked: false, reward: 4000 },
            { id: 'combo20', name: 'Combo Master', desc: 'Alcanza combo 20x', target: 20, type: 'combo', unlocked: false, reward: 8000 },
            { id: 'speed15', name: 'Velocista', desc: 'Alcanza velocidad 15+', target: 15, type: 'speed', unlocked: false, reward: 3000 },
            { id: 'size40', name: 'Gigante', desc: 'Tamaño de bola 40+', target: 40, type: 'size', unlocked: false, reward: 4000 },
            { id: 'ascension1', name: 'Ascendido', desc: 'Haz tu primera ascensión', target: 1, type: 'ascension', unlocked: false, reward: 100000 }
        ];
        let cards = [
            { id: 'speed', name: 'Carta de Velocidad', effect: '+10% velocidad', rarity: 'común', cost: 25, owned: false },
            { id: 'coins', name: 'Carta de Fortuna', effect: '+25% coins', rarity: 'rara', cost: 25, owned: false },
            { id: 'critical', name: 'Carta Crítica', effect: '+5% crítico', rarity: 'épica', cost: 50, owned: false },
            { id: 'experience', name: 'Carta de Sabiduría', effect: '+30% experiencia', rarity: 'rara', cost: 35, owned: false },
            { id: 'combo', name: 'Carta de Combo', effect: '+2 duración combo', rarity: 'épica', cost: 60, owned: false },
            { id: 'diamond', name: 'Carta de Gemas', effect: '+15% diamantes', rarity: 'legendaria', cost: 100, owned: false },
            { id: 'prestige', name: 'Carta de Poder', effect: '+50% puntos prestigio', rarity: 'legendaria', cost: 150, owned: false },
            { id: 'ultimate', name: 'Carta Suprema', effect: 'x2 a TODO', rarity: 'mítica', cost: 500, owned: false }
        ];
        let pets = [
            { id: 'cat', name: 'Gato Cósmico', effect: '+15% experiencia', cost: 50, owned: false },
            { id: 'dragon', name: 'Dragón Dorado', effect: '+30% coins', cost: 200, owned: false },
            { id: 'phoenix', name: 'Fénix de Fuego', effect: '+20% velocidad', cost: 150, owned: false },
            { id: 'unicorn', name: 'Unicornio Mágico', effect: '+25% diamantes', cost: 300, owned: false },
            { id: 'kraken', name: 'Kraken Abismal', effect: '+40% combo', cost: 400, owned: false },
            { id: 'celestial', name: 'Ser Celestial', effect: '+100% todo por 1min cada hora', cost: 1000, owned: false },
            { id: 'robot', name: 'Robot Recolector', effect: 'Recoge orbes automáticamente', cost: 2000, owned: false, premium: true },
            { id: 'ancientDragon', name: 'Dragón Ancestral', effect: 'x5 a todas las ganancias', cost: 5000, owned: false, premium: true }
        ];
        let artifacts = [
            { id: 'orb', name: 'Orbe del Tiempo', effect: 'Ralentiza el tiempo 10%', cost: 100, owned: false },
            { id: 'crown', name: 'Corona Infinita', effect: 'Niveles infinitos', cost: 500, owned: false },
            { id: 'ring', name: 'Anillo de Poder', effect: 'x3 puntos de prestigio', cost: 250, owned: false },
            { id: 'amulet', name: 'Amuleto de la Suerte', effect: '+50% críticos', cost: 300, owned: false },
            { id: 'staff', name: 'Bastón Arcano', effect: 'Auto-prestigio cada 10min', cost: 800, owned: false },
            { id: 'relic', name: 'Reliquia Ancestral', effect: 'Genera recursos offline', cost: 1200, owned: false }
        ];
        let currentEvent = null;
        let eventTimeLeft = 0;
        let dailyChallenges = [
            { id: 'bounces', name: 'Rebotador Experto', desc: 'Haz 500 rebotes', target: 500, progress: 0, reward: 800, type: 'coins', completed: false },
            { id: 'coins', name: 'Coleccionista Diario', desc: 'Gana 10K coins', target: 10000, progress: 0, reward: 3, type: 'diamonds', completed: false },
            { id: 'diamonds', name: 'Cazador de Gemas', desc: 'Consigue 8 diamantes', target: 8, progress: 0, reward: 1500, type: 'coins', completed: false },
            { id: 'combo', name: 'Combo Diario', desc: 'Alcanza combo 12x', target: 12, progress: 0, reward: 2, type: 'diamonds', completed: false },
            { id: 'levels', name: 'Subir de Nivel', desc: 'Sube 2 niveles', target: 2, progress: 0, reward: 2000, type: 'coins', completed: false },
            { id: 'speed', name: 'Velocidad Extrema', desc: 'Alcanza velocidad 15+', target: 15, progress: 0, reward: 4, type: 'diamonds', completed: false },
            { id: 'upgrades', name: 'Mejorador', desc: 'Compra 3 mejoras', target: 3, progress: 0, reward: 2500, type: 'coins', completed: false },
            { id: 'orbs', name: 'Recolector de Orbes', desc: 'Recoge 5 orbes', target: 5, progress: 0, reward: 6, type: 'diamonds', completed: false },
            { id: 'prestige', name: 'Prestigio Rápido', desc: 'Haz 1 prestigio', target: 1, progress: 0, reward: 15, type: 'diamonds', completed: false },
            { id: 'experience', name: 'Sabio', desc: 'Gana 20K experiencia', target: 20000, progress: 0, reward: 4000, type: 'coins', completed: false },
            { id: 'critical', name: 'Crítico Maestro', desc: 'Haz 50 críticos', target: 50, progress: 0, reward: 8, type: 'diamonds', completed: false },
            { id: 'particles', name: 'Lluvia de Partículas', desc: 'Genera 500 partículas', target: 500, progress: 0, reward: 3500, type: 'coins', completed: false }
        ];

        let advancedMissions = [
            { id: 'marathon', name: 'Maratón de Rebotes', desc: 'Haz 10K rebotes sin parar', target: 10000, progress: 0, reward: 25000, type: 'coins', completed: false, difficulty: 'hard' },
            { id: 'collector', name: 'Gran Coleccionista', desc: 'Obtén 500 diamantes', target: 500, progress: 0, reward: 100, type: 'diamonds', completed: false, difficulty: 'extreme' },
            { id: 'master', name: 'Maestro del Combo', desc: 'Mantén combo 50x por 1 minuto', target: 60, progress: 0, reward: 50000, type: 'coins', completed: false, difficulty: 'legendary' },
            { id: 'ascender', name: 'Camino a la Ascensión', desc: 'Alcanza 5 prestigios', target: 5, progress: 0, reward: 200, type: 'diamonds', completed: false, difficulty: 'mythic' },
            { id: 'speedster', name: 'Velocista Supremo', desc: 'Velocidad 50+ por 5 minutos', target: 300, progress: 0, reward: 75000, type: 'coins', completed: false, difficulty: 'extreme' },
            { id: 'giant', name: 'Bola Gigante', desc: 'Tamaño 100+ por 10 minutos', target: 600, progress: 0, reward: 150, type: 'diamonds', completed: false, difficulty: 'legendary' }
        ];
        let currentDailyChallenge = null;
        let afkTime = 0;
        let lastActivity = Date.now();
        let afkRewards = { coins: 0, diamonds: 0, experience: 0 };
        let leaderboardData = [];
        let playerRank = 0;
        let season = 1;
        let nightMode = false;
        let autoClicker = { active: false, level: 0 };
        let idleBonus = 1;
        let dateEvent = null;
        let betaStats = { sessionStart: Date.now(), orbsCollected: 0, codesRedeemed: 0, eventsTriggered: 0, crashes: 0 };
        let notificationCooldown = { level: 0, achievement: 0, event: 0 };

        let restaurantData = { reputation: 0, customers: [], menuSpecial: null };
        let frameSkip = 0;
        let frameCount = 0;
        let lastFrameTime = 0;
        let lastFPSUpdate = performance.now();
        let currentFPS = 60;

        let batterySaverMode = false;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let isLowEndDevice = navigator.hardwareConcurrency <= 2 || navigator.deviceMemory <= 2;
        let musicMode = false;
        let audioContext = null;
        let analyser = null;
        let audioSource = null;
        let frequencyData = null;
        let musicSensitivity = 1;
        let musicTheme = 'disco';
        let musicBPM = 0;
        let beatHistory = [];
        let lastBeatTime = 0;
        let bpmMode = 'auto';
        let manualBPM = 120;
        let musicBeatMultiplier = 1;
        let musicComboStreak = 0;
        let visualizerBars = [];
        let musicTrail = [];
        let backgroundWaves = [];
        let strobeEffect = false;
        let musicOrbSpawnRate = 0;

        // Funciones UI
        // Sistema unificado de paneles
        function togglePanel(panelId) {
            console.log('togglePanel called with:', panelId);
            const panel = document.getElementById(panelId);
            if (!panel) {
                console.error('Panel not found:', panelId);
                return;
            }

            const isVisible = panel.style.display === 'block';
            console.log('Panel visibility:', isVisible);

            // Cerrar todos los paneles
            ['shop', 'config', 'stats', 'missions', 'achievements', 'dailyChallenges', 'importExport', 'premiumShop', 'codes', 'feedback', 'musicPanel'].forEach(id => {
                const p = document.getElementById(id);
                if (p) p.style.display = 'none';
            });

            // Abrir el panel solicitado si no estaba visible
            if (!isVisible) {
                panel.style.display = 'block';
                console.log('Panel opened:', panelId);
            }
        }

        // Funciones de cierre individuales
        function closeConfig() { document.getElementById('config').style.display = 'none'; }
        function closeStats() { document.getElementById('stats').style.display = 'none'; }
        function closeMissions() { document.getElementById('missions').style.display = 'none'; }
        function closeAchievements() { document.getElementById('achievements').style.display = 'none'; }
        function closeDailyChallenges() { document.getElementById('dailyChallenges').style.display = 'none'; }
        function closeShop() { document.getElementById('shop').style.display = 'none'; }
        function closePremiumShop() { document.getElementById('premiumShop').style.display = 'none'; }
        function closeCodes() { document.getElementById('codes').style.display = 'none'; }
        function closeFeedback() { document.getElementById('feedback').style.display = 'none'; }
        function closeMusicPanel() { document.getElementById('musicPanel').style.display = 'none'; }

        function submitFeedback() {
            const type = document.getElementById('feedbackType').value;
            const text = document.getElementById('feedbackText').value;
            if (!text.trim()) {
                showNotification('⚠️ Escribe tu feedback primero');
                return;
            }

            const feedbackData = {
                type, text,
                version: 'Beta 2',
                timestamp: new Date().toISOString(),
                stats: betaStats,
                gameData: { level, coins, diamonds, prestige: gameData.prestige },
                userAgent: navigator.userAgent,
                url: window.location.href
            };

            // Formato simplificado pero informativo
            const issueTitle = `[${type.toUpperCase()}] ${text.substring(0, 40)}`;
            const issueBody = `**${text}**\n\nNivel: ${level} | Coins: ${formatNumber(coins)} | Diamantes: ${diamonds}\nOrbes: ${betaStats.orbsCollected} | Tiempo: ${Math.floor((Date.now() - betaStats.sessionStart) / 60000)}min\n\n*Datos técnicos completos disponibles en console.log del navegador*`;
            const githubUrl = `https://github.com/thisisfenix/FNCengine/issues/new?title=${encodeURIComponent(issueTitle)}&body=${encodeURIComponent(issueBody)}&labels=beta-feedback,${type}`;

            // Siempre guardar en console.log
            console.log('FEEDBACK BETA 2:', feedbackData);

            // Mostrar opciones al usuario
            if (confirm('¿Cómo quieres enviar tu feedback?\n\nOK = GitHub Issue\nCancelar = Copiar texto')) {
                window.open(githubUrl, '_blank');
            } else {
                // Copiar versión simplificada
                const shortText = `[${type.toUpperCase()}] ${text}\nNivel ${level}, ${formatNumber(coins)} coins, ${diamonds} diamantes\nOrbes: ${betaStats.orbsCollected}, Tiempo: ${Math.floor((Date.now() - betaStats.sessionStart) / 60000)}min\n\n(Datos técnicos en console.log)`;
                navigator.clipboard.writeText(shortText).then(() => {
                    showNotification('📋 Feedback copiado');
                }).catch(() => {
                    showNotification('📋 Ver consola (F12)');
                });
            }

            document.getElementById('feedbackText').value = '';
            closeFeedback();
        }

        // Función para tabs del panel unificado
        function openAchievementTab(evt, tabName) {
            const tabcontent = document.querySelectorAll('#achievements .tabcontent');
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = 'none';
            }

            const tablinks = document.querySelectorAll('#achievements .tablinks');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active');
            }

            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }

        function updateResetTimer() {
            const now = Date.now();
            const timeSinceReset = now - gameData.lastDailyReset;
            const timeLeft = 86400000 - timeSinceReset;

            const resetBtn = document.getElementById('resetDailyChallengesBtn');
            const newChallengeBtn = document.getElementById('newChallengeBtn');

            if (timeLeft > 0) {
                const hours = Math.floor(timeLeft / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);

                const timerEl = document.getElementById('resetTimer');
                if (timerEl) {
                    timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }

                if (resetBtn) resetBtn.style.display = 'none';
                if (newChallengeBtn) {
                    newChallengeBtn.disabled = true;
                    newChallengeBtn.style.opacity = '0.5';
                }
            } else {
                const timerEl = document.getElementById('resetTimer');
                if (timerEl) timerEl.textContent = '00:00:00';
                if (resetBtn) resetBtn.style.display = 'inline-block';
                if (newChallengeBtn) {
                    newChallengeBtn.disabled = false;
                    newChallengeBtn.style.opacity = '1';
                }
            }
        }

        function resetDailyChallenges() {
            gameData.lastDailyReset = Date.now();
            dailyChallenges.forEach(challenge => {
                challenge.completed = false;
                challenge.progress = 0;
                challenge.claimed = false;
            });
            currentDailyChallenge = null;
            updateDailyChallengesDisplay();
            showNotification('🔄 ¡Desafíos diarios reseteados!');
            document.getElementById('resetDailyChallengesBtn').style.display = 'none';
        }

        let controlsVisible = true;
        let uiVisible = true;

        function toggleControlsVisibility() {
            const controls = document.getElementById('controls');
            const toggleBtn = document.getElementById('toggleControls');

            controlsVisible = !controlsVisible;

            // Añadir animación de rotación
            toggleBtn.style.transform = 'rotate(180deg)';
            setTimeout(() => toggleBtn.style.transform = '', 300);

            if (controlsVisible) {
                controls.classList.remove('hidden');
                toggleBtn.textContent = '▲';
            } else {
                controls.classList.add('hidden');
                toggleBtn.textContent = '▼';
            }
        }

        function toggleUIVisibility() {
            const ui = document.getElementById('ui');
            const currencyDisplay = document.getElementById('currency-display');
            const toggleBtn = document.getElementById('toggleUI');

            uiVisible = !uiVisible;

            if (uiVisible) {
                ui.style.display = 'flex';
                currencyDisplay.style.display = 'block';
                toggleBtn.textContent = '◀';
            } else {
                ui.style.display = 'none';
                currencyDisplay.style.display = 'none';
                toggleBtn.textContent = '▶';
            }
        }




        function showPremiumShop() { togglePanel('premiumShop'); }

        function toggleTheme() {
            lightMode = !lightMode;
            const root = document.documentElement;
            if (lightMode) {
                root.style.setProperty('--glass', 'rgba(0, 0, 0, 0.1)');
                root.style.setProperty('--glass-border', 'rgba(0, 0, 0, 0.2)');
                document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)';
                if (canvas) canvas.style.background = 'radial-gradient(circle at center, rgba(200, 200, 200, 0.3) 0%, rgba(150, 150, 150, 0.5) 100%)';
                document.getElementById('themeToggle').textContent = 'Modo Oscuro';
            } else {
                root.style.setProperty('--glass', 'rgba(255, 255, 255, 0.1)');
                root.style.setProperty('--glass-border', 'rgba(255, 255, 255, 0.2)');
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                if (canvas) canvas.style.background = 'radial-gradient(circle at center, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.3) 100%)';
                document.getElementById('themeToggle').textContent = 'Modo Claro';
            }
        }

        function updateVolumeValue() {
            const value = document.getElementById('volumeSlider').value;
            document.getElementById('volumeValue').textContent = value + '%';
        }

        function resetSettings() {
            if (confirm('¿Restaurar toda la configuración a valores por defecto?')) {
                localStorage.removeItem('gameConfig');
                location.reload();
            }
        }

        function exportSettings() {
            const config = localStorage.getItem('gameConfig') || '{}';
            const blob = new Blob([config], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fnc_config.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('📤 Configuración exportada');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const config = JSON.parse(e.target.result);
                            localStorage.setItem('gameConfig', JSON.stringify(config));
                            loadConfig();
                            showNotification('📥 Configuración importada');
                        } catch (error) {
                            showNotification('⚠️ Error al importar configuración');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function updateSpeedValue() {
            const value = document.getElementById('gameSpeedSlider').value;
            document.getElementById('speedValue').textContent = parseFloat(value).toFixed(1) + 'x';
        }

        function updateParticleValue() {
            const value = document.getElementById('particleCountSlider').value;
            document.getElementById('particleValue').textContent = value;
        }

        function updateUIScale() {
            const value = document.getElementById('uiScale').value;
            document.getElementById('uiScaleValue').textContent = Math.round(value * 100) + '%';
        }

        function toggleMusicMode() {
            musicMode = document.getElementById('musicMode').checked;

            if (musicMode) {
                showNotification('🎵 Efectos reactivos activados');
            } else {
                showNotification('🎵 Efectos reactivos desactivados');
                resetMusicEffects();
            }
        }

        function resetMusicEffects() {
            if (canvas) {
                canvas.style.transform = 'scale(1)';
                canvas.style.filter = '';
            }

            const ui = document.getElementById('ui');
            const currency = document.getElementById('currency-display');
            const controls = document.getElementById('controls');

            [ui, currency, controls].forEach(el => {
                if (el) {
                    el.style.background = '';
                    el.style.borderColor = '';
                    el.style.boxShadow = '';
                }
            });
        }

        function setupMusicEventListeners() {
            setTimeout(() => {
                const sensitivitySlider = document.getElementById('musicSensitivity');
                const themeSelect = document.getElementById('musicTheme');
                const manualBpmInput = document.getElementById('manualBpm');
                const bpmModeSelect = document.getElementById('bpmMode');
                const musicFileInput = document.getElementById('musicFile');
                const playPauseBtn = document.getElementById('playPauseBtn');
                const stopBtn = document.getElementById('stopBtn');

                if (sensitivitySlider) {
                    sensitivitySlider.addEventListener('input', (e) => {
                        musicSensitivity = parseFloat(e.target.value);
                    });
                }

                if (themeSelect) {
                    themeSelect.addEventListener('change', (e) => {
                        musicTheme = e.target.value;
                        applyMusicTheme();
                    });
                }

                if (manualBpmInput) {
                    manualBpmInput.addEventListener('input', (e) => {
                        if (bpmMode === 'manual') {
                            manualBPM = parseInt(e.target.value) || 120;
                            musicBPM = manualBPM;
                            document.getElementById('musicBPM').textContent = manualBPM + ' BPM (Manual)';
                            adaptSensitivityToBPM();
                        }
                    });
                }

                if (bpmModeSelect) {
                    bpmModeSelect.addEventListener('change', toggleBpmMode);
                }

                if (musicFileInput) {
                    musicFileInput.addEventListener('change', (e) => {
                        if (e.target.files[0]) {
                            loadMusicFile(e.target.files[0]);
                        }
                    });
                }
                
                if (playPauseBtn) {
                    playPauseBtn.addEventListener('click', toggleMusic);
                }
                
                if (stopBtn) {
                    stopBtn.addEventListener('click', stopMusic);
                }
            }, 100);
        }

        function toggleBpmMode() {
            const bpmModeSelect = document.getElementById('bpmMode');
            const manualInput = document.getElementById('manualBpm');
            
            if (!bpmModeSelect || !manualInput) return;
            
            bpmMode = bpmModeSelect.value;

            if (bpmMode === 'manual') {
                manualInput.disabled = false;
                manualInput.style.opacity = '1';
                manualBPM = parseInt(manualInput.value) || 120;
                musicBPM = manualBPM;
                
                // Limpiar historial de beats automático
                beatHistory = [];
                
                document.getElementById('musicBPM').textContent = manualBPM + ' BPM (Manual)';
                adaptSensitivityToBPM();
            } else {
                manualInput.disabled = true;
                manualInput.style.opacity = '0.5';
                
                // Resetear para detección automática
                beatHistory = [];
                musicBPM = 120; // BPM por defecto
                
                document.getElementById('musicBPM').textContent = musicBPM + ' BPM (Auto)';
                resetSensitivity();
            }
        }

        function adaptSensitivityToBPM() {
            if (bpmMode === 'manual' && manualBPM) {
                // Curva de sensibilidad más suave para BPM altos
                let adaptedSensitivity;

                if (manualBPM < 80) {
                    adaptedSensitivity = 1.6; // Muy lento
                } else if (manualBPM < 100) {
                    adaptedSensitivity = 1.3; // Lento
                } else if (manualBPM < 130) {
                    adaptedSensitivity = 1.0; // Normal
                } else if (manualBPM < 160) {
                    adaptedSensitivity = 0.8; // Rápido
                } else {
                    adaptedSensitivity = 0.6; // Muy rápido (168 BPM)
                }

                musicSensitivity = adaptedSensitivity;
                document.getElementById('musicSensitivity').value = adaptedSensitivity;

                // Multiplicador más equilibrado
                const bpmMultiplier = Math.max(0.6, Math.min(1.8, manualBPM / 120));
                musicBeatMultiplier = 1 + (bpmMultiplier * 0.3);
            }
        }

        function resetSensitivity() {
            musicSensitivity = 1.0;
            document.getElementById('musicSensitivity').value = 1.0;
            musicBeatMultiplier = 1.0;
        }

        function applyMusicTheme() {
            const themes = {
                disco: { hueShift: 0, saturation: 1.5, brightness: 1.2 },
                rock: { hueShift: 30, saturation: 1.8, brightness: 0.9 },
                electronic: { hueShift: 180, saturation: 2.0, brightness: 1.4 },
                chill: { hueShift: 240, saturation: 0.8, brightness: 0.7 }
            };

            const theme = themes[musicTheme] || themes.disco;
            document.documentElement.style.setProperty('--music-hue-shift', theme.hueShift);
            document.documentElement.style.setProperty('--music-saturation', theme.saturation);
            document.documentElement.style.setProperty('--music-brightness', theme.brightness);
        }

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512; // Mayor resolución
                analyser.smoothingTimeConstant = 0.8;
                frequencyData = new Uint8Array(analyser.frequencyBinCount);
                initMusicVisualizer();
            }
        }

        function initMusicVisualizer() {
            const visualizer = document.getElementById('musicVisualizer');
            visualizer.innerHTML = '';
            visualizerBars = [];

            for (let i = 0; i < 32; i++) {
                const bar = document.createElement('div');
                bar.style.cssText = `
                    width: 3px;
                    background: linear-gradient(to top, #FF6B35, #4CAF50, #FFD700);
                    border-radius: 1px;
                    height: 2px;
                    transition: height 0.1s ease;
                `;
                visualizer.appendChild(bar);
                visualizerBars.push(bar);
            }
        }

        function toggleMusic() {
            const fileInput = document.getElementById('musicFile');
            const playBtn = document.getElementById('playPauseBtn');

            if (!fileInput.files[0]) {
                showNotification('⚠️ Selecciona un archivo de música primero');
                return;
            }

            if (audioSource && !audioSource.paused) {
                audioSource.pause();
                playBtn.textContent = '▶️ Play';
            } else {
                playMusic(fileInput.files[0]);
                playBtn.textContent = '⏸️ Pause';
            }
        }

        function playMusic(file) {
            loadMusicFile(file);
            
            if (!audioContext) {
                try {
                    initAudioContext();
                } catch (error) {
                    console.warn('Error inicializando AudioContext:', error);
                    showNotification('⚠️ Audio no disponible - Activando MODO FIESTA 🎉');
                    activatePartyMode();
                    return;
                }
            }
            
            audioSource.addEventListener('canplay', () => {
                try {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    const source = audioContext.createMediaElementSource(audioSource);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                    audioSource.play();
                } catch (error) {
                    console.warn('Error conectando audio:', error);
                    // Reproducir sin análisis si falla la conexión
                    audioSource.play().catch(() => {
                        showNotification('❌ Error reproduciendo - Activando MODO FIESTA 🎉');
                        activatePartyMode();
                    });
                }
            }, { once: true });
        }

        function updateMusicProgress() {
            if (!audioSource || !audioSource.duration || isNaN(audioSource.duration)) return;
            
            const current = audioSource.currentTime || 0;
            const duration = audioSource.duration || 0;
            const progress = duration > 0 ? (current / duration) * 100 : 0;
            
            const progressBar = document.getElementById('musicProgressBar');
            if (progressBar) progressBar.style.width = progress + '%';
            
            const currentMin = Math.floor(current / 60);
            const currentSec = Math.floor(current % 60);
            const totalMin = Math.floor(duration / 60);
            const totalSec = Math.floor(duration % 60);
            
            const timeEl = document.getElementById('musicTime');
            if (timeEl && duration > 0) {
                timeEl.textContent = `${currentMin}:${currentSec.toString().padStart(2, '0')} / ${totalMin}:${totalSec.toString().padStart(2, '0')}`;
            }
        }

        function stopMusic() {
            if (audioSource) {
                audioSource.pause();
                audioSource.currentTime = 0;
                document.getElementById('playPauseBtn').textContent = '▶️';
                URL.revokeObjectURL(audioSource.src);
            }
            resetMusicEffects();
        }

        function updateMusicEffects() {
            if (!musicMode || !analyser || !audioSource || audioSource.paused) {
                resetMusicEffects();
                return;
            }

            analyser.getByteFrequencyData(frequencyData);

            // Análisis avanzado de frecuencias
            const bass = frequencyData.slice(0, 32).reduce((sum, v) => sum + v, 0) / 32 / 255;
            const mid = frequencyData.slice(32, 128).reduce((sum, v) => sum + v, 0) / 96 / 255;
            const high = frequencyData.slice(128, 256).reduce((sum, v) => sum + v, 0) / 128 / 255;
            const average = (bass + mid + high) / 3;
            const intensity = average * musicSensitivity;

            // Actualizar visualizador
            updateVisualizer();

            // Detectar BPM y beats
            detectBeatAndBPM(intensity);

            // Efectos de zoom y rotación épicos
            const isBeat = intensity > 0.6;
            if (isBeat) {
                // Zoom explosivo
                const zoomIntensity = 1 + (intensity * 0.15);
                canvas.style.transform = `scale(${zoomIntensity}) rotate(${intensity * 2}deg)`;
                canvas.style.transition = 'transform 0.08s ease-out';

                // Efecto estroboscópico
                if (musicTheme === 'electronic' && intensity > 0.8) {
                    document.body.style.filter = `brightness(${1 + intensity}) contrast(${1 + intensity * 0.5})`;
                    setTimeout(() => document.body.style.filter = '', 50);
                }

                // Reset suave
                setTimeout(() => {
                    canvas.style.transform = 'scale(1) rotate(0deg)';
                    canvas.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                }, 120);

                // Multiplicador de beat
                musicBeatMultiplier = 1 + (intensity * 0.5);
                musicComboStreak++;
            } else {
                musicBeatMultiplier = Math.max(1, musicBeatMultiplier * 0.98);
                if (intensity < 0.2) musicComboStreak = Math.max(0, musicComboStreak - 1);
            }

            // HUD reactiva con temas
            updateMusicHUD(bass, mid, high, intensity);

            // Pelota con estela musical
            updateMusicBall(bass, mid, high, intensity);

            // Partículas explosivas
            if (isBeat) {
                createMusicParticles(intensity, bass, mid, high);
            }

            // Ondas de fondo
            updateBackgroundWaves(intensity);

            // Orbes musicales especiales
            if (Math.random() < intensity * 0.02) {
                spawnMusicOrb(intensity);
            }

            // Velocidad adaptativa
            gameSpeed = 1 + (intensity * 0.4 * musicSensitivity);

            // Actualizar displays
            document.getElementById('musicIntensity').textContent = Math.round(intensity * 100);
            document.getElementById('musicBeatMultiplier').textContent = 'x' + musicBeatMultiplier.toFixed(1);
        }

        function updateVisualizer() {
            visualizerBars.forEach((bar, i) => {
                const dataIndex = Math.floor(i * frequencyData.length / visualizerBars.length);
                const value = frequencyData[dataIndex] / 255;
                const height = Math.max(2, value * 18);

                bar.style.height = height + 'px';
                bar.style.background = `hsl(${value * 120 + (i * 8)}, 80%, ${50 + value * 30}%)`;
                bar.style.boxShadow = value > 0.7 ? `0 0 ${value * 8}px currentColor` : 'none';
            });
        }

        function detectBeatAndBPM(intensity) {
            const now = Date.now();
            const bpmEl = document.getElementById('musicBPM');

            if (bpmMode === 'manual') {
                // Modo manual - usar BPM fijo
                musicBPM = manualBPM || 120;
                
                const beatInterval = 60000 / musicBPM;
                if (now - lastBeatTime > beatInterval * 0.9) {
                    lastBeatTime = now;
                }
                
                if (bpmEl) bpmEl.textContent = musicBPM + ' BPM (Manual)';
                return;
            }

            // Modo automático - detectar BPM del audio
            if (intensity > 0.6 && now - lastBeatTime > 300) {
                beatHistory.push(now);
                lastBeatTime = now;

                if (beatHistory.length > 10) beatHistory.shift();

                if (beatHistory.length >= 3) {
                    const intervals = [];
                    for (let i = 1; i < beatHistory.length; i++) {
                        intervals.push(beatHistory[i] - beatHistory[i - 1]);
                    }
                    
                    // Filtrar intervalos extremos
                    const validIntervals = intervals.filter(interval => interval > 300 && interval < 2000);
                    
                    if (validIntervals.length > 0) {
                        const avgInterval = validIntervals.reduce((a, b) => a + b) / validIntervals.length;
                        const detectedBPM = Math.round(60000 / avgInterval);
                        
                        // Suavizar cambios de BPM
                        if (Math.abs(detectedBPM - musicBPM) < 20 || musicBPM === 0) {
                            musicBPM = detectedBPM;
                        }
                    }
                }
            }
            
            // Fallback si no se detecta BPM
            if (musicBPM === 0 || musicBPM < 60 || musicBPM > 200) {
                musicBPM = 120;
            }
            
            if (bpmEl) bpmEl.textContent = musicBPM + ' BPM (Auto)';
        }

        function updateMusicHUD(bass, mid, high, intensity) {
            const themeMultiplier = {
                disco: { hue: 0, sat: 1.5, bright: 1.2 },
                rock: { hue: 30, sat: 1.8, bright: 0.9 },
                electronic: { hue: 180, sat: 2.0, bright: 1.4 },
                chill: { hue: 240, sat: 0.8, bright: 0.7 }
            }[musicTheme];

            const elements = [
                { el: document.getElementById('ui'), freq: bass, base: 0 },
                { el: document.getElementById('currency-display'), freq: mid, base: 120 },
                { el: document.getElementById('controls'), freq: high, base: 240 }
            ];

            elements.forEach(({ el, freq, base }) => {
                if (!el) return;

                const hue = (base + themeMultiplier.hue + freq * 180) % 360;
                const saturation = Math.min(100, (40 + intensity * 60) * themeMultiplier.sat);
                const lightness = Math.min(80, (30 + intensity * 30) * themeMultiplier.bright);

                el.style.background = `hsla(${hue}, ${saturation}%, ${lightness}%, 0.95)`;
                el.style.borderColor = `hsl(${hue + 60}, ${saturation + 20}%, ${lightness + 20}%)`;
                el.style.boxShadow = `0 0 ${15 + intensity * 30}px hsla(${hue}, ${saturation}%, ${lightness}%, 0.8)`;
            });
        }

        function updateMusicBall(bass, mid, high, intensity) {
            // Tamaño reactivo
            ball.radius = (20 + gameData.upgrades.size.level * 2) + (intensity * 20);

            // Color dinámico
            const hue = (bass * 60 + mid * 180 + high * 300) % 360;
            ball.color = `hsl(${hue}, ${80 + intensity * 20}%, ${50 + intensity * 30}%)`;

            // Estela musical
            if (intensity > 0.3) {
                musicTrail.push({
                    x: ball.x, y: ball.y,
                    color: ball.color,
                    life: 500 + intensity * 300,
                    maxLife: 500 + intensity * 300,
                    size: ball.radius * 0.8
                });
            }

            // Actualizar estela
            for (let i = musicTrail.length - 1; i >= 0; i--) {
                musicTrail[i].life -= 16;
                if (musicTrail[i].life <= 0) {
                    musicTrail.splice(i, 1);
                }
            }
        }

        function createMusicParticles(intensity, bass, mid, high) {
            const count = Math.floor(5 + intensity * 15);

            for (let i = 0; i < count; i++) {
                particles.push({
                    x: ball.x + (Math.random() - 0.5) * 80,
                    y: ball.y + (Math.random() - 0.5) * 80,
                    dx: (Math.random() - 0.5) * 30,
                    dy: (Math.random() - 0.5) * 30,
                    life: 600 + intensity * 800,
                    maxLife: 600 + intensity * 800,
                    alpha: 1,
                    color: `hsl(${(bass * 60 + mid * 180 + high * 300 + i * 30) % 360}, 100%, ${60 + intensity * 40}%)`,
                    size: 2 + intensity * 4,
                    musical: true
                });
            }
        }

        function updateBackgroundWaves(intensity) {
            if (intensity > 0.5) {
                backgroundWaves.push({
                    x: ball.x, y: ball.y,
                    radius: 0,
                    maxRadius: 100 + intensity * 200,
                    life: 1000,
                    color: `hsla(${intensity * 360}, 70%, 50%, 0.3)`
                });
            }

            for (let i = backgroundWaves.length - 1; i >= 0; i--) {
                const wave = backgroundWaves[i];
                wave.radius += 3;
                wave.life -= 16;

                if (wave.life <= 0 || wave.radius >= wave.maxRadius) {
                    backgroundWaves.splice(i, 1);
                }
            }
        }

        function spawnMusicOrb(intensity) {
            const musicOrbTypes = [
                { id: 'beat', name: 'Orbe del Beat', color: '#FF1493', effect: 'beat', power: intensity * 2, duration: 8000, rarity: 'musical' },
                { id: 'bass', name: 'Orbe de Graves', color: '#8A2BE2', effect: 'bass', power: intensity * 1.5, duration: 6000, rarity: 'musical' },
                { id: 'melody', name: 'Orbe Melódico', color: '#00CED1', effect: 'melody', power: intensity * 3, duration: 10000, rarity: 'musical' }
            ];

            const orbType = musicOrbTypes[Math.floor(Math.random() * musicOrbTypes.length)];

            orbs.push({
                x: Math.random() * (width - 100) + 50,
                y: Math.random() * (height - 100) + 50,
                radius: 18 + intensity * 8,
                type: orbType,
                alpha: 1,
                life: orbType.duration,
                maxLife: orbType.duration,
                pulsePhase: 0,
                musical: true
            });
        }

        function resetMusicEffects() {
            // Resetear estilos de HUD
            const ui = document.getElementById('ui');
            const currencyDisplay = document.getElementById('currency-display');
            const controls = document.getElementById('controls');

            if (ui) {
                ui.style.background = '';
                ui.style.borderColor = '';
                ui.style.boxShadow = '';
            }

            if (currencyDisplay) {
                currencyDisplay.style.background = '';
                currencyDisplay.style.borderColor = '';
                currencyDisplay.style.boxShadow = '';
            }

            if (controls) {
                controls.style.background = '';
                controls.style.borderColor = '';
                controls.style.boxShadow = '';
            }

            // Resetear canvas
            if (canvas) {
                canvas.style.transform = 'scale(1)';
                canvas.style.transition = '';
            }

            // Resetear pelota
            ball.radius = 20 + gameData.upgrades.size.level * 2;
            ball.color = '#ff6b35';
            gameSpeed = 1;
        }

        // Sistema Premium Integrado
        function showPremiumRequired(featureName) {
            showNotification(`💎 ${featureName} requiere Premium - Solo personalización, sin ventajas de gameplay`);
            setTimeout(() => showPremiumShop(), 1000);
        }

        function initPremiumSystem() {
            if (gameData.premiumUnlocked) {
                premiumUnlocked = true;
                document.querySelectorAll('.premium-feature').forEach(el => {
                    el.style.opacity = '1';
                    el.style.pointerEvents = 'auto';
                });
                document.querySelectorAll('.premium-feature input, .premium-feature button, .premium-feature select').forEach(el => el.disabled = false);
            }

            document.querySelectorAll('.premium-feature input, .premium-feature button, .premium-feature select').forEach(el => {
                if (!premiumUnlocked) {
                    el.addEventListener('click', (e) => {
                        if (!premiumUnlocked) {
                            e.preventDefault();
                            showPremiumRequired(el.closest('.premium-feature').querySelector('label')?.textContent || 'Esta característica');
                        }
                    });
                }
            });
        }

        // Funciones Premium Específicas
        function enablePremiumFeatures() {
            // Efectos de aura
            if (document.getElementById('auraEffects')?.checked && premiumUnlocked) {
                ball.auraEnabled = true;
            }

            // Celebraciones épicas
            if (document.getElementById('epicCelebrations')?.checked && premiumUnlocked) {
                window.epicCelebrationsEnabled = true;
            }

            // Temas musicales premium
            const premiumTheme = document.getElementById('premiumMusicThemes')?.value;
            if (premiumTheme && premiumUnlocked) {
                applyPremiumMusicTheme(premiumTheme);
            }
        }

        function applyPremiumMusicTheme(theme) {
            const themes = {
                'Synthwave': { hue: 300, saturation: 2.5, brightness: 1.8 },
                'Dubstep': { hue: 120, saturation: 3.0, brightness: 2.0 },
                'Jazz': { hue: 45, saturation: 1.2, brightness: 0.8 },
                'Classical': { hue: 200, saturation: 1.0, brightness: 1.1 }
            };

            if (themes[theme]) {
                const themeData = themes[theme];
                document.documentElement.style.setProperty('--premium-hue', themeData.hue);
                document.documentElement.style.setProperty('--premium-saturation', themeData.saturation);
                document.documentElement.style.setProperty('--premium-brightness', themeData.brightness);
            }
        }

        function exportStatsAsPDF() {
            if (!premiumUnlocked) {
                showPremiumRequired('Exportar estadísticas');
                return;
            }

            const statsData = {
                nivel: level,
                coins: formatNumber(coins),
                diamantes: diamonds,
                rebotes: formatNumber(bounces),
                prestigio: gameData.prestige,
                tiempoJugado: Math.floor((Date.now() - playTimeStart) / 60000) + 'm',
                mejorCombo: bestCombo.toFixed(1) + 'x'
            };

            const csvContent = Object.entries(statsData).map(([key, value]) => `${key},${value}`).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fnc_stats_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('📄 Estadísticas exportadas como CSV');
        }

        function openSkinEditor() {
            if (!premiumUnlocked) {
                showPremiumRequired('Editor de skins');
                return;
            }
            showNotification('🎨 Editor de skins disponible en próxima actualización');
        }

        function startReplayRecording() {
            if (!premiumUnlocked) {
                showPremiumRequired('Grabador de replays');
                return;
            }
            showNotification('📹 Grabación de replay iniciada (simulación)');
        }

        function showTitlesAndBadges() {
            if (!premiumUnlocked) {
                showPremiumRequired('Títulos y badges');
                return;
            }
            const titles = ['Maestro Chef', 'Leyenda Culinaria', 'Rey de la Cocina', 'Estrella Michelin'];
            const randomTitle = titles[Math.floor(Math.random() * titles.length)];
            showNotification(`🏆 Título desbloqueado: ${randomTitle}`);
        }

        function applyConfig() {
            soundEnabled = document.getElementById('soundToggle').checked;
            performanceMode = document.getElementById('performanceMode').checked;
            batterySaverMode = document.getElementById('batterySaver').checked;
            gameSpeed = parseFloat(document.getElementById('gameSpeedSlider').value);
            musicMode = document.getElementById('musicMode').checked;

            // Aplicar calidad gráfica
            const quality = document.getElementById('graphicsQuality').value;

            switch (quality) {
                case 'low':
                    document.getElementById('particleCountSlider').value = batterySaverMode ? 0 : 5;
                    break;
                case 'medium':
                    document.getElementById('particleCountSlider').value = batterySaverMode ? 5 : 15;
                    break;
                case 'high':
                    document.getElementById('particleCountSlider').value = batterySaverMode ? 10 : 30;
                    break;
                case 'ultra':
                    document.getElementById('particleCountSlider').value = batterySaverMode ? 15 : 50;
                    break;
            }

            // Aplicar optimizaciones de batería
            if (batterySaverMode) {
                gameSpeed = Math.min(gameSpeed, 1.5);
                document.getElementById('gameSpeedSlider').max = '1.5';
            } else {
                document.getElementById('gameSpeedSlider').max = '3';
            }

            // Aplicar escala de UI
            const uiScale = document.getElementById('uiScale').value;
            document.documentElement.style.setProperty('--ui-scale', uiScale);

            // Aplicar tipo de fondo
            const backgroundType = document.getElementById('backgroundType').value;
            applyBackgroundType(backgroundType);

            // Actualizar FPS objetivo
            updateFPSTarget();

            // Aplicar auto-save interval
            const autoSaveInterval = parseInt(document.getElementById('autoSaveInterval')?.value || 10) * 1000;
            if (window.autoSaveTimer) clearInterval(window.autoSaveTimer);
            window.autoSaveTimer = setInterval(autoSave, autoSaveInterval);
            console.log('Auto-guardado configurado cada', autoSaveInterval / 1000, 'segundos');

            // Aplicar mostrar FPS
            const showFPS = document.getElementById('showFPS').checked;
            let fpsDisplay = document.getElementById('fpsDisplay');
            if (showFPS && !fpsDisplay) {
                fpsDisplay = document.createElement('div');
                fpsDisplay.id = 'fpsDisplay';
                fpsDisplay.style.cssText = 'position: fixed; top: 5px; left: 5px; color: white; font-size: 12px; z-index: 1001; background: rgba(0,0,0,0.8); padding: 6px 10px; border-radius: 6px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2);';
                fpsDisplay.textContent = 'FPS: --';
                document.body.appendChild(fpsDisplay);
            } else if (!showFPS && fpsDisplay) {
                fpsDisplay.remove();
            }

            updateSpeedValue();
            updateParticleValue();
            updateUIScale();
            updateVolumeValue();

            if (premiumUnlocked) {
                ball.color = document.getElementById('ballColor').value;
                enablePremiumFeatures();
            }

            // Guardar configuración completa
            const config = {
                soundEnabled,
                performanceMode,
                gameSpeed,
                graphicsQuality: quality,
                targetFPS: document.getElementById('targetFPS').value,
                uiScale,
                vibration: document.getElementById('vibrationToggle').checked,
                notifications: document.getElementById('notificationsToggle').checked,
                batterySaver: batterySaverMode,
                reduceAnimations: document.getElementById('reduceAnimations').checked,
                pauseBackground: document.getElementById('pauseBackground').checked,
                backgroundType: document.getElementById('backgroundType').value,
                volume: document.getElementById('volumeSlider').value,
                achievementSounds: document.getElementById('achievementSounds').checked,
                autoSaveInterval: document.getElementById('autoSaveInterval').value,
                confirmPrestige: document.getElementById('confirmPrestige').checked,
                devMode: document.getElementById('devMode').checked,
                showFPS: document.getElementById('showFPS').checked,
                debugCollisions: document.getElementById('debugCollisions').checked,
                lightMode
            };
            localStorage.setItem('gameConfig', JSON.stringify(config));

            showNotification('⚙️ Configuración aplicada');
            saveGame();
        }

        function applyBackgroundType(type) {
            const canvas = document.getElementById('gameCanvas');
            if (!canvas) return;

            switch (type) {
                case 'gradient':
                    canvas.style.background = 'radial-gradient(circle at center, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.3) 100%)';
                    break;
                case 'solid':
                    canvas.style.background = '#222';
                    break;
                case 'stars':
                    canvas.style.background = '#000 url("data:image/svg+xml,%3Csvg width="100" height="100" xmlns="http://www.w3.org/2000/svg"%3E%3Cdefs%3E%3Cpattern id="stars" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"%3E%3Ccircle cx="10" cy="10" r="1" fill="%23fff" opacity="0.3"/%3E%3C/pattern%3E%3C/defs%3E%3Crect width="100%" height="100%" fill="url(%23stars)"/%3E%3C/svg%3E")';
                    break;
                case 'minimal':
                    canvas.style.background = '#111';
                    break;
            }
        }

        function loadConfig() {
            const savedConfig = localStorage.getItem('gameConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    if (config.gameSpeed) {
                        document.getElementById('gameSpeedSlider').value = config.gameSpeed;
                        gameSpeed = config.gameSpeed;
                    }
                    if (config.graphicsQuality) document.getElementById('graphicsQuality').value = config.graphicsQuality;
                    if (config.targetFPS) document.getElementById('targetFPS').value = config.targetFPS;
                    if (config.uiScale) {
                        document.getElementById('uiScale').value = config.uiScale;
                        document.documentElement.style.setProperty('--ui-scale', config.uiScale);
                    }
                    if (config.backgroundType) {
                        document.getElementById('backgroundType').value = config.backgroundType;
                        applyBackgroundType(config.backgroundType);
                    }
                    if (config.volume) {
                        document.getElementById('volumeSlider').value = config.volume;
                    }
                    if (config.autoSaveInterval) {
                        document.getElementById('autoSaveInterval').value = config.autoSaveInterval;
                    }
                    if (config.vibration !== undefined) document.getElementById('vibrationToggle').checked = config.vibration;
                    if (config.notifications !== undefined) document.getElementById('notificationsToggle').checked = config.notifications;
                    if (config.achievementSounds !== undefined) document.getElementById('achievementSounds').checked = config.achievementSounds;
                    if (config.confirmPrestige !== undefined) document.getElementById('confirmPrestige').checked = config.confirmPrestige;
                    if (config.devMode !== undefined) document.getElementById('devMode').checked = config.devMode;
                    if (config.showFPS !== undefined) document.getElementById('showFPS').checked = config.showFPS;
                    if (config.debugCollisions !== undefined) document.getElementById('debugCollisions').checked = config.debugCollisions;
                    if (config.soundEnabled !== undefined) {
                        document.getElementById('soundToggle').checked = config.soundEnabled;
                        soundEnabled = config.soundEnabled;
                    }
                    if (config.performanceMode !== undefined) {
                        document.getElementById('performanceMode').checked = config.performanceMode;
                        performanceMode = config.performanceMode;
                    }
                    if (config.batterySaver !== undefined) {
                        document.getElementById('batterySaver').checked = config.batterySaver;
                        batterySaverMode = config.batterySaver;
                    }
                    if (config.reduceAnimations !== undefined) document.getElementById('reduceAnimations').checked = config.reduceAnimations;
                    if (config.pauseBackground !== undefined) document.getElementById('pauseBackground').checked = config.pauseBackground;
                    if (config.lightMode !== undefined) {
                        lightMode = config.lightMode;
                        if (lightMode) toggleTheme();
                    }

                    updateSpeedValue();
                    updateParticleValue();
                    updateUIScale();
                    updateVolumeValue();
                } catch (e) {
                    console.log('Error cargando configuración');
                }
            }
        }

        function resetGame() {
            if (confirm('¿REINICIAR TODO EL PROGRESO? Esto borrará ABSOLUTAMENTE TODO: coins, diamantes, estrellas, mejoras, prestigio, misiones, etc.')) {
                // Limpiar localStorage completamente
                localStorage.removeItem('circleBounceUltimate');
                localStorage.removeItem('circleBounceUltimate_slot1');
                localStorage.removeItem('circleBounceUltimate_slot2');
                localStorage.removeItem('circleBounceUltimate_slot3');

                // Resetear todas las variables del juego
                coins = 0;
                diamonds = 0;
                experience = 0;
                bounces = 0;
                level = 1;
                combo = 1;
                totalBounces = 0;
                totalCoins = 0;
                bestCombo = 1;
                missionSet = 1;
                completedMissions = 0;
                premiumUnlocked = false;
                selectedSkin = 'default';

                // Resetear gameData completamente
                gameData = {
                    coins: 0,
                    diamonds: 0,
                    experience: 0,
                    bounces: 0,
                    level: 1,
                    prestige: 0,
                    prestigePoints: 0,
                    ascension: 0,
                    ascensionPoints: 0,
                    upgrades: {
                        coinMult: { level: 0, baseCost: 100, multiplier: 1.5, maxLevel: 1000 },
                        speed: { level: 0, baseCost: 150, multiplier: 1.6, maxLevel: 500 },
                        size: { level: 0, baseCost: 200, multiplier: 1.7, maxLevel: 200 },
                        combo: { level: 0, baseCost: 250, multiplier: 1.8, maxLevel: 100 },
                        critical: { level: 0, baseCost: 300, multiplier: 1.9, maxLevel: 50 },
                        diamondGen: { level: 0, baseCost: 500, multiplier: 2.0, maxLevel: 25 },
                        expMult: { level: 0, baseCost: 10, multiplier: 2.5, currency: 'diamonds', maxLevel: 100 },
                        auto: { level: 0, baseCost: 25, multiplier: 3.0, currency: 'diamonds', maxLevel: 10 },
                        timeAsc: { level: 0, baseCost: 100, multiplier: 5.0, currency: 'diamonds', maxLevel: 5 },
                        dimension: { level: 0, baseCost: 200, multiplier: 10.0, currency: 'diamonds', maxLevel: 3 },
                        omnipotence: { level: 0, baseCost: 1000, multiplier: 50.0, currency: 'diamonds', maxLevel: 2 },
                        infinite: { level: 0, baseCost: 5000, multiplier: 100.0, currency: 'diamonds', maxLevel: 1 }
                    },
                    research: {
                        unlocked: [],
                        available: ['efficiency1', 'automation1']
                    }
                };

                // Resetear misiones
                missions = {
                    bounces: { target: 50, progress: 0, reward: 200, completed: false },
                    coins: { target: 500, progress: 0, reward: 300, completed: false },
                    diamonds: { target: 3, progress: 0, reward: 5, completed: false },
                    level: { target: 5, progress: 0, reward: 1000, completed: false },
                    combo: { target: 5, progress: 0, reward: 500, completed: false },
                    upgrades: { target: 3, progress: 0, reward: 1500, completed: false }
                };

                // Resetear sartén completamente
                ball.radius = 20;
                ball.dx = ball.baseSpeed;
                ball.dy = ball.baseSpeed;
                ball.color = '#ff6b35';
                ball.x = width / 2;
                ball.y = height / 2;

                // Regenerar misiones y actualizar UI
                generateMissions();
                updateUI();
                showNotification('¡RESET COMPLETO! Todo ha sido reiniciado.');
            }
        }

        function selectSkin(skin) {
            // Verificar si es premium
            const premiumSkins = ['rainbow', 'galaxy', 'cosmic', 'neon', 'diamond'];
            if (premiumSkins.includes(skin) && !premiumUnlocked) {
                showPremiumShop();
                return;
            }

            selectedSkin = skin;
            document.querySelectorAll('.skin-option').forEach(el => el.classList.remove('selected'));

            // Encontrar y seleccionar la skin clickeada
            const skinElements = document.querySelectorAll('.skin-option');
            skinElements.forEach(el => {
                if (el.onclick && el.onclick.toString().includes(skin)) {
                    el.classList.add('selected');
                    el.style.border = '2px solid var(--primary)';
                } else {
                    el.style.border = '2px solid transparent';
                }
            });

            const colors = {
                default: '#ff6b35',
                fire: '#ff6600',
                ice: '#00ccff',
                rainbow: '#ff0000',
                galaxy: '#9900ff',
                cosmic: '#00ffff',
                neon: '#ff0080',
                diamond: '#b9f2ff'
            };

            ball.color = colors[skin] || '#ff6b35';
            gameData.selectedSkin = skin;
            saveGame();
            showNotification(`🎨 Skin "${skin}" seleccionada`);
        }

        function buyPremium() {
            const premiumCost = 5000 + (gameData.prestige * 2000) + (gameData.ascension * 10000);
            if (coins >= premiumCost && !premiumUnlocked) {
                coins -= premiumCost;
                premiumUnlocked = true;
                document.querySelectorAll('.premium-feature').forEach(el => {
                    el.style.opacity = '1';
                    el.style.pointerEvents = 'auto';
                });
                document.querySelectorAll('.premium-feature input').forEach(el => el.disabled = false);
                updateUI();
                saveGame();
                closePremiumShop();
                showNotification('¡Premium desbloqueado!');
            }
        }

        function updateStats() {
            const playTime = Math.floor((Date.now() - playTimeStart) / 60000);
            const sessionTime = Math.floor((Date.now() - betaStats.sessionStart) / 60000);

            // Estadísticas básicas
            if (document.getElementById('fpsCounter')) document.getElementById('fpsCounter').textContent = currentFPS;
            if (document.getElementById('particleCounter')) document.getElementById('particleCounter').textContent = particles.length;
            if (document.getElementById('totalBounces')) document.getElementById('totalBounces').textContent = formatNumber(totalBounces);
            if (document.getElementById('totalCoins')) document.getElementById('totalCoins').textContent = formatNumber(totalCoins);
            if (document.getElementById('playTime')) document.getElementById('playTime').textContent = playTime + 'm';
            if (document.getElementById('bestCombo')) document.getElementById('bestCombo').textContent = bestCombo.toFixed(1) + 'x';

            // Estadísticas beta
            if (document.getElementById('sessionTime')) document.getElementById('sessionTime').textContent = sessionTime + 'm';
            if (document.getElementById('totalOrbs')) document.getElementById('totalOrbs').textContent = betaStats.orbsCollected;
            if (document.getElementById('codesRedeemed')) document.getElementById('codesRedeemed').textContent = betaStats.codesRedeemed;
            if (document.getElementById('eventsTriggered')) document.getElementById('eventsTriggered').textContent = betaStats.eventsTriggered;
            if (document.getElementById('crashCount')) document.getElementById('crashCount').textContent = betaStats.crashes;
        }

        function generateMissions() {
            const missionTypes = [
                { type: 'bounces', name: 'Realiza {target} rebotes', reward: 'coins', base: 300, scale: 1.6 },
                { type: 'coins', name: 'Consigue {target} coins', reward: 'coins', base: 8000, scale: 1.8 },
                { type: 'diamonds', name: 'Obtén {target} diamantes', reward: 'diamonds', base: 30, scale: 1.4 },
                { type: 'level', name: 'Alcanza nivel {target}', reward: 'coins', base: 10, scale: 1.3 },
                { type: 'combo', name: 'Combo de {target}x', reward: 'coins', base: 8, scale: 1.4 },
                { type: 'upgrades', name: 'Compra {target} mejoras', reward: 'coins', base: 15, scale: 1.6 }
            ];

            Object.keys(missions).forEach(key => {
                const mission = missions[key];
                const type = missionTypes.find(t => t.type === key);
                if (type && !mission.completed) {
                    mission.target = Math.floor(type.base * Math.pow(type.scale, missionSet - 1));
                    mission.reward = Math.floor(mission.target * (type.base / 10) * missionSet);
                    if (!mission.progress) mission.progress = 0;
                    if (!mission.completed) mission.completed = false;
                    if (!mission.claimed) mission.claimed = false;
                    mission.name = type.name.replace('{target}', mission.target);
                    mission.rewardType = type.reward;
                }
            });

            renderMissions();
        }

        function renderMissions() {
            const list = document.getElementById('missionList');
            list.innerHTML = '';
            Object.keys(missions).forEach(key => {
                const mission = missions[key];
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px; background: rgba(255,255,255,0.1); margin: 5px 0; border-radius: 5px;';
                div.innerHTML = `
                    <h4>${mission.name}</h4>
                    <div>Progreso: <span id="${key}Progress">${mission.progress}</span>/${mission.target}</div>
                    <div style="background: #333; height: 5px; border-radius: 3px; margin: 5px 0;">
                        <div id="${key}Bar" style="background: var(--success); height: 100%; width: ${(mission.progress / mission.target) * 100}%; border-radius: 3px;"></div>
                    </div>
                    <div style="color: var(--success); font-size: 12px;">Recompensa: ${mission.reward} ${mission.rewardType}</div>
                `;
                list.appendChild(div);
            });
            document.getElementById('missionSetNumber').textContent = missionSet;
        }

        function updateMissions() {
            if (!missions.bounces.completed) missions.bounces.progress = Math.min(bounces, missions.bounces.target);
            if (!missions.coins.completed) missions.coins.progress = Math.min(coins, missions.coins.target);
            if (!missions.diamonds.completed) missions.diamonds.progress = Math.min(diamonds, missions.diamonds.target);
            if (!missions.level.completed) missions.level.progress = Math.min(level, missions.level.target);
            if (!missions.combo.completed) missions.combo.progress = Math.min(Math.floor(combo), missions.combo.target);

            Object.keys(missions).forEach(key => {
                const mission = missions[key];
                const progressEl = document.getElementById(key + 'Progress');
                const barEl = document.getElementById(key + 'Bar');
                if (progressEl) progressEl.textContent = mission.progress;
                if (barEl) barEl.style.width = (mission.progress / mission.target) * 100 + '%';

                if (mission.progress >= mission.target && !mission.completed && !mission.claimed) {
                    mission.completed = true;
                    mission.claimed = true;
                    completedMissions++;
                    if (mission.rewardType === 'coins') {
                        coins += mission.reward;
                    } else if (mission.rewardType === 'diamonds') {
                        diamonds += mission.reward;
                    }
                    showNotification(`¡Misión completada! +${mission.reward} ${mission.rewardType}`);

                    if (completedMissions >= 2) {
                        completedMissions = 0;
                        missionSet++;
                        generateMissions();
                        // Sin notificación de nuevas misiones
                    }
                }
            });
        }

        // Funciones del sistema AFK
        function resetAfkTimer() {
            lastActivity = Date.now();
            afkTime = 0;
        }

        function handleVisibilityChange() {
            const pauseBackground = document.getElementById('pauseBackground')?.checked ?? true;

            if (document.hidden) {
                lastActivity = Date.now() - 60000; // Marca como inactivo hace 1 minuto
                if (pauseBackground && !gamePaused) {
                    gamePaused = true;
                    console.log('Juego pausado automáticamente (segundo plano)');
                }
            } else {
                resetAfkTimer();
                if (pauseBackground && gamePaused) {
                    gamePaused = false;
                    console.log('Juego reanudado automáticamente');
                }
            }
        }

        function handleWindowBlur() {
            lastActivity = Date.now() - 30000; // Marca como inactivo hace 30s
        }

        function handleWindowFocus() {
            resetAfkTimer();
        }

        function checkGitHubPages() {
            // Sistema antipiracy eliminado
        }

        function updateAfkSystem() {
            const now = Date.now();
            const timeSinceActivity = Math.floor((now - lastActivity) / 1000);

            if (timeSinceActivity > 30) {
                afkTime = timeSinceActivity - 30;

                if (afkTime > 0 && afkTime % 10 === 0) {
                    const afkMultiplier = Math.min(afkTime / 3600, 2);
                    afkRewards.coins += Math.floor(level * afkMultiplier * 0.1);
                    afkRewards.diamonds += Math.floor(afkMultiplier * 0.01);
                    afkRewards.experience += Math.floor(level * afkMultiplier * 0.05);
                }

                idleBonus = 1 + (afkTime / 7200);
            } else {
                afkTime = 0;
                idleBonus = 1;
            }
        }

        function claimAfkRewards() {
            if (afkRewards.coins > 0 || afkRewards.diamonds > 0 || afkRewards.experience > 0) {
                coins += Math.floor(afkRewards.coins);
                diamonds += Math.floor(afkRewards.diamonds);
                experience += Math.floor(afkRewards.experience);

                showNotification(`💤 Recompensas AFK: +${Math.floor(afkRewards.coins)} coins, +${Math.floor(afkRewards.diamonds)} diamantes, +${Math.floor(afkRewards.experience)} exp`);

                afkRewards = { coins: 0, diamonds: 0, experience: 0 };
                updateUI();
            } else {
                // Sin notificación para AFK vacío
            }
        }

        function updateDailyChallenges() {
            if (currentDailyChallenge && !currentDailyChallenge.completed) {
                let newProgress = 0;
                switch (currentDailyChallenge.id) {
                    case 'bounces':
                        newProgress = Math.min(bounces, currentDailyChallenge.target);
                        break;
                    case 'coins':
                        newProgress = Math.min(coins, currentDailyChallenge.target);
                        break;
                    case 'diamonds':
                        newProgress = Math.min(diamonds, currentDailyChallenge.target);
                        break;
                    case 'combo':
                        newProgress = Math.min(Math.floor(combo), currentDailyChallenge.target);
                        break;
                    case 'levels':
                        newProgress = Math.min(level, currentDailyChallenge.target);
                        break;
                    case 'speed':
                        newProgress = Math.min(Math.abs(ball.dx) + Math.abs(ball.dy), currentDailyChallenge.target);
                        break;
                    case 'upgrades':
                        newProgress = Math.min(Object.values(gameData.upgrades).reduce((sum, u) => sum + u.level, 0), currentDailyChallenge.target);
                        break;
                    case 'orbs':
                        if (!currentDailyChallenge.orbsCollected) currentDailyChallenge.orbsCollected = 0;
                        newProgress = currentDailyChallenge.orbsCollected;
                        break;
                    case 'prestige':
                        newProgress = Math.min(gameData.prestige, currentDailyChallenge.target);
                        break;
                    case 'experience':
                        newProgress = Math.min(experience, currentDailyChallenge.target);
                        break;
                    case 'critical':
                        if (!currentDailyChallenge.criticalHits) currentDailyChallenge.criticalHits = 0;
                        newProgress = currentDailyChallenge.criticalHits;
                        break;
                    case 'particles':
                        if (!currentDailyChallenge.particlesGenerated) currentDailyChallenge.particlesGenerated = 0;
                        newProgress = currentDailyChallenge.particlesGenerated;
                        break;
                }

                currentDailyChallenge.progress = Math.max(currentDailyChallenge.progress, newProgress);

                if (currentDailyChallenge.progress >= currentDailyChallenge.target && !currentDailyChallenge.claimed) {
                    currentDailyChallenge.completed = true;
                    currentDailyChallenge.claimed = true;
                    if (currentDailyChallenge.type === 'coins') {
                        coins += currentDailyChallenge.reward;
                        gameData.coins = coins;
                    } else {
                        diamonds += currentDailyChallenge.reward;
                        gameData.diamonds = diamonds;
                    }
                    // Sin notificación de desafío completado
                    currentDailyChallenge = null;
                }
            }

            // Actualizar misiones avanzadas
            advancedMissions.forEach(mission => {
                if (!mission.completed) {
                    let newProgress = 0;
                    switch (mission.id) {
                        case 'marathon':
                            newProgress = Math.min(bounces, mission.target);
                            break;
                        case 'collector':
                            newProgress = Math.min(diamonds, mission.target);
                            break;
                        case 'master':
                            if (Math.floor(combo) >= 50) {
                                if (!mission.comboStartTime) mission.comboStartTime = Date.now();
                                newProgress = Math.min(Math.floor((Date.now() - mission.comboStartTime) / 1000), mission.target);
                            } else {
                                mission.comboStartTime = null;
                                newProgress = 0;
                            }
                            break;
                        case 'ascender':
                            newProgress = Math.min(gameData.prestige, mission.target);
                            break;
                        case 'speedster':
                            if (Math.abs(ball.dx) + Math.abs(ball.dy) >= 50) {
                                if (!mission.speedStartTime) mission.speedStartTime = Date.now();
                                newProgress = Math.min(Math.floor((Date.now() - mission.speedStartTime) / 1000), mission.target);
                            } else {
                                mission.speedStartTime = null;
                                newProgress = 0;
                            }
                            break;
                        case 'giant':
                            if (ball.radius >= 100) {
                                if (!mission.sizeStartTime) mission.sizeStartTime = Date.now();
                                newProgress = Math.min(Math.floor((Date.now() - mission.sizeStartTime) / 1000), mission.target);
                            } else {
                                mission.sizeStartTime = null;
                                newProgress = 0;
                            }
                            break;
                    }

                    mission.progress = Math.max(mission.progress, newProgress);

                    if (mission.progress >= mission.target && !mission.claimed) {
                        mission.completed = true;
                        mission.claimed = true;
                        if (mission.rewardType === 'coins') {
                            coins += mission.reward;
                            gameData.coins = coins;
                        } else {
                            diamonds += mission.reward;
                            gameData.diamonds = diamonds;
                        }
                        // Sin notificación de misión completada
                    }
                }
            });
        }

        function selectRandomDailyChallenge() {
            const now = Date.now();
            const timeSinceReset = now - gameData.lastDailyReset;
            const timeLeft = 86400000 - timeSinceReset;

            if (timeLeft > 0) {
                const hoursLeft = Math.ceil(timeLeft / 3600000);
                showNotification(`⏰ Desafíos se resetean en ${hoursLeft}h`);
                return;
            }

            if (!currentDailyChallenge || currentDailyChallenge.completed) {
                const availableChallenges = dailyChallenges.filter(c => !c.completed);
                if (availableChallenges.length > 0) {
                    currentDailyChallenge = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
                    currentDailyChallenge.progress = 0;
                    currentDailyChallenge.completed = false;
                    showNotification(`🎯 Nuevo desafío: ${currentDailyChallenge.name}`);
                    updateDailyChallengesDisplay();
                } else {
                    showNotification('¡Todos los desafíos completados!');
                }
            } else {
                // Sin notificación para desafío activo
            }
        }

        function updateDailyChallengesDisplay() {
            const container = document.getElementById('dailyChallengesContainer');
            if (container) {
                container.innerHTML = '';

                if (currentDailyChallenge) {
                    const div = document.createElement('div');
                    div.className = 'upgrade';
                    div.innerHTML = `
                        <h4>🎯 ${currentDailyChallenge.name}</h4>
                        <p>${currentDailyChallenge.desc}</p>
                        <p>Progreso: ${currentDailyChallenge.progress}/${currentDailyChallenge.target}</p>
                        <div style="background: #333; height: 8px; border-radius: 4px; margin: 5px 0;">
                            <div style="background: var(--success); height: 100%; width: ${(currentDailyChallenge.progress / currentDailyChallenge.target) * 100}%; border-radius: 4px;"></div>
                        </div>
                        <p style="color: var(--success);">Recompensa: ${currentDailyChallenge.reward} ${currentDailyChallenge.type}</p>
                        <div style="color: ${currentDailyChallenge.completed ? '#4CAF50' : '#ff4444'};">Estado: ${currentDailyChallenge.completed ? '✅ Completado' : '⏳ En progreso'}</div>
                    `;
                    container.appendChild(div);
                } else {
                    container.innerHTML = '<div class="upgrade"><h4>Sin desafío activo</h4><p>Selecciona un nuevo desafío aleatorio</p></div>';
                }
            }
        }

        function redeemCode() {
            const code = document.getElementById('codeInput').value.toUpperCase().trim();
            if (!code) return;

            if (redeemedCodes.includes(code)) {
                // Sin notificación para códigos repetidos
                return;
            }

            const codes = {
                'WELCOME2': { coins: 5000, diamonds: 15, speedBoost: 120, desc: 'Pack bienvenida beta' },
                'BETA2024': { coins: 1000, diamonds: 5, desc: '1K coins + 5 diamantes' },
                'FENIX2024': { coins: 500, diamonds: 3, desc: '500 coins + 3 diamantes' },
                'BETATEST2': { coins: 2000, diamonds: 10, desc: '2K coins + 10 diamantes' },
                'FEEDBACK': { coins: 1000, orb: 'mythic', desc: 'Orbe mítico + 1K coins' },
                'GITHUB': { diamonds: 5, comboBoost: 60, desc: '5 diamantes + combo boost' },
                'ORBES': { coins: 300, orb: 'rare', desc: '300 coins + orbe raro' },
                'SPEED': { speedBoost: 60, desc: 'Velocidad x1.5 por 1 min' },
                'COMBO': { comboBoost: 30, desc: 'Combo x2 por 30 seg' }
            };

            if (codes[code]) {
                const reward = codes[code];
                redeemedCodes.push(code);

                if (reward.coins) {
                    coins += reward.coins;
                    gameData.coins = coins;
                }
                if (reward.diamonds) {
                    diamonds += reward.diamonds;
                    gameData.diamonds = diamonds;
                }
                if (reward.orb === 'rare') {
                    const rareOrb = orbTypes.find(o => o.rarity === 'raro');
                    if (rareOrb) {
                        orbs.push({
                            x: width / 2, y: height / 2, radius: 18, type: rareOrb,
                            alpha: 1, life: 15000, maxLife: 15000, pulsePhase: 0
                        });
                    }
                } else if (reward.orb === 'mythic') {
                    const mythicOrb = orbTypes.find(o => o.rarity === 'mítico');
                    if (mythicOrb) {
                        orbs.push({
                            x: width / 2, y: height / 2, radius: 25, type: mythicOrb,
                            alpha: 1, life: 25000, maxLife: 25000, pulsePhase: 0
                        });
                    }
                }
                if (reward.speedBoost) {
                    // Aplicar boost temporal menor
                    const currentSpeedX = Math.abs(ball.dx);
                    const currentSpeedY = Math.abs(ball.dy);
                    const directionX = ball.dx > 0 ? 1 : -1;
                    const directionY = ball.dy > 0 ? 1 : -1;

                    ball.dx = (currentSpeedX * 1.5) * directionX;
                    ball.dy = (currentSpeedY * 1.5) * directionY;

                    setTimeout(() => {
                        ball.dx = currentSpeedX * directionX;
                        ball.dy = currentSpeedY * directionY;
                    }, reward.speedBoost * 1000);
                }
                if (reward.comboBoost) {
                    combo *= 2;
                    setTimeout(() => {
                        combo = Math.max(1, combo / 2);
                    }, reward.comboBoost * 1000);
                }

                showNotification(`✅ Código canjeado: ${reward.desc}`);
                document.getElementById('codeInput').value = '';
                betaStats.codesRedeemed++;
                updateUI();
            } else {
                // Sin notificación para códigos inválidos
            }
        }

        function buyAutoClicker(level) {
            const costs = { 1: 100, 2: 300, 3: 1000 };
            const cost = costs[level];

            if (diamonds >= cost && autoClicker.level < level) {
                diamonds -= cost;
                autoClicker.level = level;
                autoClicker.active = true;

                // Configurar intervalo según el nivel
                const intervals = { 1: 5000, 2: 2000, 3: 1000 };
                if (autoClicker.interval) clearInterval(autoClicker.interval);

                autoClicker.interval = setInterval(() => {
                    if (!gamePaused && autoClicker.active) {
                        handleBounce();
                    }
                }, intervals[level]);

                showNotification(`🤖 Auto-Clicker Nivel ${level} activado!`);
                updateUI();
            }
        }

        // Modificar handleBounce
        const originalHandleBounce = handleBounce;
        handleBounce = function () {
            originalHandleBounce();
            totalBounces++;
            totalCoins = coins;
            if (combo > bestCombo) bestCombo = combo;
            updateMissions();
        };

        // Auto-guardado y generación de recursos
        setInterval(() => {
            autoSave();
            generateResources();
            generateEvent();

            // Verificar eventos por fecha
            const newDateEvent = checkDateEvents();
            if (newDateEvent && !dateEvent) {
                dateEvent = newDateEvent;
                showNotification(`🎉 ${dateEvent.name} activo!`);
                betaStats.eventsTriggered++;
            } else if (!newDateEvent && dateEvent) {
                dateEvent = null;
            }
            if (eventTimeLeft > 0) {
                eventTimeLeft--;
                if (!gameData.events) gameData.events = { current: null, timeLeft: 0 };
                gameData.events.timeLeft = eventTimeLeft;
                updateEventsDisplay();
                if (eventTimeLeft <= 0) {
                    currentEvent = null;
                    if (!gameData.events) gameData.events = { current: null, timeLeft: 0 };
                    gameData.events.current = null;
                    showNotification('🎪 Evento terminado');
                    updateEventsDisplay();
                }
            }

            // Sistema de clientes del restaurante
            if (Math.random() < 0.0005 && restaurantData.customers.length < 3) {
                const customerTypes = [
                    { name: 'Cliente Regular', tip: Math.floor(level * 5), patience: 30 },
                    { name: 'Crítico Gastronómico', tip: Math.floor(level * 15), patience: 60 },
                    { name: 'Chef Visitante', tip: Math.floor(level * 8), patience: 45 }
                ];
                const customer = customerTypes[Math.floor(Math.random() * customerTypes.length)];
                customer.arrivalTime = Date.now();
                restaurantData.customers.push(customer);

                // Sin notificación de cliente
            }

            // Procesar clientes
            restaurantData.customers.forEach((customer, index) => {
                const waitTime = (Date.now() - customer.arrivalTime) / 1000;
                if (waitTime > customer.patience) {
                    restaurantData.customers.splice(index, 1);
                    restaurantData.reputation = Math.max(0, restaurantData.reputation - 5);
                } else if (bounces % 50 === 0 && bounces > 0) {
                    coins += customer.tip;
                    restaurantData.reputation += 2;
                    restaurantData.customers.splice(index, 1);
                    gameData.coins = coins;
                }
            });

            // Actualizar estadísticas en tiempo real
            updateStats();

            // Reset diario de desafíos (cada 24 horas)
            const now = Date.now();
            if (now - gameData.lastDailyReset >= 86400000) {
                gameData.lastDailyReset = now;
                dailyChallenges.forEach(challenge => {
                    challenge.completed = false;
                    challenge.progress = 0;
                });
                currentDailyChallenge = null;
                showNotification('🌅 ¡Nuevos desafíos diarios disponibles!');
                updateDailyChallengesDisplay();
            }

            const premiumCost = 5000 + (gameData.prestige * 2000) + (gameData.ascension * 10000);
            document.getElementById('premiumProgress').textContent = coins;
            if (document.getElementById('premiumCost')) {
                document.getElementById('premiumCost').textContent = premiumCost;
            }
        }, 1000);

        // CSS adicional
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .skin-option:hover {
                border-color: var(--hud-color) !important;
                transform: scale(1.05);
            }
            .skin-option.selected {
                border-color: var(--hud-color) !important;
            }
        `;
        document.head.appendChild(style);





        function saveToSlot() {
            const now = Date.now();
            if (now - gameData.lastSave < 30000) {
                showNotification('Debes esperar 30 segundos entre guardados');
                return;
            }

            const slot = document.getElementById('saveSlot').value;
            gameData.lastSave = now;
            gameData.saveCount++;

            const saveData = {
                coins, diamonds, experience, bounces, level,
                prestige: gameData.prestige, prestigePoints: gameData.prestigePoints,
                ascension: gameData.ascension, ascensionPoints: gameData.ascensionPoints,
                achievements: gameData.achievements, cards: gameData.cards, pets: gameData.pets,
                artifacts: gameData.artifacts, events: gameData.events, season: gameData.season,
                infiniteLevels: gameData.infiniteLevels, lastSave: gameData.lastSave,
                lastDailyReset: gameData.lastDailyReset, saveCount: gameData.saveCount,
                premiumUnlocked, selectedSkin, missionSet, completedMissions,
                totalBounces, totalCoins, bestCombo, missions,
                dailyChallenges, currentDailyChallenge,
                upgrades: gameData.upgrades, research: gameData.research,
                timestamp: now, checksum: btoa(JSON.stringify({ coins, diamonds, level }))
            };
            localStorage.setItem(`circleBounceUltimate_slot${slot}`, JSON.stringify(saveData));
            showNotification(`Guardado en Slot ${slot}`);
        }

        function loadFromSlot() {
            const slot = document.getElementById('saveSlot').value;
            const saved = localStorage.getItem(`circleBounceUltimate_slot${slot}`);
            if (saved) {
                try {
                    const data = JSON.parse(saved);

                    // Validar checksum anti-exploit
                    const expectedChecksum = btoa(JSON.stringify({ coins: data.coins, diamonds: data.diamonds, level: data.level }));
                    if (data.checksum !== expectedChecksum) {
                        showNotification('Datos corruptos o modificados');
                        return;
                    }

                    // Validar timestamp
                    if (!data.timestamp || Date.now() - data.timestamp > 86400000 * 30) {
                        showNotification('Guardado demasiado antiguo');
                        return;
                    }

                    coins = Math.max(0, data.coins || 0);
                    diamonds = Math.max(0, data.diamonds || 0);
                    experience = Math.max(0, data.experience || 0);
                    bounces = Math.max(0, data.bounces || 0);
                    level = Math.max(1, data.level || 1);
                    gameData.prestige = Math.max(0, data.prestige || 0);
                    gameData.prestigePoints = Math.max(0, data.prestigePoints || 0);
                    gameData.ascension = Math.max(0, data.ascension || 0);
                    gameData.ascensionPoints = Math.max(0, data.ascensionPoints || 0);
                    gameData.achievements = data.achievements || [];
                    gameData.cards = data.cards || [];
                    gameData.pets = data.pets || [];
                    gameData.artifacts = data.artifacts || [];
                    gameData.events = data.events || { current: null, timeLeft: 0 };
                    gameData.season = Math.max(1, data.season || 1);
                    gameData.infiniteLevels = data.infiniteLevels || false;
                    gameData.lastSave = data.lastSave || Date.now();
                    gameData.lastDailyReset = data.lastDailyReset || Date.now();
                    gameData.saveCount = data.saveCount || 0;
                    missionSet = Math.max(1, data.missionSet || 1);
                    completedMissions = Math.max(0, data.completedMissions || 0);
                    missions = data.missions || missions;
                    if (data.dailyChallenges && Array.isArray(data.dailyChallenges)) dailyChallenges = data.dailyChallenges;
                    if (data.currentDailyChallenge && typeof data.currentDailyChallenge === 'object') currentDailyChallenge = data.currentDailyChallenge;
                    gameData.upgrades = data.upgrades || gameData.upgrades;
                    gameData.research = data.research || gameData.research;

                    // syncCollectionData(); // Fixed: function will be added
                    updateUI();
                    renderMissions();
                    showNotification(`Cargado desde Slot ${slot}`);
                } catch (e) {
                    showNotification('Error al cargar slot');
                }
            } else {
                showNotification('Slot vacío');
            }
        }



        function doAscension() {
            if (gameData.prestige >= 25 && coins >= 1e12) {
                let ascensionPointsGained = Math.floor(Math.log10(coins / 1e9) + gameData.prestige / 5);

                coins = 0;
                diamonds = 0;
                experience = 0;
                bounces = 0;
                level = 1;
                combo = 1;
                totalBounces = 0;
                totalCoins = 0;
                missionSet = 1;
                completedMissions = 0;

                gameData.coins = 0;
                gameData.diamonds = 0;
                gameData.experience = 0;
                gameData.bounces = 0;
                gameData.level = 1;
                gameData.prestige = 0;
                gameData.prestigePoints = 0;

                Object.keys(gameData.upgrades).forEach(key => {
                    gameData.upgrades[key].level = 0;
                });

                gameData.ascensionPoints += ascensionPointsGained;
                gameData.ascension++;

                // Resetear sartén a valores iniciales
                ball.radius = 20;
                ball.dx = ball.baseSpeed;
                ball.dy = ball.baseSpeed;
                ball.color = '#ff6b35';

                generateMissions();
                updateUI();
                showNotification(`¡Ascensión completada! +${ascensionPointsGained} puntos cósmicos`);
            } else {
                showNotification('Necesitas 25+ prestigios y 1T+ coins para ascender');
            }
        }

        function buyAscensionUpgrade(upgradeId) {
            if (upgradeId === 'cosmicMult' && gameData.ascensionPoints >= 1) {
                gameData.ascensionPoints -= 1;
                updateUI();
                showNotification('¡Multiplicador cósmico comprado! x2 a todas las ganancias');
            } else if (upgradeId === 'prestigeGen' && gameData.ascensionPoints >= 2) {
                gameData.ascensionPoints -= 2;
                updateUI();
                showNotification('¡Generador de prestigio activado!');
            } else if (upgradeId === 'timeAccel' && gameData.ascensionPoints >= 3) {
                gameData.ascensionPoints -= 3;
                updateUI();
                showNotification('¡Acelerador temporal activado! Juego 2x más rápido');
            }
        }

        function checkAchievements() {
            if (!gameData.achievements) gameData.achievements = [];

            achievements.forEach(achievement => {
                if (!achievement.unlocked) {
                    let progress = 0;
                    switch (achievement.type) {
                        case 'bounces': progress = bounces; break;
                        case 'coins': progress = coins; break;
                        case 'diamonds': progress = diamonds; break;
                        case 'prestige': progress = gameData.prestige; break;
                        case 'level': progress = level; break;
                        case 'combo': progress = Math.floor(combo); break;
                        case 'speed': progress = Math.abs(ball.dx) + Math.abs(ball.dy); break;
                        case 'size': progress = ball.radius; break;
                        case 'ascension': progress = gameData.ascension; break;
                    }
                    if (progress >= achievement.target) {
                        achievement.unlocked = true;
                        gameData.achievements.push(achievement.id);
                        coins += achievement.reward;
                        gameData.coins = coins;
                        // updateAchievementsDisplay(); // Fixed: function will be added
                    }
                }
            });
        }

        function generateAdvancedMissions() {
            const missionTypes = [
                { type: 'marathon', name: 'Maratón de {target} rebotes', reward: 'coins', base: 5000, scale: 2.0, difficulty: 'hard' },
                { type: 'collector', name: 'Colecciona {target} diamantes', reward: 'diamonds', base: 100, scale: 1.8, difficulty: 'extreme' },
                { type: 'speedrun', name: 'Alcanza nivel {target} rápido', reward: 'coins', base: 25, scale: 1.5, difficulty: 'medium' },
                { type: 'combo_master', name: 'Mantén combo {target}x', reward: 'diamonds', base: 30, scale: 1.6, difficulty: 'legendary' },
                { type: 'upgrader', name: 'Compra {target} mejoras', reward: 'coins', base: 20, scale: 1.4, difficulty: 'easy' },
                { type: 'prestige_rush', name: 'Haz {target} prestigios', reward: 'diamonds', base: 3, scale: 1.3, difficulty: 'mythic' }
            ];

            advancedMissions.forEach((mission, index) => {
                if (!mission.completed) {
                    const type = missionTypes[index % missionTypes.length];
                    mission.target = Math.floor(type.base * Math.pow(type.scale, missionSet - 1));
                    mission.reward = Math.floor(mission.target * (type.base / 10) * missionSet);
                    mission.name = type.name.replace('{target}', mission.target);
                    mission.rewardType = type.reward;
                    mission.difficulty = type.difficulty;
                    mission.progress = 0;
                }
            });

            updateAdvancedMissions();
        }

        function updateAdvancedMissions() {
            const container = document.getElementById('advancedMissionList');
            if (!container) return;

            container.innerHTML = '';
            advancedMissions.forEach((mission, index) => {
                const difficultyColors = {
                    'easy': '#4CAF50',
                    'medium': '#FF9800',
                    'hard': '#F44336',
                    'extreme': '#9C27B0',
                    'legendary': '#FF6B35',
                    'mythic': '#E91E63'
                };

                const div = document.createElement('div');
                div.className = `upgrade ${mission.difficulty === 'legendary' ? 'legendary-upgrade' : mission.difficulty === 'mythic' ? 'mythic-upgrade' : ''}`;
                div.innerHTML = `
                    <h4>${mission.name} <span style="color: ${difficultyColors[mission.difficulty]}">[${mission.difficulty.toUpperCase()}]</span></h4>
                    <p>Progreso: ${mission.progress}/${mission.target}</p>
                    <div style="background: #333; height: 8px; border-radius: 4px; margin: 5px 0;">
                        <div style="background: ${difficultyColors[mission.difficulty]}; height: 100%; width: ${(mission.progress / mission.target) * 100}%; border-radius: 4px;"></div>
                    </div>
                    <p>Recompensa: ${mission.reward} ${mission.rewardType}</p>
                    ${mission.completed ? '<button disabled>✓ Completada</button>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function updateExpandedChallenges() {
            const container = document.getElementById('expandedChallengesContainer');
            if (!container) return;

            container.innerHTML = '';

            if (currentDailyChallenge) {
                const div = document.createElement('div');
                div.className = 'upgrade';
                div.innerHTML = `
                    <h4>🎯 ${currentDailyChallenge.name} (ACTIVO)</h4>
                    <p>${currentDailyChallenge.desc}</p>
                    <p>Progreso: ${currentDailyChallenge.progress}/${currentDailyChallenge.target}</p>
                    <div style="background: #333; height: 8px; border-radius: 4px; margin: 5px 0;">
                        <div style="background: var(--success); height: 100%; width: ${(currentDailyChallenge.progress / currentDailyChallenge.target) * 100}%; border-radius: 4px;"></div>
                    </div>
                    <p style="color: var(--success);">Recompensa: ${currentDailyChallenge.reward} ${currentDailyChallenge.type}</p>
                `;
                container.appendChild(div);
            }

            dailyChallenges.forEach(challenge => {
                if (challenge !== currentDailyChallenge) {
                    const div = document.createElement('div');
                    div.className = 'upgrade';
                    div.style.opacity = challenge.completed ? '0.6' : '1';
                    div.innerHTML = `
                        <h4>${challenge.name} ${challenge.completed ? '✅' : ''}</h4>
                        <p>${challenge.desc}</p>
                        <p>Recompensa: ${challenge.reward} ${challenge.type}</p>
                        <div style="color: ${challenge.completed ? '#4CAF50' : '#888'};">Estado: ${challenge.completed ? 'Completado' : 'Disponible'}</div>
                    `;
                    container.appendChild(div);
                }
            });
        }

        function updateAchievementsDisplay() {
            achievements.forEach(achievement => {
                const element = document.getElementById(`achievement-${achievement.id}`);
                if (element) {
                    element.textContent = achievement.unlocked ? '✅ Completado' : '❌ Bloqueado';
                    element.style.color = achievement.unlocked ? '#4CAF50' : '#ff4444';
                }
            });
        }

        function updateEventsDisplay() {
            const nameEl = document.getElementById('eventName');
            const descEl = document.getElementById('eventDesc');
            const timerEl = document.getElementById('eventTimer');

            if (currentEvent) {
                nameEl.textContent = `🎪 ${currentEvent.name}`;
                descEl.textContent = currentEvent.desc;
                const minutes = Math.floor(eventTimeLeft / 60);
                const seconds = eventTimeLeft % 60;
                timerEl.textContent = `Tiempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                timerEl.style.color = '#4CAF50';
            } else {
                nameEl.textContent = 'Sin evento activo';
                descEl.textContent = 'Los eventos aparecen aleatoriamente cada ~100 segundos';
                timerEl.textContent = '';
            }
        }

        function generateEvent() {
            const events = [
                { name: 'Festival de Especias', desc: 'x2 especias por 1 hora', duration: 3600, effect: 'diamonds' },
                { name: 'Hora Pico del Restaurante', desc: 'x3 ingredientes por 30 min', duration: 1800, effect: 'coins' },
                { name: 'Chef en Racha', desc: 'Combo no decae por 45 min', duration: 2700, effect: 'combo' },
                { name: 'Cocina Rápida', desc: 'x5 velocidad por 20 min', duration: 1200, effect: 'speed' },
                { name: 'Platos Perfectos', desc: '100% platos perfectos por 15 min', duration: 900, effect: 'critical' },
                { name: 'Masterclass Culinaria', desc: 'x4 experiencia por 40 min', duration: 2400, effect: 'experience' },
                { name: 'Cocina Mágica', desc: '+10 especias por 25 min', duration: 1500, effect: 'magic' },
                { name: 'Inspección Michelin', desc: 'x10 a TODO por 5 min', duration: 300, effect: 'cosmic' }
            ];

            if (!currentEvent && Math.random() < 0.008) {
                currentEvent = events[Math.floor(Math.random() * events.length)];
                eventTimeLeft = currentEvent.duration;
                if (!gameData.events) gameData.events = { current: null, timeLeft: 0 };
                gameData.events.current = currentEvent;
                gameData.events.timeLeft = eventTimeLeft;
                betaStats.eventsTriggered++;
            }
        }

        function buyCard(cardId) {
            const card = cards.find(c => c.id === cardId);
            if (card && !card.owned && diamonds >= card.cost) {
                diamonds -= card.cost;
                card.owned = true;
                gameData.cards.push(cardId);
                showNotification(`🃏 Carta obtenida: ${card.name} `);
                updateUI();
            }
        }

        function buyPet(petId) {
            const pet = pets.find(p => p.id === petId);
            if (!pet) return;

            if (pet.premium && !premiumUnlocked) {
                showPremiumShop();
                return;
            }

            if (pet && !pet.owned && diamonds >= pet.cost) {
                diamonds -= pet.cost;
                pet.owned = true;
                gameData.pets.push(petId);
                gameData.diamonds = diamonds;
                showNotification(`🐾 Mascota obtenida: ${pet.name} `);
                updateUI();
            }
        }

        function buyArtifact(artifactId) {
            const artifact = artifacts.find(a => a.id === artifactId);
            if (artifact && !artifact.owned && diamonds >= artifact.cost) {
                diamonds -= artifact.cost;
                artifact.owned = true;
                gameData.artifacts.push(artifactId);
                if (artifactId === 'crown') gameData.infiniteLevels = true;
                showNotification(`⚡ Artefacto obtenido: ${artifact.name} `);
                updateUI();
            }
        }

        function syncCollectionData() {
            // Inicializar arrays si no existen
            if (!gameData.achievements) gameData.achievements = [];
            if (!gameData.cards) gameData.cards = [];
            if (!gameData.pets) gameData.pets = [];
            if (!gameData.artifacts) gameData.artifacts = [];

            // Sincronizar logros
            achievements.forEach(achievement => {
                if (gameData.achievements.includes(achievement.id)) {
                    achievement.unlocked = true;
                }
            });

            // Sincronizar cartas
            cards.forEach(card => {
                if (gameData.cards.includes(card.id)) {
                    card.owned = true;
                }
            });

            // Sincronizar mascotas
            pets.forEach(pet => {
                if (gameData.pets.includes(pet.id)) {
                    pet.owned = true;
                }
            });

            // Sincronizar artefactos
            artifacts.forEach(artifact => {
                if (gameData.artifacts.includes(artifact.id)) {
                    artifact.owned = true;
                }
            });
        }

        function applyCollectionEffects() {
            let coinMultiplier = 1;
            let expMultiplier = 1;
            let speedMultiplier = 1;

            // Asegurar que los arrays existen
            const cards = gameData.cards || [];
            const pets = gameData.pets || [];

            // Efectos de cartas
            if (cards.includes('coins')) coinMultiplier *= 1.25;
            if (cards.includes('speed')) speedMultiplier *= 1.1;
            if (cards.includes('experience')) expMultiplier *= 1.3;
            if (cards.includes('ultimate')) { coinMultiplier *= 2; expMultiplier *= 2; speedMultiplier *= 2; }

            // Efectos de mascotas
            if (pets.includes('cat')) expMultiplier *= 1.15;
            if (pets.includes('dragon')) coinMultiplier *= 1.3;
            if (pets.includes('phoenix')) speedMultiplier *= 1.2;
            if (pets.includes('unicorn')) coinMultiplier *= 1.25;
            if (pets.includes('kraken')) coinMultiplier *= 1.4;
            if (pets.includes('robot')) {
                // Robot recolector automático
                orbs.forEach((orb, index) => {
                    if (Math.random() < 0.02) {
                        collectOrb(orb);
                        orbs.splice(index, 1);
                    }
                });
            }
            if (pets.includes('ancientDragon')) {
                coinMultiplier *= 5;
                expMultiplier *= 5;
                speedMultiplier *= 2;
            }

            // Efectos de ascensión
            if (gameData.ascensionPoints > 0) {
                coinMultiplier *= Math.pow(2, gameData.ascensionPoints);
                expMultiplier *= Math.pow(2, gameData.ascensionPoints);
            }

            return { coinMultiplier, expMultiplier, speedMultiplier };
        }

        // Funciones faltantes
        function checkAchievements() { }
        function updateOrbs() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                orb.life -= 16;
                if (orb.life <= 0) orbs.splice(i, 1);
                if (orb.musical) orb.pulsePhase += 0.1;
            }
            if (Math.random() < 0.001 && orbs.length < 5) spawnRandomOrb();
        }

        function spawnRandomOrb() {
            const orbType = orbTypes[Math.floor(Math.random() * orbTypes.length)];
            orbs.push({
                x: Math.random() * (width - 100) + 50,
                y: Math.random() * (height - 100) + 50,
                radius: 15, type: orbType, alpha: 1,
                life: orbType.duration, maxLife: orbType.duration,
                pulsePhase: 0, musical: false
            });
        }

        function checkOrbCollisions() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                const distance = Math.sqrt(Math.pow(ball.x - orb.x, 2) + Math.pow(ball.y - orb.y, 2));
                if (distance < ball.radius + orb.radius) {
                    collectOrb(orb);
                    orbs.splice(i, 1);
                }
            }
        }

        function collectOrb(orb) {
            activeOrbEffects.push({
                type: orb.type.effect, name: orb.type.name,
                power: orb.type.power, timeLeft: orb.type.duration,
                color: orb.type.color
            });

            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: orb.x + (Math.random() - 0.5) * 30,
                    y: orb.y + (Math.random() - 0.5) * 30,
                    dx: (Math.random() - 0.5) * 15,
                    dy: (Math.random() - 0.5) * 15,
                    life: 2000, maxLife: 2000, alpha: 1,
                    color: orb.type.color
                });
            }

            switch (orb.type.effect) {
                case 'speed':
                    ball.dx *= orb.type.power;
                    ball.dy *= orb.type.power;
                    break;
                case 'coins':
                    coins += Math.floor(level * orb.type.power * 2);
                    gameData.coins = coins;
                    break;
                case 'diamonds':
                    diamonds += Math.floor(orb.type.power * 0.5);
                    gameData.diamonds = diamonds;
                    break;
                case 'combo':
                    combo += orb.type.power;
                    break;
                case 'experience':
                    experience += Math.floor(level * orb.type.power * 3);
                    gameData.experience = experience;
                    break;
            }

            betaStats.orbsCollected++;
            updateUI();
        }

        function updateOrbEffects() {
            activeOrbEffects.forEach((effect, index) => {
                effect.timeLeft -= 16;
                if (effect.timeLeft <= 0) {
                    if (effect.type === 'speed') {
                        ball.dx /= effect.power;
                        ball.dy /= effect.power;
                    } else if (effect.type === 'time') {
                        gameSpeed = 1;
                    }
                    activeOrbEffects.splice(index, 1);
                }
            });
        }

        function checkDateEvents() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const dayOfWeek = now.getDay();

            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return { name: 'Fin de Semana', desc: 'x2 monedas', multiplier: 2, type: 'coins' };
            }
            if (month === 10) {
                return { name: 'Halloween', desc: '+50% diamantes', multiplier: 1.5, type: 'diamonds' };
            }
            if (month === 12) {
                return { name: 'Navidad', desc: 'x3 experiencia', multiplier: 3, type: 'experience' };
            }
            return null;
        }

        // Funciones placeholder
        function updateAfkSystem() { }
        function resetAfkTimer() { }
        function handleVisibilityChange() { }
        function handleWindowBlur() { }
        function handleWindowFocus() { }
        function redeemCode() { }
        function claimAfkRewards() { }
        function buyAutoClicker() { }
        function doAscension() { }
        function buyAscensionUpgrade() { }
        function generateAdvancedMissions() { }
        function updateDailyChallengesDisplay() { }
        function selectRandomDailyChallenge() { }
        function updateDailyChallenges() { }

        function saveToSlot() {
            const slot = document.getElementById('saveSlot').value;
            const saveData = {
                coins, diamonds, experience, bounces, level,
                prestige: gameData.prestige, prestigePoints: gameData.prestigePoints,
                achievements: gameData.achievements, upgrades: gameData.upgrades,
                timestamp: Date.now()
            };
            localStorage.setItem(`circleBounceUltimate_slot${slot}`, JSON.stringify(saveData));
            showNotification(`Guardado en Slot ${slot}`);
        }

        function loadFromSlot() {
            const slot = document.getElementById('saveSlot').value;
            const saved = localStorage.getItem(`circleBounceUltimate_slot${slot}`);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    coins = data.coins || 0;
                    diamonds = data.diamonds || 0;
                    experience = data.experience || 0;
                    bounces = data.bounces || 0;
                    level = data.level || 1;
                    gameData = { ...gameData, ...data };
                    updateUI();
                    showNotification(`Cargado desde Slot ${slot}`);
                } catch (error) {
                    showNotification('Error al cargar slot');
                }
            }
        }

        // Inicializar generadores automáticos
        setInterval(generateResources, 1000);
        setInterval(generateEvent, 1000);

        // Inicializar el juego cuando se carga la página
        window.addEventListener('load', () => {
            dateEvent = checkDateEvents();
            init();
            loadConfig();
            generateMissions();
            generateAdvancedMissions();
            syncCollectionData();
            updateDailyChallengesDisplay();
            selectRandomDailyChallenge();
            setInterval(updateResetTimer, 1000);

            // Configurar listeners de música
            if (document.getElementById('musicPanel')) {
                setupMusicEventListeners();
            }

            // Mostrar primer tip después de 30 segundos
            setTimeout(showRandomTip, 30000);

            const autoSaveInterval = 10000;
            setInterval(autoSave, autoSaveInterval);
            console.log('Auto-guardado iniciado cada 10 segundos');

            setTimeout(() => {
                const arrow = document.getElementById('controlsArrow');
                if (arrow) arrow.style.display = 'none';
            }, 15000);

            document.getElementById('controls').addEventListener('click', () => {
                const arrow = document.getElementById('controlsArrow');
                if (arrow) arrow.style.display = 'none';
            });
        });

        window.addEventListener('error', (e) => {
            betaStats.crashes++;
            console.error('ERROR:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error?.stack,
                gameState: { level, coins, diamonds, prestige: gameData.prestige }
            });
        });
        // Sistema de música simplificado
        function setupMusicEventListeners() {
            setTimeout(() => {
                const musicFile = document.getElementById('musicFile');
                const playBtn = document.getElementById('playPauseBtn');
                const stopBtn = document.getElementById('stopBtn');
                const sensitivity = document.getElementById('musicSensitivity');
                const theme = document.getElementById('musicTheme');

                if (musicFile) {
                    musicFile.addEventListener('change', (e) => {
                        if (e.target.files[0]) {
                            loadMusicFile(e.target.files[0]);
                        }
                    });
                }

                if (playBtn) {
                    playBtn.addEventListener('click', toggleMusic);
                }

                if (stopBtn) {
                    stopBtn.addEventListener('click', stopMusic);
                }

                if (sensitivity) {
                    sensitivity.addEventListener('input', (e) => {
                        musicSensitivity = parseFloat(e.target.value);
                    });
                }

                if (theme) {
                    theme.addEventListener('change', (e) => {
                        musicTheme = e.target.value;
                    });
                }
            }, 100);
        }

        function loadMusicFile(file) {
            if (audioSource) {
                audioSource.pause();
                URL.revokeObjectURL(audioSource.src);
            }

            const url = URL.createObjectURL(file);
            audioSource = new Audio(url);
            audioSource.loop = true;

            audioSource.addEventListener('loadedmetadata', () => {
                showNotification(`🎵 Cargado: ${file.name}`);
            });
        }

        function toggleMusic() {
            if (!audioSource) {
                showNotification('⚠️ Carga un archivo de música primero');
                return;
            }

            const playBtn = document.getElementById('playPauseBtn');

            if (audioSource.paused) {
                audioSource.play();
                playBtn.textContent = '⏸️ Pause';
                if (musicMode) {
                    initAudioContext();
                }
            } else {
                audioSource.pause();
                playBtn.textContent = '▶️ Play';
            }
        }

        function stopMusic() {
            if (audioSource) {
                audioSource.pause();
                audioSource.currentTime = 0;
                document.getElementById('playPauseBtn').textContent = '▶️ Play';
            }
        }

        function initAudioContext() {
            if (!audioContext && audioSource) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    frequencyData = new Uint8Array(analyser.frequencyBinCount);

                    const source = audioContext.createMediaElementSource(audioSource);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                } catch (error) {
                    console.warn('Error inicializando audio:', error);
                }
            }
        }

        function resetSensitivity() {
            musicSensitivity = 1.0;
            document.getElementById('musicSensitivity').value = 1.0;
            musicBeatMultiplier = 1.0;
        }

        function applyMusicTheme() {
            const themes = {
                disco: { hueShift: 0, saturation: 1.5, brightness: 1.2 },
                rock: { hueShift: 30, saturation: 1.8, brightness: 0.9 },
                electronic: { hueShift: 180, saturation: 2.0, brightness: 1.4 },
                chill: { hueShift: 240, saturation: 0.8, brightness: 0.7 }
            };

            const theme = themes[musicTheme] || themes.disco;
            document.documentElement.style.setProperty('--music-hue-shift', theme.hueShift);
            document.documentElement.style.setProperty('--music-saturation', theme.saturation);
            document.documentElement.style.setProperty('--music-brightness', theme.brightness);
        }

        // Funciones de orbes
        function updateOrbs() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                orb.life -= 16;
                orb.alpha = orb.life / orb.maxLife;

                if (orb.musical) {
                    orb.pulsePhase += 0.1;
                }

                if (orb.life <= 0) {
                    orbs.splice(i, 1);
                }
            }

            // Generar orbes aleatorios
            if (Math.random() < 0.002) {
                spawnRandomOrb();
            }
        }

        function spawnRandomOrb() {
            const orbType = orbTypes[Math.floor(Math.random() * orbTypes.length)];
            orbs.push({
                x: Math.random() * (width - 100) + 50,
                y: Math.random() * (height - 100) + 50,
                radius: 15,
                type: orbType,
                alpha: 1,
                life: orbType.duration,
                maxLife: orbType.duration
            });
        }

        function checkOrbCollisions() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                const distance = Math.sqrt((ball.x - orb.x) ** 2 + (ball.y - orb.y) ** 2);

                if (distance < ball.radius + orb.radius) {
                    collectOrb(orb);
                    orbs.splice(i, 1);
                }
            }
        }

        function collectOrb(orb) {
            activeOrbEffects.push({
                type: orb.type.effect,
                name: orb.type.name,
                power: orb.type.power,
                timeLeft: orb.type.duration,
                color: orb.type.color
            });

            switch (orb.type.effect) {
                case 'speed':
                    ball.dx *= orb.type.power;
                    ball.dy *= orb.type.power;
                    break;
                case 'coins':
                    coins += Math.floor(level * orb.type.power * 10);
                    gameData.coins = coins;
                    break;
                case 'diamonds':
                    diamonds += orb.type.power;
                    gameData.diamonds = diamonds;
                    break;
                case 'combo':
                    combo += orb.type.power;
                    break;
                case 'experience':
                    experience += Math.floor(level * orb.type.power * 3);
                    gameData.experience = experience;
                    break;
            }

            betaStats.orbsCollected++;
            updateUI();
        }

        // Sistema BPM y efectos musicales
        function updateMusicEffects() {
            if (!musicMode || !analyser || !audioSource || audioSource.paused) return;

            analyser.getByteFrequencyData(frequencyData);
            const intensity = frequencyData.reduce((sum, v) => sum + v, 0) / frequencyData.length / 255 * musicSensitivity;

            detectBeatAndBPM(intensity);

            if (intensity > 0.6) {
                musicBeatMultiplier = 1 + (intensity * 0.5);
                canvas.style.transform = `scale(${1 + intensity * 0.1})`;
                setTimeout(() => canvas.style.transform = 'scale(1)', 100);
            }
        }

        function detectBeatAndBPM(intensity) {
            const now = Date.now();

            if (bpmMode === 'manual') {
                const manualInput = document.getElementById('manualBpm');
                if (manualInput && !manualInput.disabled) {
                    manualBPM = parseInt(manualInput.value) || 120;
                    musicBPM = manualBPM;
                }

                const beatInterval = 60000 / manualBPM;
                if (now - lastBeatTime > beatInterval * 0.8) {
                    lastBeatTime = now;
                    musicBeatMultiplier = 1 + (0.8 * musicSensitivity * 0.5);
                }
                return;
            }

            if (intensity > 0.7 && now - lastBeatTime > 200) {
                beatHistory.push(now);
                lastBeatTime = now;

                if (beatHistory.length > 8) beatHistory.shift();

                if (beatHistory.length >= 4) {
                    const intervals = [];
                    for (let i = 1; i < beatHistory.length; i++) {
                        intervals.push(beatHistory[i] - beatHistory[i - 1]);
                    }
                    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                    musicBPM = Math.round(60000 / avgInterval);
                }
            }
        }

        function toggleBpmMode() {
            bpmMode = document.getElementById('bpmMode')?.value || 'auto';
            const manualInput = document.getElementById('manualBpm');

            if (bpmMode === 'manual' && manualInput) {
                manualInput.disabled = false;
                manualBPM = parseInt(manualInput.value) || 120;
                musicBPM = manualBPM;
            } else if (manualInput) {
                manualInput.disabled = true;
            }
        }

        // Sistema de tips aleatorios
        const gameTips = [
            '💡 Los orbes dorados dan más ingredientes',
            '🎵 La música reactiva multiplica tus ganancias',
            '⭐ El prestigio te da bonificadores permanentes',
            '🔥 Los combos altos aumentan las recompensas',
            '🎯 Completa misiones para obtener bonus',
            '💰 Guarda especias para mejoras avanzadas',
            '🎲 Los códigos especiales dan recompensas únicas',
            '🚀 El modo rendimiento mejora el FPS en móviles'
        ];

        function showRandomTip() {
            const tip = gameTips[Math.floor(Math.random() * gameTips.length)];
            showNotification(tip);
        }

        // Mostrar tip cada 2 minutos
        setInterval(showRandomTip, 120000);
        
        // Contador de reproducción musical
        function updateMusicProgress() {
            if (!audioSource || !audioSource.duration) return;
            
            const current = audioSource.currentTime || 0;
            const duration = audioSource.duration || 0;
            const progress = duration > 0 ? (current / duration) * 100 : 0;
            
            const progressBar = document.getElementById('musicProgressBar');
            if (progressBar) progressBar.style.width = progress + '%';
            
            const currentMin = Math.floor(current / 60);
            const currentSec = Math.floor(current % 60);
            const totalMin = Math.floor(duration / 60);
            const totalSec = Math.floor(duration % 60);
            
            const timeEl = document.getElementById('musicTime');
            if (timeEl && !isNaN(duration) && duration > 0) {
                timeEl.textContent = `${currentMin}:${currentSec.toString().padStart(2, '0')} / ${totalMin}:${totalSec.toString().padStart(2, '0')}`;
            }
        }
        
        // Iniciar progreso cuando se carga música
        function startMusicProgress() {
            if (window.musicProgressInterval) {
                clearInterval(window.musicProgressInterval);
            }
            window.musicProgressInterval = setInterval(updateMusicProgress, 100);
        }
        
        // MODO MÚSICA LOCURA - Efectos extremos
        function updateMusicEffects() {
            if (!musicMode || !analyser || !audioSource || audioSource.paused) {
                resetMusicEffects();
                return;
            }
            
            analyser.getByteFrequencyData(frequencyData);
            
            const bass = frequencyData.slice(0, 32).reduce((sum, v) => sum + v, 0) / 32 / 255;
            const mid = frequencyData.slice(32, 128).reduce((sum, v) => sum + v, 0) / 96 / 255;
            const high = frequencyData.slice(128, 256).reduce((sum, v) => sum + v, 0) / 128 / 255;
            const intensity = (bass + mid + high) / 3 * musicSensitivity;
            
            detectBeatAndBPM(intensity);
            
            // Calcular timing basado en BPM actual
            const bpmFactor = musicBPM / 120; // Factor de velocidad
            const beatDuration = Math.max(50, 200 / bpmFactor); // Duración adaptada al BPM
            
            // EFECTOS EXTREMOS POR INTENSIDAD
            if (intensity > 0.9) {
                // 🔥 MODO APOCALIPSIS - BPM extremo
                const crazyZoom = 1 + intensity * 0.8;
                const crazyRotation = intensity * 45 * bpmFactor;
                canvas.style.transform = `scale(${crazyZoom}) rotate(${crazyRotation}deg) skew(${intensity * 15}deg)`;
                canvas.style.filter = `hue-rotate(${intensity * 720}deg) saturate(${2 + intensity * 2}) contrast(${1 + intensity}) brightness(${1 + intensity})`;
                
                // Pantalla completa loca
                document.body.style.background = `radial-gradient(circle, hsl(${intensity * 360}, 100%, ${intensity * 80}%), hsl(${(intensity * 360 + 180) % 360}, 100%, ${intensity * 40}%))`;
                document.body.style.filter = `invert(${intensity}) sepia(${intensity})`;
                
                // UI completamente loca
                ['ui', 'currency-display', 'controls'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.transform = `translate(${(Math.random() - 0.5) * 30}px, ${(Math.random() - 0.5) * 30}px) rotate(${(Math.random() - 0.5) * 20}deg)`;
                        el.style.filter = `hue-rotate(${Math.random() * 360}deg) saturate(${2 + Math.random()})`;
                    }
                });
                
                setTimeout(() => resetVisualEffects(), beatDuration);
                
            } else if (intensity > 0.8) {
                // 🌪️ MODO TORMENTA - BPM alto
                const stormZoom = 1 + intensity * 0.5;
                const stormRotation = intensity * 25 * bpmFactor;
                canvas.style.transform = `scale(${stormZoom}) rotate(${stormRotation}deg)`;
                canvas.style.filter = `hue-rotate(${intensity * 540}deg) saturate(${1.5 + intensity}) brightness(${1.2 + intensity * 0.5})`;
                
                // Efecto estroboscópico adaptado al BPM
                const strobeSpeed = Math.max(50, 150 / bpmFactor);
                document.body.style.background = `linear-gradient(${intensity * 180}deg, hsl(${intensity * 360}, 90%, ${40 + intensity * 40}%), hsl(${(intensity * 360 + 120) % 360}, 90%, ${30 + intensity * 30}%))`;
                
                // UI vibrando al ritmo
                ['ui', 'currency-display', 'controls'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.transform = `translate(${(Math.random() - 0.5) * 15}px, ${(Math.random() - 0.5) * 15}px)`;
                        el.style.boxShadow = `0 0 ${20 + intensity * 30}px hsl(${intensity * 360}, 100%, 50%)`;
                    }
                });
                
                setTimeout(() => resetVisualEffects(), beatDuration);
                
            } else if (intensity > 0.6) {
                // ⚡ MODO ENERGÍA - BPM medio
                const energyZoom = 1 + intensity * 0.3;
                const energyRotation = intensity * 15 * bpmFactor;
                canvas.style.transform = `scale(${energyZoom}) rotate(${energyRotation}deg)`;
                canvas.style.filter = `hue-rotate(${intensity * 360}deg) saturate(${1.2 + intensity * 0.5}) brightness(${1.1 + intensity * 0.3})`;
                
                // Fondo pulsante
                document.body.style.background = `radial-gradient(ellipse at center, hsl(${intensity * 360}, 70%, ${25 + intensity * 25}%), transparent)`;
                
                // UI con glow
                ['ui', 'currency-display', 'controls'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.boxShadow = `0 0 ${15 + intensity * 20}px hsl(${intensity * 360}, 80%, 60%)`;
                        el.style.borderColor = `hsl(${intensity * 360}, 100%, 70%)`;
                    }
                });
                
                setTimeout(() => resetVisualEffects(), beatDuration);
                
            } else if (intensity > 0.4) {
                // 🎵 MODO SUAVE - BPM bajo
                const softZoom = 1 + intensity * 0.15;
                canvas.style.transform = `scale(${softZoom})`;
                canvas.style.filter = `hue-rotate(${intensity * 180}deg) brightness(${1 + intensity * 0.2})`;
                
                setTimeout(() => resetVisualEffects(), beatDuration * 1.5);
            }
            
            // EFECTOS EN LA PELOTA - Adaptados al BPM
            if (intensity > 0.5) {
                const hueShift = (bass * 120 + mid * 240 + high * 360) % 360;
                ball.color = `hsl(${hueShift}, ${80 + intensity * 20}%, ${50 + intensity * 30}%)`;
                
                // Tamaño pulsante al BPM
                const baseBallSize = 20 + gameData.upgrades.size.level * 2;
                const pulseFactor = 1 + (intensity * 0.8 * Math.sin(Date.now() * bpmFactor / 100));
                ball.radius = baseBallSize * pulseFactor;
                
                // Velocidad adaptada al BPM
                const speedMultiplier = 1 + (intensity * 0.5 * bpmFactor);
                if (Math.abs(ball.dx) < ball.maxSpeed && Math.abs(ball.dy) < ball.maxSpeed) {
                    ball.dx *= speedMultiplier;
                    ball.dy *= speedMultiplier;
                }
            }
            
            // PARTÍCULAS LOCAS
            if (intensity > 0.7) {
                createCrazyMusicParticles(intensity, bass, mid, high, bpmFactor);
            }
            
            // MULTIPLICADORES EXTREMOS
            musicBeatMultiplier = 1 + (intensity * 1.5 * bpmFactor);
            
            // Actualizar displays con efectos
            updateMusicDisplays(intensity, bpmFactor);
        }
        
        function resetVisualEffects() {
            canvas.style.transform = 'scale(1) rotate(0deg)';
            canvas.style.filter = '';
            document.body.style.background = '';
            document.body.style.filter = '';
            
            ['ui', 'currency-display', 'controls'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.transform = '';
                    el.style.filter = '';
                    el.style.boxShadow = '';
                    el.style.borderColor = '';
                }
            });
        }
        
        function createCrazyMusicParticles(intensity, bass, mid, high, bpmFactor) {
            const count = Math.floor(10 + intensity * 30 * bpmFactor);
            
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: ball.x + (Math.random() - 0.5) * 100,
                    y: ball.y + (Math.random() - 0.5) * 100,
                    dx: (Math.random() - 0.5) * 50 * bpmFactor,
                    dy: (Math.random() - 0.5) * 50 * bpmFactor,
                    life: 300 + intensity * 1000,
                    maxLife: 300 + intensity * 1000,
                    alpha: 1,
                    color: `hsl(${(bass * 60 + mid * 180 + high * 300 + i * 20) % 360}, 100%, ${60 + intensity * 40}%)`,
                    size: 3 + intensity * 8,
                    musical: true,
                    crazy: true
                });
            }
        }
        
        function updateMusicDisplays(intensity, bpmFactor) {
            const intensityEl = document.getElementById('musicIntensity');
            const beatMultEl = document.getElementById('musicBeatMultiplier');
            const bpmEl = document.getElementById('musicBPM');
            
            if (intensityEl) {
                intensityEl.textContent = Math.round(intensity * 100);
                intensityEl.style.color = `hsl(${intensity * 120}, 100%, ${50 + intensity * 30}%)`;
                intensityEl.style.textShadow = `0 0 ${5 + intensity * 10}px currentColor`;
            }
            
            if (beatMultEl) {
                beatMultEl.textContent = 'x' + musicBeatMultiplier.toFixed(1);
                beatMultEl.style.color = `hsl(${intensity * 240}, 100%, ${60 + intensity * 20}%)`;
                beatMultEl.style.transform = `scale(${1 + intensity * 0.3})`;
            }
            
            if (bpmEl) {
                bpmEl.textContent = musicBPM + ' BPM';
                bpmEl.style.color = `hsl(${bpmFactor * 60}, 100%, ${50 + bpmFactor * 30}%)`;
                if (intensity > 0.8) {
                    bpmEl.style.animation = `pulse ${60000 / musicBPM}ms infinite`;
                }
            }
        }
        
        function resetMusicEffects() {
            musicBeatMultiplier = 1.0;
            musicComboStreak = 0;
            
            // Resetear todos los efectos visuales
            resetVisualEffects();
            
            // Resetear pelota
            ball.color = '#ff6b35';
            ball.radius = 20 + gameData.upgrades.size.level * 2;
            
            // Resetear displays
            ['musicIntensity', 'musicBeatMultiplier', 'musicBPM'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.color = '';
                    el.style.textShadow = '';
                    el.style.transform = '';
                    el.style.animation = '';
                }
            });
        }
        
        // Función para cargar música con procesamiento y modo fiesta
        function loadMusicFile(file) {
            if (audioSource) {
                audioSource.pause();
                if (audioSource.src && audioSource.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audioSource.src);
                }
            }
            
            showNotification('🎵 Procesando canción...');
            
            try {
                const url = URL.createObjectURL(file);
                audioSource = new Audio();
                audioSource.crossOrigin = 'anonymous';
                audioSource.loop = true;
                audioSource.src = url;
                
                audioSource.addEventListener('loadedmetadata', () => {
                    const duration = audioSource.duration;
                    const fileName = file.name.replace(/\.[^/.]+$/, "");
                    
                    if (duration && !isNaN(duration)) {
                        const minutes = Math.floor(duration / 60);
                        const seconds = Math.floor(duration % 60);
                        showNotification(`✅ ${fileName} - ${minutes}:${seconds.toString().padStart(2, '0')} procesada`);
                        updateMusicProgress();
                    } else {
                        showNotification(`⚠️ No se pudo procesar ${fileName} - Activando MODO FIESTA 🎉`);
                        activatePartyMode();
                    }
                });
                
                audioSource.addEventListener('error', (e) => {
                    console.warn('Error de audio:', e);
                    showNotification(`❌ Error procesando ${file.name} - Activando MODO FIESTA 🎉`);
                    activatePartyMode();
                });
                
                audioSource.addEventListener('play', () => {
                    startMusicProgress();
                });
                
                audioSource.addEventListener('pause', () => {
                    if (window.musicProgressInterval) {
                        clearInterval(window.musicProgressInterval);
                        window.musicProgressInterval = null;
                    }
                });
                
                // Precargar metadatos
                audioSource.load();
                
            } catch (error) {
                console.warn('Error creando blob URL:', error);
                showNotification(`❌ Error de seguridad - Activando MODO FIESTA 🎉`);
                activatePartyMode();
            }
        }
        
        function activatePartyMode() {
            musicMode = true;
            document.getElementById('musicMode').checked = true;
            
            window.partyModeInterval = setInterval(() => {
                if (!musicMode) {
                    clearInterval(window.partyModeInterval);
                    return;
                }
                
                const fakeIntensity = 0.7 + Math.random() * 0.3;
                const fakeBPM = 120 + Math.random() * 60;
                
                const partyZoom = 1 + fakeIntensity * 0.4;
                const partyRotation = fakeIntensity * 20;
                canvas.style.transform = `scale(${partyZoom}) rotate(${partyRotation}deg)`;
                canvas.style.filter = `hue-rotate(${fakeIntensity * 360}deg) saturate(${1.5 + fakeIntensity})`;
                
                document.body.style.background = `linear-gradient(${fakeIntensity * 180}deg, hsl(${fakeIntensity * 360}, 90%, ${40 + fakeIntensity * 30}%), hsl(${(fakeIntensity * 360 + 120) % 360}, 90%, ${30 + fakeIntensity * 20}%))`;
                
                ['ui', 'currency-display', 'controls'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.boxShadow = `0 0 ${15 + fakeIntensity * 25}px hsl(${fakeIntensity * 360}, 100%, 60%)`;
                        el.style.borderColor = `hsl(${fakeIntensity * 360}, 100%, 70%)`;
                    }
                });
                
                ball.color = `hsl(${fakeIntensity * 360}, 100%, ${50 + fakeIntensity * 30}%)`;
                ball.radius = (20 + gameData.upgrades.size.level * 2) * (1 + fakeIntensity * 0.3);
                
                for (let i = 0; i < 5; i++) {
                    particles.push({
                        x: ball.x + (Math.random() - 0.5) * 80,
                        y: ball.y + (Math.random() - 0.5) * 80,
                        dx: (Math.random() - 0.5) * 30,
                        dy: (Math.random() - 0.5) * 30,
                        life: 800,
                        maxLife: 800,
                        alpha: 1,
                        color: `hsl(${Math.random() * 360}, 100%, ${60 + Math.random() * 40}%)`,
                        size: 4 + Math.random() * 6,
                        musical: true,
                        party: true
                    });
                }
                
                musicBeatMultiplier = 1 + (fakeIntensity * 1.2);
                const intensityEl = document.getElementById('musicIntensity');
                const beatMultEl = document.getElementById('musicBeatMultiplier');
                const bpmEl = document.getElementById('musicBPM');
                const timeEl = document.getElementById('musicTime');
                
                if (intensityEl) intensityEl.textContent = Math.round(fakeIntensity * 100);
                if (beatMultEl) beatMultEl.textContent = 'x' + musicBeatMultiplier.toFixed(1);
                if (bpmEl) bpmEl.textContent = Math.round(fakeBPM) + ' BPM (FIESTA)';
                if (timeEl) timeEl.textContent = '🎉 MODO FIESTA 🎉';
                
                setTimeout(() => {
                    canvas.style.transform = 'scale(1) rotate(0deg)';
                    canvas.style.filter = '';
                    document.body.style.background = '';
                    
                    ['ui', 'currency-display', 'controls'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.style.boxShadow = '';
                            el.style.borderColor = '';
                        }
                    });
                }, 200);
                
            }, 300 + Math.random() * 200);
            
            showNotification('🎉 MODO FIESTA ACTIVADO - Efectos sin audio!');
        }
        
        // ORBS SYSTEM FIXES
        function updateOrbs() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                if (!orb) continue;
                
                orb.life -= 16;
                orb.alpha = Math.max(0, orb.life / orb.maxLife);
                
                if (orb.musical) {
                    orb.pulsePhase = (orb.pulsePhase || 0) + 0.1;
                }

                if (orb.life <= 0) {
                    orbs.splice(i, 1);
                }
            }

            if (Math.random() < 0.003 + (level * 0.0001)) {
                spawnOrb();
            }
            
            if (musicMode && Math.random() < 0.001) {
                spawnMusicOrb(0.5);
            }
        }

        function checkOrbCollisions() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                if (!orb) continue;
                
                const distance = Math.sqrt((ball.x - orb.x) ** 2 + (ball.y - orb.y) ** 2);

                if (distance < ball.radius + orb.radius) {
                    collectOrb(orb);
                    orbs.splice(i, 1);
                }
            }
        }

        function spawnOrb() {
            const orbType = orbTypes[Math.floor(Math.random() * orbTypes.length)];
            orbs.push({
                x: Math.random() * (width - 100) + 50,
                y: Math.random() * (height - 100) + 50,
                radius: 15,
                type: orbType,
                alpha: 1,
                life: 8000,
                maxLife: 8000,
                pulsePhase: 0,
                musical: false
            });
        }

        function collectOrb(orb) {
            if (!orb || !orb.type) return;
            
            const effect = {
                type: orb.type.effect,
                power: orb.type.power,
                duration: orb.type.duration,
                timeLeft: orb.type.duration,
                name: orb.type.name,
                color: orb.type.color
            };

            activeOrbEffects.push(effect);
            betaStats.orbsCollected++;

            switch (orb.type.effect) {
                case 'speed':
                    ball.dx *= orb.type.power;
                    ball.dy *= orb.type.power;
                    break;
                case 'coins':
                    coins += Math.floor(100 * orb.type.power);
                    gameData.coins = coins;
                    break;
                case 'diamonds':
                    diamonds += Math.floor(orb.type.power);
                    gameData.diamonds = diamonds;
                    break;
                case 'combo':
                    combo = Math.min(combo * orb.type.power, 20);
                    break;
                case 'experience':
                    experience += Math.floor(200 * orb.type.power);
                    gameData.experience = experience;
                    break;
                case 'time':
                    gameSpeed *= orb.type.power;
                    break;
                case 'rainbow':
                    coins += Math.floor(500 * orb.type.power);
                    diamonds += Math.floor(5 * orb.type.power);
                    experience += Math.floor(1000 * orb.type.power);
                    gameData.coins = coins;
                    gameData.diamonds = diamonds;
                    gameData.experience = experience;
                    break;
                case 'beat':
                case 'bass':
                case 'melody':
                    musicBeatMultiplier += orb.type.power;
                    musicComboStreak += 5;
                    break;
            }

            createParticles(orb.x, orb.y);
            showNotification(`🔮 ${orb.type.name} recogido!`);
            updateUI();
        }

        function updateOrbEffects() {
            for (let i = activeOrbEffects.length - 1; i >= 0; i--) {
                const effect = activeOrbEffects[i];
                if (!effect) continue;
                
                effect.timeLeft -= 16;

                if (effect.timeLeft <= 0) {
                    switch (effect.type) {
                        case 'speed':
                            ball.dx /= effect.power;
                            ball.dy /= effect.power;
                            break;
                        case 'time':
                            gameSpeed /= effect.power;
                            break;
                        case 'beat':
                        case 'bass':
                        case 'melody':
                            musicBeatMultiplier = Math.max(1, musicBeatMultiplier - effect.power);
                            break;
                    }
                    activeOrbEffects.splice(i, 1);
                }
            }
        }
        
        // MISSING FUNCTIONS
        function startMusicProgress() {
            if (window.musicProgressInterval) {
                clearInterval(window.musicProgressInterval);
            }
            window.musicProgressInterval = setInterval(() => {
                updateMusicProgress();
            }, 100);
        }

        function applyCollectionEffects() {
            let coinMultiplier = 1;
            let expMultiplier = 1;
            
            if (gameData.cards && gameData.cards.includes('coins')) coinMultiplier *= 1.25;
            if (gameData.cards && gameData.cards.includes('experience')) expMultiplier *= 1.3;
            if (gameData.cards && gameData.cards.includes('ultimate')) {
                coinMultiplier *= 2;
                expMultiplier *= 2;
            }
            
            if (gameData.pets && gameData.pets.includes('dragon')) coinMultiplier *= 1.3;
            if (gameData.pets && gameData.pets.includes('cat')) expMultiplier *= 1.15;
            if (gameData.pets && gameData.pets.includes('ancientDragon')) {
                coinMultiplier *= 5;
                expMultiplier *= 5;
            }
            
            return { coinMultiplier, expMultiplier };
        }

        function checkAchievements() {
            achievements.forEach(achievement => {
                if (achievement.unlocked) return;
                
                let currentValue = 0;
                switch (achievement.type) {
                    case 'bounces': currentValue = bounces; break;
                    case 'coins': currentValue = coins; break;
                    case 'diamonds': currentValue = diamonds; break;
                    case 'level': currentValue = level; break;
                    case 'prestige': currentValue = gameData.prestige; break;
                    case 'combo': currentValue = combo; break;
                    case 'speed': currentValue = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy); break;
                    case 'size': currentValue = ball.radius; break;
                    case 'ascension': currentValue = gameData.ascension; break;
                }
                
                if (currentValue >= achievement.target) {
                    achievement.unlocked = true;
                    coins += achievement.reward;
                    gameData.coins = coins;
                    gameData.achievements = gameData.achievements || [];
                    if (!gameData.achievements.includes(achievement.id)) {
                        gameData.achievements.push(achievement.id);
                        showNotification(`🏆 Logro desbloqueado: ${achievement.name}! +${achievement.reward} coins`);
                    }
                }
            });
        }

        function updateStats() {
            const playTime = Math.floor((Date.now() - playTimeStart) / 60000);
            const sessionTime = Math.floor((Date.now() - betaStats.sessionStart) / 60000);
            
            const totalBouncesEl = document.getElementById('totalBounces');
            const totalCoinsEl = document.getElementById('totalCoins');
            const playTimeEl = document.getElementById('playTime');
            const bestComboEl = document.getElementById('bestCombo');
            const sessionTimeEl = document.getElementById('sessionTime');
            const totalOrbsEl = document.getElementById('totalOrbs');
            const codesRedeemedEl = document.getElementById('codesRedeemed');
            const eventsTriggeredEl = document.getElementById('eventsTriggered');
            const crashCountEl = document.getElementById('crashCount');
            const particleCounterEl = document.getElementById('particleCounter');
            
            if (totalBouncesEl) totalBouncesEl.textContent = formatNumber(totalBounces + bounces);
            if (totalCoinsEl) totalCoinsEl.textContent = formatNumber(totalCoins + coins);
            if (playTimeEl) playTimeEl.textContent = playTime + 'm';
            if (bestComboEl) bestComboEl.textContent = Math.max(bestCombo, combo).toFixed(1) + 'x';
            if (sessionTimeEl) sessionTimeEl.textContent = sessionTime + 'm';
            if (totalOrbsEl) totalOrbsEl.textContent = betaStats.orbsCollected;
            if (codesRedeemedEl) codesRedeemedEl.textContent = redeemedCodes.length;
            if (eventsTriggeredEl) eventsTriggeredEl.textContent = betaStats.eventsTriggered;
            if (crashCountEl) crashCountEl.textContent = betaStats.crashes;
            if (particleCounterEl) particleCounterEl.textContent = particles.length;
        }

        function updateMissions() {
            const missionList = document.getElementById('missionList');
            if (!missionList) return;
            
            missionList.innerHTML = '';
            
            Object.entries(missions).forEach(([key, mission]) => {
                const div = document.createElement('div');
                div.className = 'upgrade';
                div.innerHTML = `
                    <h4>${getMissionName(key)}</h4>
                    <p>Progreso: ${mission.progress}/${mission.target}</p>
                    <p>Recompensa: ${mission.reward} ${key === 'diamonds' ? 'diamantes' : 'coins'}</p>
                    <div>${mission.completed ? '✅ Completada' : '⏳ En progreso'}</div>
                `;
                missionList.appendChild(div);
            });
        }

        function getMissionName(key) {
            const names = {
                bounces: 'Rebotes Diarios',
                coins: 'Coleccionista de Coins',
                diamonds: 'Cazador de Diamantes',
                level: 'Subir de Nivel',
                combo: 'Maestro del Combo',
                upgrades: 'Comprador de Mejoras'
            };
            return names[key] || key;
        }

        function renderMissions() {
            updateMissions();
        }

        function updateDailyChallenges() {
            if (!currentDailyChallenge) return;
            
            switch (currentDailyChallenge.id) {
                case 'bounces':
                    currentDailyChallenge.progress = bounces;
                    break;
                case 'coins':
                    currentDailyChallenge.progress = coins;
                    break;
                case 'diamonds':
                    currentDailyChallenge.progress = diamonds;
                    break;
                case 'combo':
                    currentDailyChallenge.progress = Math.max(currentDailyChallenge.progress || 0, combo);
                    break;
                case 'levels':
                    currentDailyChallenge.progress = level;
                    break;
                case 'speed':
                    const currentSpeed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
                    currentDailyChallenge.progress = Math.max(currentDailyChallenge.progress || 0, currentSpeed);
                    break;
                case 'orbs':
                    currentDailyChallenge.progress = betaStats.orbsCollected;
                    break;
                case 'prestige':
                    currentDailyChallenge.progress = gameData.prestige;
                    break;
                case 'experience':
                    currentDailyChallenge.progress = experience;
                    break;
            }
            
            if (currentDailyChallenge.progress >= currentDailyChallenge.target && !currentDailyChallenge.completed) {
                currentDailyChallenge.completed = true;
                showNotification(`🎯 Desafío completado: ${currentDailyChallenge.name}!`);
            }
        }

        function updateDailyChallengesDisplay() {
            const container = document.getElementById('dailyChallengesContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            dailyChallenges.forEach(challenge => {
                const div = document.createElement('div');
                div.className = 'upgrade';
                if (challenge.completed) div.classList.add('legendary-upgrade');
                
                div.innerHTML = `
                    <h4>${challenge.name}</h4>
                    <p>${challenge.desc}</p>
                    <p>Progreso: ${challenge.progress || 0}/${challenge.target}</p>
                    <p>Recompensa: ${challenge.reward} ${challenge.type === 'diamonds' ? 'diamantes' : 'coins'}</p>
                    <div>${challenge.completed ? '✅ Completado' : '⏳ En progreso'}</div>
                `;
                
                container.appendChild(div);
            });
        }

        function selectRandomDailyChallenge() {
            const availableChallenges = dailyChallenges.filter(c => !c.completed);
            if (availableChallenges.length === 0) {
                showNotification('🎯 Todos los desafíos completados!');
                return;
            }
            
            currentDailyChallenge = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
            showNotification(`🎯 Nuevo desafío: ${currentDailyChallenge.name}`);
            updateDailyChallengesDisplay();
        }

        function claimAfkRewards() {
            if (afkRewards.coins > 0 || afkRewards.diamonds > 0 || afkRewards.experience > 0) {
                coins += afkRewards.coins;
                diamonds += afkRewards.diamonds;
                experience += afkRewards.experience;
                
                gameData.coins = coins;
                gameData.diamonds = diamonds;
                gameData.experience = experience;
                
                showNotification(`💤 Recompensas AFK: +${afkRewards.coins} coins, +${afkRewards.diamonds} diamantes, +${afkRewards.experience} exp`);
                
                afkRewards = { coins: 0, diamonds: 0, experience: 0 };
                updateUI();
            } else {
                showNotification('💤 No hay recompensas AFK disponibles');
            }
        }

        function updateAfkSystem() {
            const now = Date.now();
            const timeSinceActivity = now - lastActivity;
            
            if (timeSinceActivity > 30000) {
                afkTime = Math.floor(timeSinceActivity / 1000);
                
                if (afkTime > 0 && afkTime % 60 === 0) {
                    const afkMinutes = Math.floor(afkTime / 60);
                    afkRewards.coins += Math.floor(level * 10 * afkMinutes);
                    afkRewards.experience += Math.floor(level * 5 * afkMinutes);
                    
                    if (afkMinutes % 5 === 0) {
                        afkRewards.diamonds += Math.floor(afkMinutes / 5);
                    }
                }
            } else {
                afkTime = 0;
            }
        }

        function resetAfkTimer() {
            lastActivity = Date.now();
            afkTime = 0;
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                if (document.getElementById('pauseBackground')?.checked) {
                    gamePaused = true;
                }
            } else {
                if (document.getElementById('pauseBackground')?.checked) {
                    gamePaused = false;
                }
                resetAfkTimer();
            }
        }

        function handleWindowBlur() {
            if (document.getElementById('pauseBackground')?.checked) {
                gamePaused = true;
            }
        }

        function handleWindowFocus() {
            if (document.getElementById('pauseBackground')?.checked) {
                gamePaused = false;
            }
            resetAfkTimer();
        }

        // Game Constants
        const GAME_CONFIG = {
            BALL_SPEED: 2,
            BALL_RADIUS: 10,
            ORB_LIFETIME: 15000,
            PARTICLE_LIFETIME: 2000,
            AFK_TIMEOUT: 300000,
            MAX_ORBS: 50,
            MAX_PARTICLES: 100,
            CANVAS_WIDTH: 800,
            CANVAS_HEIGHT: 600
        };

        // Object Pools for Performance
        const orbPool = [];
        const particlePool = [];
        
        function getPooledOrb() {
            return orbPool.pop() || {};
        }
        
        function returnOrbToPool(orb) {
            if (orbPool.length < 20) orbPool.push(orb);
        }
        
        function getPooledParticle() {
            return particlePool.pop() || {};
        }
        
        function returnParticleToPool(particle) {
            if (particlePool.length < 50) particlePool.push(particle);
        }

        function redeemCode() {
            try {
                const codeInput = document.getElementById('codeInput');
                if (!codeInput) {
                    console.warn('Code input element not found');
                    return;
                }
                
                const code = codeInput.value.trim().toUpperCase();
                
                // Input validation
                if (!code || code.length > 20) {
                    showNotification('⚠️ Ingresa un código válido');
                    return;
                }
                
                if (redeemedCodes.includes(code)) {
                    showNotification('⚠️ Código ya canjeado');
                    return;
                }
            
            const codes = {
                'WELCOME2': { coins: 1000, diamonds: 5, message: 'Pack de bienvenida beta' },
                'BETA2024': { coins: 1000, diamonds: 5, message: '1K coins + 5 diamantes' },
                'FENIX2024': { coins: 500, diamonds: 3, message: '500 coins + 3 diamantes' },
                'BETATEST2': { coins: 2000, diamonds: 10, message: '2K coins + 10 diamantes' },
                'FEEDBACK': { coins: 1000, diamonds: 0, message: 'Orbe mítico + 1K coins', special: 'mythic_orb' },
                'GITHUB': { coins: 0, diamonds: 5, message: '5 diamantes + boost combo', special: 'combo_boost' },
                'ORBES': { coins: 300, diamonds: 0, message: '300 coins + orbe raro', special: 'rare_orb' },
                'SPEED': { coins: 0, diamonds: 0, message: 'Velocidad x1.5 por 1 min', special: 'speed_boost' },
                'COMBO': { coins: 0, diamonds: 0, message: 'Combo x2 por 30 seg', special: 'combo_boost_temp' }
            };
            
            if (codes[code]) {
                const reward = codes[code];
                
                coins += reward.coins || 0;
                diamonds += reward.diamonds || 0;
                gameData.coins = coins;
                gameData.diamonds = diamonds;
                
                if (reward.special) {
                    switch (reward.special) {
                        case 'mythic_orb':
                            spawnSpecialOrb('rainbow');
                            break;
                        case 'rare_orb':
                            spawnSpecialOrb('diamonds');
                            break;
                        case 'speed_boost':
                            ball.dx *= 1.5;
                            ball.dy *= 1.5;
                            setTimeout(() => {
                                ball.dx /= 1.5;
                                ball.dy /= 1.5;
                            }, 60000);
                            break;
                        case 'combo_boost':
                            combo *= 2;
                            break;
                        case 'combo_boost_temp':
                            const originalCombo = combo;
                            combo *= 2;
                            setTimeout(() => combo = originalCombo, 30000);
                            break;
                    }
                }
                
                redeemedCodes.push(code);
                betaStats.codesRedeemed++;
                
                showNotification(`🎁 ${reward.message}`);
                codeInput.value = '';
                updateUI();
                
            } else {
                showNotification('❌ Código inválido');
            }
            } catch (error) {
                console.warn('Error redeeming code:', error);
                showNotification('❌ Error procesando código');
            }
        }

        function spawnSpecialOrb(type) {
            try {
                const specialOrb = orbTypes.find(orb => orb.id === type);
                if (specialOrb && orbs.length < GAME_CONFIG.MAX_ORBS) {
                    const orb = getPooledOrb();
                    Object.assign(orb, {
                        x: Math.random() * (width - 100) + 50,
                        y: Math.random() * (height - 100) + 50,
                        radius: 20,
                        type: specialOrb,
                        alpha: 1,
                        life: GAME_CONFIG.ORB_LIFETIME,
                        maxLife: GAME_CONFIG.ORB_LIFETIME,
                        pulsePhase: 0,
                        musical: false
                    });
                    orbs.push(orb);
                }
            } catch (error) {
                console.warn('Error spawning special orb:', error);
            }
        }
        
        // Función mejorada para cargar archivos de música
        function loadMusicFile(file) {
            if (!file) return;
            
            // Limpiar audio anterior de forma segura
            if (audioSource) {
                audioSource.pause();
                audioSource.currentTime = 0;
                if (audioSource.src && audioSource.src.startsWith('blob:')) {
                    try {
                        URL.revokeObjectURL(audioSource.src);
                    } catch (e) {
                        console.warn('Error revocando URL:', e);
                    }
                }
                // Remover event listeners
                audioSource.onloadedmetadata = null;
                audioSource.ontimeupdate = null;
                audioSource.onended = null;
                audioSource.onerror = null;
            }
            
            // Verificar tipo de archivo
            const validTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/m4a'];
            const validExtensions = /\.(mp3|wav|ogg|m4a)$/i;
            
            if (!validTypes.includes(file.type) && !file.name.match(validExtensions)) {
                console.warn('Formato de audio no soportado:', file.type, file.name);
                return;
            }
            
            try {
                // Crear nuevo elemento de audio
                audioSource = new Audio();
                
                // Crear URL del archivo de forma segura
                const url = URL.createObjectURL(file);
                audioSource.src = url;
                
                // Configurar eventos con manejo de errores mejorado
                audioSource.onloadedmetadata = function() {
                    try {
                        const duration = this.duration || 0;
                        const minutes = Math.floor(duration / 60);
                        const seconds = Math.floor(duration % 60);
                        const infoEl = document.getElementById('musicInfo');
                        if (infoEl) {
                            infoEl.textContent = `${file.name} - ${minutes}:${seconds.toString().padStart(2, '0')}`;
                        }
                    } catch (e) {
                        console.warn('Error actualizando info de música:', e);
                    }
                };
                
                audioSource.ontimeupdate = function() {
                    try {
                        updateMusicProgress();
                    } catch (e) {
                        console.warn('Error actualizando progreso:', e);
                    }
                };
                
                audioSource.onended = function() {
                    try {
                        const playBtn = document.getElementById('playPauseBtn');
                        if (playBtn) playBtn.textContent = '▶️ Play';
                        resetMusicEffects();
                    } catch (e) {
                        console.warn('Error al finalizar música:', e);
                    }
                };
                
                audioSource.onerror = function(e) {
                    console.warn('Error de audio (manejado):', e);
                    // No mostrar notificación para evitar spam
                    try {
                        if (this.src && this.src.startsWith('blob:')) {
                            URL.revokeObjectURL(this.src);
                        }
                        resetMusicEffects();
                    } catch (cleanupError) {
                        console.warn('Error en cleanup:', cleanupError);
                    }
                };
                
                // Precargar metadatos
                audioSource.load();
                
            } catch (error) {
                console.warn('Error cargando archivo de música:', error);
                // Continuar sin música en lugar de mostrar error
            }
        }

        // Función para limpiar recursos de audio al cerrar
        function cleanupAudioResources() {
            if (audioSource) {
                try {
                    audioSource.pause();
                    if (audioSource.src && audioSource.src.startsWith('blob:')) {
                        URL.revokeObjectURL(audioSource.src);
                    }
                } catch (e) {
                    console.warn('Error en cleanup:', e);
                }
            }
            
            if (audioContext && audioContext.state !== 'closed') {
                try {
                    audioContext.close();
                } catch (e) {
                    console.warn('Error cerrando AudioContext:', e);
                }
            }
        }

        // Enhanced resource cleanup
        function cleanupAllResources() {
            try {
                cleanupAudioResources();
                
                // Cancel animation frame
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                // Clear arrays and return objects to pools
                orbs.forEach(returnOrbToPool);
                particles.forEach(returnParticleToPool);
                orbs.length = 0;
                particles.length = 0;
                
                // Clear timers
                afkTimer = 0;
                
            } catch (error) {
                console.warn('Error during cleanup:', error);
            }
        }

        // Error boundary for unhandled errors
        window.addEventListener('error', function(event) {
            console.error('Unhandled error:', event.error);
            // Don't crash the game, just log the error
            event.preventDefault();
        });

        // Enhanced page lifecycle management
        window.addEventListener('beforeunload', cleanupAllResources);
        window.addEventListener('unload', cleanupAllResources);
        window.addEventListener('pagehide', cleanupAllResources);

        // Keyboard accessibility
        document.addEventListener('keydown', function(event) {
            try {
                switch(event.key) {
                    case ' ':
                    case 'Escape':
                        event.preventDefault();
                        if (gameRunning) {
                            gamePaused = !gamePaused;
                            showNotification(gamePaused ? '⏸️ Pausado' : '▶️ Reanudado');
                        }
                        break;
                    case 'r':
                    case 'R':
                        if (event.ctrlKey) {
                            event.preventDefault();
                            location.reload();
                        }
                        break;
                }
            } catch (error) {
                console.warn('Error handling keyboard input:', error);
            }
        });

        // Initialize everything with error handling
        window.addEventListener('load', function() {
            try {
                init();
            } catch (error) {
                console.error('Error during initialization:', error);
                showNotification('❌ Error al inicializar el juego');
            }
        });
    </script>
</body>

</html>